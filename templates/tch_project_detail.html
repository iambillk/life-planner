{# =============================================================================
  FILE: templates/projects_tch_detail.html
  PURPOSE: TCH Project ‚Äî Detail view (tasks, ideas, milestones, notes, files)
  TEMPLATE VERSION: v1.2.0
  LAST UPDATED: 2025-09-06

  v1.2.0
  - NEW: Add files to existing projects without new routes
  - NEW: Always show files section with empty state
  - NEW: Inline upload form using existing edit endpoint
  v1.1.3
  - Force inner scrolling by giving .section-scroll a fixed viewport height (height: 60vh)
  - Keep min-height:0 on ancestors so flex children can shrink
  - Cards contain their scroller (overflow:hidden on the card; .section-scroll does the scrolling)
============================================================================= #}

{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}
{% block header %}{{ project.name }}{% endblock %}

{% block extra_css %}
<style>
  :root{
    --pd-bg: var(--bg, #0b0f1a);
    --pd-panel: var(--panel, #121a2a);
    --pd-card: var(--card, #0f1625);
    --pd-line: var(--line, #1f2a3d);
    --pd-text: var(--text, #e6eaf2);
    --pd-muted: var(--text-muted, #9fb0c8);
    --pd-primary: var(--primary, #6ea8ff);
    --pd-primary-700: var(--primary-700, #3f7fe6);
    --pd-success: var(--success, #22c55e);
    --pd-warn: var(--warning, #f59e0b);
    --pd-danger: var(--danger, #ef4444);
    --pd-radius: var(--radius, 14px);
    --pd-radius-sm: var(--pd-radius-sm, 10px);
    --pd-shadow: 0 6px 18px rgba(0,0,0,.35);
  }

  .project-detail-container{
    padding:16px; max-width:1200px; margin:0 auto; display:grid; gap:16px;
    min-height: 0;
  }

  /* Sticky summary header */
  .project-header-section{
    position: sticky; top: 12px; z-index: 5;
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border: 1px solid var(--pd-line);
    border-radius: var(--pd-radius);
    padding: 12px;
    box-shadow: var(--pd-shadow);
    backdrop-filter: blur(6px);
  }
  .header-top{
    display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin-bottom:8px;
  }
  .header-top h1{ margin:0; font-size:1.2rem; letter-spacing:.2px; }
  .header-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:12px; border:1px solid var(--pd-line);
    background:var(--pd-card); color:var(--pd-text); text-decoration:none; font-size:.95rem;
    transition:transform .1s ease, border-color .2s ease, background .2s ease;
  }
  .btn:hover{ border-color:var(--pd-primary); transform:translateY(-1px); }
  .btn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .btn-primary:hover{ background: rgba(110,168,255,.25); }
  .btn-outline{ background:transparent; }
  .btn-secondary{ background:#0c1322; }
  .btn-success{ background:#16351f; border-color:#1f6f3a; }
  .btn-sm{ padding:6px 10px; font-size:.85rem; border-radius:10px; }

  /* Chips */
  .project-metadata{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
    background:#0c1322; color:var(--pd-muted); border:1px solid var(--pd-line); white-space:nowrap;
  }
  .chip strong{ color:var(--pd-text); font-weight:800; }
  .chip-status{ background:#0c1529; color:#0a0f1a; border-color:transparent; }
  .chip-status.status-active{ background:#3b82f6; }
  .chip-status.status-planning{ background:#64748b; }
  .chip-status.status-on_hold{ background:#f59e0b; }
  .chip-status.status-completed{ background:#22c55e; }
  .chip-priority.priority-low{ background:#4b5563; color:#0a0f1a; }
  .chip-priority.priority-medium{ background:#3b82f6; color:#0a0f1a; }
  .chip-priority.priority-high{ background:#f59e0b; color:#0a0f1a; }
  .chip-priority.priority-critical{ background:#ef4444; color:#0a0f1a; }

  .project-description{ color:var(--pd-muted); margin-top:8px; }

  .header-progress{ margin-top:8px; display:flex; align-items:center; gap:10px; }
  .progress-bar-compact{
    flex:1; height:10px; border-radius:999px; overflow:hidden; background:#0c1322; border:1px solid var(--pd-line);
  }
  .progress-fill-compact{ height:100%; background:linear-gradient(90deg, var(--pd-primary), var(--pd-primary-700)); }
  .progress-label{ font-size:.85rem; color:var(--pd-muted); min-width:70px; text-align:right; }

  /* Info cards (goal/motivation/strategy) */
  .info-cards-section{ display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px; }
  .info-card{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius-sm); padding:12px; box-shadow:var(--pd-shadow); }
  .info-card-header{ display:flex; align-items:center; gap:8px; color:var(--pd-text); font-weight:700; margin-bottom:8px; border-bottom:1px dashed var(--pd-line); padding-bottom:6px; }
  .info-card-content{ color:var(--pd-muted); }

  /* Progress / timeline */
  .progress-section{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); padding:14px; box-shadow:var(--pd-shadow); }
  .progress-section h2{ margin:0 0 10px 0; font-size:1.05rem; }
  .progress-container{ display:grid; gap:12px; }
  .progress-bar-large{ height:22px; background:#0c1322; border:1px solid var(--pd-line); border-radius:999px; overflow:hidden; }
  .progress-fill-large{ height:100%; display:flex; align-items:center; justify-content:center; background:linear-gradient(90deg, var(--pd-primary), var(--pd-primary-700)); transition:width .3s; }
  .progress-text{ color:#0a0f1a; font-weight:800; font-size:.85rem; }
  .timeline-info{ display:flex; gap:16px; flex-wrap:wrap; color:var(--pd-muted); }
  .timeline-item{ display:inline-flex; align-items:center; gap:8px; }

  .overdue-label{ background:var(--pd-danger); color:#0a0f1a; font-weight:800; font-size:.72rem; padding:2px 8px; border-radius:8px; margin-left:6px; }

  /* Main content grid */
  .content-grid{
    display:grid; grid-template-columns:repeat(auto-fit, minmax(380px,1fr)); gap:14px;
    min-height: 0; align-items:start;
  }

  /* Content sections with internal scrollers */
  .content-section{
    display:flex; flex-direction:column; gap:10px;
    background:var(--pd-card); border:1px solid var(--pd-line);
    border-radius:var(--pd-radius); padding:12px; box-shadow:var(--pd-shadow);
    min-height: 0;
    overflow: hidden; /* contain the inner scroller */
  }
  .section-header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom:1px dashed var(--pd-line); padding-bottom:6px;
    min-height: 0;
  }
  .section-header h2{ margin:0; font-size:1.05rem; }

  /* Add dropdown + panels */
  .split-actions{ position:relative; display:flex; gap:6px; }
  .add-btn{ cursor:pointer; }
  .caret-btn{ width:32px; justify-content:center; }
  .menu{
    position:absolute; top:100%; right:0; margin-top:6px; min-width:180px;
    background:#0c1322; border:1px solid var(--pd-line); border-radius:12px; box-shadow:var(--pd-shadow); padding:6px; display:none;
  }
  .menu.open{ display:block; }
  .menu a{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; text-decoration:none; color:var(--pd-text);
  }
  .menu a:hover{ background:rgba(255,255,255,.05); }

  .add-panel{
    display:none; background:#0c1322; border:1px solid var(--pd-line); border-radius:10px; padding:10px;
  }
  .add-panel.open{ display:block; }

  .form-slab input, .form-slab textarea, .form-slab select,
  .add-panel input, .add-panel textarea, .add-panel select{
    width:100%; background:#0b1120; color:var(--pd-text);
    border:1px solid var(--pd-line); border-radius:8px; padding:8px; font-size:.95rem; margin-bottom:8px;
  }

  /* *** The actual scroller *** */
  .section-scroll{
    height: 40vh;            /* FORCE an inner scroll area */
    min-height: 0;
    overflow: auto;
    padding-right:4px;
    overscroll-behavior: contain;
  }

  /* Tasks */
  .task-category{ margin-bottom:10px; }
  .task-category h3{ margin:6px 0; font-size:.95rem; color:var(--pd-text); }
  .task-item{
    display:flex; gap:10px; align-items:flex-start; background:#0c1322;
    border:1px solid var(--pd-line); border-radius:10px; padding:10px; margin-bottom:8px;
  }
  .task-item.completed{ opacity:.6; }
  .task-title{ font-weight:700; margin-bottom:4px; }
  .task-description{ color:var(--pd-muted); font-size:.9rem; margin-bottom:4px; }
  .task-meta{ display:flex; gap:10px; color:var(--pd-muted); font-size:.8rem; }
  .task-actions{ display:flex; gap:6px; }
  .priority-low,.priority-medium,.priority-high{
    background:#334155; color:#e2e8f0; padding:2px 8px; border-radius:999px; font-weight:800; font-size:.72rem;
  }

  /* Ideas */
  .idea-item{ background:#0c1322; border:1px solid var(--pd-line); border-left:3px solid var(--pd-primary); border-radius:10px; padding:10px; margin-bottom:8px; }
  .idea-content{ color:var(--pd-text); margin-bottom:8px; }
  .idea-footer{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .idea-footer select{ background:#0b1120; color:var(--pd-text); border:1px solid var(--pd-line); border-radius:8px; padding:6px 8px; font-size:.9rem; }
  .idea-date{ color:var(--pd-muted); font-size:.8rem; }

  /* Milestones */
  .milestone-item{ background:#0c1322; border:1px solid var(--pd-line); border-radius:10px; padding:10px; margin-bottom:8px; }
  .milestone-item.completed{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.08); }
  .milestone-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
  .completed-badge{ background:var(--pd-success); color:#0a0f1a; padding:2px 8px; border-radius:999px; font-weight:800; }
  .milestone-date{ color:var(--pd-muted); font-size:.85rem; }

  /* Notes */
  .note-item{ background:#0c1322; border:1px solid var(--pd-line); border-radius:10px; padding:10px; margin-bottom:8px; }
  .note-header{ display:flex; justify-content:space-between; font-size:.8rem; color:var(--pd-muted); margin-bottom:6px; }
  .note-category{ background:var(--pd-primary); color:#0a0f1a; padding:2px 8px; border-radius:999px; font-weight:800; }
  .note-content{ color:var(--pd-text); }

  /* Todo lists */
  .todo-lists-section{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); padding:14px; box-shadow:var(--pd-shadow); }
  .todo-lists-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:12px; margin-top:10px; }
  .todo-list-card{ background:#0c1322; border:1px solid var(--pd-line); border-radius:12px; padding:12px; position:relative; }
  .todo-list-card .pinned-badge{ position:absolute; right:10px; top:10px; color:var(--pd-danger); }
  .todo-progress{ display:flex; align-items:center; gap:10px; margin-top:8px; color:var(--pd-muted); font-size:.85rem; }
  .progress-bar-small{ flex:1; height:8px; border-radius:999px; overflow:hidden; background:#0b1120; border:1px solid var(--pd-line); }
  .progress-fill-small{ height:100%; background:var(--pd-success); }

  /* Files (now at bottom) */
  .files-section{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); padding:14px; box-shadow:var(--pd-shadow); }
  .files-section h2{ margin:0 0 10px 0; font-size:1.05rem; }
  .files-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:10px; margin-top:10px; }
  .file-card{ background:#0c1322; border:1px solid var(--pd-line); border-radius:12px; padding:10px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .file-icon{ font-size:28px; }
  .file-name{ font-weight:700; color:var(--pd-text); font-size:.9rem; word-break:break-word; }
  .file-date{ color:var(--pd-muted); font-size:.75rem; }
  .file-actions{ display:flex; gap:6px; }
  .btn-icon{ background:transparent; border:1px solid var(--pd-line); color:var(--pd-text); border-radius:10px; padding:6px 8px; font-size:.9rem; }
  .btn-icon:hover{ border-color:var(--pd-primary); }
  .btn-icon.btn-delete:hover{ border-color:var(--pd-danger); color:var(--pd-danger); }

  /* File upload specific styles */
  .file-upload-panel{
    background:#0c1322; border:1px solid var(--pd-line); border-radius:10px; padding:12px; margin-bottom:12px;
  }
  .drop{
    position:relative; border:2px dashed var(--pd-line); border-radius:12px;
    background:#0b1120; padding:12px; transition: border-color .2s ease, background .2s ease;
  }
  .drop.is-drag{ border-color: var(--pd-primary); background: rgba(110,168,255,.06); }
  .file-upload-input{ width:100%; }
  .file-upload-input::-webkit-file-upload-button{
    padding:8px 12px; border-radius:10px; border:none; cursor:pointer;
    color:#0a0f1a; background: var(--pd-primary); margin-right:10px;
  }
  .selected-files-list{ margin-top:10px; display:grid; gap:6px; }
  .file-pill{
    display:flex; align-items:center; gap:8px; padding:6px 10px;
    background:#0b1120; border:1px solid var(--pd-line); border-radius:999px; font-size:.9rem;
  }
  .file-pill .type{ font-weight:800; font-size:.75rem; color:#0a0f1a; padding:2px 8px; border-radius:999px; }
  .type.image{ background:#a78bfa; }
  .type.pdf{ background:#f87171; }
  .type.word{ background:#60a5fa; }
  .type.excel{ background:#34d399; }
  .type.archive{ background:#fbbf24; }
  .type.other{ background:#94a3b8; }
  .pill-size{ margin-left:auto; color: var(--pd-muted); font-size:.8rem; }
  .totals{ margin-top:6px; padding-top:6px; border-top:1px dashed var(--pd-line); color: var(--pd-muted); font-size:.9rem; }

  .empty-state{ text-align:center; color:var(--pd-muted); padding:20px; }
  .empty-state-box{ text-align:center; padding:30px; }
  .empty-state-box p{ color:var(--pd-muted); margin-bottom:12px; font-size:1.1rem; }

  /* Anchors + footer */
  .page-foot{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); padding:8px; }
  .page-foot details{ border:1px dashed var(--pd-line); border-radius:10px; padding:6px 8px; }
  .page-foot summary{ cursor:pointer; font-weight:700; }
  .page-foot code{ display:block; white-space:pre-wrap; margin-top:6px; font-size:.85rem; }

  .anchor-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .anchor{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:#0c1322; color:var(--pd-muted); border:1px solid var(--pd-line); text-decoration:none; }
  .anchor:hover{ border-color:var(--pd-primary); color:var(--pd-text); }

  @media (max-width: 820px){
    .header-top{ grid-template-columns:1fr; }
    .section-scroll{ height: 50vh; }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-detail-container">

  <!-- Sticky summary -->
  <div class="project-header-section">
    <div class="header-top">
      <h1>{{ project.name }}</h1>
      <div class="header-actions">
        <a href="#progress"   class="anchor">üìà Progress</a>
        <a href="#tasks"      class="anchor">‚úÖ Tasks</a>
        <a href="#ideas"      class="anchor">üí° Ideas</a>
        <a href="#milestones" class="anchor">üèÅ Milestones</a>
        <a href="#notes"      class="anchor">üìù Notes</a>
        <a href="#files"      class="anchor">üìé Files</a>

        <a href="{{ url_for('projects.edit_tch', id=project.id) }}" class="btn">‚úèÔ∏è Edit</a>
        <a href="{{ url_for('projects.tch_index') }}" class="btn btn-outline">‚Üê Back</a>
      </div>
    </div>

    <div class="project-metadata">
      <span class="chip"><strong>Category:</strong> {{ project.category }}</span>
      <span class="chip chip-status status-{{ project.status }}">{{ project.status|replace('_',' ')|title }}</span>
      <span class="chip chip-priority priority-{{ project.priority }}">{{ project.priority|title }} Priority</span>
    </div>

    {% if project.description %}
      <div class="project-description">{{ project.description }}</div>
    {% endif %}

    <div class="header-progress">
      <div class="progress-bar-compact" aria-hidden="true">
        <div class="progress-fill-compact" style="width: {{ project.progress }}%"></div>
      </div>
      <div class="progress-label">{{ project.progress }}% complete</div>
    </div>

    <div class="anchor-row" aria-label="Jump to section">
      <a class="anchor" href="#progress">üìà Progress</a>
      <a class="anchor" href="#tasks">‚úÖ Tasks</a>
      <a class="anchor" href="#ideas">üí° Ideas</a>
      <a class="anchor" href="#milestones">üèÅ Milestones</a>
      <a class="anchor" href="#notes">üìù Notes</a>
      <a class="anchor" href="#files">üìé Files</a>
    </div>
  </div>

  <!-- Secondary info cards -->
  <div class="info-cards-section">
    {% if project.goal %}
      <div class="info-card">
        <div class="info-card-header">üéØ Goal</div>
        <div class="info-card-content">{{ project.goal }}</div>
      </div>
    {% endif %}
    {% if project.motivation %}
      <div class="info-card">
        <div class="info-card-header">üî• Motivation</div>
        <div class="info-card-content">{{ project.motivation }}</div>
      </div>
    {% endif %}
    {% if project.strategy %}
      <div class="info-card">
        <div class="info-card-header">‚ôüÔ∏è Strategy</div>
        <div class="info-card-content">{{ project.strategy }}</div>
      </div>
    {% endif %}
  </div>

  <!-- Progress & timeline -->
  <div class="progress-section" id="progress">
    <h2>Progress Overview</h2>
    <div class="progress-container">
      <div class="progress-bar-large">
        <div class="progress-fill-large" style="width: {{ project.progress }}%">
          <span class="progress-text">{{ project.progress }}%</span>
        </div>
      </div>
      <div class="timeline-info">
        <div class="timeline-item">üóìÔ∏è Started:
          {{ project.start_date.strftime('%b %d, %Y') if project.start_date else 'Not set' }}
        </div>
        {% if project.deadline %}
        <div class="timeline-item">‚úÖ Deadline:
          {{ project.deadline.strftime('%b %d, %Y') }}
          {% set now = datetime.now().date() %}
          {% if project.deadline < now and project.status != 'completed' %}
            <span class="overdue-label">OVERDUE</span>
          {% endif %}
        </div>
        {% endif %}
        {% if project.completed_date %}
        <div class="timeline-item">üèÅ Completed:
          {{ project.completed_date.strftime('%b %d, %Y') }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT GRID -->
  <div class="content-grid">

    <!-- ===== Tasks ===== -->
    <section class="content-section" id="tasks" aria-labelledby="tasks-title">
      <div class="section-header">
        <h2 id="tasks-title">‚úÖ Tasks</h2>

        <div class="split-actions" data-section="tasks">
          <button type="button" class="btn btn-primary btn-sm add-btn" data-action="quick">Add</button>
          <button type="button" class="btn btn-primary btn-sm caret-btn" aria-label="More add options" data-toggle="menu">‚åÑ</button>
          <div class="menu" role="menu">
            <a href="#" data-action="quick">‚ûï Quick Task</a>
            <a href="#" data-action="full">üìù Full Task Form</a>
          </div>
        </div>
      </div>

      <div class="add-panel" data-panel="tasks-quick">
        <form method="POST" action="{{ url_for('projects.add_tch_task', project_id=project.id) }}">
          <input type="text" name="title" placeholder="Task title" required>
          <button class="btn btn-primary btn-sm" type="submit">Add Task</button>
        </form>
      </div>

      <div class="add-panel" data-panel="tasks-full">
        <form method="POST" action="{{ url_for('projects.add_tch_task', project_id=project.id) }}" class="form-slab">
          <input type="text" name="title" placeholder="Task title" required>
          <textarea name="description" placeholder="Description (optional)" rows="2"></textarea>
          <select name="category" required>
            <option value="" disabled selected>Select Category</option>
            <option>Development</option><option>Design</option><option>Testing</option>
            <option>Documentation</option><option>Research</option><option>Other</option>
          </select>
          <select name="priority">
            <option value="low">Low Priority</option>
            <option value="medium" selected>Medium Priority</option>
            <option value="high">High Priority</option>
          </select>
          <input type="date" name="due_date" placeholder="Due date">
          <button type="submit" class="btn btn-primary btn-sm">Create Task</button>
        </form>
      </div>

      <div class="section-scroll">
        {% for category, tasks in tasks_by_category.items() %}
          <div class="task-category">
            <h3>{{ category }}</h3>
            {% for task in tasks %}
            <div class="task-item {% if task.completed %}completed{% endif %}">
              <input type="checkbox"
                     class="task-checkbox"
                     data-task-id="{{ task.id }}"
                     data-endpoint="{{ url_for('projects.toggle_tch_task', task_id=task.id) }}"
                     {% if task.completed %}checked{% endif %}>
              <div class="task-content">
                <div class="task-title">{{ task.title }}</div>
                {% if task.description %}<div class="task-description">{{ task.description }}</div>{% endif %}
                <div class="task-meta">
                  <span class="priority-{{ task.priority }}">{{ task.priority|title }}</span>
                  {% if task.due_date %}<span>üìÖ {{ task.due_date.strftime('%b %d') }}</span>{% endif %}
                </div>
              </div>
              <div class="task-actions">
                <a href="{{ url_for('projects.edit_tch_task', task_id=task.id) }}" class="btn btn-sm">‚úèÔ∏è</a>
                <form method="POST" action="{{ url_for('projects.delete_tch_task', task_id=task.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-sm" onclick="return confirm('Delete this task?')">üóëÔ∏è</button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="empty-state">No tasks yet. Use Add ‚åÑ to create one.</p>
        {% endfor %}
      </div>
    </section>

    <!-- ===== Ideas ===== -->
    <section class="content-section" id="ideas" aria-labelledby="ideas-title">
      <div class="section-header">
        <h2 id="ideas-title">üí° Ideas</h2>

        <div class="split-actions" data-section="ideas">
          <button type="button" class="btn btn-primary btn-sm add-btn" data-action="quick">Add</button>
          <button type="button" class="btn btn-primary btn-sm caret-btn" data-toggle="menu">‚åÑ</button>
          <div class="menu" role="menu">
            <a href="#" data-action="quick">‚ûï Quick Idea</a>
            <a href="#" data-action="full">üìù Full Idea Form</a>
          </div>
        </div>
      </div>

      <div class="add-panel" data-panel="ideas-quick">
        <form method="POST" action="{{ url_for('projects.add_tch_idea', project_id=project.id) }}">
          <textarea name="content" rows="3" placeholder="Got an idea? Write it down‚Ä¶" required></textarea>
          <button type="submit" class="btn btn-primary btn-sm">Add Idea</button>
        </form>
      </div>

      <div class="add-panel" data-panel="ideas-full">
        <form method="POST" action="{{ url_for('projects.add_tch_idea', project_id=project.id) }}" class="form-slab">
          <textarea name="content" rows="3" placeholder="Idea details‚Ä¶" required></textarea>
          <button type="submit" class="btn btn-primary btn-sm">Create Idea</button>
        </form>
      </div>

      <div class="section-scroll ideas-list">
        {% for idea in project.ideas %}
        <div class="idea-item status-{{ idea.status }}">
          <div class="idea-content">{{ idea.content }}</div>
          <div class="idea-footer">
            <form method="POST" action="{{ url_for('projects.update_idea_status', idea_id=idea.id) }}">
              <select name="status" onchange="this.form.submit()">
                <option value="new"         {% if idea.status == 'new' %}selected{% endif %}>New</option>
                <option value="considered"  {% if idea.status == 'considered' %}selected{% endif %}>Considered</option>
                <option value="implemented" {% if idea.status == 'implemented' %}selected{% endif %}>Implemented</option>
                <option value="rejected"    {% if idea.status == 'rejected' %}selected{% endif %}>Rejected</option>
              </select>
            </form>
            <span class="idea-date">{{ idea.created_at.strftime('%b %d') }}</span>
          </div>
        </div>
        {% else %}
        <p class="empty-state">No ideas yet. Use Add ‚åÑ to add one.</p>
        {% endfor %}
      </div>
    </section>

    <!-- ===== Milestones ===== -->
    <section class="content-section" id="milestones" aria-labelledby="milestones-title">
      <div class="section-header">
        <h2 id="milestones-title">üèÅ Milestones</h2>

        <div class="split-actions" data-section="milestones">
          <button type="button" class="btn btn-primary btn-sm add-btn" data-action="quick">Add</button>
          <button type="button" class="btn btn-primary btn-sm caret-btn" data-toggle="menu">‚åÑ</button>
          <div class="menu" role="menu">
            <a href="#" data-action="quick">‚ûï Quick Milestone</a>
            <a href="#" data-action="full">üìù Full Milestone Form</a>
          </div>
        </div>
      </div>

      <div class="add-panel" data-panel="milestones-quick">
        <form method="POST" action="{{ url_for('projects.add_tch_milestone', project_id=project.id) }}">
          <input type="text" name="title" placeholder="Milestone title" required>
          <input type="date" name="target_date" placeholder="Target date">
          <button type="submit" class="btn btn-primary btn-sm">Add Milestone</button>
        </form>
      </div>

      <div class="add-panel" data-panel="milestones-full">
        <form method="POST" action="{{ url_for('projects.add_tch_milestone', project_id=project.id) }}" class="form-slab">
          <input type="text" name="title" placeholder="Milestone title" required>
          <textarea name="description" placeholder="Description" rows="2"></textarea>
          <input type="date" name="target_date" placeholder="Target date">
          <button type="submit" class="btn btn-primary btn-sm">Create Milestone</button>
        </form>
      </div>

      <div class="section-scroll milestones-list">
        {% for milestone in project.milestones %}
        <div class="milestone-item {% if milestone.completed %}completed{% endif %}">
          <div class="milestone-header">
            <h4>{{ milestone.title }}</h4>
            {% if not milestone.completed %}
            <form method="POST" action="{{ url_for('projects.complete_milestone', milestone_id=milestone.id) }}">
              <button type="submit" class="btn btn-success btn-sm">Complete</button>
            </form>
            {% else %}
            <span class="completed-badge">Completed</span>
            {% endif %}
          </div>
          {% if milestone.description %}<p>{{ milestone.description }}</p>{% endif %}
          {% if milestone.target_date %}
          <div class="milestone-date">üìÖ Target: {{ milestone.target_date.strftime('%b %d, %Y') }}</div>
          {% endif %}
        </div>
        {% else %}
        <p class="empty-state">No milestones set. Use Add ‚åÑ to create one.</p>
        {% endfor %}
      </div>
    </section>

    <!-- ===== Notes ===== -->
    <section class="content-section" id="notes" aria-labelledby="notes-title">
      <div class="section-header">
        <h2 id="notes-title">üìù Notes</h2>

        <div class="split-actions" data-section="notes">
          <button type="button" class="btn btn-primary btn-sm add-btn" data-action="quick">Add</button>
          <button type="button" class="btn btn-primary btn-sm caret-btn" data-toggle="menu">‚åÑ</button>
          <div class="menu" role="menu">
            <a href="#" data-action="quick">‚ûï Quick Note</a>
            <a href="#" data-action="full">üìù Full Note Form</a>
          </div>
        </div>
      </div>

      <div class="add-panel" data-panel="notes-quick">
        <form method="POST" action="{{ url_for('projects.add_tch_note', project_id=project.id) }}">
          <textarea name="content" rows="3" placeholder="Add a note‚Ä¶" required></textarea>
          <button type="submit" class="btn btn-primary btn-sm">Add Note</button>
        </form>
      </div>

      <div class="add-panel" data-panel="notes-full">
        <form method="POST" action="{{ url_for('projects.add_tch_note', project_id=project.id) }}" class="form-slab">
          <textarea name="content" rows="3" placeholder="Note details‚Ä¶" required></textarea>
          <select name="category">
            <option value="general">General</option>
            <option value="meeting">Meeting</option>
            <option value="technical">Technical</option>
            <option value="idea">Idea</option>
          </select>
          <button type="submit" class="btn btn-primary btn-sm">Create Note</button>
        </form>
      </div>

      <div class="section-scroll notes-list">
        {% for note in project.notes %}
        <div class="note-item">
          <div class="note-header">
            <span class="note-category">{{ note.category|title }}</span>
            <span class="note-date">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
          </div>
          <div class="note-content">{{ note.content }}</div>
        </div>
        {% else %}
        <p class="empty-state">No notes yet. Use Add ‚åÑ to add one.</p>
        {% endfor %}
      </div>
    </section>

  </div><!-- /content-grid -->

  {% if project_todos %}
  <div class="todo-lists-section" id="todos">
    <h2>üìã Attached Todo Lists</h2>
    <div class="todo-lists-grid">
      {% for todo in project_todos %}
      <div class="todo-list-card">
        {% if todo.is_pinned %}<span class="pinned-badge">üìå</span>{% endif %}
        <h3>{{ todo.title }}</h3>
        {% if todo.description %}<p>{{ todo.description }}</p>{% endif %}
        <div class="todo-progress">
          <div class="progress-bar-small">
            <div class="progress-fill-small" style="width: {{ todo.completion_percentage }}%"></div>
          </div>
          <span>{{ todo.completed_count }}/{{ todo.total_count }} completed</span>
        </div>
        <a href="{{ url_for('todo.view_list', id=todo.id) }}" class="btn btn-sm btn-outline">View List</a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Files section - Always visible now -->
  <div class="files-section" id="files">
    <div class="section-header">
      <h2>üìé Project Files</h2>
      <button class="btn btn-primary btn-sm" onclick="toggleFileUploadPanel()">
        ‚ûï Add Files
      </button>
    </div>

    <!-- File upload panel (hidden by default) -->
    <div class="file-upload-panel" id="file-upload-panel" style="display:none;">
      <form method="POST" 
            action="{{ url_for('projects.edit_tch', id=project.id) }}" 
            enctype="multipart/form-data">
        <!-- Hidden fields to preserve existing project data -->
        <input type="hidden" name="name" value="{{ project.name }}">
        <input type="hidden" name="category" value="{{ project.category }}">
        <input type="hidden" name="description" value="{{ project.description or '' }}">
        <input type="hidden" name="goal" value="{{ project.goal or '' }}">
        <input type="hidden" name="motivation" value="{{ project.motivation or '' }}">
        <input type="hidden" name="strategy" value="{{ project.strategy or '' }}">
        <input type="hidden" name="priority" value="{{ project.priority }}">
        <input type="hidden" name="status" value="{{ project.status }}">
        <input type="hidden" name="start_date" value="{{ project.start_date.strftime('%Y-%m-%d') if project.start_date else '' }}">
        <input type="hidden" name="deadline" value="{{ project.deadline.strftime('%Y-%m-%d') if project.deadline else '' }}">
        
        <!-- File upload area -->
        <div id="dropZone" class="drop">
          <input type="file" 
                 id="attachments" 
                 name="attachments" 
                 class="file-upload-input"
                 multiple
                 accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.zip,.rar,.7z">
          <div class="hint">Drag & drop files here, or click to select.</div>
        </div>
        
        <!-- Selected files preview -->
        <div id="selected-files" class="selected-files-list" aria-live="polite"></div>
        <div id="files-total" class="totals"></div>
        
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button type="submit" class="btn btn-primary btn-sm">Upload Files</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="toggleFileUploadPanel()">Cancel</button>
        </div>
      </form>
    </div>

    {% if files %}
      <!-- Existing files grid -->
      <div class="files-grid">
        {% for file in files %}
        <div class="file-card">
          <div class="file-icon">
            {% if file.original_name.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %} üñºÔ∏è
            {% elif file.original_name.lower().endswith('.pdf') %} üìï
            {% elif file.original_name.lower().endswith(('.doc', '.docx')) %} üìÑ
            {% elif file.original_name.lower().endswith(('.xls', '.xlsx')) %} üìä
            {% elif file.original_name.lower().endswith(('.zip', '.rar', '.7z')) %} üóúÔ∏è
            {% else %} üìÅ
            {% endif %}
          </div>
          <div class="file-name" title="{{ file.original_name }}">{{ file.original_name|truncate(28) }}</div>
          <div class="file-date">{{ file.uploaded_at.strftime('%b %d, %Y') }}</div>
          <div class="file-actions">
            <a class="btn-icon" title="Download" href="{{ url_for('projects.download_file', project_id=project.id, file_id=file.id) }}">‚¨áÔ∏è</a>
            <form method="POST" action="{{ url_for('projects.delete_file', project_id=project.id, file_id=file.id) }}" onsubmit="return confirm('Delete this file?');" style="display:inline;">
              <button type="submit" class="btn-icon btn-delete" title="Delete">üóëÔ∏è</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty state -->
      <div class="empty-state-box">
        <p>üìÅ No files uploaded yet</p>
        <button class="btn btn-primary" onclick="toggleFileUploadPanel()">
          Upload your first file
        </button>
      </div>
    {% endif %}
  </div>

  <div class="page-foot">
    <details>
      <summary>Page Info & Changelog</summary>
      <code>v1.2.0 ‚Äî Added inline file upload capability using existing edit endpoint</code>
    </details>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function closeAllMenus() {
    document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
  }
  function togglePanel(section, kind) {
    const quick = document.querySelector(`.add-panel[data-panel="${section}-quick"]`);
    const full  = document.querySelector(`.add-panel[data-panel="${section}-full"]`);
    if (!quick || !full) return;
    [quick, full].forEach(p => p.classList.remove('open'));
    if (kind === 'quick') quick.classList.add('open');
    if (kind === 'full')  full.classList.add('open');
  }
  document.querySelectorAll('.split-actions').forEach(group => {
    const section = group.getAttribute('data-section');
    const menu = group.querySelector('.menu');
    if (!section || !menu) return;
    group.querySelectorAll('.add-btn').forEach(btn => {
      btn.addEventListener('click', e => { e.preventDefault(); togglePanel(section, btn.dataset.action || 'quick'); closeAllMenus(); });
    });
    const caret = group.querySelector('[data-toggle="menu"]');
    caret?.addEventListener('click', e => {
      e.preventDefault();
      const isOpen = menu.classList.contains('open');
      closeAllMenus();
      if (!isOpen) menu.classList.add('open');
    });
    menu.querySelectorAll('a[data-action]').forEach(item => {
      item.addEventListener('click', e => { e.preventDefault(); togglePanel(section, item.dataset.action); menu.classList.remove('open'); });
    });
  });
  document.addEventListener('click', e => { if (!e.target.closest('.split-actions')) closeAllMenus(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllMenus(); });
})();

(function(){
  const boxes = document.querySelectorAll('.task-checkbox');
  if (!boxes.length) return;
  boxes.forEach(cb => {
    cb.addEventListener('change', async function () {
      const endpoint = this.getAttribute('data-endpoint');
      if (!endpoint) return;
      try {
        const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }});
        const data = await res.json();
        if (data && data.success) {
          const wrap = this.closest('.task-item');
          if (wrap) wrap.classList.toggle('completed', !!data.completed);
        } else {
          this.checked = !this.checked;
        }
      } catch (e) {
        this.checked = !this.checked;
      }
    });
  });
})();

// Toggle file upload panel
function toggleFileUploadPanel() {
  const panel = document.getElementById('file-upload-panel');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    // Clear any previously selected files when closing
    if (panel.style.display === 'none') {
      const input = document.getElementById('attachments');
      if (input) input.value = '';
      const list = document.getElementById('selected-files');
      if (list) list.innerHTML = '';
      const totals = document.getElementById('files-total');
      if (totals) totals.textContent = '';
    }
  }
}

// File upload drag & drop functionality
(function(){
  const dz = document.getElementById('dropZone');
  const input = document.getElementById('attachments');
  const list = document.getElementById('selected-files');
  const totals = document.getElementById('files-total');

  function extType(name){
    const ext = (name.split('.').pop() || '').toLowerCase();
    if(['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)) return 'image';
    if(ext === 'pdf') return 'pdf';
    if(['doc','docx','rtf'].includes(ext)) return 'word';
    if(['xls','xlsx','csv'].includes(ext)) return 'excel';
    if(['zip','rar','7z','tar','gz'].includes(ext)) return 'archive';
    return 'other';
  }
  
  function fmtSize(bytes){
    if(bytes < 1024) return bytes + ' B';
    if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1024/1024).toFixed(1) + ' MB';
  }
  
  function renderFiles(files){
    if(!files || !files.length){ 
      list.innerHTML=''; 
      totals.textContent=''; 
      return; 
    }
    let total = 0;
    const rows = Array.from(files).map(f => {
      total += f.size;
      const t = extType(f.name);
      return `<div class="file-pill">
        <span class="type ${t}">${t}</span>
        <span class="name" title="${f.name}">${f.name}</span>
        <span class="pill-size">${fmtSize(f.size)}</span>
      </div>`;
    }).join('');
    list.innerHTML = rows;
    totals.textContent = `${files.length} file${files.length>1?'s':''} ‚Ä¢ ${fmtSize(total)}`;
  }

  if(input) {
    input.addEventListener('change', e => renderFiles(e.target.files));
  }
  
  if(dz) {
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e => {
      e.preventDefault(); 
      e.stopPropagation(); 
      dz.classList.add('is-drag');
    }));
    
    ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e => {
      e.preventDefault(); 
      e.stopPropagation(); 
      dz.classList.remove('is-drag');
    }));
    
    dz.addEventListener('drop', e => {
      if(!input) return;
      const dt = e.dataTransfer;
      if(dt?.files?.length){
        input.files = dt.files;
        renderFiles(dt.files);
      }
    });
  }
})();
</script>
{% endblock %}