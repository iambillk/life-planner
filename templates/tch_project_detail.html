{# =============================================================================
  FILE: templates/tch_project_detail.html
  PURPOSE: TCH Project ‚Äî Detail (Tasks left; RHS stacked cards with full-screen modals)
  TEMPLATE VERSION: v3.7.0 (Marcus style)
  LAST UPDATED: 2025-10-10

  v3.7.0 (2025-10-10)
  - FEATURE: "Minimize Task" per-category sections with chevron + live counts, persisted per-project via localStorage
  - UX: Polished "Marcus" aesthetic ‚Äî depth, micro-animations, focus rings, spacing, and typography
  - ACCESSIBILITY: Proper aria-expanded, aria-controls, and focus outlines on interactive elements
  - PERF: No backend changes required; progressive enhancement only

  v3.6.0
  - REFACTOR: Professional modal UX matching personal projects
  - Enhanced form styling with labels, focus states, animations
  - Modern glassmorphism effects and smooth transitions
  - Better accessibility and responsive design

  v3.5.1
  - Wire Task Category select to TASK_CATEGORIES (per-project constant, passed from route)
  - Render Task Priority filter pills from PRIORITY_LEVELS + JS filter handler update

  v3.5.0
  - Fix: Left/right column bottom alignment (grid stretch + task card fills row)
  - UX: "Add Task" opens full-screen modal form (no backend changes)
  - Docs: List view only (removed Grid toggle)
  - Order: Notes ‚Üí Documents ‚Üí Ideas ‚Üí Milestones
  - Removed footer/changelog
============================================================================= #}

{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}
{% block header %}{{ project.name }}{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MARCUS THEME POLISH ==================== */
  :root{
    --pd-bg:#090e17; --pd-panel:#0f1625; --pd-card:#0c1322; --pd-sub:#0b1120;
    --pd-line:#1b2740; --pd-text:#e8eef8; --pd-muted:#a2b6d4;
    --pd-primary:#79b0ff; --pd-primary-700:#4d86e9;
    --pd-success:#22c55e; --pd-warn:#f59e0b; --pd-danger:#ef4444;
    --pd-radius:16px; --pd-radius-sm:12px;
    --pd-shadow: 0 20px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.04) inset;
    --ring: 0 0 0 3px rgba(121,176,255,.2);
  }
  html { scroll-behavior:smooth; }
  .project-page{ padding:16px; }
  .project-wrap{ max-width:1420px; margin:0 auto; display:grid; gap:16px; padding-bottom:16px; }

  /* Sticky, glossy header */
  .project-header{
    position:sticky; top:12px; z-index:6;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); padding:14px; backdrop-filter:blur(6px);
  }
  .project-header__top{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin-bottom:8px; }
  .project-title{ margin:0; font-size:1.35rem; letter-spacing:.3px; }
  .header-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  .chip-row{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:var(--pd-sub); color:var(--pd-muted); border:1px solid var(--pd-line); white-space:nowrap; }
  .chip strong{ color:var(--pd-text); }
  .chip-status{ background:#0d1428; border-color:transparent; color:#0a0f1a; }
  .chip-status.status-active{ background:#3b82f6; }
  .chip-status.status-planning{ background:#64748b; }
  .chip-status.status-on_hold{ background:#f59e0b; }
  .chip-status.status-completed{ background:#22c55e; }
  .chip-priority.priority-low{ background:#4b5563; color:#0a0f1a; }
  .chip-priority.priority-medium{ background:#3b82f6; color:#0a0f1a; }
  .chip-priority.priority-high{ background:#f59e0b; color:#0a0f1a; }
  .chip-priority.priority-critical{ background:#ef4444; color:#0a0f1a; }

  .project-desc{ background:var(--pd-sub); border-left:3px solid var(--pd-primary); padding:10px 12px; border-radius:10px; margin-bottom:8px; color:var(--pd-muted); }
  .header-progress{ display:flex; align-items:center; gap:12px; }
  .progress-track{ flex:1; height:10px; border-radius:999px; overflow:hidden; background:var(--pd-sub); border:1px solid var(--pd-line); }
  .progress-fill{ height:100%; background:linear-gradient(90deg,var(--pd-primary),var(--pd-primary-700)); transition:width .35s; }
  .progress-label{ font-size:.85rem; color:var(--pd-muted); min-width:80px; text-align:right; }
  .anchor-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .anchor{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:var(--pd-sub); color:var(--pd-muted); border:1px solid var(--pd-line); text-decoration:none; transition:transform .12s ease; }
  .anchor:hover{ border-color:var(--pd-primary); color:var(--pd-text); transform:translateY(-1px); }

  /* Buttons */
  .btn{ 
    display:inline-flex; align-items:center; gap:8px; padding:10px 18px; 
    background:#0c1322; color:var(--pd-text); border:1.5px solid var(--pd-line); 
    border-radius:12px; cursor:pointer; text-decoration:none; 
    transition:all .18s ease; font-size:.95rem; font-weight:700;
    justify-content:center; letter-spacing:.2px;
  }
  .btn:hover{ border-color:var(--pd-primary); transform:translateY(-2px); box-shadow:0 4px 12px rgba(121,176,255,.25); }
  .btn:focus-visible{ outline:none; box-shadow: var(--ring); }
  .btn-primary{ background:linear-gradient(135deg, #79b0ff 0%, #5a8fdb 100%); border-color:transparent; color:#081020; }
  .btn-outline{ background:transparent; }
  .btn-sm{ padding:8px 14px; font-size:.88rem; border-radius:10px; }
  .btn-icon{ background:transparent; border:1px solid var(--pd-line); color:var(--pd-text); border-radius:10px; padding:6px 8px; font-size:.92rem; cursor:pointer; transition:all .18s ease; }
  .btn-icon:hover{ border-color:var(--pd-primary); transform:translateY(-1px); }
  .btn-icon.btn-delete:hover{ border-color:var(--pd-danger); color:var(--pd-danger); }
  .inline-actions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

  /* Grid layout */
  .layout{ display:grid; grid-template-columns:1.2fr .8fr; gap:16px; align-items:stretch; }

  /* Left: Tasks */
  .tasks-card{
    background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); display:flex; flex-direction:column; height:100%; min-height:520px;
  }
  .section-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px 10px; border-bottom:1px dashed var(--pd-line); flex-shrink:0; }
  .section-header h2{ margin:0; font-size:1.12rem; letter-spacing:.2px; }
  .split-actions{ position:relative; display:flex; gap:8px; }
  .add-btn{ border:none; cursor:pointer; padding:10px 14px; background:var(--pd-primary); color:#0a0f1a; border-radius:10px; font-size:.88rem; font-weight:800; }

  /* Task filters */
  .task-toolbar{ display:flex; gap:8px; align-items:center; padding:0 12px 10px; border-bottom:1px dashed var(--pd-line); flex-wrap:wrap; }
  .pill{ padding:7px 12px; border:1px solid var(--pd-line); border-radius:999px; font-size:.86rem; color:var(--pd-muted); background:var(--pd-sub); cursor:pointer; transition:all .12s ease; }
  .pill:hover{ border-color:var(--pd-primary); color:var(--pd-text); }
  .pill.is-active{ color:#0a0f1a; background:var(--pd-primary); border-color:transparent; }

  .tasks-scroll{ flex:1; min-height:0; overflow:auto; padding:12px; max-height:calc(100vh - 260px); }
  .tasks-scroll::-webkit-scrollbar{ width:8px; }
  .tasks-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.18); border-radius:4px; }

  /* ---- Collapsible task categories ---- */
  .task-category{ margin:12px 0; }
  .cat-header{
    width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; margin:0 0 8px 0; background:var(--pd-sub); border:1px solid var(--pd-line);
    border-radius:12px; color:var(--pd-text); cursor:pointer; font-weight:800; font-size:.94rem;
    transition:transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .cat-header:hover{ border-color:var(--pd-primary); transform:translateY(-1px); background:rgba(121,176,255,.06); }
  .cat-header:focus-visible{ outline:none; box-shadow: var(--ring); }
  .cat-left{ display:flex; align-items:center; gap:8px; }
  .chev{ display:inline-block; transition:transform .18s ease; font-size:.95rem; opacity:.9; }
  .cat-header[aria-expanded="true"] .chev{ transform:rotate(90deg); }
  .cat-title{ font-weight:900; letter-spacing:.2px; }
  .cat-count{ background:rgba(121,176,255,.18); border:1px solid rgba(121,176,255,.35); color:#b7d3ff; font-weight:900; border-radius:999px; padding:2px 10px; font-size:.78rem; }
  .task-list{ display:grid; gap:8px; }
  .task-list.collapsed{ display:none; }

  .task-item{ display:flex; gap:10px; align-items:flex-start; background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:12px; padding:10px; transition:background .12s ease, transform .12s ease; }
  .task-item:hover{ background:#0d172d; transform:translateY(-1px); }
  .task-item.completed{ opacity:.6; }
  .task-item.completed .task-title{ text-decoration:line-through; }
  .task-item[draggable="true"]{ cursor:grab; }
  .task-item.dragging{ opacity:.5; outline:1px dashed var(--pd-primary); }
  .task-checkbox{ flex-shrink:0; margin-top:2px; accent-color:var(--pd-primary); cursor:pointer; }
  .task-content{ flex:1; min-width:0; }
  .task-title{ font-weight:800; margin-bottom:2px; font-size:.96rem; }
  .task-description{ color:var(--pd-muted); font-size:.86rem; margin-bottom:4px; }
  .task-meta{ display:flex; gap:10px; color:var(--pd-muted); font-size:.78rem; }
  .task-actions{ display:flex; gap:6px; flex-shrink:0; }

  /* Right: stacked cards */
  .rhs{ display:grid; gap:16px; align-items:start; }
  .card{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); box-shadow:var(--pd-shadow); overflow:hidden; display:flex; flex-direction:column; height:280px; min-height:280px; }
  .card__head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px dashed var(--pd-line); flex-shrink:0; }
  .card__head h2{ margin:0; font-size:1.06rem; }
  .card__body{ padding:12px; overflow:auto; flex:1; min-height:0; }
  .card__body::-webkit-scrollbar{ width:8px; }
  .card__body::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:4px; }

  .empty-state{ text-align:center; padding:10px; color:var(--pd-muted); font-size:.9rem; }
  .idea-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-left:3px solid var(--pd-primary); border-radius:10px; padding:8px; margin-bottom:8px; }
  .idea-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .idea-footer select{ background:#0b1120; color:var(--pd-text); border:1px solid var(--pd-line); padding:4px 8px; border-radius:6px; font-size:.85rem; }
  .idea-date{ color:var(--pd-muted); font-size:.78rem; }
  .milestone-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:10px; padding:8px; margin-bottom:8px; }
  .milestone-item.completed{ opacity:.75; }
  .milestone-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .milestone-header h4{ margin:0; font-size:.95rem; color:var(--pd-text); }
  .milestone-item p{ margin:4px 0; color:var(--pd-muted); font-size:.85rem; }
  .milestone-date{ color:var(--pd-muted); font-size:.78rem; }
  .completed-badge{ background:var(--pd-success); color:#0a0f1a; padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:800; }
  .note-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:10px; padding:8px; margin-bottom:8px; }
  .note-header{ display:flex; justify-content:space-between; margin-bottom:4px; font-size:.78rem; color:var(--pd-muted); }
  .note-category{ background:var(--pd-primary); color:#0a0f1a; padding:2px 6px; border-radius:6px; font-weight:800; font-size:.72rem; }
  .doc-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .vault-docs-list{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  .vault-docs-list tr{ background:var(--pd-sub); }
  .vault-docs-list td{ padding:10px; border-top:1px solid var(--pd-line); border-bottom:1px solid var(--pd-line); vertical-align:middle; }
  .vault-docs-list tr td:first-child{ border-left:1px solid var(--pd-line); border-radius:10px 0 0 10px; }
  .vault-docs-list tr td:last-child{ border-right:1px solid var(--pd-line); border-radius:0 10px 10px 0; }
  .doc-name-cell{ font-weight:800; color:var(--pd-text); }
  .doc-type{ color:var(--pd-muted); font-size:.85rem; }

  /* ==================== MODAL SYSTEM - PROFESSIONAL UX ==================== */
  .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); backdrop-filter:blur(8px); z-index:9999; justify-content:center; align-items:center; animation:fadeIn .2s ease-out; }
  .modal-overlay.show{ display:flex; }
  .modal-content{ background:linear-gradient(145deg,#0f1625 0%,#121a2a 100%); border:1px solid rgba(110,168,255,.2); border-radius:20px; padding:0; max-width:620px; width:92%; max-height:88vh; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.05) inset, 0 4px 20px rgba(110,168,255,.15); animation:slideUp .3s cubic-bezier(.16,1,.3,1); transform-origin:center; }
  @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
  @keyframes slideUp{ from{opacity:0; transform:translateY(30px) scale(.95)} to{opacity:1; transform:translateY(0) scale(1)} }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:24px 28px; border-bottom:1px solid rgba(31,42,61,.8); background:linear-gradient(180deg, rgba(255,255,255,.03) 0%, transparent 100%); }
  .modal-header h3{ margin:0; font-size:1.35rem; font-weight:800; color:#e6eaf2; display:flex; align-items:center; gap:10px; }
  .close-btn{ background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); color:#e6eaf2; width:36px; height:36px; border-radius:10px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:all .2s ease; }
  .close-btn:hover{ background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.4); color:#ef4444; transform:rotate(90deg); }
  .modal-body{ padding:28px; overflow-y:auto; max-height:calc(88vh - 140px); }
  .modal-body::-webkit-scrollbar{ width:8px; }
  .modal-body::-webkit-scrollbar-track{ background:rgba(255,255,255,.02); border-radius:4px; }
  .modal-body::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.1); border-radius:4px; }
  .modal-body::-webkit-scrollbar-thumb:hover{ background:rgba(255,255,255,.15); }
  .modal-content form{ display:flex; flex-direction:column; gap:20px; }
  .form-group{ display:flex; flex-direction:column; gap:8px; }
  .form-label{ color:#9fb0c8; font-size:.88rem; font-weight:800; text-transform:uppercase; letter-spacing:.5px; display:flex; align-items:center; gap:6px; }
  .form-label .required{ color:#ef4444; font-size:1.1rem; }
  .modal-content input[type="text"],
  .modal-content input[type="date"],
  .modal-content input[type="file"],
  .modal-content select,
  .modal-content textarea{ width:100%; padding:14px 16px; background:rgba(12,19,34,.6); border:1.5px solid rgba(31,42,61,.8); border-radius:12px; color:#e6eaf2; font-size:.98rem; font-family:inherit; transition:all .2s ease; outline:none; }
  .modal-content input[type="text"]::placeholder, .modal-content textarea::placeholder{ color:rgba(159,176,200,.4); }
  .modal-content input[type="text"]:focus,
  .modal-content input[type="date"]:focus,
  .modal-content select:focus,
  .modal-content textarea:focus{ border-color:var(--pd-primary); background:rgba(12,19,34,.8); box-shadow: var(--ring), 0 4px 12px rgba(110,168,255,.15); }
  .modal-content select{ cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239fb0c8' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:40px; }
  .modal-content textarea{ resize:vertical; min-height:120px; line-height:1.6; }
  .modal-content input[type="file"]{ padding:12px; cursor:pointer; font-size:.92rem; }
  .modal-content input[type="file"]::file-selector-button{ padding:8px 16px; background:rgba(110,168,255,.12); border:1px solid rgba(110,168,255,.3); border-radius:8px; color:#6ea8ff; font-weight:800; cursor:pointer; margin-right:12px; transition:all .2s ease; }
  .modal-content input[type="file"]::file-selector-button:hover{ background:rgba(110,168,255,.2); border-color:#6ea8ff; }
  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; padding-top:8px; }

  @media (max-width:980px){
    .layout{ grid-template-columns:1fr; }
    .tasks-card{ min-height:460px; }
    .card{ height:auto; min-height:280px; }
    .modal-content{ width:96%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-page">
  <div class="project-wrap">

    <!-- Sticky Header -->
    <div class="project-header">
      <div class="project-header__top">
        <h1 class="project-title">{{ project.name }}</h1>
        <div class="header-actions">
          <a href="{{ url_for('projects.edit_tch', id=project.id) }}" class="btn">‚úèÔ∏è Edit</a>
          <a href="{{ url_for('projects.tch_index') }}" class="btn btn-outline">‚Üê Back</a>
        </div>
      </div>

      <div class="chip-row">
        <span class="chip"><strong>Category:</strong> {{ project.category }}</span>
        <span class="chip chip-status status-{{ project.status }}">{{ project.status|replace('_',' ')|title }}</span>
        <span class="chip chip-priority priority-{{ project.priority }}">{{ project.priority|title }} Priority</span>
      </div>

      {% if project.description %}
        <div class="project-desc">{{ project.description }}</div>
      {% endif %}

      <div class="header-progress" id="progress">
        <div class="progress-track"><div class="progress-fill" style="width: {{ project.progress }}%"></div></div>
        <div class="progress-label">{{ project.progress }}% complete</div>
      </div>

      <div class="anchor-row" aria-label="Jump to section">
        <a class="anchor" href="#tasks">‚úÖ Tasks</a>
        <a class="anchor" href="#notes">üìù Notes</a>
        <a class="anchor" href="#documents">üìÅ Documents</a>
        <a class="anchor" href="#ideas">üí° Ideas</a>
        <a class="anchor" href="#milestones">üèÅ Milestones</a>
      </div>
    </div>

    <!-- Main layout -->
    <div class="layout">

      <!-- LEFT: TASKS -->
      <section class="tasks-card" id="tasks" aria-labelledby="tasks-title">
        <div class="section-header">
          <h2 id="tasks-title">‚úÖ Tasks</h2>
          <div class="split-actions" data-section="tasks">
            <button type="button" class="add-btn" onclick="openModal('task-modal')">‚ûï Add Task</button>
          </div>
        </div>

        <!-- Filters (priority pills from PRIORITY_LEVELS) -->
        <div class="task-toolbar" role="toolbar" aria-label="Task filters">
          <button class="pill is-active" data-filter="all" type="button">All</button>
          <button class="pill" data-filter="due" type="button">Due</button>
          {% for p in priority_levels %}
            <button class="pill" data-filter="priority-{{ p }}" type="button">{{ p|title }} Priority</button>
          {% endfor %}
          <button class="pill" data-filter="completed" type="button">Completed</button>
        </div>

        <!-- Scrollable tasks -->
        <div class="tasks-scroll" id="taskList" aria-live="polite">
          {% for category, tasks in tasks_by_category.items() %}
          <div class="task-category" data-category="{{ category }}">
            <button 
              class="cat-header" 
              type="button"
              aria-expanded="false"
              aria-controls="cat-{{ loop.index }}-list"
              data-cat="{{ category }}"
            >
              <span class="cat-left">
                <span class="chev" aria-hidden="true">‚ñ∏</span>
                <span class="cat-title">{% if category != 'Uncategorized' %}{{ category }}{% else %}Uncategorized{% endif %}</span>
              </span>
              <span class="cat-count" data-count>{{ tasks|length }}</span>
            </button>

            <div class="task-list collapsed" id="cat-{{ loop.index }}-list" data-category="{{ category }}">
              {% for task in tasks %}
              <div class="task-item {% if task.completed %}completed{% endif %}"
                   draggable="true"
                   data-task-id="{{ task.id }}"
                   data-priority="{{ task.priority or 'medium' }}"
                   data-completed="{{ '1' if task.completed else '0' }}"
                   data-due="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
                <input type="checkbox" class="task-checkbox"
                       data-endpoint="{{ url_for('projects.toggle_task', task_id=task.id) }}"
                       {% if task.completed %}checked{% endif %}>
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  {% if task.description %}<div class="task-description">{{ task.description }}</div>{% endif %}
                  <div class="task-meta">
                    {% if task.due_date %}<span>üìÖ {{ task.due_date.strftime('%b %d') }}</span>{% endif %}
                    {% if task.priority %}<span class="priority-{{ task.priority }}">{{ task.priority|title }}</span>{% endif %}
                  </div>
                </div>
                <div class="task-actions">
                  <a href="{{ url_for('projects.edit_tch_task', task_id=task.id) }}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_task', task_id=task.id) }}" style="display:inline;">
                    <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this task?')">üóëÔ∏è</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <p class="empty-state">No tasks yet. Click "Add Task".</p>
          {% endfor %}
        </div>
      </section>

      <!-- RIGHT: NOTES ‚Üí DOCUMENTS ‚Üí IDEAS ‚Üí MILESTONES -->
      <aside class="rhs">

        <!-- NOTES -->
        <div class="card" id="notes" aria-labelledby="notes-title">
          <div class="card__head">
            <h2 id="notes-title">üìù Notes</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('note-modal')">‚ûï Add</button>
          </div>
          <div class="card__body">
            {% for note in project.notes %}
            <div class="note-item">
              <div class="note-header">
                <span class="note-category">{{ note.category|title }}</span>
                <span class="note-date">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
              </div>
              <div class="note-content">{{ note.content }}</div>
              <div class="inline-actions" style="margin-top:6px;">
                <a href="{{ url_for('projects.edit_tch_note', note_id=note.id) }}" class="btn-icon" title="Edit Note">‚úèÔ∏è</a>
                <form method="POST" action="{{ url_for('projects.delete_tch_note', note_id=note.id) }}">
                  <button type="submit" class="btn-icon btn-delete" title="Delete Note" onclick="return confirm('Delete this note?')">üóëÔ∏è</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No notes yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- DOCUMENTS (List-only) -->
        <div class="card" id="documents" aria-labelledby="documents-title">
          <div class="card__head">
            <h2 id="documents-title">üìÅ Project Documents</h2>
            <div class="doc-toolbar">
              <span style="opacity:.65; font-size:.9rem;">List view</span>
              <button class="btn btn-primary btn-sm" onclick="openModal('doc-modal')">‚ûï Add</button>
            </div>
          </div>
          <div class="card__body">
            {% if vault_documents %}
              <table class="vault-docs-list" id="docsList">
                <tbody>
                {% for doc in vault_documents %}
                  <tr>
                    <td class="doc-name-cell">
                      {% if doc.doc_type == 'image' %}üñºÔ∏è{% elif doc.doc_type == 'contract' %}üìú{% elif doc.doc_type in ['invoice','receipt'] %}üßæ{% elif doc.doc_type == 'spreadsheet' %}üìä{% elif doc.doc_type == 'note' %}üìù{% elif 'pdf' in (doc.mime_type or '') %}üìï{% else %}üìÑ{% endif %}
                      {{ doc.title }}
                      <div class="doc-type">{{ doc.doc_type|title }} ‚Ä¢ {{ doc.created_at.strftime('%b %d, %Y') }}</div>
                    </td>
                    <td class="doc-actions">
                      <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="btn-icon" title="View">üëÅÔ∏è</a>
                      {% if doc.file_path %}
                      <a href="{{ url_for('vault.download_file', id=doc.id) }}" class="btn-icon" title="Download">‚¨á</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="empty-state">No documents yet. Click Add.</p>
            {% endif %}
          </div>
        </div>

        <!-- IDEAS -->
        <div class="card" id="ideas" aria-labelledby="ideas-title">
          <div class="card__head">
            <h2 id="ideas-title">üí° Ideas</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('idea-modal')">‚ûï Add</button>
          </div>
          <div class="card__body">
            {% for idea in project.ideas %}
            <div class="idea-item status-{{ idea.status }}">
              <div class="idea-content">{{ idea.content }}</div>
              <div class="idea-footer">
                <form method="POST" action="{{ url_for('projects.update_idea_status', idea_id=idea.id) }}">
                  <select name="status" onchange="this.form.submit()">
                    <option value="new" {% if idea.status == 'new' %}selected{% endif %}>New</option>
                    <option value="considering" {% if idea.status == 'considering' %}selected{% endif %}>Considering</option>
                    <option value="implemented" {% if idea.status == 'implemented' %}selected{% endif %}>Implemented</option>
                    <option value="rejected" {% if idea.status == 'rejected' %}selected{% endif %}>Rejected</option>
                  </select>
                </form>
                <div class="inline-actions">
                  <a href="{{ url_for('projects.edit_tch_idea', idea_id=idea.id) }}" class="btn-icon" title="Edit Idea">‚úèÔ∏è</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_idea', idea_id=idea.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete Idea" onclick="return confirm('Delete this idea?')">üóëÔ∏è</button>
                  </form>
                  <span class="idea-date">{{ idea.created_at.strftime('%b %d') }}</span>
                </div>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No ideas yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- MILESTONES -->
        <div class="card" id="milestones" aria-labelledby="milestones-title">
          <div class="card__head">
            <h2 id="milestones-title">üèÅ Milestones</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('milestone-modal')">‚ûï Add</button>
          </div>
          <div class="card__body">
            {% for milestone in project.milestones %}
            <div class="milestone-item {% if milestone.completed %}completed{% endif %}">
              <div class="milestone-header">
                <h4>{{ milestone.title }}</h4>
                <div class="inline-actions">
                  {% if not milestone.completed %}
                  <form method="POST" action="{{ url_for('projects.complete_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon" title="Mark Complete">‚úÖ</button>
                  </form>
                  {% else %}
                  <span class="completed-badge">Completed</span>
                  {% endif %}
                  <a href="{{ url_for('projects.edit_tch_milestone', milestone_id=milestone.id) }}" class="btn-icon" title="Edit Milestone">‚úèÔ∏è</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete Milestone" onclick="return confirm('Delete this milestone?')">üóëÔ∏è</button>
                  </form>
                </div>
              </div>
              {% if milestone.description %}<p>{{ milestone.description }}</p>{% endif %}
              {% if milestone.target_date %}
              <div class="milestone-date">üìÖ Target: {{ milestone.target_date.strftime('%b %d, %Y') }}</div>
              {% endif %}
            </div>
            {% else %}
            <p class="empty-state">No milestones yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

      </aside>
    </div>

  </div>
</div>

<!-- ================= MODALS ================= -->

<!-- TASK: Add -->
<div id="task-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="task-modal-title">‚úÖ Add Task</h3>
      <button class="close-btn" onclick="closeModal('task-modal')" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('projects.add_tch_task', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Task Title <span class="required">*</span></label>
          <input type="text" name="title" placeholder="What needs to be done?" required>
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description" rows="6" placeholder="Provide additional details..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Category <span class="required">*</span></label>
          <select name="category" required>
            <option value="" disabled selected>Select category‚Ä¶</option>
            {% for c in task_categories %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Priority <span class="required">*</span></label>
          <select name="priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" name="due_date">
          <div class="form-helper">üìÖ Optional: Set a deadline for this task</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('task-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- NOTES: Add -->
<div id="note-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="note-modal-title">üìù Add Note</h3>
      <button class="close-btn" onclick="closeModal('note-modal')" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('projects.add_tch_note', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Category <span class="required">*</span></label>
          <select name="category" required>
            <option value="general">General</option>
            <option value="meeting">Meeting</option>
            <option value="technical">Technical</option>
            <option value="idea">Idea</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Note Content <span class="required">*</span></label>
          <textarea name="content" rows="8" placeholder="Write your note here..." required></textarea>
          <div class="form-helper">üí° Capture important information and insights</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('note-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Note</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- DOCUMENTS: Add (Vault) -->
<div id="doc-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="doc-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="doc-modal-title">üìÅ Add Document</h3>
      <button class="close-btn" onclick="closeModal('doc-modal')" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('projects.upload_tch_vault_document', id=project.id) }}" enctype="multipart/form-data">
        <div class="form-group">
          <label class="form-label">Choose File <span class="required">*</span></label>
          <input type="file" name="file" required accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif">
          <div class="form-helper">üìé Supported: PDF, Word, Excel, Images, Text</div>
        </div>

        <div class="form-group">
          <label class="form-label">Document Title</label>
          <input type="text" name="title" placeholder="Leave blank to use filename">
        </div>

        <div class="form-group">
          <label class="form-label">Document Type <span class="required">*</span></label>
          <select name="doc_type">
            <option value="document">üìÑ Document</option>
            <option value="contract">üìú Contract</option>
            <option value="invoice">üßæ Invoice</option>
            <option value="receipt">üßæ Receipt</option>
            <option value="image">üñºÔ∏è Image</option>
            <option value="spreadsheet">üìä Spreadsheet</option>
            <option value="note">üìù Note</option>
            <option value="other">üìé Other</option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('doc-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload Document</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- IDEAS: Add -->
<div id="idea-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="idea-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="idea-modal-title">üí° Add Idea</h3>
      <button class="close-btn" onclick="closeModal('idea-modal')" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('projects.add_tch_idea', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Idea Description <span class="required">*</span></label>
          <textarea name="content" rows="8" placeholder="Describe your idea in detail..." required></textarea>
          <div class="form-helper">üí≠ No idea is too big or too small!</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('idea-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Idea</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MILESTONES: Add -->
<div id="milestone-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="milestone-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="milestone-modal-title">üèÅ Add Milestone</h3>
      <button class="close-btn" onclick="closeModal('milestone-modal')" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('projects.add_tch_milestone', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Milestone Title <span class="required">*</span></label>
          <input type="text" name="title" placeholder="e.g., Launch Beta Version" required>
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description" rows="6" placeholder="What needs to be accomplished?"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Target Date</label>
          <input type="date" name="target_date">
          <div class="form-helper">üìÖ Optional: Set a target completion date</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('milestone-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Milestone</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Helpers */
function qsa(root, sel){ return Array.from((root || document).querySelectorAll(sel)); }

/* Modal System with Animations */
function openModal(id){ 
  const m=document.getElementById(id); 
  if(!m) return; 
  m.classList.add('show');
  m.style.display='flex'; 
  document.body.style.overflow='hidden'; 
  // Focus first input
  setTimeout(() => {
    const firstInput = m.querySelector('input:not([type="hidden"]), textarea, select');
    if(firstInput) firstInput.focus();
  }, 100);
}

function closeModal(id){ 
  const m=document.getElementById(id); 
  if(!m) return; 
  m.classList.remove('show');
  setTimeout(() => { m.style.display='none'; }, 200);
  document.body.style.overflow=''; 
}

document.addEventListener('click', e => { 
  const ov=e.target.closest('.modal-overlay'); 
  if(ov && e.target===ov){ closeModal(ov.getAttribute('id')); }
});

document.addEventListener('keydown', e => { 
  if(e.key==='Escape'){ qsa(document,'.modal-overlay.show').forEach(m => closeModal(m.getAttribute('id'))); }
});

/* Task checkbox -> POST toggle */
(function(){
  const boxes=document.querySelectorAll('.task-checkbox'); if(!boxes.length) return;
  boxes.forEach(cb=>{
    cb.addEventListener('change', async function(){
      const endpoint=this.getAttribute('data-endpoint'); if(!endpoint) return;
      try{
        const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'}});
        const data=await res.json();
        if(data && typeof data.completed!== 'undefined'){
          this.checked=!!data.completed;
          const item=this.closest('.task-item');
          item?.classList.toggle('completed', !!data.completed);
        }else{ this.checked=!this.checked; }
      }catch(err){ this.checked=!this.checked; }
    });
  });
})();

/* Task filters (driven by PRIORITY_LEVELS) */
(function(){
  const toolbar=document.querySelector('.task-toolbar'); if(!toolbar) return;
  function setActive(btn){ qsa(toolbar,'.pill').forEach(p=>p.classList.remove('is-active')); btn.classList.add('is-active'); }
  function isDue(iso){ if(!iso) return false; const t=new Date(); t.setHours(0,0,0,0); const d=new Date(iso+'T00:00:00'); return d<=t; }

  toolbar.addEventListener('click',e=>{
    const btn=e.target.closest('.pill'); if(!btn) return;
    setActive(btn); const f=btn.dataset.filter;

    qsa(document,'.task-item').forEach(el=>{
      const done = el.dataset.completed==='1';
      const pri  = (el.dataset.priority||'medium').toLowerCase();
      const due  = el.dataset.due||'';
      let show   = true;

      if (f==='all')            show = true;
      else if (f==='due')       show = isDue(due) && !done;
      else if (f==='completed') show = done;
      else if (f && f.startsWith('priority-')) {
        const want = f.slice('priority-'.length);
        show = pri===want && !done;
      }

      el.style.display = show ? '' : 'none';
    });
  });
})();

/* Drag & Drop (client-side only) */
(function(){
  const lists=qsa(document,'.task-list'); if(!lists.length) return;
  let dragging=null;
  lists.forEach(list=>{
    list.addEventListener('dragstart',e=>{ const item=e.target.closest('.task-item'); if(!item) return; dragging=item; item.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    list.addEventListener('dragover',e=>{ e.preventDefault(); const after=getAfter(list,e.clientY); if(!dragging) return; if(after==null) list.appendChild(dragging); else list.insertBefore(dragging,after); });
    list.addEventListener('drop',()=>{ if(!dragging) return; dragging.classList.remove('dragging'); dragging=null; refreshCounts(); });
    list.addEventListener('dragend',()=>{ if(dragging) dragging.classList.remove('dragging'); dragging=null; });
  });
  function getAfter(container,y){
    const els=qsa(container,'.task-item:not(.dragging)'); let closest={offset:Number.NEGATIVE_INFINITY,el:null};
    els.forEach(el=>{ const r=el.getBoundingClientRect(); const off=y-(r.top+r.height/2); if(off<0 && off>closest.offset) closest={offset:off,el}; });
    return closest.el;
  }
})();

/* ---- Collapsible Categories with Persistence ---- */
(function() {
  const projectId = "{{ project.id }}";
  const KEY = `tch:taskCats:v1:proj:${projectId}`;

  function loadState(){ try{ return JSON.parse(localStorage.getItem(KEY) || "{}"); }catch(_){ return {}; } }
  function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function applyState(){
    const state = loadState();
    document.querySelectorAll('.task-category').forEach(cat => {
      const name = cat.dataset.category || '';
      const header = cat.querySelector('.cat-header');
      const list = cat.querySelector('.task-list');
      const expanded = state[name] === true; // default collapsed
      header?.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      list?.classList.toggle('collapsed', !expanded);
    });
  }

  function wireToggles(){
    const state = loadState();
    document.querySelectorAll('.cat-header').forEach(btn => {
      btn.addEventListener('click', () => {
        const cat = btn.dataset.cat || '';
        const list = document.getElementById(btn.getAttribute('aria-controls'));
        const nowExpanded = btn.getAttribute('aria-expanded') !== 'true';
        btn.setAttribute('aria-expanded', nowExpanded ? 'true' : 'false');
        list?.classList.toggle('collapsed', !nowExpanded);
        state[cat] = nowExpanded; saveState(state);
      });
    });
  }

  window.refreshCounts = function refreshCounts(){
    document.querySelectorAll('.task-category').forEach(cat => {
      const countEl = cat.querySelector('[data-count]');
      const list = cat.querySelector('.task-list');
      if(countEl && list){
        const items = list.querySelectorAll('.task-item');
        countEl.textContent = items.length;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    applyState();
    wireToggles();
    refreshCounts();
  });
})();
</script>
{% endblock %}
