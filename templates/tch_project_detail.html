{# =============================================================================
  FILE: templates/tch_project_detail.html
  PURPOSE: TCH Project — Detail (Tasks left; RHS stacked cards with full-screen modals)
  TEMPLATE VERSION: v3.5.1
  LAST UPDATED: 2025-09-27

  v3.5.1
  - Wire Task Category select to TASK_CATEGORIES (per-project constant, passed from route)
  - Render Task Priority filter pills from PRIORITY_LEVELS + JS filter handler update

  v3.5.0
  - Fix: Left/right column bottom alignment (grid stretch + task card fills row)
  - UX: "Add Task" opens full-screen modal form (no backend changes)
  - Docs: List view only (removed Grid toggle)
  - Order: Notes → Documents → Ideas → Milestones
  - Removed footer/changelog
============================================================================= #}

{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}
{% block header %}{{ project.name }}{% endblock %}

{% block extra_css %}
<style>
  :root{
    --pd-bg:#0b0f1a; --pd-panel:#121a2a; --pd-card:#0f1625; --pd-sub:#0c1322;
    --pd-line:#1f2a3d; --pd-text:#e6eaf2; --pd-muted:#9fb0c8;
    --pd-primary:#6ea8ff; --pd-primary-700:#3f7fe6;
    --pd-success:#22c55e; --pd-warn:#f59e0b; --pd-danger:#ef4444;
    --pd-radius:16px; --pd-radius-sm:12px;
    --pd-shadow:0 10px 24px rgba(0,0,0,.35);
  }

  .project-page{ padding:16px; }
  .project-wrap{ max-width:1400px; margin:0 auto; display:grid; gap:16px; padding-bottom:16px; }

  /* Sticky header */
  .project-header{
    position:sticky; top:12px; z-index:6;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); padding:12px; backdrop-filter:blur(6px);
  }
  .project-header__top{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin-bottom:8px; }
  .project-title{ margin:0; font-size:1.3rem; }
  .header-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  .chip-row{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:var(--pd-sub); color:var(--pd-muted); border:1px solid var(--pd-line); white-space:nowrap; }
  .chip strong{ color:var(--pd-text); }
  .chip-status{ background:#0c1529; border-color:transparent; color:#0a0f1a; }
  .chip-status.status-active{ background:#3b82f6; }
  .chip-status.status-planning{ background:#64748b; }
  .chip-status.status-on_hold{ background:#f59e0b; }
  .chip-status.status-completed{ background:#22c55e; }
  .chip-priority.priority-low{ background:#4b5563; color:#0a0f1a; }
  .chip-priority.priority-medium{ background:#3b82f6; color:#0a0f1a; }
  .chip-priority.priority-high{ background:#f59e0b; color:#0a0f1a; }
  .chip-priority.priority-critical{ background:#ef4444; color:#0a0f1a; }

  .project-desc{ background:var(--pd-sub); border-left:3px solid var(--pd-primary); padding:8px 10px; border-radius:10px; margin-bottom:8px; color:var(--pd-muted); }
  .header-progress{ display:flex; align-items:center; gap:12px; }
  .progress-track{ flex:1; height:10px; border-radius:999px; overflow:hidden; background:var(--pd-sub); border:1px solid var(--pd-line); }
  .progress-fill{ height:100%; background:linear-gradient(90deg,var(--pd-primary),var(--pd-primary-700)); transition:width .3s; }
  .progress-label{ font-size:.85rem; color:var(--pd-muted); min-width:80px; text-align:right; }

  .anchor-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .anchor{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:var(--pd-sub); color:var(--pd-muted); border:1px solid var(--pd-line); text-decoration:none; }
  .anchor:hover{ border-color:var(--pd-primary); color:var(--pd-text); }

  /* Buttons */
  .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#0c1322; color:var(--pd-text); border:1px solid var(--pd-line); border-radius:var(--pd-radius-sm); cursor:pointer; text-decoration:none; transition:.2s; font-size:.95rem; }
  .btn:hover{ border-color:var(--pd-primary); transform:translateY(-1px); }
  .btn-primary{ background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.45); }
  .btn-outline{ background:transparent; }
  .btn-success{ background:#16351f; border-color:#1f6f3a; }
  .btn-sm{ padding:6px 10px; font-size:.85rem; border-radius:10px; }
  .btn-icon{ background:transparent; border:1px solid var(--pd-line); color:var(--pd-text); border-radius:10px; padding:6px 8px; font-size:.9rem; cursor:pointer; }
  .btn-icon:hover{ border-color:var(--pd-primary); }
  .btn-icon.btn-delete:hover{ border-color:var(--pd-danger); color:var(--pd-danger); }
  .inline-actions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .inline-actions form{ display:inline; }

  /* Grid layout (alignment fix: stretch both columns) */
  .layout{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
    align-items:stretch;  /* <— stretch items to the tallest column */
  }

  /* Left: Tasks card stretches full column height; internal area scrolls */
  .tasks-card{
    background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); display:flex; flex-direction:column;
    height:100%;               /* <— fill grid row height */
    min-height:480px;
  }
  .section-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 12px 8px; border-bottom:1px dashed var(--pd-line); flex-shrink:0; }
  .section-header h2{ margin:0; font-size:1.1rem; }

  .split-actions{ position:relative; display:flex; gap:2px; }
  .add-btn, .caret-btn{ border:none; cursor:pointer; }
  .add-btn{ padding:6px 10px; background:var(--pd-primary); color:#0a0f1a; border-radius:8px; font-size:.85rem; font-weight:700; }
  .caret-btn{ display:none; } /* no inline dropdown for tasks; we use full-screen modal instead */
  .menu{ display:none; }

  .add-panel{ display:none; } /* hide inline add panels for tasks */

  /* Task filters */
  .task-toolbar{ display:flex; gap:8px; align-items:center; padding:0 12px 8px; border-bottom:1px dashed var(--pd-line); }
  .pill{ padding:6px 10px; border:1px solid var(--pd-line); border-radius:999px; font-size:.85rem; color:var(--pd-muted); background:var(--pd-sub); cursor:pointer; }
  .pill.is-active{ color:#0a0f1a; background:var(--pd-primary); border-color:transparent; }

  /* Make task list scroll independently; max-height keeps it usable on tall RHS */
  .tasks-scroll{
    flex:1; min-height:0; overflow:auto; padding:12px;
    /* reasonable max-height so it’s always scrolly even if the RHS column grows */
    max-height:calc(100vh - 260px);
  }
  .tasks-scroll::-webkit-scrollbar{ width:8px; }
  .tasks-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:4px; }

  .task-category{ margin:10px 0; }
  .task-category h3{ margin:4px 0 8px; font-size:.95rem; color:var(--pd-text); }
  .task-list{ display:grid; gap:8px; }
  .task-item{ display:flex; gap:10px; align-items:flex-start; background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:12px; padding:10px; }
  .task-item.completed{ opacity:.6; }
  .task-item.completed .task-title{ text-decoration:line-through; }
  .task-item[draggable="true"]{ cursor:grab; }
  .task-item.dragging{ opacity:.5; outline:1px dashed var(--pd-primary); }
  .task-checkbox{ flex-shrink:0; margin-top:2px; accent-color:var(--pd-primary); cursor:pointer; }
  .task-content{ flex:1; min-width:0; }
  .task-title{ font-weight:700; margin-bottom:2px; font-size:.95rem; }
  .task-description{ color:var(--pd-muted); font-size:.85rem; margin-bottom:4px; }
  .task-meta{ display:flex; gap:10px; color:var(--pd-muted); font-size:.78rem; }
  .task-actions{ display:flex; gap:6px; flex-shrink:0; }

  /* Right: stacked cards — fixed height + own scroll; same width as left */
  .rhs{ display:grid; gap:16px; align-items:start; }
  .card{
    background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); overflow:hidden; display:flex; flex-direction:column;
    height:280px; min-height:280px;
  }
  .card__head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px dashed var(--pd-line); flex-shrink:0; }
  .card__body{ padding:12px; overflow:auto; flex:1; min-height:0; }
  .card__body::-webkit-scrollbar{ width:8px; }
  .card__body::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:4px; }

  .empty-state{ text-align:center; padding:10px; color:var(--pd-muted); font-size:.9rem; }

  .idea-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-left:3px solid var(--pd-primary); border-radius:10px; padding:8px; margin-bottom:8px; }
  .idea-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .idea-footer select{ background:#0b1120; color:var(--pd-text); border:1px solid var(--pd-line); padding:4px 8px; border-radius:6px; font-size:.85rem; }
  .idea-date{ color:var(--pd-muted); font-size:.78rem; }

  .milestone-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:10px; padding:8px; margin-bottom:8px; }
  .milestone-item.completed{ opacity:.75; }
  .milestone-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .milestone-header h4{ margin:0; font-size:.95rem; color:var(--pd-text); }
  .milestone-item p{ margin:4px 0; color:var(--pd-muted); font-size:.85rem; }
  .milestone-date{ color:var(--pd-muted); font-size:.78rem; }
  .completed-badge{ background:var(--pd-success); color:#0a0f1a; padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:800; }

  .note-item{ background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:10px; padding:8px; margin-bottom:8px; }
  .note-header{ display:flex; justify-content:space-between; margin-bottom:4px; font-size:.78rem; color:var(--pd-muted); }
  .note-category{ background:var(--pd-primary); color:#0a0f1a; padding:2px 6px; border-radius:6px; font-weight:700; font-size:.72rem; }

  /* Docs list-only */
  .doc-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .vault-docs-list{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  .vault-docs-list tr{ background:var(--pd-sub); }
  .vault-docs-list td{ padding:10px; border-top:1px solid var(--pd-line); border-bottom:1px solid var(--pd-line); vertical-align:middle; }
  .vault-docs-list tr td:first-child{ border-left:1px solid var(--pd-line); border-radius:10px 0 0 10px; }
  .vault-docs-list tr td:last-child{ border-right:1px solid var(--pd-line); border-radius:0 10px 10px 0; }
  .doc-name-cell{ font-weight:700; color:var(--pd-text); }
  .doc-type{ color:var(--pd-muted); font-size:.85rem; }

  /* Full-screen (centered) modal */
  .modal-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.65);
    display:none; z-index:100; align-items:center; justify-content:center;
  }
  .modal-content{
    width:min(980px,92vw); max-height:92vh; overflow:auto;
    background:var(--pd-card); border:1px solid var(--pd-line);
    border-radius:16px; box-shadow:var(--pd-shadow); padding:16px;
  }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .modal-header h3{ margin:0; }
  .close-btn{ border:none; background:transparent; color:var(--pd-text); font-size:1.3rem; cursor:pointer; }
  .modal-content form input, .modal-content form textarea, .modal-content form select{
    width:100%; background:#0b1120; color:var(--pd-text);
    border:1px solid var(--pd-line); border-radius:10px; padding:10px; margin-bottom:10px; font-size:.95rem;
  }

  @media (max-width:980px){
    .layout{ grid-template-columns:1fr; }
    .tasks-card{ min-height:420px; }
    .card{ height:auto; min-height:280px; }
    .modal-content{ width:92vw; }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-page">
  <div class="project-wrap">

    <!-- Sticky Header -->
    <div class="project-header">
      <div class="project-header__top">
        <h1 class="project-title">{{ project.name }}</h1>
        <div class="header-actions">
          <a href="{{ url_for('projects.edit_tch', id=project.id) }}" class="btn">✏️ Edit</a>
          <a href="{{ url_for('projects.tch_index') }}" class="btn btn-outline">← Back</a>
        </div>
      </div>

      <div class="chip-row">
        <span class="chip"><strong>Category:</strong> {{ project.category }}</span>
        <span class="chip chip-status status-{{ project.status }}">{{ project.status|replace('_',' ')|title }}</span>
        <span class="chip chip-priority priority-{{ project.priority }}">{{ project.priority|title }} Priority</span>
      </div>

      {% if project.description %}
        <div class="project-desc">{{ project.description }}</div>
      {% endif %}

      <div class="header-progress" id="progress">
        <div class="progress-track"><div class="progress-fill" style="width: {{ project.progress }}%"></div></div>
        <div class="progress-label">{{ project.progress }}% complete</div>
      </div>

      <div class="anchor-row" aria-label="Jump to section">
        <a class="anchor" href="#tasks">✅ Tasks</a>
        <a class="anchor" href="#notes">📝 Notes</a>
        <a class="anchor" href="#documents">📁 Documents</a>
        <a class="anchor" href="#ideas">💡 Ideas</a>
        <a class="anchor" href="#milestones">🏁 Milestones</a>
      </div>
    </div>

    <!-- Main layout -->
    <div class="layout">

      <!-- LEFT: TASKS -->
      <section class="tasks-card" id="tasks" aria-labelledby="tasks-title">
        <div class="section-header">
          <h2 id="tasks-title">✅ Tasks</h2>
          <div class="split-actions" data-section="tasks">
            <button type="button" class="add-btn" onclick="openModal('task-modal')">➕ Add Task</button>
          </div>
        </div>

        <!-- Filters (priority pills from PRIORITY_LEVELS) -->
        <div class="task-toolbar" role="toolbar" aria-label="Task filters">
          <button class="pill is-active" data-filter="all" type="button">All</button>
          <button class="pill" data-filter="due" type="button">Due</button>
          {% for p in priority_levels %}
            <button class="pill" data-filter="priority-{{ p }}" type="button">{{ p|title }} Priority</button>
          {% endfor %}
          <button class="pill" data-filter="completed" type="button">Completed</button>
        </div>

        <!-- Scrollable tasks -->
        <div class="tasks-scroll" id="taskList" aria-live="polite">
          {% for category, tasks in tasks_by_category.items() %}
          <div class="task-category">
            {% if category != 'Uncategorized' %}<h3>{{ category }}</h3>{% endif %}
            <div class="task-list" data-category="{{ category }}">
              {% for task in tasks %}
              <div class="task-item {% if task.completed %}completed{% endif %}"
                   draggable="true"
                   data-task-id="{{ task.id }}"
                   data-priority="{{ task.priority or 'medium' }}"
                   data-completed="{{ '1' if task.completed else '0' }}"
                   data-due="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
                <input type="checkbox" class="task-checkbox"
                       data-endpoint="{{ url_for('projects.toggle_task', task_id=task.id) }}"
                       {% if task.completed %}checked{% endif %}>
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  {% if task.description %}<div class="task-description">{{ task.description }}</div>{% endif %}
                  <div class="task-meta">
                    {% if task.due_date %}<span>📅 {{ task.due_date.strftime('%b %d') }}</span>{% endif %}
                    {% if task.priority %}<span class="priority-{{ task.priority }}">{{ task.priority|title }}</span>{% endif %}
                  </div>
                </div>
                <div class="task-actions">
                  <a href="{{ url_for('projects.edit_tch_task', task_id=task.id) }}" class="btn-icon" title="Edit">✏️</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_task', task_id=task.id) }}" style="display:inline;">
                    <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this task?')">🗑️</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <p class="empty-state">No tasks yet. Click “Add Task”.</p>
          {% endfor %}
        </div>
      </section>

      <!-- RIGHT: NOTES → DOCUMENTS → IDEAS → MILESTONES -->
      <aside class="rhs">

        <!-- NOTES -->
        <div class="card" id="notes" aria-labelledby="notes-title">
          <div class="card__head">
            <h2 id="notes-title">📝 Notes</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('note-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for note in project.notes %}
            <div class="note-item">
              <div class="note-header">
                <span class="note-category">{{ note.category|title }}</span>
                <span class="note-date">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
              </div>
              <div class="note-content">{{ note.content }}</div>
              <div class="inline-actions" style="margin-top:6px;">
                <a href="{{ url_for('projects.edit_tch_note', note_id=note.id) }}" class="btn-icon" title="Edit Note">✏️</a>
                <form method="POST" action="{{ url_for('projects.delete_tch_note', note_id=note.id) }}">
                  <button type="submit" class="btn-icon btn-delete" title="Delete Note" onclick="return confirm('Delete this note?')">🗑️</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No notes yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- DOCUMENTS (List-only) -->
        <div class="card" id="documents" aria-labelledby="documents-title">
          <div class="card__head">
            <h2 id="documents-title">📁 Project Documents</h2>
            <div class="doc-toolbar">
              <span style="opacity:.65; font-size:.9rem;">List view</span>
              <button class="btn btn-primary btn-sm" onclick="openModal('doc-modal')">➕ Add</button>
            </div>
          </div>
          <div class="card__body">
            {% if vault_documents %}
              <table class="vault-docs-list" id="docsList">
                <tbody>
                {% for doc in vault_documents %}
                  <tr>
                    <td class="doc-name-cell">
                      {% if doc.doc_type == 'image' %}🖼️{% elif doc.doc_type == 'contract' %}📜{% elif doc.doc_type in ['invoice','receipt'] %}🧾{% elif doc.doc_type == 'spreadsheet' %}📊{% elif doc.doc_type == 'note' %}📝{% elif 'pdf' in (doc.mime_type or '') %}📕{% else %}📄{% endif %}
                      {{ doc.title }}
                      <div class="doc-type">{{ doc.doc_type|title }} • {{ doc.created_at.strftime('%b %d, %Y') }}</div>
                    </td>
                    <td class="doc-actions">
                      <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="btn-icon" title="View">👁️</a>
                      {% if doc.file_path %}
                      <a href="{{ url_for('vault.download_file', id=doc.id) }}" class="btn-icon" title="Download">⬇</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="empty-state">No documents yet. Click Add.</p>
            {% endif %}
          </div>
        </div>

        <!-- IDEAS -->
        <div class="card" id="ideas" aria-labelledby="ideas-title">
          <div class="card__head">
            <h2 id="ideas-title">💡 Ideas</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('idea-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for idea in project.ideas %}
            <div class="idea-item status-{{ idea.status }}">
              <div class="idea-content">{{ idea.content }}</div>
              <div class="idea-footer">
                <form method="POST" action="{{ url_for('projects.update_idea_status', idea_id=idea.id) }}">
                  <select name="status" onchange="this.form.submit()">
                    <option value="new" {% if idea.status == 'new' %}selected{% endif %}>New</option>
                    <option value="considering" {% if idea.status == 'considering' %}selected{% endif %}>Considering</option>
                    <option value="implemented" {% if idea.status == 'implemented' %}selected{% endif %}>Implemented</option>
                    <option value="rejected" {% if idea.status == 'rejected' %}selected{% endif %}>Rejected</option>
                  </select>
                </form>
                <div class="inline-actions">
                  <a href="{{ url_for('projects.edit_tch_idea', idea_id=idea.id) }}" class="btn-icon" title="Edit Idea">✏️</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_idea', idea_id=idea.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete Idea" onclick="return confirm('Delete this idea?')">🗑️</button>
                  </form>
                  <span class="idea-date">{{ idea.created_at.strftime('%b %d') }}</span>
                </div>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No ideas yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- MILESTONES -->
        <div class="card" id="milestones" aria-labelledby="milestones-title">
          <div class="card__head">
            <h2 id="milestones-title">🏁 Milestones</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('milestone-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for milestone in project.milestones %}
            <div class="milestone-item {% if milestone.completed %}completed{% endif %}">
              <div class="milestone-header">
                <h4>{{ milestone.title }}</h4>
                <div class="inline-actions">
                  {% if not milestone.completed %}
                  <form method="POST" action="{{ url_for('projects.complete_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon" title="Mark Complete">✅</button>
                  </form>
                  {% else %}
                  <span class="completed-badge">Completed</span>
                  {% endif %}
                  <a href="{{ url_for('projects.edit_tch_milestone', milestone_id=milestone.id) }}" class="btn-icon" title="Edit Milestone">✏️</a>
                  <form method="POST" action="{{ url_for('projects.delete_tch_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete Milestone" onclick="return confirm('Delete this milestone?')">🗑️</button>
                  </form>
                </div>
              </div>
              {% if milestone.description %}<p>{{ milestone.description }}</p>{% endif %}
              {% if milestone.target_date %}
              <div class="milestone-date">📅 Target: {{ milestone.target_date.strftime('%b %d, %Y') }}</div>
              {% endif %}
            </div>
            {% else %}
            <p class="empty-state">No milestones yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

      </aside>
    </div>

  </div>
</div>

<!-- ================= MODALS (full-screen forms) ================= -->

<!-- TASK: Add -->
<div id="task-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="task-modal-title">Add Task</h3>
      <button class="close-btn" onclick="closeModal('task-modal')" aria-label="Close">✖</button>
    </div>
    <form method="POST" action="{{ url_for('projects.add_tch_task', project_id=project.id) }}">
      <input type="text" name="title" placeholder="Task title" required>
      <textarea name="description" rows="8" placeholder="Description"></textarea>

      {# Category: wired to TASK_CATEGORIES passed from route #}
      <select name="category" required>
        <option value="" disabled selected>Select category…</option>
        {% for c in task_categories %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>

      <select name="priority">
        <option value="low">Low</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
        <option value="critical">Critical</option>
      </select>

      <input type="date" name="due_date" placeholder="Due date">
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeModal('task-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Task</button>
      </div>
    </form>
  </div>
</div>

<!-- NOTES: Add -->
<div id="note-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="note-modal-title">Add Note</h3>
      <button class="close-btn" onclick="closeModal('note-modal')" aria-label="Close">✖</button>
    </div>
    <form method="POST" action="{{ url_for('projects.add_tch_note', project_id=project.id) }}">
      <select name="category" required>
        <option value="general">General</option>
        <option value="meeting">Meeting</option>
        <option value="technical">Technical</option>
        <option value="idea">Idea</option>
      </select>
      <textarea name="content" rows="8" placeholder="Write your note…" required></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeModal('note-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Note</button>
      </div>
    </form>
  </div>
</div>

<!-- DOCUMENTS: Add (Vault) -->
<div id="doc-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="doc-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="doc-modal-title">Add Document</h3>
      <button class="close-btn" onclick="closeModal('doc-modal')" aria-label="Close">✖</button>
    </div>
    <form method="POST" action="{{ url_for('projects.upload_tch_vault_document', id=project.id) }}" enctype="multipart/form-data">
      <input type="file" name="file" required accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif">
      <input type="text" name="title" placeholder="Document title (optional)">
      <select name="doc_type">
        <option value="document">Document</option>
        <option value="contract">Contract</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="image">Image</option>
        <option value="spreadsheet">Spreadsheet</option>
        <option value="note">Note</option>
        <option value="other">Other</option>
      </select>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeModal('doc-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- IDEAS: Add -->
<div id="idea-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="idea-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="idea-modal-title">Add Idea</h3>
      <button class="close-btn" onclick="closeModal('idea-modal')" aria-label="Close">✖</button>
    </div>
    <form method="POST" action="{{ url_for('projects.add_tch_idea', project_id=project.id) }}">
      <textarea name="content" rows="8" placeholder="Describe the idea…" required></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeModal('idea-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Idea</button>
      </div>
    </form>
  </div>
</div>

<!-- MILESTONES: Add -->
<div id="milestone-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="milestone-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="milestone-modal-title">Add Milestone</h3>
      <button class="close-btn" onclick="closeModal('milestone-modal')" aria-label="Close">✖</button>
    </div>
    <form method="POST" action="{{ url_for('projects.add_tch_milestone', project_id=project.id) }}">
      <input type="text" name="title" placeholder="Milestone title" required>
      <textarea name="description" rows="6" placeholder="Description"></textarea>
      <input type="date" name="target_date" placeholder="Target date">
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeModal('milestone-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Milestone</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Helpers */
function qsa(root, sel){ return Array.from((root || document).querySelectorAll(sel)); }

/* Modals */
function openModal(id){ const m=document.getElementById(id); if(!m) return; m.style.display='flex'; document.body.style.overflow='hidden'; }
function closeModal(id){ const m=document.getElementById(id); if(!m) return; m.style.display='none'; document.body.style.overflow=''; }
document.addEventListener('click', e => { const ov=e.target.closest('.modal-overlay'); if(ov && e.target===ov){ ov.style.display='none'; document.body.style.overflow=''; }});
document.addEventListener('keydown', e => { if(e.key==='Escape'){ qsa(document,'.modal-overlay').forEach(m=>m.style.display='none'); document.body.style.overflow=''; }});

/* Task checkbox -> POST toggle */
(function(){
  const boxes=document.querySelectorAll('.task-checkbox'); if(!boxes.length) return;
  boxes.forEach(cb=>{
    cb.addEventListener('change', async function(){
      const endpoint=this.getAttribute('data-endpoint'); if(!endpoint) return;
      try{
        const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'}});
        const data=await res.json();
        if(data && typeof data.completed!=='undefined'){
          this.checked=!!data.completed;
          this.closest('.task-item')?.classList.toggle('completed',!!data.completed);
        }else{ this.checked=!this.checked; }
      }catch(err){ this.checked=!this.checked; }
    });
  });
})();

/* Task filters (driven by PRIORITY_LEVELS) */
(function(){
  const toolbar=document.querySelector('.task-toolbar'); if(!toolbar) return;
  function setActive(btn){ qsa(toolbar,'.pill').forEach(p=>p.classList.remove('is-active')); btn.classList.add('is-active'); }
  function isDue(iso){ if(!iso) return false; const t=new Date(); t.setHours(0,0,0,0); const d=new Date(iso+'T00:00:00'); return d<=t; }

  toolbar.addEventListener('click',e=>{
    const btn=e.target.closest('.pill'); if(!btn) return;
    setActive(btn); const f=btn.dataset.filter;

    qsa(document,'.task-item').forEach(el=>{
      const done = el.dataset.completed==='1';
      const pri  = (el.dataset.priority||'medium').toLowerCase();
      const due  = el.dataset.due||'';
      let show   = true;

      if (f==='all')            show = true;
      else if (f==='due')       show = isDue(due) && !done;
      else if (f==='completed') show = done;
      else if (f && f.startsWith('priority-')) {
        const want = f.slice('priority-'.length);
        show = pri===want && !done;
      }

      el.style.display = show ? '' : 'none';
    });
  });
})();

/* Drag & Drop (client-side only) */
(function(){
  const lists=qsa(document,'.task-list'); if(!lists.length) return;
  let dragging=null;
  lists.forEach(list=>{
    list.addEventListener('dragstart',e=>{ const item=e.target.closest('.task-item'); if(!item) return; dragging=item; item.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    list.addEventListener('dragover',e=>{ e.preventDefault(); const after=getAfter(list,e.clientY); if(!dragging) return; if(after==null) list.appendChild(dragging); else list.insertBefore(dragging,after); });
    list.addEventListener('drop',()=>{ if(!dragging) return; dragging.classList.remove('dragging'); dragging=null; });
    list.addEventListener('dragend',()=>{ if(dragging) dragging.classList.remove('dragging'); dragging=null; });
  });
  function getAfter(container,y){
    const els=qsa(container,'.task-item:not(.dragging)'); let closest={offset:Number.NEGATIVE_INFINITY,el:null};
    els.forEach(el=>{ const r=el.getBoundingClientRect(); const off=y-(r.top+r.height/2); if(off<0 && off>closest.offset) closest={offset:off,el}; });
    return closest.el;
  }
})();
</script>
{% endblock %}
