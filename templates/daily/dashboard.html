<!-- templates/daily/dashboard.html (v2.1) -->
{% extends "base.html" %}
{% block title %}Daily Command Center{% endblock %}

{% block extra_css %}
<style>
  /* ==================== THEME ==================== */
  :root {
    --dash-bg: var(--bg, #0b0f1a);
    --dash-panel: var(--panel, #121a2a);
    --dash-card: var(--card, #0f1625);
    --dash-sub: #0c1322;
    --dash-line: var(--line, #1f2a3d);
    --dash-text: var(--text, #e6eaf2);
    --dash-muted: var(--text-muted, #9fb0c8);
    --dash-primary: var(--primary, #6ea8ff);
    --dash-success: var(--success, #22c55e);
    --dash-warning: var(--warning, #f59e0b);
    --dash-danger: var(--danger, #ef4444);
    --dash-radius: 16px;
    --dash-radius-sm: 12px;
    --dash-shadow: 0 10px 30px rgba(0,0,0,.45);
    --dash-shadow-soft: 0 6px 18px rgba(0,0,0,.35);
  }

  /* ==================== PAGE LAYOUT ==================== */
  .dashboard-wrap {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px; 
    display: grid; 
    gap: 20px;
  }

  /* Sticky top bar */
  .topbar {
    position: sticky; top: 0; z-index: 6;
    display: grid; grid-template-columns: 1fr auto; gap: 16px;
    padding: 14px 16px; border-radius: 14px; 
    background: linear-gradient(135deg, rgba(110,168,255,.12), rgba(139,92,246,.10));
    border: 1px solid var(--dash-line); box-shadow: var(--dash-shadow-soft);
    backdrop-filter: blur(6px);
  }
  .topbar-title { 
    font-size: 22px; font-weight: 800; letter-spacing: -.2px;
    background: linear-gradient(135deg, var(--dash-text), var(--dash-primary));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .topbar-sub { color: var(--dash-muted); font-size: 13px; }
  .quick-stats { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .qchip { 
    display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; 
    border: 1px solid var(--dash-line); background: var(--dash-card);
    border-radius: 999px; font-size: 12px; color: var(--dash-text);
  }
  .qdot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* Progress puck */
  .puck { position: relative; width: 44px; height: 44px; border-radius: 50%; display:grid; place-items:center; }
  .puck > span { font-size: 11px; font-weight: 700; color: var(--dash-text); }

  /* Banner row */
  .banner-row { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
  @media (max-width: 900px){ .banner-row { grid-template-columns: 1fr; } }

  .banner {
    border:1px solid var(--dash-line); background: var(--dash-card);
    box-shadow: var(--dash-shadow); border-radius: var(--dash-radius); overflow: hidden; position: relative;
  }
  .banner-head { padding: 22px; }
  .banner-title { font-weight: 800; font-size: 28px; letter-spacing: -0.5px; margin-bottom: 6px; }
  .banner-date { font-size: 14px; color: var(--dash-muted); }
  .glowbar { position:absolute; left:0; right:0; top:0; height:2px; background: linear-gradient(90deg, var(--dash-primary), #8b5cf6, var(--dash-primary)); opacity:.7; animation: shimmer 3s ease-in-out infinite; }
  @keyframes shimmer { 0%,100%{opacity:.55} 50%{opacity:1} }

  .alert-card {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    border: 1px solid rgba(239,68,68,.6);
    border-radius: var(--dash-radius);
    padding: 18px; text-align:center; color:#fff; box-shadow: var(--dash-shadow);
    display:grid; gap:8px; place-items:center;
    animation: pulseRed 2s ease-in-out infinite;
  }
  @keyframes pulseRed { 0%,100%{ box-shadow:0 0 20px rgba(239,68,68,.35)} 50%{ box-shadow:0 0 40px rgba(239,68,68,.55)} }
  .alert-btn { background:#fff; color:#991b1b; padding:10px 18px; border-radius:999px; font-weight:800; text-decoration:none }
  .alert-btn:hover { filter: brightness(1.05) }

  /* System messages */
  .sys-msg { border:1px solid rgba(239,68,68,.4); color:#ff6b6b; background: linear-gradient(135deg, rgba(239,68,68,.18), rgba(239,68,68,.08)); padding:14px 16px; border-radius:12px; text-align:center; animation:pulseGlow 2s ease-in-out infinite; }
  @keyframes pulseGlow { 0%,100%{ box-shadow:0 0 18px rgba(239,68,68,.18)} 50%{ box-shadow:0 0 28px rgba(239,68,68,.32)} }

  .lockout {
    border:2px solid rgba(239,68,68,.6); background: linear-gradient(135deg, rgba(239,68,68,.12), rgba(239,68,68,.04));
    border-radius: var(--dash-radius); padding: 34px; text-align:center; position:relative; box-shadow: var(--dash-shadow);
  }
  .lockout h3 { color: var(--dash-danger); font-size: 28px; margin: 0 0 8px; }
  .lockout p { color: var(--dash-text); white-space: pre-line; margin:0 }

  /* GRID: left and right columns */
  .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 20px; }
  @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr; } }

  /* Card */
  .card { background: var(--dash-card); border:1px solid var(--dash-line); border-radius: var(--dash-radius); box-shadow: var(--dash-shadow-soft); }
  .card-head { display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid var(--dash-line); }
  .card-title { text-transform:uppercase; letter-spacing:.8px; font-weight:800; font-size:13px; display:flex; gap:10px; align-items:center; }
  .card-actions { display:flex; gap:10px; align-items:center; }
  .card-actions a { color: var(--dash-primary); text-decoration:none; font-weight:700; font-size:12px; padding:6px 8px; border-radius:8px; }
  .card-actions a:hover { background: rgba(110,168,255,.1); }
  .card-body { padding:18px; }

  /* Biological Minimums */
  .bio {
    background: var(--dash-card); border:1px solid var(--dash-line); border-radius: var(--dash-radius); box-shadow: var(--dash-shadow-soft);
  }
  .bio-head { display:flex; gap:10px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--dash-line); }
  .bio-title { color: var(--dash-primary); font-weight:900; letter-spacing:.6px; font-size:12px; text-transform:uppercase; }
  .bio-info { margin-left:auto; color: var(--dash-muted); font-size:12px; }
  .bio-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; padding: 14px; }
  .bio-item { background: linear-gradient(135deg, var(--dash-panel), rgba(30,41,59,.5)); border:1px solid var(--dash-line); border-radius:12px; padding:14px 10px; text-align:center; cursor:pointer; position:relative; transition:.2s; overflow:hidden; }
  .bio-item:hover:not(.completed){ transform: translateY(-3px); border-color: var(--dash-primary); box-shadow: 0 10px 28px rgba(110,168,255,.25); }
  .bio-item.completed { background: linear-gradient(135deg, rgba(34,197,94,.2), rgba(34,197,94,.1)); border-color: rgba(34,197,94,.45); }
  .bio-item.completed::after { content:'✓'; position:absolute; top:6px; right:8px; color: var(--dash-success); font-weight:900; font-size:12px }
  .bio-ico { font-size:26px; margin-bottom:6px; }
  .bio-name { font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:.5px; }
  .bio-status { font-size:10px; color: var(--dash-muted); font-weight:600; }

  /* Projects */
  .proj-list { max-height: 620px; overflow:auto; padding-right:8px; }
  .proj-list::-webkit-scrollbar { width:6px }
  .proj-list::-webkit-scrollbar-thumb { background: var(--dash-primary); border-radius:3px }
  .proj-card { position:relative; background: linear-gradient(135deg, var(--dash-panel), rgba(30,41,59,.5)); border:1px solid var(--dash-line); border-radius:12px; padding:16px; margin-bottom:12px; transition:.2s; overflow:hidden; }
  .proj-card:hover { transform: translateX(6px); border-color: var(--dash-primary); box-shadow: 0 12px 26px rgba(0,0,0,.40); }
  .proj-ac { display:flex; gap:10px; margin-top:12px }
  .btn { display:inline-flex; align-items:center; gap:6px; padding:9px 14px; border-radius:10px; border:1px solid transparent; font-size:12px; font-weight:800; cursor:pointer; text-decoration:none }
  .btn-pri { background: linear-gradient(135deg, var(--dash-primary), #8b5cf6); color:#fff }
  .btn-pri:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(110,168,255,.35) }
  .btn-ok { background: linear-gradient(135deg, var(--dash-success), #16a34a); color:#fff }
  .btn-ok:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(34,197,94,.35) }
  .ptype { text-align:center; font-size:10px; color: var(--dash-muted); font-weight:800; text-transform:uppercase; letter-spacing:.5px }

  .status-badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:10px; font-weight:900; text-transform:uppercase; letter-spacing:.5px; margin-right:6px }
  .status-overdue { background: rgba(239,68,68,.2); color:#ff6b6b; border:1px solid rgba(239,68,68,.3); animation: blink 1.5s ease-in-out infinite }
  .status-today { background: rgba(245,158,11,.2); color: var(--dash-warning); border:1px solid rgba(245,158,11,.3) }
  .status-soon { background: rgba(59,130,246,.2); color: #60a5fa; border:1px solid rgba(59,130,246,.3) }
  .status-neglect { background: rgba(107,114,128,.2); color:#9ca3af; border:1px solid rgba(107,114,128,.3) }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.6} }
  .prio { display:inline-block; padding:3px 8px; border-radius:8px; font-size:10px; font-weight:800; text-transform:uppercase }
  .prio-1 { background: rgba(239,68,68,.15); color:#ff6b6b }
  .prio-2 { background: rgba(245,158,11,.15); color: var(--dash-warning) }
  .prio-3 { background: rgba(59,130,246,.15); color:#60a5fa }

  .locked { opacity:.4; filter: blur(2px); pointer-events:none }
  .locked-note { text-align:center; padding: 54px 16px; color: var(--dash-muted); }

  /* Events */
  .event { position:relative; background: linear-gradient(135deg, var(--dash-panel), rgba(30,41,59,.5)); border-left:3px solid var(--dash-primary); border-radius:10px; padding:12px 12px; cursor:pointer; transition:.2s }
  .event:hover { transform: translateX(4px); box-shadow: 0 8px 20px rgba(0,0,0,.35) }
  .ev-time { font-size:11px; color: var(--dash-primary); font-weight:900; text-transform:uppercase; letter-spacing:.5px }
  .ev-title { font-size:14px; font-weight:800; color: var(--dash-text) }
  .ev-who { font-size:10px; display:inline-block; background: var(--dash-card); border:1px solid var(--dash-line); color: var(--dash-muted); padding:2px 8px; border-radius:999px }
  .ev-actions { position:absolute; top:8px; right:8px; display:flex; gap:6px; opacity:0; transition:.2s }
  .event:hover .ev-actions { opacity:1 }
  .ev-btn { background: var(--dash-card); border:1px solid var(--dash-line); border-radius:6px; padding:4px 6px; font-size:11px; text-decoration:none; color: var(--dash-text) }
  .ev-btn.edit { color: var(--dash-primary) }
  .ev-btn.del { color: var(--dash-danger) }
  .nope { text-align:center; color: var(--dash-muted); padding: 26px; font-style: italic }

  /* Notes */
  .note-row { display:flex; gap:10px; margin-bottom:14px }
  .note-sel, .note-inp { background: var(--dash-panel); border:1px solid var(--dash-line); border-radius:10px; padding:10px; color: var(--dash-text) }
  .note-sel { min-width:120px }
  .note-inp { flex:1 }
  .note-inp:focus, .note-sel:focus { outline:none; border-color: var(--dash-primary); box-shadow:0 0 0 3px rgba(110,168,255,.12) }
  .note-add { background: linear-gradient(135deg, var(--dash-primary), #8b5cf6); border:none; color:#fff; border-radius:10px; padding:10px 18px; font-weight:800; cursor:pointer }
  .note-list { max-height: 320px; overflow:auto; padding-right:8px }
  .note { display:flex; justify-content:space-between; align-items:center; gap:12px; background: linear-gradient(135deg, var(--dash-panel), rgba(30,41,59,.5)); border:1px solid var(--dash-line); border-radius:10px; padding:12px; margin-bottom:8px }
  .note-txt { font-size:13px; color: var(--dash-text) }
  .note-ok { color: var(--dash-success); text-decoration:none; font-size:18px; padding:0 8px }

  /* Action launcher */
  .launcher { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:14px }
  .launch { text-decoration:none; color: var(--dash-text); text-align:center; background: linear-gradient(135deg, var(--dash-card), rgba(30,41,59,.5)); border:1px solid var(--dash-line); border-radius: var(--dash-radius); padding:22px; position:relative; overflow:hidden; transition:.2s }
  .launch:hover { transform: translateY(-4px); border-color: var(--dash-primary); box-shadow: 0 12px 32px rgba(110,168,255,.28) }
  .launch-ico { font-size:34px; margin-bottom:10px }
  .launch-t { font-size:14px; font-weight:800; text-transform:uppercase; letter-spacing:.5px }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrap">

  <!-- TOP BAR -->
  <div class="topbar">
    <div>
      <div class="topbar-title">📋 DAILY COMMAND CENTER</div>
      <div class="topbar-sub">{{ today.strftime('%A, %B %d, %Y') }}</div>
    </div>
    <div class="quick-stats">
      <span class="qchip"><span class="qdot" style="background:#60a5fa"></span>{{ daily_tasks|length }} projects</span>
      <span class="qchip"><span class="qdot" style="background:#34d399"></span>{{ today_events|length if today_events else 0 }} events today</span>
      <span class="qchip"><span class="qdot" style="background:#f59e0b"></span>{{ notes_by_category|length if notes_by_category else 0 }} note groups</span>
      <!-- Morning progress puck (0..3) -->
      {% set mc = human.morning_complete if human and human.morning_complete is not none else 0 %}
      {% set pct = (mc/3.0)*100 %}
      <div class="qchip" title="Morning minimums">
        <div class="puck" style="background: conic-gradient(var(--dash-success) {{ pct }}%, rgba(255,255,255,.08) 0);">
          <span>{{ mc }}/3</span>
        </div>
        unlock
      </div>
    </div>
  </div>

  <!-- BANNERS -->
  <div class="banner-row">
    <div class="banner">
      <div class="glowbar"></div>
      <div class="banner-head">
        <div class="banner-title">Stay lethal, stay focused.</div>
        <div class="banner-date">Dial today in, crush tomorrow.</div>
      </div>
    </div>

    {% if show_evening_review %}
      {% if evening_review_end_hour == 99 or 
            (evening_review_end_hour < evening_review_hour and 
             (datetime.now().hour >= evening_review_hour or datetime.now().hour <= evening_review_end_hour)) or
            (evening_review_end_hour >= evening_review_hour and 
             evening_review_hour <= datetime.now().hour <= evening_review_end_hour) %}
      <div class="alert-card">
        <div style="font-weight:900; font-size:16px">🌙 EVENING REVIEW TIME</div>
        <div style="opacity:.9; font-size:12px">Grade the day & prime tomorrow</div>
        <a class="alert-btn" href="{{ url_for('daily.evening_review') }}">Start Review →</a>
      </div>
      {% endif %}
    {% endif %}
  </div>

  {% if harassment %}
    <div class="sys-msg">⚠️ {{ harassment }} ⚠️</div>
  {% endif %}

  {% if lockout %}
    <div class="lockout">
      <h3>🔒 SYSTEM LOCKED</h3>
      <p>{{ lockout_message }}</p>
    </div>
  {% endif %}

  <!-- BIOLOGICAL MINIMUMS -->
  <div class="bio">
    <div class="bio-head">
      <div class="bio-title">🧬 Biological Minimums</div>
      <div class="bio-info">{{ human.morning_complete }}/3 to unlock</div>
    </div>
    <div class="bio-grid">
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="meds">
        <button type="submit" class="bio-item {% if human.meds_taken %}completed{% endif %}">
          <div class="bio-ico">💊</div>
          <div class="bio-name">Meds</div>
          <div class="bio-status">{% if human.meds_taken %}✓{% else %}TAKE NOW{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="shower">
        <button type="submit" class="bio-item {% if human.shower_taken %}completed{% endif %}">
          <div class="bio-ico">🚿</div>
          <div class="bio-name">Shower</div>
          <div class="bio-status">{% if human.shower_taken %}✓{% else %}{{ human.days_since_shower }} days{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="teeth_am">
        <button type="submit" class="bio-item {% if human.teeth_brushed_am %}completed{% endif %}">
          <div class="bio-ico">🦷</div>
          <div class="bio-name">Teeth AM</div>
          <div class="bio-status">{% if human.teeth_brushed_am %}✓{% else %}DO IT{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="breakfast">
        <button type="submit" class="bio-item {% if human.breakfast %}completed{% endif %}">
          <div class="bio-ico">🍳</div>
          <div class="bio-name">Breakfast</div>
          <div class="bio-status">{% if human.breakfast %}✓{% else %}EAT{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="lunch">
        <button type="submit" class="bio-item {% if human.lunch %}completed{% endif %}">
          <div class="bio-ico">🥪</div>
          <div class="bio-name">Lunch</div>
          <div class="bio-status">{% if human.lunch %}✓{% else %}NOON{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="dinner">
        <button type="submit" class="bio-item {% if human.dinner %}completed{% endif %}">
          <div class="bio-ico">🍽️</div>
          <div class="bio-name">Dinner</div>
          <div class="bio-status">{% if human.dinner %}✓{% else %}6PM{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="teeth_pm">
        <button type="submit" class="bio-item {% if human.teeth_brushed_pm %}completed{% endif %}">
          <div class="bio-ico">🦷</div>
          <div class="bio-name">Teeth PM</div>
          <div class="bio-status">{% if human.teeth_brushed_pm %}✓{% else %}NIGHT{% endif %}</div>
        </button>
      </form>
      <form method="POST" action="{{ url_for('daily.update_human') }}" style="display: contents;">
        <input type="hidden" name="task" value="water">
        <button type="submit" class="bio-item">
          <div class="bio-ico">💧</div>
          <div class="bio-name">Water</div>
          <div class="bio-status">{{ human.water_glasses }}/8</div>
        </button>
      </form>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- LEFT: Project Focus -->
    <div class="card {% if lockout %}locked{% endif %}">
      <div class="card-head">
        <div class="card-title">{% if lockout %}🔒{% else %}🎯{% endif %} Today’s Project Focus</div>
        {% if not lockout %}
        <div class="card-actions">
          <a href="{{ url_for('daily.refresh_tasks') }}">🔄 Refresh</a>
          <span style="color:var(--dash-muted); font-size:12px">{{ daily_tasks|length }} projects</span>
        </div>
        {% endif %}
      </div>
      <div class="card-body">
        {% if lockout %}
          <div class="locked-note">
            <div style="font-size:46px; margin-bottom:8px">🔒</div>
            <div style="font-weight:800">Projects locked</div>
            <div style="font-size:13px; margin-top:6px">Complete biological minimums to unlock</div>
          </div>
        {% elif daily_tasks %}
          <div class="proj-list">
            {% for task in daily_tasks %}
            <div class="proj-card" style="border-left:4px solid {% if 'TCH' in task.project_type %}#6ea8ff{% else %}#22c55e{% endif %};">
              <div style="display:flex; justify-content:space-between; gap:14px; align-items:flex-start;">
                <div style="flex:1">
                  <div style="font-weight:800; font-size:16px; margin-bottom:6px">{{ task.project_name }}</div>
                  <div style="margin-bottom:8px">
                    {% if 'OVERDUE' in task.task_description %}
                      <span class="status-badge status-overdue">⚠️ Overdue</span>
                    {% elif 'DUE TODAY' in task.task_description %}
                      <span class="status-badge status-today">🔥 Due Today</span>
                    {% elif 'Due in' in task.task_description %}
                      <span class="status-badge status-soon">📅 Deadline Soon</span>
                    {% elif 'Neglected for' in task.task_description %}
                      <span class="status-badge status-neglect">📌 Neglected</span>
                    {% endif %}

                    {% if task.priority == 1 %}
                      <span class="prio prio-1">🔥 Immediate</span>
                    {% elif task.priority == 2 %}
                      <span class="prio prio-2">⏰ High</span>
                    {% elif task.priority == 3 %}
                      <span class="prio prio-3">📌 Medium</span>
                    {% endif %}
                  </div>
                  <div class="proj-ac">
                    <a class="btn btn-pri" href="{{ url_for('projects.tch_detail' if 'TCH' in task.project_type else 'persprojects.detail', id=task.project_id) }}">View Project →</a>
                    <button class="btn btn-ok" onclick="completeProject({{ task.id }})">✓ Worked On It</button>
                  </div>
                </div>
                <div style="text-align:center; padding:8px 6px">
                  <div style="font-size:24px; margin-bottom:4px">{% if 'TCH' in task.project_type %}💼{% else %}🏠{% endif %}</div>
                  <div class="ptype">{{ task.project_type }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div style="text-align:center; margin-top:12px; padding-top:12px; border-top:1px dashed var(--dash-line)">
              <a href="{{ url_for('daily.select_tasks') }}" style="color:var(--dash-primary); font-weight:800; text-decoration:none">+ Add More Projects</a>
              <span style="margin:0 10px; color:var(--dash-muted)">|</span>
              <a href="{{ url_for('daily.task_stats') }}" style="color:var(--dash-muted); text-decoration:none; font-size:12px">View Stats</a>
            </div>
          </div>
        {% else %}
          <div class="nope">No projects selected for today. <a href="{{ url_for('daily.select_tasks') }}" style="color:var(--dash-primary)">Select projects →</a></div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT: Schedule + Notes -->
    <div style="display:grid; gap:20px">
      <!-- Schedule -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">📅 Schedule</div>
          <div class="card-actions"><a href="{{ url_for('daily.calendar_view') }}">View Full →</a></div>
        </div>
        <div class="card-body">
          <div style="font-weight:800; margin-bottom:10px; color:var(--dash-primary); font-size:12px; text-transform:uppercase; letter-spacing:.5px">Today ({{ today.strftime('%A, %b %d') }})</div>
          {% if today_events %}
          <div style="display:flex; flex-direction:column; gap:10px">
            {% for event in today_events %}
            <div class="event" onclick="showEventDetails({{ event.id }})">
              <div class="ev-actions">
                <a class="ev-btn edit" title="Edit" onclick="event.stopPropagation();" href="{{ url_for('daily.edit_event', event_id=event.id) }}?return_to=dashboard">✏️</a>
                <button class="ev-btn del" title="Delete" onclick="event.stopPropagation(); quickDeleteEvent({{ event.id }})">🗑️</button>
              </div>
              <div class="ev-time">{{ event.event_time or 'All Day' }}</div>
              <div class="ev-title">{{ event.event_type }} {% if event.recurring_id %}<span style="background:var(--dash-primary); color:#fff; padding:1px 4px; border-radius:4px; font-size:9px; font-weight:800">↻</span>{% endif %}</div>
              {% if event.who %}<span class="ev-who">{{ event.who }}</span>{% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
            <div class="nope">No events today</div>
          {% endif %}

          <div style="height:14px"></div>
          <div style="font-weight:800; margin-bottom:10px; color:var(--dash-primary); font-size:12px; text-transform:uppercase; letter-spacing:.5px">Tomorrow</div>
          {% if tomorrow_events %}
          <div style="display:flex; flex-direction:column; gap:10px">
            {% for event in tomorrow_events %}
            <div class="event" onclick="showEventDetails({{ event.id }})">
              <div class="ev-actions">
                <a class="ev-btn edit" title="Edit" onclick="event.stopPropagation();" href="{{ url_for('daily.edit_event', event_id=event.id) }}?return_to=dashboard">✏️</a>
                <button class="ev-btn del" title="Delete" onclick="event.stopPropagation(); quickDeleteEvent({{ event.id }})">🗑️</button>
              </div>
              <div class="ev-time">{{ event.event_time or 'All Day' }}</div>
              <div class="ev-title">{{ event.event_type }} {% if event.recurring_id %}<span style="background:var(--dash-primary); color:#fff; padding:1px 4px; border-radius:4px; font-size:9px; font-weight:800">↻</span>{% endif %}</div>
              {% if event.who %}<span class="ev-who">{{ event.who }}</span>{% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
            <div class="nope">Nothing scheduled</div>
          {% endif %}

          <div style="text-align:center; margin-top:14px; padding-top:14px; border-top:1px dashed var(--dash-line)">
            <a href="{{ url_for('daily.add_event') }}" style="color:var(--dash-primary); font-weight:800; text-decoration:none">+ Add Event</a>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="card">
        <div class="card-head"><div class="card-title">📝 Quick Notes</div></div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('daily.add_note') }}" class="note-row" onsubmit="return noteSubmit(this)">
            <select name="category" class="note-sel" aria-label="Category">
              <option value="Idea">💡 Idea</option>
              <option value="Todo">✅ Todo</option>
              <option value="Remember">🧠 Remember</option>
              <option value="Bug">🐛 Bug</option>
              <option value="Random">🎲 Random</option>
            </select>
            <input name="note" class="note-inp" placeholder="Capture a thought..." required />
            <button class="note-add" type="submit">Add</button>
          </form>

          {% if notes_by_category %}
          <div class="note-list">
            {% for category, notes in notes_by_category.items() %}
              <div style="margin-bottom:12px">
                <div style="font-size:12px; color:var(--dash-primary); font-weight:900; text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px">{{ category }}</div>
                {% for note in notes %}
                  <div class="note">
                    <div class="note-txt">{{ note.note }}</div>
                    <a class="note-ok" href="{{ url_for('daily.resolve_note', note_id=note.id) }}">✓</a>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <div class="nope">No notes yet today</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ACTION LAUNCHER -->
  <div class="launcher">
    <a class="launch" href="{{ url_for('daily.calendar_view') }}">
      <div class="launch-ico">📆</div>
      <div class="launch-t">Calendar</div>
    </a>
    <a class="launch" href="{{ url_for('daily.select_tasks') }}">
      <div class="launch-ico">🎯</div>
      <div class="launch-t">Select Projects</div>
    </a>
    <a class="launch" href="{{ url_for('daily.settings') }}">
      <div class="launch-ico">⚙️</div>
      <div class="launch-t">Settings</div>
    </a>
    <a class="launch" href="{{ url_for('daily.task_stats') }}">
      <div class="launch-ico">📊</div>
      <div class="launch-t">Rotation Stats</div>
    </a>
  </div>

</div>

<script>
  function completeProject(taskId) {
    if (confirm('Mark this project as worked on today?')) {
      window.location.href = `/daily/tasks/complete/${taskId}`;
    }
  }
  function showEventDetails(eventId) {
    window.location.href = `{{ url_for('daily.edit_event', event_id=0) }}?return_to=dashboard`.replace('0', eventId);
  }
  function quickDeleteEvent(eventId) {
    if (!confirm('Delete this event?')) return;
    fetch(`{{ url_for('daily.quick_delete_event', event_id=0) }}`.replace('0', eventId), { method:'POST', headers:{'Content-Type':'application/json'} })
      .then(r=>r.json()).then(d=>{ if(d.success) location.reload(); else alert('Failed to delete event'); })
      .catch(()=>alert('Failed to delete event'));
  }
  function noteSubmit(form){
    // Basic UX nicety: disable button after submit
    const btn = form.querySelector('button[type="submit"]');
    if(btn){ btn.disabled = true; setTimeout(()=>btn.disabled=false, 1500); }
    return true;
  }
  // Keep harassment message fresh
  setInterval(()=>location.reload(), 30*60*1000);
</script>
{% endblock %}
