<!-- templates/daily/calendar_month.html -->
{% extends "base.html" %}
{% block title %}Month Calendar{% endblock %}
{% block header %}MONTH VIEW{% endblock %}

{% block extra_css %}
<style>
  :root{
    --glow: 0 12px 34px rgba(0,0,0,.28);
    --glow-strong: 0 18px 50px rgba(0,0,0,.36);
    --chip-bg: color-mix(in oklab, var(--panel) 90%, transparent);
  }

  .calendar-container{max-width:1400px;margin:0 auto;padding:20px 20px 64px}

  /* Top nav */
  .calendar-nav{
    position:sticky;top:0;z-index:6;
    background: var(--panel);
    border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin-bottom:18px;
    display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;
    box-shadow: var(--glow);backdrop-filter: blur(6px);
  }
  .nav-buttons{display:flex;gap:10px;flex-wrap:wrap}
  .month-title{font-size:1.35rem;font-weight:800;color:var(--primary);text-align:center;flex:1;letter-spacing:.2px}

  .nav-btn{
    background: var(--card);color: var(--text);
    padding:11px 14px;border:1px solid var(--line);border-radius:10px;font-weight:800;
    text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease
  }
  .nav-btn:hover{transform:translateY(-2px);border-color:var(--primary);filter:brightness(1.03)}
  .nav-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .nav-btn.primary:hover{filter:brightness(1.05)}
  .nav-btn.warning{
    background:#f59e0b;color:#fff;border-color:#f59e0b;
    box-shadow:0 6px 18px rgba(245,158,11,.25);
  }
  .nav-btn.warning:hover{filter:brightness(1.05)}

  /* Dropdown */
  .dropdown{position:relative}
  .dropdown-toggle{cursor:pointer}
  .dropdown-menu{
    position:absolute;right:0;top:calc(100% + 6px);
    min-width:240px;background:var(--card);border:1px solid var(--line);border-radius:10px;
    padding:8px;display:none;box-shadow: var(--glow-strong);
  }
  .dropdown.open .dropdown-menu{display:block}
  .dropdown-item{
    display:flex;align-items:center;gap:8px;
    padding:10px 10px;border-radius:8px;text-decoration:none;color:var(--text);
    border:1px solid transparent;
  }
  .dropdown-item:hover{background:var(--panel);border-color:var(--line)}

  /* Legends */
  .chip-legend{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;
    background:var(--chip-bg);border:1px solid var(--line);font-size:.8rem;color:var(--text-muted)
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.me{background:var(--primary)}
  .dot.wife{background:#ec4899}
  .dot.kids{background:#10b981}
  .dot.family{background:#f59e0b}
  .dot.deadline{background:#ef4444}

  /* Stats */
  .month-stats{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:12px;margin-bottom:18px
  }
  .stat-card{
    background:linear-gradient(180deg,color-mix(in oklab,var(--card) 96%, transparent), var(--card));
    border:1px solid var(--line);border-radius:14px;padding:14px;text-align:center;
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;box-shadow: var(--glow)
  }
  .stat-card:hover{transform:translateY(-2px);border-color:var(--primary)}
  .stat-value{font-size:1.9rem;font-weight:800;line-height:1;margin-bottom:6px;color:var(--text)}
  .stat-label{font-size:.78rem;color:var(--text-muted);letter-spacing:.4px;text-transform:uppercase}

  /* Grid */
  .calendar-grid{background: var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:18px;box-shadow: var(--glow)}
  .weekday-headers{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .weekday-header{text-align:center;font-weight:800;font-size:.9rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px}
  .month-days{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}

  .day-cell{
    background: var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;min-height:130px;cursor:pointer;
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;position:relative;overflow:hidden;
  }
  .day-cell:hover{transform:translateY(-2px);border-color:var(--primary);filter:brightness(1.02)}
  .day-cell.other-month{opacity:.45;background:var(--card)}
  .day-cell.today{
    background: linear-gradient(180deg, color-mix(in oklab, var(--primary) 10%, transparent), var(--panel));
    border-color: color-mix(in oklab, var(--primary) 60%, var(--line));
    box-shadow: 0 0 0 2px color-mix(in oklab, var(--primary) 45%, transparent), var(--glow-strong);
  }
  .day-cell.weekend{background: linear-gradient(180deg, color-mix(in oklab, #10b981 8%, transparent), var(--panel))}
  .ring{position:absolute;inset:6px;border-radius:10px;border:1px solid transparent;pointer-events:none}
  .density-0 .ring{border-color:transparent}
  .density-1 .ring{border-color:color-mix(in oklab,var(--primary) 18%, transparent)}
  .density-2 .ring{border-color:color-mix(in oklab,var(--primary) 35%, transparent)}
  .density-3 .ring{border-color:color-mix(in oklab,var(--primary) 55%, transparent)}
  .density-4 .ring{border-color:color-mix(in oklab,var(--primary) 75%, transparent)}

  .day-number{font-size:1rem;font-weight:800;color:var(--text);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .wk-link{
    font-size:.7rem;color:var(--text-muted);text-decoration:none;border:1px solid var(--line);border-radius:999px;padding:2px 8px;
    transition:transform .16s ease, border-color .16s ease
  }
  .wk-link:hover{transform:translateY(-1px);border-color:var(--primary)}

  /* Chips w/ truncation */
  .event-chip{
    display:flex;align-items:center;gap:6px;
    font-size:.72rem;padding:3px 6px;margin:3px 0;border-radius:8px;background:var(--primary);color:#fff;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .event-chip .icon{flex:0 0 auto}
  .event-chip .label{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .event-chip.wife{background:#ec4899}
  .event-chip.kids{background:#10b981}
  .event-chip.family{background:#f59e0b}
  .event-chip.deadline{background:#ef4444;font-weight:800}
  .recurring-indicator{display:inline-block;font-size:.7rem;opacity:.9}

  .more-events{font-size:.75rem;color:var(--text-muted);text-align:center;margin-top:6px;font-style:italic;user-select:none}
  .more-events a{color:inherit;text-decoration:none;border-bottom:1px dashed var(--line)}
  .more-events a:hover{color:var(--primary);border-bottom-color:var(--primary)}

  /* Modal */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .2s ease}
  .modal-overlay.show{display:block}
  .day-modal{
    display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background: var(--card);border:1px solid var(--line);border-radius:16px;padding:22px;
    max-width:680px;width:92%;max-height:76vh;overflow:auto;z-index:1000;animation:slideIn .25s ease;
    box-shadow: var(--glow-strong)
  }
  .day-modal.show{display:block}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--line)}
  .modal-title{font-size:1.25rem;font-weight:800;color:var(--primary)}
  .close-btn{background:none;border:none;font-size:1.8rem;color:var(--text-muted);cursor:pointer;transition:color .18s ease}
  .close-btn:hover{color:var(--danger)}
  .modal-events{display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto}

  .modal-event{background: var(--panel);padding:12px;border-radius:10px;border-left:4px solid var(--primary);position:relative;transition:transform .16s ease, box-shadow .16s ease}
  .modal-event:hover{transform:translateX(2px);box-shadow:0 6px 18px rgba(0,0,0,.18)}
  .modal-event.wife{border-left-color:#ec4899}
  .modal-event.kids,.modal-event.ziggy,.modal-event.gus{border-left-color:#10b981}
  .modal-event.family{border-left-color:#f59e0b}
  .modal-event.deadline{border-left-color:#ef4444}
  .modal-event .row{display:flex;gap:6px;align-items:center}
  .modal-event .title{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  .event-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px;opacity:0;transition:opacity .18s ease}
  .modal-event:hover .event-actions{opacity:1}
  .event-action-btn{background: var(--card);border:1px solid var(--line);border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.8rem;color:var(--text);text-decoration:none;transition:transform .16s ease, filter .16s ease}
  .event-action-btn:hover{transform:scale(1.06)}
  .event-action-btn.edit{color:var(--primary)}
  .event-action-btn.delete{color:var(--danger)}

  .modal-actions{margin-top:16px;padding-top:12px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:center}
  .modal-btn{padding:10px 16px;border-radius:10px;font-weight:800;cursor:pointer;transition:transform .16s ease;text-decoration:none;border:none;background:var(--panel);color:var(--text)}
  .modal-btn:hover{transform:translateY(-1px)}
  .modal-btn.primary{background:var(--primary);color:#fff}
  .modal-btn.primary:hover{filter:brightness(1.05)}
  .no-events-message{text-align:center;color:var(--text-muted);padding:18px;font-style:italic}

  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideIn{from{opacity:0;transform:translate(-50%,-45%)}to{opacity:1;transform:translate(-50%,-50%)}}
  @media (prefers-reduced-motion:reduce){.nav-btn,.day-cell,.modal-event{transition:none}}
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">

  <!-- NAVIGATION -->
  <div class="calendar-nav" id="topNav">
    <!-- LEFT: Prev / Next / Today -->
    <div class="nav-buttons">
      {% set prev_month = month_start - timedelta(days=1) %}
      <a href="{{ url_for('daily.calendar_view', view='month', month=prev_month.strftime('%Y-%m')) }}" class="nav-btn" id="btnPrev">‚Üê Previous</a>

      {% set next_month = month_end + timedelta(days=1) %}
      <a href="{{ url_for('daily.calendar_view', view='month', month=next_month.strftime('%Y-%m')) }}" class="nav-btn" id="btnNext">Next ‚Üí</a>

      <a href="{{ url_for('daily.calendar_view', view='month', month=today.strftime('%Y-%m')) }}" class="nav-btn" id="btnToday">‚ö° Today</a>
    </div>

    <div class="month-title">{{ month_start.strftime('%B %Y') }}</div>

    <!-- RIGHT: Analytics / TimeTree (orange) / More dropdown -->
    <div class="nav-buttons">
      <a href="{{ url_for('daily.calendar_analytics') }}" class="nav-btn">üìä Analytics</a>
      <a href="javascript:void(0)" class="nav-btn warning" onclick="checkTimeTree()">üì± Check TimeTree</a>

      <div class="dropdown" id="moreMenu">
        <a class="nav-btn dropdown-toggle" onclick="toggleDropdown(event)">‚ãØ More ‚ñæ</a>
        <div class="dropdown-menu" role="menu" aria-label="More">
          <a class="dropdown-item" href="{{ url_for('daily.calendar_view', view='week') }}">üìÖ Week View</a>
          <a class="dropdown-item" href="{{ url_for('daily.add_event') }}">‚ûï Add Event</a>
          <a class="dropdown-item" href="{{ url_for('daily.index') }}">‚Üê Back to Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Legends -->
    <div class="chip-legend" style="flex-basis:100%;justify-content:center">
      <span class="chip"><span class="dot me"></span>Me</span>
      <span class="chip"><span class="dot wife"></span>Wife</span>
      <span class="chip"><span class="dot kids"></span>Kids</span>
      <span class="chip"><span class="dot family"></span>Family</span>
      <span class="chip"><span class="dot deadline"></span>Deadline</span>
    </div>
  </div>

  <!-- MONTH STATS -->
  <div class="month-stats">
    <div class="stat-card"><div class="stat-value">{{ events|length }}</div><div class="stat-label">Total Events</div></div>
    <div class="stat-card"><div class="stat-value">{{ events|selectattr('who','equalto','Me')|list|length }}</div><div class="stat-label">Your Events</div></div>
    <div class="stat-card"><div class="stat-value">{{ events|selectattr('who','equalto','Wife')|list|length }}</div><div class="stat-label">Wife's Events</div></div>
    <div class="stat-card"><div class="stat-value">{{ events|selectattr('who','in',['Ziggy','Gus'])|list|length }}</div><div class="stat-label">Kid Events</div></div>
    <div class="stat-card"><div class="stat-value">{{ project_deadlines|length if project_deadlines else 0 }}</div><div class="stat-label">Deadlines</div></div>
  </div>

  <!-- CALENDAR GRID -->
  <div class="calendar-grid">
    <div class="weekday-headers">
      <div class="weekday-header">Sun</div><div class="weekday-header">Mon</div><div class="weekday-header">Tue</div>
      <div class="weekday-header">Wed</div><div class="weekday-header">Thu</div><div class="weekday-header">Fri</div><div class="weekday-header">Sat</div>
    </div>

    <div class="month-days">
      {% set todays_monday = today - timedelta(days=today.weekday()) %}
      {% for day_info in calendar_days %}
        {% set total_items = (day_info.events|length) + (day_info.deadlines|length) %}
        {% set density = 0 if total_items == 0 else 1 if total_items <= 2 else 2 if total_items <= 4 else 3 if total_items <= 6 else 4 %}

        {# Combine deadlines + events to render first 3 and count remainder (fixes +X more) #}
        {% set all_items = day_info.deadlines + day_info.events %}

        <div
          class="day-cell density-{{ density }} {% if not day_info.is_current_month %}other-month{% endif %} {% if day_info.is_today %}today{% endif %} {% if day_info.is_weekend %}weekend{% endif %}"
          onclick="showDayDetails('{{ day_info.date.strftime('%Y-%m-%d') }}')"
          {% if day_info.is_today %}id="todayCell"{% endif %}
        >
          <span class="ring" aria-hidden="true"></span>

          <div class="day-number">
            <span>{{ day_info.day }}</span>

            {# Compute correct week_offset without changing routes #}
            {% set target_monday = day_info.date - timedelta(days=day_info.date.weekday()) %}
            {% set week_offset = ((target_monday - todays_monday).days // 7) %}
            <a class="wk-link"
               href="{{ url_for('daily.calendar_view', view='week', week_offset=week_offset) }}"
               title="Open in Week View">Week</a>
          </div>

          {# First 3 items #}
          {% for item in all_items[:3] %}
            {% if item.name is defined %}
              <div class="event-chip deadline" title="DEADLINE: {{ item.name }}">
                <span class="icon">‚ö†Ô∏è</span>
                <span class="label">{{ item.name|truncate(18, True, '‚Ä¶') }}</span>
              </div>
            {% else %}
              <div class="event-chip {% if item.who == 'Wife' %}wife{% elif item.who in ['Ziggy','Gus'] %}kids{% elif item.who == 'Family' %}family{% endif %}"
                   title="{{ item.event_time or '' }} - {{ item.event_type }} ({{ item.who }})">
                {% if item.event_time %}<span class="icon">{{ item.event_time|truncate(8, True, '') }}</span>{% endif %}
                <span class="label">{{ item.event_type|truncate(20, True, '‚Ä¶') }}</span>
                {% if item.recurring_id %}<span class="recurring-indicator">‚Üª</span>{% endif %}
              </div>
            {% endif %}
          {% endfor %}

          {% set remaining = (all_items|length - 3) if (all_items|length > 3) else 0 %}
          {% if remaining > 0 %}
            <div class="more-events">
              <a href="javascript:void(0)" onclick="showDayDetails('{{ day_info.date.strftime('%Y-%m-%d') }}')" tabindex="0">+{{ remaining }} more</a>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeDayModal()"></div>
<div class="day-modal" id="dayModal" role="dialog" aria-modal="true" aria-labelledby="modalDate">
  <div class="modal-header">
    <h3 class="modal-title" id="modalDate">Date</h3>
    <button class="close-btn" onclick="closeDayModal()" aria-label="Close">√ó</button>
  </div>
  <div class="modal-events" id="modalContent"></div>
  <div class="modal-actions">
    <button class="modal-btn primary" id="addEventBtn">‚ûï Add Event</button>
    <button class="modal-btn" onclick="closeDayModal()">Close</button>
  </div>
</div>

<!-- Hidden form for delete (kept for consistency with week) -->
<form id="deleteForm" method="POST" style="display:none">
  <input type="hidden" name="return_to" value="calendar">
  <input type="hidden" name="delete_all_recurring" id="deleteAllRecurring" value="no">
</form>
{% endblock %}

{% block extra_js %}
<script>
  let currentDayEvents = [];

  function toggleDropdown(e){
    e.stopPropagation();
    document.getElementById('moreMenu').classList.toggle('open');
  }
  document.addEventListener('click', ()=> {
    document.getElementById('moreMenu')?.classList.remove('open');
  });

  function showDayDetails(dateStr){
    const date = new Date(dateStr);
    const options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    document.getElementById('modalDate').textContent = date.toLocaleDateString('en-US', options);
    document.getElementById('addEventBtn').onclick = function(){
      window.location.href = `{{ url_for('daily.add_event') }}?date=${dateStr}`;
    };

    fetch(`{{ url_for('daily.api_get_events', date_str='') }}${dateStr}`)
      .then(r => r.json())
      .then(data => {
        currentDayEvents = data.events || [];
        const content = document.getElementById('modalContent');
        content.innerHTML = '';

        const hasEvents = data.events && data.events.length;
        const hasDeadlines = data.deadlines && data.deadlines.length;

        if (!hasEvents && !hasDeadlines){
          content.innerHTML = '<div class="no-events-message">No events scheduled for this day</div>';
        } else {
          if (hasDeadlines){
            data.deadlines.forEach(d => {
              const el = document.createElement('div');
              el.className = 'modal-event deadline';
              el.innerHTML = `
                <div class="row"><span class="title" style="font-weight:700;color:#ef4444">‚ö†Ô∏è DEADLINE: ${d.name}</span></div>
                <div style="font-size:14px;color:var(--text-muted)">Priority: ${d.priority || 'Medium'}</div>
              `;
              content.appendChild(el);
            });
          }
          if (hasEvents){
            data.events.forEach(event => {
              const whoClass = (event.who||'').toLowerCase().replace(' ','-');
              const el = document.createElement('div');
              el.className = `modal-event ${whoClass}`;
              const safeTime = (event.time || 'All Day');
              const safeType = (event.type || '');
              el.innerHTML = `
                <div class="event-actions">
                  <a href="/daily/events/${event.id}/edit?return_to=calendar" class="event-action-btn edit" title="Edit">‚úèÔ∏è</a>
                  <button class="event-action-btn delete" onclick="quickDeleteEvent(${event.id})" title="Delete">üóëÔ∏è</button>
                </div>
                <div class="row" style="font-weight:700;margin-bottom:4px;">
                  <span class="title">${safeTime} - ${safeType}${event.is_recurring ? '<span style="color:var(--info);margin-left:8px;">‚Üª Recurring</span>' : ''}</span>
                </div>
                <div style="font-size:14px;color:var(--text-muted)">Who: ${event.who||'‚Äî'}</div>
                ${event.description ? `<div style="font-size:13px;margin-top:6px;color:var(--text)">${event.description}</div>` : ''}
              `;
              content.appendChild(el);
            });
          }
        }
      })
      .catch(err => {
        console.error('Error fetching events:', err);
        document.getElementById('modalContent').innerHTML =
          '<div class="no-events-message" style="color:var(--danger)">Error loading events</div>';
      });

    document.getElementById('modalOverlay').classList.add('show');
    document.getElementById('dayModal').classList.add('show');
  }

  function closeDayModal(){
    document.getElementById('modalOverlay').classList.remove('show');
    document.getElementById('dayModal').classList.remove('show');
  }

  function quickDeleteEvent(eventId){
    const event = currentDayEvents.find(e => e.id === eventId);
    let confirmMsg = 'Are you sure you want to delete this event?';
    if (event && event.is_recurring){
      if (confirm('This is a recurring event.\n\nClick OK to delete ALL future occurrences\nClick Cancel to delete only this instance')){
        document.getElementById('deleteAllRecurring').value = 'yes';
        confirmMsg = 'Delete ALL future occurrences of this event?';
      } else {
        document.getElementById('deleteAllRecurring').value = 'no';
        confirmMsg = 'Delete only this instance?';
      }
    }
    if (confirm(confirmMsg)){
      fetch(`{{ url_for('daily.quick_delete_event', event_id=0) }}`.replace('0', eventId), {
        method:'POST', headers:{'Content-Type':'application/json'}
      })
      .then(r => r.json())
      .then(data => { if (data.success){ location.reload(); } else { alert('Failed to delete event'); }})
      .catch(err => { console.error('Error:', err); alert('Failed to delete event'); });
    }
  }

  function checkTimeTree(){
    if (confirm('üì± Open TimeTree App?\n\nThis will redirect you to TimeTree for family calendar sync.')){
      window.open('https://timetreeapp.com', '_blank');
    }
  }

  // Keyboard niceties
  document.addEventListener('keydown', (e)=>{
    const modalOpen = document.getElementById('dayModal').classList.contains('show');
    if (e.key === 'Escape' && modalOpen) closeDayModal();
    if (!modalOpen){
      if (e.key === 'ArrowLeft'){ document.getElementById('btnPrev')?.click(); }
      if (e.key === 'ArrowRight'){ document.getElementById('btnNext')?.click(); }
      if (e.key.toLowerCase() === 't'){ document.getElementById('btnToday')?.click(); }
    }
  });

  // Subtle highlight & center on today if present
  (function(){
    const todayCell = document.getElementById('todayCell');
    if (todayCell){
      todayCell.animate([{boxShadow:'0 0 0 0px rgba(255,255,255,0)'},{boxShadow:'0 0 0 10px rgba(255,255,255,0.06)'}],{duration:600,iterations:1});
      if (todayCell.getBoundingClientRect().top < 0 || todayCell.getBoundingClientRect().bottom > window.innerHeight){
        todayCell.scrollIntoView({block:'center', behavior:'smooth'});
      }
    }
  })();
</script>
{% endblock %}
