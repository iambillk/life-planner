<!-- templates/persprojects/index.html - FIXED VERSION with status_counts -->
{% extends "base.html" %}
{% block title %}Personal Projects{% endblock %}
{% block header %}Personal Projects{% endblock %}

{% block extra_css %}
<style>
  /* ========= Page-scoped CSS (dark theme) ======================================= */
  :root{
    --pp-bg: var(--bg, #0b0f1a);
    --pp-panel: var(--panel, #121a2a);
    --pp-card: var(--card, #0f1625);
    --pp-line: var(--line, #1f2a3d);
    --pp-text: var(--text, #e6eaf2);
    --pp-muted: var(--text-muted, #9fb0c8);
    --pp-primary: var(--primary, #6ea8ff);
    --pp-primary-700: var(--primary-700, #3f7fe6);
    --pp-success: var(--success, #22c55e);
    --pp-warn: var(--warning, #f59e0b);
    --pp-danger: var(--danger, #ef4444);

    --pp-radius: var(--radius, 14px);
    --pp-radius-sm: var(--radius-sm, 10px);
    --pp-shadow: 0 6px 18px rgba(0,0,0,.35);
  }

  .projects-container{ display:grid; gap:16px; }

  /* ======= Page Header ======= */
  .page-header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 16px;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--pp-line); border-radius: var(--pp-radius);
    box-shadow: var(--pp-shadow);
  }
  .page-header h1{ margin:0; font-size:1.15rem; letter-spacing:.2px; font-weight:650; }
  .page-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:12px; border:1px solid var(--pp-line);
    background:var(--pp-card); color:var(--pp-text); text-decoration:none;
    transition:transform .1s ease, border-color .2s ease, background .2s ease;
    font-size:.95rem; cursor:pointer;
  }
  .btn:hover{ border-color:var(--pp-primary); transform:translateY(-1px); }
  .btn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .btn-primary:hover{ background: rgba(110,168,255,.25); }
  .btn-sm{ padding:6px 10px; border-radius:10px; font-size:.85rem; }

  /* ======= Controls Row ======= */
  .controls{ display:grid; gap:12px; }
  .controls-row{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:12px; background:var(--pp-card); border:1px solid var(--pp-line);
    border-radius:var(--pp-radius-sm);
  }
  .search-input{
    flex:1; padding:10px 14px; border:1px solid var(--pp-line);
    background:var(--pp-panel); border-radius:10px; color:var(--pp-text);
    min-width:200px; font-size:.95rem;
  }
  .search-input:focus{ outline:none; border-color:var(--pp-primary); }
  .search-input::placeholder{ color:var(--pp-muted); }
  
  .select{
    padding:10px 14px; border:1px solid var(--pp-line);
    background:var(--pp-panel); border-radius:10px; color:var(--pp-text);
    font-size:.95rem; cursor:pointer;
  }
  .select:focus{ outline:none; border-color:var(--pp-primary); }

  /* ======= Filter Tabs ======= */
  .filter-tabs{
    display:flex; gap:6px; flex-wrap:wrap;
    padding:12px; background:var(--pp-card); border:1px solid var(--pp-line);
    border-radius:var(--pp-radius-sm);
  }
  .tab{
    padding:8px 14px; border-radius:10px; text-decoration:none;
    background:var(--pp-panel); color:var(--pp-muted); transition:all .2s;
    border:1px solid transparent; font-size:.9rem; cursor:pointer;
  }
  .tab:hover{ border-color:var(--pp-primary); color:var(--pp-text); }
  .tab.active{ 
    background:rgba(110,168,255,.18); color:var(--pp-primary); 
    border-color:rgba(110,168,255,.45); 
  }
  .tab .badge{
    display:inline-block; margin-left:4px; padding:1px 6px;
    background:rgba(110,168,255,.25); border-radius:999px;
    font-size:.75rem; font-weight:700;
  }

  /* ======= Category Chips ======= */
  .category-chips{
    display:flex; gap:6px; flex-wrap:wrap;
    padding:12px; background:var(--pp-card); border:1px solid var(--pp-line);
    border-radius:var(--pp-radius-sm);
  }
  .chip{
    padding:6px 12px; border-radius:999px; font-size:.85rem;
    background:var(--pp-panel); color:var(--pp-muted); cursor:pointer;
    border:1px solid transparent; transition:all .2s;
  }
  .chip:hover{ border-color:var(--pp-primary); color:var(--pp-text); }
  .chip.active{ 
    background:rgba(110,168,255,.18); color:var(--pp-primary); 
    border-color:rgba(110,168,255,.45); 
  }

  /* ======= Projects Grid ======= */
  .projects-grid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(380px, 1fr));
    gap:16px;
  }

  /* ======= Project Card ======= */
  .project-card{
    background:var(--pp-card); border:1px solid var(--pp-line);
    border-radius:var(--pp-radius); padding:14px;
    box-shadow:var(--pp-shadow); transition:transform .15s ease, border-color .2s;
    display:flex; flex-direction:column; gap:10px;
    position:relative; overflow:visible;
  }
  .project-card:hover{ transform:translateY(-2px); border-color:var(--pp-primary); }

  /* Priority Ribbon */
  .priority-ribbon{
    position:absolute; top:-1px; right:14px;
    padding:6px 12px; border-radius:0 0 8px 8px;
    font-size:.7rem; font-weight:800; letter-spacing:.5px;
    text-transform:uppercase; z-index:2;
  }
  .priority-low{ background:#4b5563; color:#e2e8f0; }
  .priority-medium{ background:#3b82f6; color:#0a0f1a; }
  .priority-high{ background:#f59e0b; color:#0a0f1a; }
  .priority-critical{ background:#ef4444; color:#fff; animation: pulse 2s infinite; }

  @keyframes pulse{
    0%, 100%{ opacity:1; }
    50%{ opacity:.8; }
  }

  /* Card Header */
  .project-header{ display:flex; justify-content:space-between; align-items:flex-start; }
  .project-name{ 
    font-size:1.05rem; font-weight:700; color:var(--pp-text); 
    margin:0 0 8px 0; letter-spacing:.3px;
  }

  /* Status & Category Badges */
  .project-badges{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
  .status-badge{
    padding:4px 10px; border-radius:8px; font-size:.7rem;
    font-weight:800; text-transform:uppercase; letter-spacing:.3px;
  }
  .status-planning{ background:#64748b; color:#0a0f1a; }
  .status-active{ background:#3b82f6; color:#0a0f1a; }
  .status-on_hold, .status-on-hold{ background:#f59e0b; color:#0a0f1a; }
  .status-completed{ background:#22c55e; color:#0a0f1a; }

  .category-badge{
    padding:4px 10px; border-radius:8px; font-size:.7rem;
    font-weight:700; text-transform:uppercase;
    background:var(--pp-panel); color:var(--pp-muted);
    border:1px solid var(--pp-line);
  }
  
  /* Special category colors */
  .category-home-improvement{ background:#8b5cf6; color:#0a0f1a; }
  .category-hobbies-crafts{ background:#ec4899; color:#0a0f1a; }
  .category-learning-education{ background:#3b82f6; color:#0a0f1a; }
  .category-health-fitness{ background:#10b981; color:#0a0f1a; }
  .category-financial{ background:#f59e0b; color:#0a0f1a; }
  .category-travel{ background:#06b6d4; color:#0a0f1a; }
  .category-creative{ background:#a855f7; color:#0a0f1a; }
  .category-family-relationships{ background:#f43f5e; color:#0a0f1a; }
  .category-organization{ background:#6366f1; color:#0a0f1a; }

  /* Goal & Description boxes */
  .project-goal, .project-desc{
    background:#0c1322; border:1px solid var(--pp-line); border-radius:10px;
    color:var(--pp-text); font-size:.92rem; padding:10px; margin-bottom:10px;
  }
  .project-goal strong, .project-desc strong{ 
    color:var(--pp-primary); font-weight:700; 
  }

  /* Project Meta */
  .project-meta{ 
    margin:12px 0; padding-top:10px; 
    border-top:1px dashed var(--pp-line); 
  }
  .deadline{ 
    color:var(--pp-muted); font-size:.9rem; margin-bottom:8px; 
    display:flex; align-items:center; gap:6px;
  }
  .overdue-badge{
    display:inline-block; margin-left:6px; padding:2px 6px; border-radius:6px;
    background:var(--pp-danger); color:#0a0f1a; font-size:.72rem; 
    font-weight:800; animation: blink 2s infinite;
  }
  @keyframes blink{
    0%, 100%{ opacity:1; }
    50%{ opacity:.6; }
  }

  /* Progress Bar */
  .progress-bar{
    background:#0c1322; border:1px solid var(--pp-line);
    height:10px; border-radius:999px; overflow:hidden; margin-bottom:6px;
  }
  .progress-fill{ 
    background: linear-gradient(90deg, var(--pp-primary), var(--pp-primary-700)); 
    height:100%; transition: width .3s; 
  }
  .progress-text{ 
    font-size:.8rem; color:var(--pp-muted); 
    text-align:center; margin-bottom:8px;
  }

  /* Stats */
  .project-stats{ 
    display:flex; gap:12px; margin:10px 0; font-size:.85rem; 
    color:var(--pp-muted); flex-wrap:wrap; 
  }
  .project-stats span{ 
    display:inline-flex; align-items:center; gap:6px; 
  }

  /* Actions */
  .project-actions{ 
    display:flex; gap:8px; margin-top:auto; padding-top:8px;
  }

  /* Empty State */
  .empty-state{
    grid-column:1 / -1; text-align:center; padding:60px 20px; 
    color:var(--pp-muted);
    background:var(--pp-card); border:1px dashed var(--pp-line); 
    border-radius: var(--pp-radius);
  }
  .empty-state .icon{ 
    font-size:48px; margin-bottom:16px; opacity:.5; 
  }
  .empty-state h3{ 
    margin:6px 0 12px; color:var(--pp-text); font-size:1.2rem; 
  }
  .empty-state p{ margin-bottom:20px; }

  /* Stats summary bar */
  .stats-bar{
    display:flex; gap:20px; flex-wrap:wrap; justify-content:center;
    padding:14px; background:var(--pp-card); border:1px solid var(--pp-line);
    border-radius:var(--pp-radius-sm); margin-bottom:16px;
  }
  .stat-item{
    display:flex; align-items:center; gap:8px;
    color:var(--pp-muted);
  }
  .stat-item .number{
    font-size:1.2rem; font-weight:700; color:var(--pp-text);
  }

  /* Responsive */
  @media (max-width: 768px){
    .projects-grid{ grid-template-columns: 1fr; }
    .controls-row{ flex-direction:column; }
    .search-input{ width:100%; }
  }

  /* Screen reader only */
  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
</style>
{% endblock %}

{% block content %}
<div class="projects-container" id="personal-projects">
  
  <!-- ====================== HEADER ======================= -->
  <div class="page-header">
    <h1>
      <span aria-hidden="true">🎯</span> Personal Projects
    </h1>
    <div class="page-actions">
      <a href="{{ url_for('persprojects.add') }}" class="btn btn-primary" title="Create a new personal project">
        <span aria-hidden="true">➕</span> New Project
      </a>
    </div>
  </div>

  <!-- =================== STATS SUMMARY =================== -->
  <div class="stats-bar">
    <div class="stat-item">
      <span aria-hidden="true">📊</span>
      <span class="number">{{ (status_counts.planning|default(0)) + (status_counts.active|default(0)) + (status_counts.on_hold|default(0)) + (status_counts.completed|default(0)) }}</span>
      <span>Total Projects</span>
    </div>
    <div class="stat-item">
      <span aria-hidden="true">🚀</span>
      <span class="number">{{ status_counts.active|default(0) }}</span>
      <span>Active</span>
    </div>
    <div class="stat-item">
      <span aria-hidden="true">✅</span>
      <span class="number">{{ status_counts.completed|default(0) }}</span>
      <span>Completed</span>
    </div>
    <div class="stat-item">
      <span aria-hidden="true">⏳</span>
      <span class="number">{{ projects|selectattr('deadline')|list|length }}</span>
      <span>With Deadlines</span>
    </div>
  </div>

  <!-- =================== CONTROLS ======================== -->
  <div class="controls">
    <!-- Search & Sort Row -->
    <div class="controls-row" role="group" aria-label="Search and sort">
      <input id="searchProjects" class="search-input" type="search" 
             placeholder="🔍 Search projects..." autocomplete="off" />
      <select id="sortProjects" class="select" aria-label="Sort projects">
        <option value="updated_desc">📅 Recently Updated</option>
        <option value="deadline_asc">⏰ Earliest Deadline</option>
        <option value="progress_desc">📈 Highest Progress</option>
        <option value="priority_desc">🔥 Highest Priority</option>
        <option value="name_asc">🔤 Name (A-Z)</option>
        <option value="created_desc">✨ Newest First</option>
      </select>
    </div>

    <!-- Status Filter Tabs -->
    <div class="filter-tabs" role="tablist" aria-label="Status filter">
      <a href="{{ url_for('persprojects.index', status='all') }}"
         class="tab {% if status_filter == 'all' %}active{% endif %}" 
         role="tab" aria-selected="{{ 'true' if status_filter == 'all' else 'false' }}">
        All Projects
      </a>
      <a href="{{ url_for('persprojects.index', status='planning') }}"
         class="tab {% if status_filter == 'planning' %}active{% endif %}" 
         role="tab">
        📝 Planning
        {% if status_counts.planning > 0 %}<span class="badge">{{ status_counts.planning }}</span>{% endif %}
      </a>
      <a href="{{ url_for('persprojects.index', status='active') }}"
         class="tab {% if status_filter == 'active' %}active{% endif %}" 
         role="tab">
        🚀 Active
        {% if status_counts.active > 0 %}<span class="badge">{{ status_counts.active }}</span>{% endif %}
      </a>
      <a href="{{ url_for('persprojects.index', status='on_hold') }}"
         class="tab {% if status_filter == 'on_hold' %}active{% endif %}" 
         role="tab">
        ⏸️ On Hold
        {% if status_counts.on_hold > 0 %}<span class="badge">{{ status_counts.on_hold }}</span>{% endif %}
      </a>
      <a href="{{ url_for('persprojects.index', status='completed') }}"
         class="tab {% if status_filter == 'completed' %}active{% endif %}" 
         role="tab">
        ✅ Completed
        {% if status_counts.completed > 0 %}<span class="badge">{{ status_counts.completed }}</span>{% endif %}
      </a>
    </div>

    <!-- Category Filter -->
    <div class="category-chips" role="group" aria-label="Category filter">
      <span class="chip active" data-category="all" onclick="filterCategory('all')">
        All Categories
      </span>
      {% for cat in categories %}
      <span class="chip" data-category="{{ cat|lower|replace(' ', '-') }}" 
            onclick="filterCategory('{{ cat|lower|replace(' ', '-') }}')">
        {{ cat }}
      </span>
      {% endfor %}
    </div>
  </div>

  <!-- =================== PROJECTS GRID =================== -->
  <div class="projects-grid" id="projectsGrid">
    {% for project in projects %}
    <div class="project-card" 
         data-name="{{ project.name|lower }}"
         data-category="{{ (project.category or 'other')|lower|replace(' ', '-') }}"
         data-status="{{ project.status }}"
         data-priority="{{ project.priority }}"
         data-progress="{{ project.progress }}"
         data-created="{{ project.created_at.isoformat() }}"
         data-updated="{{ project.updated_at.isoformat() }}"
         data-deadline="{{ project.deadline.isoformat() if project.deadline else '9999' }}">
      
      <!-- Priority Ribbon -->
      <div class="priority-ribbon priority-{{ project.priority }}">
        {% if project.priority == 'critical' %}🔥{% endif %}
        {{ project.priority|upper }}
      </div>

      <!-- Project Name -->
      <h3 class="project-name">{{ project.name }}</h3>

      <!-- Status & Category Badges -->
      <div class="project-badges">
        <span class="status-badge status-{{ project.status }}">
          {{ project.status|replace('_', ' ')|upper }}
        </span>
        <span class="category-badge category-{{ (project.category or 'other')|lower|replace(' ', '-') }}">
          <span aria-hidden="true">🏷️</span> {{ project.category or 'Uncategorized' }}
        </span>
      </div>

      <!-- Goal (if exists) -->
      {% if project.goal %}
      <div class="project-goal">
        <strong>Goal:</strong> {{ project.goal|truncate(150) }}
      </div>
      {% endif %}

      <!-- Description (if exists) -->
      {% if project.description %}
      <div class="project-desc">
        <strong>Description:</strong> {{ project.description|truncate(200) }}
      </div>
      {% endif %}

      <!-- Meta Section -->
      <div class="project-meta">
        {% if project.deadline %}
        <div class="deadline">
          <span aria-hidden="true">📅</span>
          <span>Due: {{ project.deadline.strftime('%b %d, %Y') }}</span>
          {% set now = datetime.now().date() %}
          {% if project.deadline < now and project.status != 'completed' %}
            <span class="overdue-badge">OVERDUE</span>
          {% endif %}
        </div>
        {% endif %}

        <!-- Progress Bar -->
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ project.progress }}%"></div>
        </div>
        <div class="progress-text">{{ project.progress }}% Complete</div>
      </div>

      <!-- Stats -->
      <div class="project-stats">
        {% if project.tasks %}
        <span><span aria-hidden="true">✅</span> {{ project.tasks|selectattr('completed')|list|length }}/{{ project.tasks|length }} tasks</span>
        {% endif %}
        {% if project.ideas %}
        <span><span aria-hidden="true">💡</span> {{ project.ideas|length }} ideas</span>
        {% endif %}
        {% if project.milestones %}
        <span><span aria-hidden="true">🏁</span> {{ project.milestones|selectattr('completed')|list|length }}/{{ project.milestones|length }} milestones</span>
        {% endif %}
        {% if project.files %}
        <span><span aria-hidden="true">📎</span> {{ project.files|length }} files</span>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="project-actions">
        <a href="{{ url_for('persprojects.detail', id=project.id) }}" class="btn btn-sm btn-primary">
          <span aria-hidden="true">👁️</span> View
        </a>
        <a href="{{ url_for('persprojects.edit', id=project.id) }}" class="btn btn-sm">
          <span aria-hidden="true">✏️</span> Edit
        </a>
        <form method="POST" action="{{ url_for('persprojects.delete', id=project.id) }}" 
              style="display:inline;" 
              onsubmit="return confirm('Delete project: {{ project.name }}?\n\nThis will permanently delete all tasks, ideas, milestones, notes, and files.');">
          <button type="submit" class="btn btn-sm" style="border-color:var(--pp-danger); color:var(--pp-danger);">
            <span aria-hidden="true">🗑️</span> Delete
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
      <div class="icon" aria-hidden="true">📂</div>
      <h3>No personal projects found</h3>
      <p>
        {% if status_filter != 'all' %}
          No {{ status_filter|replace('_', ' ') }} projects yet.
        {% else %}
          Start organizing your life with personal projects!
        {% endif %}
      </p>
      <a href="{{ url_for('persprojects.add') }}" class="btn btn-primary">
        <span aria-hidden="true">➕</span> Create Your First Project
      </a>
    </div>
    {% endfor %}
  </div>
</div>

<!-- JavaScript for search, sort, and filter -->
<script>
// Search functionality
document.getElementById('searchProjects').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const cards = document.querySelectorAll('.project-card');
  
  cards.forEach(card => {
    const name = card.dataset.name;
    const matches = name.includes(searchTerm);
    card.style.display = matches ? '' : 'none';
  });
  
  // Show empty state if no results
  const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none');
  if (visibleCards.length === 0 && searchTerm) {
    // Could add a "no search results" message here
  }
});

// Sort functionality
document.getElementById('sortProjects').addEventListener('change', function(e) {
  const sortBy = e.target.value;
  const grid = document.getElementById('projectsGrid');
  const cards = Array.from(grid.querySelectorAll('.project-card'));
  
  cards.sort((a, b) => {
    switch(sortBy) {
      case 'updated_desc':
        return b.dataset.updated.localeCompare(a.dataset.updated);
      case 'created_desc':
        return b.dataset.created.localeCompare(a.dataset.created);
      case 'deadline_asc':
        return a.dataset.deadline.localeCompare(b.dataset.deadline);
      case 'progress_desc':
        return parseInt(b.dataset.progress) - parseInt(a.dataset.progress);
      case 'priority_desc':
        const priorityOrder = {'critical': 0, 'high': 1, 'medium': 2, 'low': 3};
        return priorityOrder[a.dataset.priority] - priorityOrder[b.dataset.priority];
      case 'name_asc':
        return a.dataset.name.localeCompare(b.dataset.name);
      default:
        return 0;
    }
  });
  
  // Re-append in new order
  cards.forEach(card => grid.appendChild(card));
});

// Category filter
let activeCategory = 'all';

function filterCategory(category) {
  activeCategory = category;
  
  // Update chip styles
  document.querySelectorAll('.category-chips .chip').forEach(chip => {
    if (chip.dataset.category === category) {
      chip.classList.add('active');
    } else {
      chip.classList.remove('active');
    }
  });
  
  // Filter cards
  document.querySelectorAll('.project-card').forEach(card => {
    if (category === 'all' || card.dataset.category === category) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// Initialize datetime for overdue checking
const datetime = { now: () => ({ date: () => new Date() }) };
</script>
{% endblock %}