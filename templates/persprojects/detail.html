{% extends "base.html" %}
{% block title %}{{ project.name }} - Personal Project{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MODAL SYSTEM - PROFESSIONAL UX ==================== */
  
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.2s ease-out;
  }
  
  .modal-overlay.show {
    display: flex;
  }
  
  .modal-content {
    background: linear-gradient(145deg, #0f1625 0%, #121a2a 100%);
    border: 1px solid rgba(110, 168, 255, 0.2);
    border-radius: 20px;
    padding: 0;
    max-width: 580px;
    width: 92%;
    max-height: 88vh;
    overflow: hidden;
    box-shadow: 
      0 25px 50px -12px rgba(0, 0, 0, 0.6),
      0 0 0 1px rgba(255, 255, 255, 0.05) inset,
      0 4px 20px rgba(110, 168, 255, 0.15);
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    transform-origin: center;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 28px;
    border-bottom: 1px solid rgba(31, 42, 61, 0.8);
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%);
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 1.35rem;
    font-weight: 700;
    color: #e6eaf2;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .close-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #e6eaf2;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .close-btn:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.4);
    color: #ef4444;
    transform: rotate(90deg);
  }
  
  .modal-body {
    padding: 28px;
    overflow-y: auto;
    max-height: calc(88vh - 140px);
  }
  
  .modal-body::-webkit-scrollbar {
    width: 8px;
  }
  
  .modal-body::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 4px;
  }
  
  .modal-body::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }
  
  .modal-body::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  
  /* Form Elements in Modals */
  .modal-content form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .form-label {
    color: #9fb0c8;
    font-size: 0.88rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .form-label .required {
    color: #ef4444;
    font-size: 1.1rem;
  }
  
  .modal-content input[type="text"],
  .modal-content input[type="date"],
  .modal-content input[type="file"],
  .modal-content select,
  .modal-content textarea {
    width: 100%;
    padding: 14px 16px;
    background: rgba(12, 19, 34, 0.6);
    border: 1.5px solid rgba(31, 42, 61, 0.8);
    border-radius: 12px;
    color: #e6eaf2;
    font-size: 0.98rem;
    font-family: inherit;
    transition: all 0.2s ease;
    outline: none;
  }
  
  .modal-content input[type="text"]::placeholder,
  .modal-content textarea::placeholder {
    color: rgba(159, 176, 200, 0.4);
  }
  
  .modal-content input[type="text"]:focus,
  .modal-content input[type="date"]:focus,
  .modal-content select:focus,
  .modal-content textarea:focus {
    border-color: #6ea8ff;
    background: rgba(12, 19, 34, 0.8);
    box-shadow: 
      0 0 0 3px rgba(110, 168, 255, 0.12),
      0 4px 12px rgba(110, 168, 255, 0.15);
  }
  
  .modal-content select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239fb0c8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 40px;
  }
  
  .modal-content textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  
  .modal-content input[type="file"] {
    padding: 12px;
    cursor: pointer;
    font-size: 0.92rem;
  }
  
  .modal-content input[type="file"]::file-selector-button {
    padding: 8px 16px;
    background: rgba(110, 168, 255, 0.12);
    border: 1px solid rgba(110, 168, 255, 0.3);
    border-radius: 8px;
    color: #6ea8ff;
    font-weight: 600;
    cursor: pointer;
    margin-right: 12px;
    transition: all 0.2s ease;
  }
  
  .modal-content input[type="file"]::file-selector-button:hover {
    background: rgba(110, 168, 255, 0.2);
    border-color: #6ea8ff;
  }
  
  /* Modal Footer/Actions */
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 8px;
  }
  
  .modal-actions .btn {
    min-width: 110px;
  }
  
  /* Helper Text */
  .form-helper {
    font-size: 0.82rem;
    color: rgba(159, 176, 200, 0.6);
    margin-top: -12px;
    line-height: 1.4;
  }
  
  /* ==================== BASE STYLES ==================== */
  
  :root{
    --pd-bg:#0b0f1a; --pd-panel:#121a2a; --pd-card:#0f1625; --pd-sub:#0c1322;
    --pd-line:#1f2a3d; --pd-text:#e6eaf2; --pd-muted:#9fb0c8;
    --pd-primary:#6ea8ff; --pd-primary-700:#3f7fe6;
    --pd-success:#22c55e; --pd-warn:#f59e0b; --pd-danger:#ef4444;
    --pd-radius:16px; --pd-radius-sm:12px;
    --pd-shadow:0 10px 24px rgba(0,0,0,.35);
  }

  body{ background:var(--pd-bg); }
  .project-page{ padding:16px; }
  .project-wrap{ max-width:1400px; margin:0 auto; display:grid; gap:16px; padding-bottom:16px; }

  /* Sticky header (hero) */
  .project-header{
    position:sticky; top:12px; z-index:6;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); padding:12px; backdrop-filter:blur(6px);
  }
  .hero-content{
    background: linear-gradient(135deg, #101927 0%, #0f1625 100%);
    border:1px solid var(--pd-line);
    border-radius:12px; padding:16px; margin-bottom:10px;
  }
  .project-title-section{ margin-bottom:6px; }
  .project-name{ margin:0 0 4px 0; font-size:1.35rem; color:var(--pd-text); font-weight:700; }
  .project-description{ color:var(--pd-muted); margin:0; }

  .project-meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .meta-chip{
    padding:6px 10px; border-radius:999px; border:1px solid var(--pd-line);
    background:var(--pd-sub); color:var(--pd-muted); font-size:.85rem;
  }
  .category-chip{ background: rgba(110,168,255,.12); border-color: rgba(110,168,255,.45); color:var(--pd-primary); }

  .header-progress{ display:flex; align-items:center; gap:12px; margin-top:8px; }
  .progress-track{ flex:1; height:10px; border-radius:999px; overflow:hidden; background:var(--pd-sub); border:1px solid var(--pd-line); }
  .progress-fill{ height:100%; background:linear-gradient(90deg, var(--pd-primary), var(--pd-primary-700)); transition:width .3s; }
  .progress-label{ font-size:.85rem; color:var(--pd-muted); min-width:80px; text-align:right; }

  .hero-actions{ display:flex; gap:8px; margin-top:8px; }
  .btn{ 
    display:inline-flex; align-items:center; gap:8px; padding:10px 18px; 
    background:#0c1322; color:var(--pd-text); border:1.5px solid var(--pd-line); 
    border-radius:12px; cursor:pointer; text-decoration:none; 
    transition:all .2s ease; font-size:.95rem; font-weight:600;
    justify-content: center;
  }
  .btn:hover{ 
    border-color:var(--pd-primary); 
    transform:translateY(-2px); 
    box-shadow: 0 4px 12px rgba(110, 168, 255, 0.2);
  }
  .btn-primary{ 
    background:linear-gradient(135deg, #6ea8ff 0%, #5a8fdb 100%);
    border-color:transparent; 
    color: #fff;
    box-shadow: 0 4px 12px rgba(110, 168, 255, 0.3);
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(110, 168, 255, 0.4);
  }
  .btn-outline {
    background: transparent;
  }
  .btn-sm{ padding:7px 14px; font-size:.88rem; border-radius:10px; }
  .btn-icon{ background:transparent; border:1px solid var(--pd-line); color:var(--pd-text); border-radius:10px; padding:6px 8px; font-size:.9rem; cursor:pointer; }
  .btn-icon:hover{ border-color:var(--pd-primary); }
  .btn-icon.btn-delete:hover{ border-color:var(--pd-danger); color:var(--pd-danger); }

  .anchor-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .anchor{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; background:var(--pd-sub); color:var(--pd-muted); border:1px solid var(--pd-line); text-decoration:none; }
  .anchor:hover{ border-color:var(--pd-primary); color:var(--pd-text); }

  /* Grid layout */
  .layout{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
    align-items:stretch;
  }

  /* Left: Tasks */
  .tasks-card{
    background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius);
    box-shadow:var(--pd-shadow); display:flex; flex-direction:column;
    height:100%; min-height:480px;
  }
  .section-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px dashed var(--pd-line); }
  .section-header h2{ margin:0; font-size:1.1rem; }
  .task-toolbar{ display:flex; gap:8px; align-items:center; padding:0 12px 8px; border-bottom:1px dashed var(--pd-line); }
  .pill{ padding:6px 10px; border:1px solid var(--pd-line); border-radius:999px; font-size:.85rem; color:var(--pd-muted); background:var(--pd-sub); cursor:pointer; }
  .pill.is-active{ color:#0a0f1a; background:var(--pd-primary); border-color:transparent; }

  .tasks-scroll{
    flex:1; min-height:0; overflow:auto; padding:12px;
    max-height:calc(100vh - 260px);
  }
  .tasks-scroll::-webkit-scrollbar{ width:8px; }
  .tasks-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:4px; }

  .task-list{ display:grid; gap:8px; }
  .task-item{ display:flex; gap:10px; align-items:flex-start; background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:12px; padding:10px; }
  .task-item.completed{ opacity:.6; }
  .task-item.completed .task-title{ text-decoration:line-through; }
  .task-item[draggable="true"]{ cursor:grab; }
  .task-item.dragging{ opacity:.5; outline:1px dashed var(--pd-primary); }

  .task-checkbox{ flex-shrink:0; margin-top:2px; accent-color:var(--pd-primary); cursor:pointer; }
  .task-content{ flex:1; min-width:0; }
  .task-title{ font-weight:700; margin-bottom:2px; font-size:.95rem; }
  .task-meta{ display:flex; gap:10px; color:var(--pd-muted); font-size:.78rem; }
  .task-actions{ display:flex; gap:6px; flex-shrink:0; }

  /* Right column */
  .rhs{ display:grid; gap:16px; align-items:start; }
  .card{ background:var(--pd-card); border:1px solid var(--pd-line); border-radius:var(--pd-radius); box-shadow:var(--pd-shadow); overflow:hidden; display:flex; flex-direction:column; height:280px; min-height:280px; }
  .card__head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px dashed var(--pd-line); }
  .card__head h2{ margin:0; font-size:1.05rem; }
  .card__body{ padding:12px; overflow:auto; flex:1; min-height:0; }
  .card__body::-webkit-scrollbar{ width:8px; }
  .card__body::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:4px; }
  .empty-state{ text-align:center; padding:10px; color:var(--pd-muted); font-size:.9rem; }

  .note-item, .idea-item, .milestone-item{
    background:var(--pd-sub); border:1px solid var(--pd-line); border-radius:10px; padding:8px; margin-bottom:8px;
  }
  .note-header{ display:flex; justify-content:space-between; margin-bottom:4px; font-size:.78rem; color:var(--pd-muted); }
  .note-category{ background:var(--pd-primary); color:#0a0f1a; padding:2px 6px; border-radius:6px; font-weight:700; font-size:.72rem; }

  .idea-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .idea-footer select{ background:#0b1120; color:var(--pd-text); border:1px solid var(--pd-line); padding:4px 8px; border-radius:6px; font-size:.85rem; }

  .milestone-item.completed{ opacity:.75; }
  .milestone-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .milestone-date{ color:var(--pd-muted); font-size:.78rem; }
  .completed-badge{ background:var(--pd-success); color:#0a0f1a; padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:800; }

  /* Docs table */
  .doc-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .vault-docs-list{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  .vault-docs-list tr{ background:var(--pd-sub); }
  .vault-docs-list td{ padding:10px; border-top:1px solid var(--pd-line); border-bottom:1px solid var(--pd-line); vertical-align:middle; }
  .vault-docs-list tr td:first-child{ border-left:1px solid var(--pd-line); border-radius:10px 0 0 10px; }
  .vault-docs-list tr td:last-child{ border-right:1px solid var(--pd-line); border-radius:0 10px 10px 0; }
  .doc-name-cell{ font-weight:700; color:var(--pd-text); }
  .doc-type{ color:var(--pd-muted); font-size:.85rem; }
  .doc-actions{ display:flex; gap:6px; justify-content:flex-end; }

  /* Attachments Emoji Grid styles */
  .attg__grid{ display:flex !important; flex-direction:column !important; gap:16px !important; }
  .attg__tile{ position:relative; width:100%; padding:18px 22px 16px !important; border-radius:18px !important; display:grid !important; grid-template-rows:auto auto; justify-items:center; align-items:center; cursor:pointer; background:var(--pd-sub); border:1px solid var(--pd-line); transition:all .2s ease; }
  .attg__tile:hover{ border-color:var(--pd-primary) !important; background:rgba(110,168,255,.05) !important; transform:translateY(-2px); }
  .attg__emoji{ width:70%; height:90px; margin:0 0 14px 0 !important; padding:0 !important; border-radius:20px !important; display:flex !important; align-items:center !important; justify-content:center !important; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08)); box-shadow:inset 0 0 0 1px var(--pd-line); font-size:44px !important; }
  .attg__emoji[data-type="pdf"]{ background-color:rgba(239,68,68,.12); }
  .attg__emoji[data-type="img"]{ background-color:rgba(59,130,246,.12); }
  .attg__emoji[data-type="sheet"]{ background-color:rgba(34,197,94,.12); }
  .attg__emoji[data-type="doc"]{ background-color:rgba(168,85,247,.12); }
  .attg__name{ text-align:center !important; font-weight:800 !important; font-size:1.05rem !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; width:92%; }
  .attg__del{ position:absolute !important; top:10px !important; right:16px !important; }
  .attg__del button{ border:1px solid var(--pd-line); background:rgba(12,17,32,.9); border-radius:10px; padding:6px 8px; opacity:.9; cursor:pointer; color:var(--pd-text); }
  .attg__del button:hover{ border-color:var(--pd-danger); color:var(--pd-danger); opacity:1; }

  /* Attachment Modal */
  .attg__modal{ position:fixed; inset:0; display:grid; place-items:center; z-index:3000; }
  .attg__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.6); }
  .attg__sheet{ position:relative; z-index:1; width:min(1100px,92vw); height:min(88vh,900px); display:flex; flex-direction:column; background:var(--pd-card); border:1px solid var(--pd-line); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.5); }
  .attg__sheetHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px dashed var(--pd-line); }
  .attg__sheetTitle{ display:flex; align-items:center; gap:10px; font-weight:800; }
  .attg__sheetActions{ display:flex; gap:8px; }
  .attg__btn{ border:1px solid var(--pd-line); background:#0b1120; color:var(--pd-text); border-radius:10px; padding:6px 10px; text-decoration:none; cursor:pointer; transition:all .2s ease; }
  .attg__btnClose:hover{ border-color:var(--pd-primary); }
  .attg__sheetBody{ padding:0; display:flex; flex:1; min-height:0; }
  .attg__viewport{ flex:1; min-height:0; display:grid; place-items:center; padding:10px; }
  .attg__hint{ color:var(--pd-muted); font-size:.95rem; }
  .attg__frame, .attg__img, .attg__text{ width:100%; height:100%; border:none; border-radius:0 0 16px 16px; background:#0b1120; color:var(--pd-text); }
  .attg__img{ object-fit:contain; }
  .attg__text{ padding:14px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
  #attgModal[hidden]{display:none!important;}

  @media (max-width:980px){
    .layout{ grid-template-columns:1fr; }
    .tasks-card{ min-height:420px; }
    .card{ height:auto; min-height:280px; }
    .modal-content { width: 96%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-page">
  <div class="project-wrap">

    <!-- Sticky Hero -->
    <div class="project-header">
      <div class="hero-content">
        <div class="project-title-section">
          <h1 class="project-name">{{ project.name }}</h1>
          {% if project.description %}
          <p class="project-description">{{ project.description }}</p>
          {% endif %}
        </div>

        <div class="project-meta">
          <span class="meta-chip category-chip">{{ project.category or 'Uncategorized' }}</span>
          <span class="meta-chip">{{ project.status|replace('_',' ')|title }}</span>
          <span class="meta-chip">{{ project.priority|title }} Priority</span>
          {% if project.deadline %}<span class="meta-chip">📅 Due {{ project.deadline.strftime('%b %d, %Y') }}</span>{% endif %}
        </div>

        <div class="header-progress">
          <div class="progress-track"><div class="progress-fill" style="width: {{ project.progress }}%"></div></div>
          <div class="progress-label">{{ project.progress }}% complete</div>
        </div>

        <div class="hero-actions">
          <a href="{{ url_for('persprojects.edit', id=project.id) }}" class="btn">✏️ Edit</a>
          <a href="{{ url_for('persprojects.index') }}" class="btn btn-outline">← Back</a>
        </div>
      </div>

      <div class="anchor-row" aria-label="Jump to">
        <a class="anchor" href="#tasks">✅ Tasks</a>
        <a class="anchor" href="#notes">📝 Notes</a>
        <a class="anchor" href="#documents">📁 Documents</a>
        <a class="anchor" href="#attachments">📎 Attachments</a>
        <a class="anchor" href="#ideas">💡 Ideas</a>
        <a class="anchor" href="#milestones">🏁 Milestones</a>
      </div>
    </div>

    <!-- Main 2-col layout -->
    <div class="layout">

      <!-- LEFT: Tasks -->
      <section class="tasks-card" id="tasks" aria-labelledby="tasks-title">
        <div class="section-header">
          <h2 id="tasks-title">✅ Tasks</h2>
          <div>
            <button class="btn btn-primary btn-sm" onclick="openModal('task-modal')">➕ Add Task</button>
          </div>
        </div>

        <!-- Filters -->
        <div class="task-toolbar" role="toolbar" aria-label="Task filters">
          <button class="pill is-active" data-filter="all" type="button">All</button>
          <button class="pill" data-filter="due" type="button">Due</button>
          {% for p in priorities %}
            <button class="pill" data-filter="priority-{{ p }}" type="button">{{ p|title }} Priority</button>
          {% endfor %}
          <button class="pill" data-filter="completed" type="button">Completed</button>
        </div>

        <div class="tasks-scroll" aria-live="polite">
          <div class="task-list">
            {% for task in project.tasks %}
            <div class="task-item {% if task.completed %}completed{% endif %}"
                 draggable="true"
                 data-priority="{{ (task.priority or 'medium')|lower }}"
                 data-completed="{{ '1' if task.completed else '0' }}"
                 data-due="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
              <input type="checkbox" class="task-checkbox"
                     data-endpoint="{{ url_for('persprojects.toggle_task', task_id=task.id) }}"
                     {% if task.completed %}checked{% endif %}>

              <div class="task-content">
                <div class="task-title">{{ task.content }}</div>
                <div class="task-meta">
                  {% if task.category %}<span>{{ task.category }}</span>{% endif %}
                  {% if task.completed_at %}<span>✓ {{ task.completed_at.strftime('%b %d') }}</span>{% endif %}
                </div>
              </div>

              <div class="task-actions">
                <a class="btn-icon" href="{{ url_for('persprojects.edit_task', task_id=task.id) }}" title="Edit">✏️</a>
                <form method="POST" action="{{ url_for('persprojects.delete_task', task_id=task.id) }}" style="display:inline;">
                  <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this task?')">🗑️</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No tasks yet. Click "Add Task".</p>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- RIGHT: Notes → Documents → Attachments → Ideas → Milestones -->
      <aside class="rhs">

        <!-- NOTES -->
        <div class="card" id="notes">
          <div class="card__head">
            <h2>📝 Notes</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('note-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for note in project.notes %}
            <div class="note-item">
              <div class="note-header">
                <span class="note-category">{{ note.category|title }}</span>
                <span class="note-date">{{ note.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
              </div>
              <div class="note-content">{{ note.content }}</div>
              <div class="inline-actions" style="margin-top:6px;">
                <a href="{{ url_for('persprojects.edit_note', note_id=note.id) }}" class="btn-icon" title="Edit">✏️</a>
                <form method="POST" action="{{ url_for('persprojects.delete_note', note_id=note.id) }}">
                  <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this note?')">🗑️</button>
                </form>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No notes yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- DOCUMENTS (Vault) -->
        <div class="card" id="documents">
          <div class="card__head">
            <h2>📁 Project Documents</h2>
            <div class="doc-toolbar">
              <span style="opacity:.65; font-size:.9rem;">List view</span>
              <button class="btn btn-primary btn-sm" onclick="openModal('doc-modal')">➕ Add</button>
            </div>
          </div>
          <div class="card__body">
            {% if vault_documents %}
              <table class="vault-docs-list">
                <tbody>
                {% for doc in vault_documents %}
                  <tr>
                    <td class="doc-name-cell">
                      {% if doc.doc_type == 'image' %}🖼️{% elif doc.doc_type == 'contract' %}📜{% elif doc.doc_type in ['invoice','receipt'] %}🧾{% elif doc.doc_type == 'spreadsheet' %}📊{% elif doc.doc_type == 'note' %}📝{% elif 'pdf' in (doc.mime_type or '') %}📕{% else %}📄{% endif %}
                      {{ doc.title }}
                      <div class="doc-type">{{ doc.doc_type|title }} • {{ doc.created_at.strftime('%b %d, %Y') }}</div>
                    </td>
                    <td class="doc-actions">
                      <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="btn-icon" title="View">👁️</a>
                      {% if doc.file_path %}
                      <a href="{{ url_for('vault.download_file', id=doc.id) }}" class="btn-icon" title="Download">⬇</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="empty-state">No documents yet. Click Add.</p>
            {% endif %}
          </div>
        </div>

        {# ================== ATTACHMENTS: EMOJI GRID + PREVIEW ================== #}
        <div id="attachments" class="attg card">
          <div class="card__head">
            <h2>📎 Attachments</h2>
            <span class="doc-type" style="opacity:.7;">tap a tile to preview</span>
          </div>
          <div class="card__body">
            {% if project.files and project.files|length %}
              <div class="attg__grid">
                {% for f in project.files %}
                  {% set name = (f.original_name or 'file') %}
                  {% set lname = name|lower %}
                  {% set ext = lname.rsplit('.', 1)[-1] if ('.' in lname) else '' %}
                  {% set t = 'other' %}
                  {% if ext in ['pdf'] %}{% set t='pdf' %}
                  {% elif ext in ['png','jpg','jpeg','gif','webp','bmp'] %}{% set t='img' %}
                  {% elif ext in ['xls','xlsx','csv'] %}{% set t='sheet' %}
                  {% elif ext in ['doc','docx','txt','rtf','md','html','htm','odt'] %}{% set t='doc' %}
                  {% endif %}
                  {% set emoji = '📎' %}
                  {% if t=='pdf' %}{% set emoji='🅰️' %}
                  {% elif t=='img' %}{% set emoji='🖼️' %}
                  {% elif t=='sheet' %}{% set emoji='📊' %}
                  {% elif t=='doc' %}{% set emoji='📄' %}
                  {% endif %}

                  <div class="attg__tile"
                       tabindex="0"
                       role="button"
                       aria-label="Open {{ name }}"
                       data-id="{{ f.id }}"
                       data-name="{{ name }}"
                       data-type="{{ t }}"
                       data-ext="{{ ext }}"
                       data-url="{{ url_for('persprojects.view_file', file_id=f.id) }}">
                    <div class="attg__emoji" data-type="{{ t }}">{{ emoji }}</div>
                    <div class="attg__name" title="{{ name }}">{{ name }}</div>
                    <form class="attg__del" method="POST" action="{{ url_for('persprojects.delete_file', file_id=f.id) }}"
                          onsubmit="return confirm('Remove this attachment reference? (File stays on NAS)');">
                      <button type="submit" title="Remove">🗑️</button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="empty-state">No attachments referenced.</p>
            {% endif %}
          </div>
        </div>

        <!-- IDEAS -->
        <div class="card" id="ideas">
          <div class="card__head">
            <h2>💡 Ideas</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('idea-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for idea in project.ideas %}
            <div class="idea-item">
              <div class="idea-content">{{ idea.content }}</div>
              <div class="idea-footer">
                <form method="POST" action="{{ url_for('persprojects.update_idea_status', idea_id=idea.id) }}">
                  <select name="status" onchange="this.form.submit()">
                    {% for s in idea_statuses %}
                      <option value="{{ s }}" {% if idea.status == s %}selected{% endif %}>
                        {{ s|replace('_',' ')|title }}
                      </option>
                    {% endfor %}
                  </select>
                </form>
                <div class="inline-actions">
                  <a href="{{ url_for('persprojects.edit_idea', idea_id=idea.id) }}" class="btn-icon" title="Edit">✏️</a>
                  <form method="POST" action="{{ url_for('persprojects.delete_idea', idea_id=idea.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this idea?')">🗑️</button>
                  </form>
                </div>
              </div>
            </div>
            {% else %}
            <p class="empty-state">No ideas yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

        <!-- MILESTONES -->
        <div class="card" id="milestones">
          <div class="card__head">
            <h2>🏁 Milestones</h2>
            <button class="btn btn-primary btn-sm" onclick="openModal('milestone-modal')">➕ Add</button>
          </div>
          <div class="card__body">
            {% for milestone in project.milestones %}
            <div class="milestone-item {% if milestone.completed %}completed{% endif %}">
              <div class="milestone-header">
                <h4 style="margin:0; font-size:.95rem; color:var(--pd-text);">{{ milestone.title }}</h4>
                <div class="inline-actions">
                  {% if not milestone.completed %}
                  <form method="POST" action="{{ url_for('persprojects.complete_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon" title="Mark Complete">✅</button>
                  </form>
                  {% else %}
                  <span class="completed-badge">Completed</span>
                  {% endif %}
                  <a href="{{ url_for('persprojects.edit_milestone', milestone_id=milestone.id) }}" class="btn-icon" title="Edit">✏️</a>
                  <form method="POST" action="{{ url_for('persprojects.delete_milestone', milestone_id=milestone.id) }}">
                    <button type="submit" class="btn-icon btn-delete" title="Delete" onclick="return confirm('Delete this milestone?')">🗑️</button>
                  </form>
                </div>
              </div>
              {% if milestone.description %}<p style="margin:4px 0; color:var(--pd-muted); font-size:.85rem;">{{ milestone.description }}</p>{% endif %}
              {% if milestone.target_date %}<div class="milestone-date">📅 Target: {{ milestone.target_date.strftime('%b %d, %Y') }}</div>{% endif %}
            </div>
            {% else %}
            <p class="empty-state">No milestones yet. Click Add.</p>
            {% endfor %}
          </div>
        </div>

      </aside>
    </div>

  </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Task Add -->
<div id="task-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="task-modal-title">✅ Add Task</h3>
      <button class="close-btn" onclick="closeModal('task-modal')" aria-label="Close">✖</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('persprojects.add_task', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Task Description <span class="required">*</span></label>
          <input type="text" name="content" placeholder="What needs to be done?" required>
        </div>

        <div class="form-group">
          <label class="form-label">Category <span class="required">*</span></label>
          <select name="category" required>
            <option value="" disabled selected>Select category…</option>
            {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Priority <span class="required">*</span></label>
          <select name="priority" required>
            {% for p in priorities %}
              <option value="{{ p }}" {% if p == 'medium' %}selected{% endif %}>{{ p|title }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" name="due_date">
        </div>

        <div class="form-group">
          <label class="form-label">Additional Notes</label>
          <textarea name="notes" rows="4" placeholder="Any additional details or context..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('task-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Note Add -->
<div id="note-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="note-modal-title">📝 Add Note</h3>
      <button class="close-btn" onclick="closeModal('note-modal')" aria-label="Close">✖</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('persprojects.add_note', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Category <span class="required">*</span></label>
          <select name="category" required>
            {% for c in note_categories %}
              <option value="{{ c }}">{{ c|title }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Note Content <span class="required">*</span></label>
          <textarea name="content" rows="8" placeholder="Write your note here..." required></textarea>
          <div class="form-helper">💡 Supports markdown formatting</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('note-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Note</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Document Add (Vault) -->
<div id="doc-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="doc-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="doc-modal-title">📁 Add Document</h3>
      <button class="close-btn" onclick="closeModal('doc-modal')" aria-label="Close">✖</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('persprojects.upload_to_vault', project_id=project.id) }}" enctype="multipart/form-data">
        <div class="form-group">
          <label class="form-label">Choose File <span class="required">*</span></label>
          <input type="file" name="file" required accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.zip">
          <div class="form-helper">📎 Supported: PDF, Word, Excel, Images, Text, ZIP</div>
        </div>

        <div class="form-group">
          <label class="form-label">Document Title</label>
          <input type="text" name="title" placeholder="Leave blank to use filename">
        </div>

        <div class="form-group">
          <label class="form-label">Document Type <span class="required">*</span></label>
          <select name="doc_type">
            <option value="document">📄 Document</option>
            <option value="contract">📜 Contract</option>
            <option value="invoice">🧾 Invoice</option>
            <option value="receipt">🧾 Receipt</option>
            <option value="image">🖼️ Image</option>
            <option value="spreadsheet">📊 Spreadsheet</option>
            <option value="note">📝 Note</option>
            <option value="other">📎 Other</option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('doc-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload Document</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Idea Add -->
<div id="idea-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="idea-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="idea-modal-title">💡 Add Idea</h3>
      <button class="close-btn" onclick="closeModal('idea-modal')" aria-label="Close">✖</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('persprojects.add_idea', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Idea Description <span class="required">*</span></label>
          <textarea name="content" rows="8" placeholder="Describe your idea in detail..." required></textarea>
          <div class="form-helper">💭 No idea is too big or too small!</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('idea-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Idea</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Milestone Add -->
<div id="milestone-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="milestone-modal-title">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="milestone-modal-title">🏁 Add Milestone</h3>
      <button class="close-btn" onclick="closeModal('milestone-modal')" aria-label="Close">✖</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{{ url_for('persprojects.add_milestone', project_id=project.id) }}">
        <div class="form-group">
          <label class="form-label">Milestone Title <span class="required">*</span></label>
          <input type="text" name="title" placeholder="e.g., Launch Beta Version" required>
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description" rows="6" placeholder="What needs to be accomplished?"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Target Date</label>
          <input type="date" name="target_date">
          <div class="form-helper">📅 Optional: Set a target completion date</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('milestone-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Milestone</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function qsa(root, sel){ return Array.from((root || document).querySelectorAll(sel)); }

/* Modal System with Animations */
function openModal(id){ 
  const m=document.getElementById(id); 
  if(!m) return; 
  m.classList.add('show');
  m.style.display='flex'; 
  document.body.style.overflow='hidden'; 
  // Focus first input
  setTimeout(() => {
    const firstInput = m.querySelector('input:not([type="hidden"]), textarea, select');
    if(firstInput) firstInput.focus();
  }, 100);
}

function closeModal(id){ 
  const m=document.getElementById(id); 
  if(!m) return; 
  m.classList.remove('show');
  setTimeout(() => {
    m.style.display='none';
  }, 200);
  document.body.style.overflow=''; 
}

// Click outside to close
document.addEventListener('click', e => { 
  const ov=e.target.closest('.modal-overlay'); 
  if(ov && e.target===ov){ 
    const id = ov.getAttribute('id');
    closeModal(id);
  }
});

// ESC to close
document.addEventListener('keydown', e => { 
  if(e.key==='Escape'){ 
    qsa(document,'.modal-overlay.show').forEach(m => {
      const id = m.getAttribute('id');
      closeModal(id);
    });
  }
});

/* Task checkbox -> POST toggle */
(function(){
  const boxes=document.querySelectorAll('.task-checkbox'); if(!boxes.length) return;
  boxes.forEach(cb=>{
    cb.addEventListener('change', function(){
      const endpoint=this.getAttribute('data-endpoint'); if(!endpoint) return;
      const form=document.createElement('form');
      form.method='POST'; form.action=endpoint;
      document.body.appendChild(form); form.submit();
    });
  });
})();

/* Task filters */
(function(){
  const toolbar=document.querySelector('.task-toolbar'); if(!toolbar) return;
  function setActive(btn){ qsa(toolbar,'.pill').forEach(p=>p.classList.remove('is-active')); btn.classList.add('is-active'); }
  function isDue(iso){ if(!iso) return false; const t=new Date(); t.setHours(0,0,0,0); const d=new Date(iso+'T00:00:00'); return d<=t; }

  toolbar.addEventListener('click', (e)=>{
    const btn=e.target.closest('.pill'); if(!btn) return;
    setActive(btn); const f=btn.dataset.filter;
    qsa(document,'.task-item').forEach(el=>{
      const done=el.dataset.completed==='1';
      const pri=(el.dataset.priority||'medium').toLowerCase();
      const due=el.dataset.due||'';
      let show=true;

      if(f==='all')            show=true;
      else if(f==='due')       show=isDue(due)&&!done;
      else if(f==='completed') show=done;
      else if(f.startsWith('priority-')){
        const want=f.replace('priority-','');
        show=(pri===want)&&!done;
      }

      el.style.display=show?'':'none';
    });
  });
})();
</script>

{# ---------- Attachments Emoji Grid: Preview Modal Behavior ---------- #}
<div id="attgModal" class="attg__modal" aria-modal="true" role="dialog" hidden>
  <div class="attg__backdrop"></div>
  <div class="attg__sheet">
    <div class="attg__sheetHead">
      <div class="attg__sheetTitle">
        <span id="attgKind">📎</span>
        <span id="attgTitle">File</span>
      </div>
      <div class="attg__sheetActions">
        <a id="attgOpen" class="attg__btn" target="_blank" rel="noopener">Open in browser</a>
        <button class="attg__btn attg__btnClose" id="attgClose" aria-label="Close">✖</button>
      </div>
    </div>
    <div class="attg__sheetBody">
      <div id="attgViewport" class="attg__viewport">
        <div class="attg__hint">Loading preview…</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const gridRoot = document.getElementById('attachments');
  if(!gridRoot) return;

  const modal = document.getElementById('attgModal');
  const openLink = document.getElementById('attgOpen');
  const kindEl = document.getElementById('attgKind');
  const titleEl = document.getElementById('attgTitle');
  const viewport = document.getElementById('attgViewport');
  const closeBtn = document.getElementById('attgClose');
  const backdrop = modal.querySelector('.attg__backdrop');

  function emojiFor(type){
    return type==='pdf' ? '📕' :
           type==='img' ? '🖼️' :
           type==='sheet' ? '📊' :
           type==='doc' ? '📄' : '📎';
  }

  function clearViewport(){
    viewport.innerHTML = '<div class="attg__hint">Loading preview…</div>';
  }

  function openModalFor(tile){
    const url  = tile.dataset.url;
    const name = tile.dataset.name || 'File';
    const type = tile.dataset.type || 'other';

    kindEl.textContent  = emojiFor(type);
    titleEl.textContent = name;
    openLink.href = url;

    clearViewport();

    if(type === 'img'){
      const img = new Image();
      img.className = 'attg__img';
      img.onload = ()=> viewport.innerHTML = '', viewport.appendChild(img);
      img.onerror = ()=> viewport.innerHTML = '<div class="attg__hint">Preview unavailable. Use "Open in browser".</div>';
      img.src = url;
    } else if(type === 'pdf'){
      const frame = document.createElement('iframe');
      frame.className = 'attg__frame';
      frame.onload = ()=> {};
      frame.onerror = ()=> viewport.innerHTML = '<div class="attg__hint">PDF preview unavailable. Use "Open in browser".</div>';
      frame.src = url;
      viewport.innerHTML = '';
      viewport.appendChild(frame);
    } else if(type === 'doc' || type === 'sheet'){
      viewport.innerHTML = '<div class="attg__hint">Quick preview not supported for this file. Use "Open in browser".</div>';
    } else {
      viewport.innerHTML = '<div class="attg__hint">Preview unavailable. Use "Open in browser".</div>';
    }

    modal.hidden = false;
    document.body.style.overflow = 'hidden';
  }

  function closeModal(){
    modal.hidden = true;
    document.body.style.overflow = '';
    clearViewport();
  }

  // Open via click/keyboard; ignore clicks on delete
  gridRoot.addEventListener('click', (e)=>{
    const tile = e.target.closest('.attg__tile');
    if(!tile || e.target.closest('.attg__del')) return;
    openModalFor(tile);
  });
  gridRoot.addEventListener('keydown', (e)=>{
    const tile = e.target.closest('.attg__tile');
    if(!tile) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      openModalFor(tile);
    }
  });

  // Close handlers
  closeBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(!modal.hidden && e.key==='Escape') closeModal(); });
})();
</script>
{% endblock %}