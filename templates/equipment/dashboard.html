{# =============================================================================
  FILE: equipment_maintenance_center.html
  PURPOSE: High-level dashboard for equipment maintenance (alerts, categories, recent)
  TEMPLATE VERSION: v1.0.0
  LAST UPDATED: 2025-09-04

  HIGHLIGHTS
  - Dark, page-scoped theme (safe CSS var fallbacks to base.html)
  - Sticky top controls: quick actions + search + sort + filter chips + density toggle
  - Collapsible alert sections (Overdue / Upcoming / Seasonal) with per-section search/sort
  - CSV export of CURRENTLY FILTERED items (per alert section)
  - Category chips panel with counts
  - Responsive ‚ÄúAll Equipment‚Äù grid with cache-busted thumbs, quick actions
  - Strong comments, semantic blocks, accessible roles/labels
  - Minimal JS; all client-side‚Äîno backend changes required

  CHANGELOG
  v1.0.0
  - NEW: Dark restyle + sticky controls bar
  - NEW: Per-section search/sort + CSV export
  - NEW: Category chips & counts
  - NEW: Equipment grid polish + quick actions
  - IMP: Collapsible sections; density toggle; consistent badges
============================================================================= #}

{% extends "base.html" %}
{% block title %}Equipment Maintenance{% endblock %}
{% block header %}Equipment Maintenance Center{% endblock %}

{# ========================= EXTRA CSS (page-scoped) ========================= #}
{% block extra_css %}
<style>
  :root{
    --em-bg: var(--bg, #0b0f1a);
    --em-panel: var(--panel, #121a2a);
    --em-card: var(--card, #0f1625);
    --em-sub: #0c1322;
    --em-line: var(--line, #1f2a3d);
    --em-text: var(--text, #e6eaf2);
    --em-muted: var(--text-muted, #9fb0c8);
    --em-primary: var(--primary, #6ea8ff);
    --em-primary-700: var(--primary-700, #3f7fe6);
    --em-success: var(--success, #22c55e);
    --em-warn: var(--warning, #f59e0b);
    --em-danger: var(--danger, #ef4444);
    --em-info: #38bdf8;

    --em-radius: var(--radius, 14px);
    --em-radius-sm: var(--radius-sm, 10px);
    --em-shadow: 0 8px 24px rgba(0,0,0,.35);
  }

  .equipment-dashboard{
    max-width: 1200px; margin: 0 auto; padding: 16px; display: grid; gap: 16px;
  }

  /* ================== Sticky top controls ================== */
  .sticky-bar{
    position: sticky; top: 12px; z-index: 5;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--em-line); border-radius: var(--em-radius); padding: 12px;
    box-shadow: var(--em-shadow); backdrop-filter: blur(6px);
  }
  .bar-row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
  .quick-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:12px; border:1px solid var(--em-line);
    background: var(--em-card); color: var(--em-text); text-decoration:none;
    transition: transform .1s ease, border-color .2s ease, background .2s ease;
    font-size:.95rem;
  }
  .btn:hover{ border-color:var(--em-primary); transform: translateY(-1px); }
  .btn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .btn-secondary{ background:#0c1322; }
  .btn-outline{ background: transparent; }
  .btn-sm{ padding:6px 10px; border-radius:10px; font-size:.85rem; }

  .controls{ display:grid; gap:10px; margin-top:8px; }
  .controls-row{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background: var(--em-card); border:1px solid var(--em-line);
    border-radius: var(--em-radius); padding:10px;
  }
  .search-input, .select{
    background:#0b1120; color: var(--em-text); border:1px solid var(--em-line);
    border-radius:10px; padding:8px 12px; outline:none; font-size:.95rem;
  }
  .search-input{ min-width: 260px; }
  .select{ min-width: 220px; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; border:1px solid var(--em-line);
    background: var(--em-card); color: var(--em-muted); font-size:.9rem; text-decoration:none;
  }
  .chip.active{ color: var(--em-text); background: rgba(110,168,255,.16); border-color: rgba(110,168,255,.45); }
  .toggle-btn{
    border:1px solid var(--em-line); background:#0c1322; color:var(--em-muted);
    border-radius:10px; padding:6px 10px; cursor:pointer;
  }
  .toggle-btn.active{ color:var(--em-text); border-color: var(--em-primary); background: rgba(110,168,255,.16); }

  /* ================== Alert sections ================== */
  .section{
    background: var(--em-card); border:1px solid var(--em-line);
    border-radius: var(--em-radius); padding: 12px; box-shadow: var(--em-shadow);
  }
  .section-header{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    border-bottom:1px dashed var(--em-line); padding-bottom:6px; margin-bottom:10px;
  }
  .section-title{ margin:0; font-size:1.05rem; }

  .inline-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .export-btn{ white-space:nowrap; }

  .alert-grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:12px;
  }
  .alert-card{
    background: var(--em-sub); border:1px solid var(--em-line); border-radius:12px; padding:12px;
    display:grid; gap:8px; transition: transform .1s ease, border-color .2s ease;
  }
  .alert-card:hover{ transform: translateY(-1px); border-color: var(--em-primary); }
  .alert-meta{ display:flex; gap:8px; flex-wrap:wrap; }
  .badge{
    display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:.75rem; font-weight:800; letter-spacing:.06em;
  }
  .badge.danger{ background: var(--em-danger); color:#0a0f1a; }
  .badge.warning{ background: var(--em-warn); color:#0a0f1a; }
  .badge.info{ background: var(--em-info); color:#0a0f1a; }
  .alert-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  /* ================== Category chips ================== */
  .categories{
    background: var(--em-card); border:1px solid var(--em-line);
    border-radius: var(--em-radius); padding: 12px; box-shadow: var(--em-shadow);
  }
  .category-grid{
    display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
  }
  .category-chip{
    display:inline-flex; align-items:center; gap:8px; text-decoration:none;
    padding:8px 12px; border-radius:999px; border:1px solid var(--em-line);
    background:#0c1322; color: var(--em-text);
  }
  .category-chip .count{ background:#0b2a38; color:#cbeafe; padding:2px 8px; border-radius:999px; font-weight:800; font-size:.8rem; }

  /* ================== Equipment grid ================== */
  .equip-wrap{
    background: var(--em-card); border:1px solid var(--em-line);
    border-radius: var(--em-radius); padding: 12px; box-shadow: var(--em-shadow);
  }
  .equip-grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; margin-top:10px;
  }
  .equip-card{
    background:#0c1322; border:1px solid var(--em-line); border-radius:12px; overflow:hidden;
    transition: transform .1s ease, border-color .2s ease;
  }
  .equip-card:hover{ transform: translateY(-1px); border-color: var(--em-primary); }
  .equip-img{ width:100%; height:140px; object-fit:cover; background:#0b1120; border-bottom:1px solid var(--em-line); }
  .equip-no{ height:140px; display:flex; align-items:center; justify-content:center; font-size:2.2rem; color:#94a3b8; border-bottom:1px solid var(--em-line); }
  .equip-body{ padding:10px; }
  .equip-body h4{ margin:0 0 6px 0; font-size:1rem; }
  .equip-tags{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
  .status-badge{
    padding:4px 10px; border-radius:999px; font-size:.72rem; font-weight:800; letter-spacing:.06em; text-transform:uppercase;
  }
  .status-active{ background: var(--em-success); color:#0a0f1a; }
  .status-storage{ background:#64748b; color:#0a0f1a; }
  .status-maintenance{ background: var(--em-warn); color:#0a0f1a; }
  .status-needs_repair{ background:#e67e22; color:#0a0f1a; }
  .status-retired{ background:#334155; color:#e2e8f0; }
  .status-sold{ background: var(--em-danger); color:#0a0f1a; }
  .equip-actions{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--em-line); }
  .equip-actions a{ flex:1; text-align:center; }

  .empty-state{
    text-align:center; padding:40px 16px; background:#0c1322; border:1px dashed var(--em-line); border-radius: var(--em-radius);
    color: var(--em-muted);
  }

  /* Density toggle */
  .dense .alert-card{ padding:10px; }
  .dense .equip-card .equip-body{ padding:8px; }
  .dense .equip-actions{ padding:8px; }

  @media (max-width: 820px){
    .bar-row{ grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{# ============================== CONTENT =================================== #}
{% block content %}
<div class="equipment-dashboard" id="emRoot">

  {# =================== STICKY BAR (quick actions + global controls) =================== #}
  <div class="sticky-bar">
    <div class="bar-row">
      <div class="quick-actions">
        <a href="{{ url_for('equipment.add') }}" class="btn btn-primary">‚ûï Add Equipment</a>
        <a href="{{ url_for('equipment.by_category', category='all') }}" class="btn btn-secondary">üìã View All</a>
        <button id="densityToggle" class="btn btn-outline">‚ÜïÔ∏è Density</button>
      </div>
      <div class="inline-controls" aria-label="Global filters">
        <input id="globalSearch" class="search-input" type="search" placeholder="Quick search (equipment name/make/model)‚Ä¶" autocomplete="off">
        <select id="globalSort" class="select" aria-label="Global sort">
          <option value="priority">Sort: Alert Priority</option>
          <option value="name">Sort: Name (A‚ÄìZ)</option>
          <option value="date_desc">Sort: Due/Overdue (newest)</option>
        </select>
      </div>
    </div>
    <div class="controls">
      <div class="controls-row" role="group" aria-label="Quick chips">
        <a href="#overdueSec" class="chip">‚ö†Ô∏è Overdue</a>
        <a href="#upcomingSec" class="chip">üìÖ Upcoming</a>
        <a href="#seasonalSec" class="chip">üçÇ Seasonal</a>
        <a href="#categoriesSec" class="chip">üè∑Ô∏è Categories</a>
        <a href="#allEquipSec" class="chip">üß∞ All Equipment</a>
      </div>
    </div>
  </div>

  {# =================== OVERDUE =================== #}
  {% if overdue %}
  <div class="section" id="overdueSec">
    <div class="section-header">
      <h3 class="section-title">‚ö†Ô∏è Overdue Maintenance</h3>
      <div class="inline-controls">
        <input class="search-input sec-search" data-scope="overdue" placeholder="Search overdue‚Ä¶" aria-label="Search overdue">
        <select class="select sec-sort" data-scope="overdue" aria-label="Sort overdue">
          <option value="days_desc">Sort: Most overdue</option>
          <option value="name_asc">Sort: Name (A‚ÄìZ)</option>
          <option value="date_desc">Sort: Date (newest)</option>
        </select>
        <button class="btn btn-outline btn-sm export-btn" data-scope="overdue">‚¨áÔ∏è Export CSV</button>
        <button class="btn btn-outline btn-sm sec-toggle" data-target="#overdueList">‚ñæ Collapse</button>
      </div>
    </div>
    <div class="alert-grid" id="overdueList">
      {% for item in overdue %}
      {# item: { equipment, service, days_overdue, date? } #}
      <div class="alert-card"
           data-scope="overdue"
           data-name="{{ item.equipment.name|lower }}"
           data-days="{{ item.days_overdue or 0 }}"
           data-date="{{ item.date.strftime('%Y-%m-%d') if item.date else '' }}"
           data-priority="1">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
          <h4 style="margin:0;">{{ item.equipment.name }}</h4>
          <span class="badge danger">OVERDUE</span>
        </div>
        <div class="alert-meta" style="color:var(--em-muted);">
          <span>Service: <strong style="color:var(--em-text);">{{ item.service }}</strong></span>
          <span>Days overdue: <strong style="color:var(--em-text);">{{ item.days_overdue }}</strong></span>
        </div>
        <div class="alert-actions">
          <a class="btn btn-sm btn-primary" href="{{ url_for('equipment.add_maintenance', id=item.equipment.id) }}">Log Service</a>
          <a class="btn btn-sm" href="{{ url_for('equipment.detail', id=item.equipment.id) }}">View</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# =================== UPCOMING =================== #}
  {% if upcoming %}
  <div class="section" id="upcomingSec">
    <div class="section-header">
      <h3 class="section-title">üìÖ Upcoming Maintenance</h3>
      <div class="inline-controls">
        <input class="search-input sec-search" data-scope="upcoming" placeholder="Search upcoming‚Ä¶" aria-label="Search upcoming">
        <select class="select sec-sort" data-scope="upcoming" aria-label="Sort upcoming">
          <option value="days_asc">Sort: Due soonest</option>
          <option value="name_asc">Sort: Name (A‚ÄìZ)</option>
          <option value="date_asc">Sort: Date (earliest)</option>
        </select>
        <button class="btn btn-outline btn-sm export-btn" data-scope="upcoming">‚¨áÔ∏è Export CSV</button>
        <button class="btn btn-outline btn-sm sec-toggle" data-target="#upcomingList">‚ñæ Collapse</button>
      </div>
    </div>
    <div class="alert-grid" id="upcomingList">
      {% for item in upcoming %}
      {# item: { equipment, service, days_until, date? } #}
      <div class="alert-card"
           data-scope="upcoming"
           data-name="{{ item.equipment.name|lower }}"
           data-days="{{ item.days_until or 0 }}"
           data-date="{{ item.date.strftime('%Y-%m-%d') if item.date else '' }}"
           data-priority="2">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
          <h4 style="margin:0;">{{ item.equipment.name }}</h4>
          <span class="badge warning">UPCOMING</span>
        </div>
        <div class="alert-meta" style="color:var(--em-muted);">
          <span>Service: <strong style="color:var(--em-text);">{{ item.service }}</strong></span>
          <span>Due in: <strong style="color:var(--em-text);">{{ item.days_until }} days</strong></span>
        </div>
        <div class="alert-actions">
          <a class="btn btn-sm" href="{{ url_for('equipment.detail', id=item.equipment.id) }}">View</a>
          <a class="btn btn-sm btn-primary" href="{{ url_for('equipment.add_maintenance', id=item.equipment.id) }}">Add Service</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# =================== SEASONAL =================== #}
  {% if seasonal_reminders %}
  <div class="section" id="seasonalSec">
    <div class="section-header">
      <h3 class="section-title">üçÇ Seasonal Reminders</h3>
      <div class="inline-controls">
        <input class="search-input sec-search" data-scope="seasonal" placeholder="Search seasonal‚Ä¶" aria-label="Search seasonal">
        <select class="select sec-sort" data-scope="seasonal" aria-label="Sort seasonal">
          <option value="name_asc">Sort: Name (A‚ÄìZ)</option>
          <option value="type_asc">Sort: Service Type</option>
        </select>
        <button class="btn btn-outline btn-sm export-btn" data-scope="seasonal">‚¨áÔ∏è Export CSV</button>
        <button class="btn btn-outline btn-sm sec-toggle" data-target="#seasonalList">‚ñæ Collapse</button>
      </div>
    </div>
    <div class="alert-grid" id="seasonalList">
      {% for reminder in seasonal_reminders %}
      {# reminder: { equipment, service_type } #}
      <div class="alert-card"
           data-scope="seasonal"
           data-name="{{ reminder.equipment.name|lower }}"
           data-type="{{ reminder.service_type|lower }}"
           data-priority="3">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
          <h4 style="margin:0;">{{ reminder.equipment.name }}</h4>
          <span class="badge info">SEASONAL</span>
        </div>
        <div class="alert-meta" style="color:var(--em-muted);">
          <span>Service: <strong style="color:var(--em-text);">{{ reminder.service_type }}</strong></span>
        </div>
        <div class="alert-actions">
          <a class="btn btn-sm btn-primary" href="{{ url_for('equipment.add_maintenance', id=reminder.equipment.id) }}">Complete</a>
          <a class="btn btn-sm" href="{{ url_for('equipment.detail', id=reminder.equipment.id) }}">View</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# =================== CATEGORIES =================== #}
  <div class="categories" id="categoriesSec">
    <div class="section-header" style="border-bottom:none; margin:0 0 4px 0; padding:0;">
      <h3 class="section-title">üè∑Ô∏è Equipment by Category</h3>
    </div>
    <div class="category-grid" role="navigation" aria-label="Category filters">
      {% for cat in categories %}
        <a href="{{ url_for('equipment.by_category', category=cat) }}" class="category-chip">
          <span class="icon">
            {% if cat == 'Auto' %}üöó
            {% elif cat == 'Lawn' %}üå±
            {% elif cat == 'Marine' %}‚õµ
            {% elif cat == 'Snow' %}‚ùÑÔ∏è
            {% elif cat == 'ATV' %}üèçÔ∏è
            {% elif cat == 'Power Tools' %}‚ö°
            {% else %}üîß{% endif %}
          </span>
          <span>{{ cat }}</span>
          <span class="count">{{ equipment|selectattr('category', 'equalto', cat)|list|length }}</span>
        </a>
      {% endfor %}
      <a href="{{ url_for('equipment.by_category', category='all') }}" class="category-chip">
        <span>All</span>
        <span class="count">{{ equipment|length }}</span>
      </a>
    </div>
  </div>

  {# =================== ALL EQUIPMENT =================== #}
  <div class="equip-wrap" id="allEquipSec">
    <div class="section-header">
      <h3 class="section-title">üß∞ All Equipment</h3>
      <div class="inline-controls">
        <input id="equipSearch" class="search-input" placeholder="Search equipment‚Ä¶" aria-label="Search equipment">
        <select id="equipSort" class="select" aria-label="Sort equipment">
          <option value="updated_desc">Sort: Recently Updated</option>
          <option value="name_asc">Sort: Name (A‚ÄìZ)</option>
          <option value="status_asc">Sort: Status</option>
          <option value="year_desc">Sort: Year (newest)</option>
        </select>
      </div>
    </div>

    {% if equipment %}
    <div class="equip-grid" id="equipGrid">
      {% for item in equipment[:36] %}
        {% set last = item.maintenance_records[0] if item.maintenance_records else None %}
        {% set last_date = last.service_date.strftime('%Y-%m-%d') if last else '' %}
        <div class="equip-card"
             data-name="{{ (item.name ~ ' ' ~ (item.make or '') ~ ' ' ~ (item.model or ''))|lower }}"
             data-status="{{ item.status }}"
             data-year="{{ item.year or '0' }}"
             data-updated="{% if item.updated_at %}{{ item.updated_at.isoformat() }}{% else %}1970-01-01T00:00:00{% endif %}">
          {% if item.profile_photo %}
            <img class="equip-img"
                 src="{{ url_for('static', filename='equipment_photos/equipment_profiles/' + item.profile_photo,
                                  v=(item.updated_at.timestamp()|int if item.updated_at else 0)) }}"
                 alt="{{ item.name }}">
          {% else %}
            <div class="equip-no">üì∑</div>
          {% endif %}
          <div class="equip-body">
            <h4><a href="{{ url_for('equipment.detail', id=item.id) }}" style="color:var(--em-text); text-decoration:none;">{{ item.name }}</a></h4>
            <div class="equip-tags">
              <span class="chip">üè∑Ô∏è {{ item.category }}</span>
              <span class="status-badge status-{{ item.status }}">{{ item.status }}</span>
            </div>
            <div style="color:var(--em-muted); font-size:.9rem;">{{ item.make or '' }} {{ item.model or '' }}</div>
          </div>
          <div class="equip-actions">
            <a class="btn btn-sm" href="{{ url_for('equipment.detail', id=item.id) }}">View</a>
            <a class="btn btn-sm btn-primary" href="{{ url_for('equipment.add_maintenance', id=item.id) }}">Add Service</a>
          </div>
        </div>
      {% endfor %}
    </div>

    {% if equipment|length > 36 %}
      <div class="empty-state" style="margin-top:10px;">
        Showing first 36. <a class="btn btn-primary btn-sm" href="{{ url_for('equipment.by_category', category='all') }}">View All Equipment</a>
      </div>
    {% endif %}
    {% else %}
      <div class="empty-state">
        <div style="font-size:42px; margin-bottom:6px;">üì¶</div>
        No equipment found. <a class="btn btn-primary btn-sm" href="{{ url_for('equipment.add') }}" style="margin-left:6px;">Add Equipment</a>
      </div>
    {% endif %}
  </div>

  {# =================== PAGE FOOT / CHANGELOG =================== #}
  <div class="section" style="position:static;">
    <details>
      <summary style="cursor:pointer; font-weight:800;">Page Info & Changelog</summary>
      <code style="display:block; white-space:pre-wrap; margin-top:8px; color:var(--em-muted);">
v1.0.0 ‚Äî Dark refactor; sticky controls; per-section search/sort; CSV export; category chips; polished grid.
      </code>
    </details>
  </div>

</div><!-- /equipment-dashboard -->
{% endblock %}

{# ============================= EXTRA JS =================================== #}
{% block extra_js %}
<script>
/* ============================================================================
   Utilities (sorting, CSV, visibility) ‚Äî generic helpers
============================================================================ */
function sortNodes(nodes, compare){ return nodes.sort(compare); }
function visible(nodes){ return nodes.filter(n => n.style.display !== 'none'); }

function exportCardsToCSV(nodes, fields){
  const header = fields.map(f => `"${f.label.replace(/"/g,'""')}"`).join(',');
  const rows = [header];

  nodes.forEach(n => {
    const data = f => {
      if (f.get) return (f.get(n) || '').toString();
      return (n.dataset[f.key] || '');
    };
    const cols = fields.map(f => `"${data(f).replace(/"/g,'""')}"`);
    rows.push(cols.join(','));
  });

  const csv = rows.join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'export.csv';
  document.body.appendChild(a); a.click(); a.remove();
}

/* ============================================================================
   Section controller (search + sort + collapse + export)
   scopeId: string (overdue|upcoming|seasonal)
   containerSel: selector for the grid
   sortSpec: map of sort functions by key
   exportFields: [{ key, label, get? }]
============================================================================ */
function wireSection(scopeId, containerSel, sortSpec, exportFields){
  const grid = document.querySelector(containerSel);
  if (!grid) return;
  const cards = Array.from(grid.children);
  const search = document.querySelector(`.sec-search[data-scope="${scopeId}"]`);
  const sort = document.querySelector(`.sec-sort[data-scope="${scopeId}"]`);
  const exportBtn = document.querySelector(`.export-btn[data-scope="${scopeId}"]`);
  const toggle = document.querySelector(`.sec-toggle[data-target="${containerSel}"]`);

  function apply(){
    const q = (search?.value || '').trim().toLowerCase();
    cards.forEach(c => {
      const show = !q || (c.dataset.name || '').includes(q) || (c.dataset.type || '').includes(q);
      c.style.display = show ? '' : 'none';
    });
    const vis = visible(cards);
    const key = sort?.value || Object.keys(sortSpec)[0];
    sortNodes(vis, sortSpec[key] || (()=>0)).forEach(n => grid.appendChild(n));
  }

  search?.addEventListener('input', apply);
  sort?.addEventListener('change', apply);
  exportBtn?.addEventListener('click', () => {
    const vis = visible(cards);
    exportCardsToCSV(vis, exportFields);
  });
  toggle?.addEventListener('click', () => {
    const open = grid.style.display !== 'none';
    grid.style.display = open ? 'none' : '';
    toggle.textContent = open ? '‚ñ∏ Expand' : '‚ñæ Collapse';
  });

  apply();
}

/* ============================================================================
   Global density toggle & global controls (soft influence)
============================================================================ */
(function(){
  const root = document.getElementById('emRoot');
  const dens = document.getElementById('densityToggle');
  dens?.addEventListener('click', () => root.classList.toggle('dense'));

  // (Optional) Global search/sort nudges per-section by priority/name/date
  const gSearch = document.getElementById('globalSearch');
  const gSort = document.getElementById('globalSort');

  function forwardSearch(){
    const val = (gSearch?.value || '').trim();
    document.querySelectorAll('.sec-search').forEach(inp => {
      inp.value = val; inp.dispatchEvent(new Event('input'));
    });
  }
  function forwardSort(){
    const val = gSort?.value || 'priority';
    const map = {
      priority: { overdue:'days_desc', upcoming:'days_asc', seasonal:'name_asc' },
      name:     { overdue:'name_asc',  upcoming:'name_asc',  seasonal:'name_asc' },
      date_desc:{ overdue:'date_desc', upcoming:'date_asc',  seasonal:'name_asc' },
    }[val] || {};
    Object.entries(map).forEach(([scope, key]) => {
      const sel = document.querySelector(`.sec-sort[data-scope="${scope}"]`);
      if (sel){ sel.value = key; sel.dispatchEvent(new Event('change')); }
    });
  }

  gSearch?.addEventListener('input', forwardSearch);
  gSort?.addEventListener('change', forwardSort);
})();

/* ============================================================================
   Wire alert sections
============================================================================ */
wireSection('overdue', '#overdueList', {
  days_desc: (a,b) => (parseInt(b.dataset.days||'0',10) - parseInt(a.dataset.days||'0',10)),
  name_asc:  (a,b) => ((a.dataset.name||'') > (b.dataset.name||'') ? 1 : -1),
  date_desc: (a,b) => ((b.dataset.date||'') > (a.dataset.date||'') ? 1 : -1),
}, [
  { key:'name',   label:'Equipment', get:n => n.querySelector('h4')?.textContent?.trim() || '' },
  { key:'',       label:'Service',   get:n => (n.querySelector('.alert-meta strong')?.textContent || '') },
  { key:'days',   label:'Days Overdue' },
  { key:'date',   label:'Date' },
]);

wireSection('upcoming', '#upcomingList', {
  days_asc:  (a,b) => (parseInt(a.dataset.days||'0',10) - parseInt(b.dataset.days||'0',10)),
  name_asc:  (a,b) => ((a.dataset.name||'') > (b.dataset.name||'') ? 1 : -1),
  date_asc:  (a,b) => ((a.dataset.date||'') > (b.dataset.date||'') ? 1 : -1),
}, [
  { key:'name',   label:'Equipment', get:n => n.querySelector('h4')?.textContent?.trim() || '' },
  { key:'',       label:'Service',   get:n => (n.querySelector('.alert-meta strong')?.textContent || '') },
  { key:'days',   label:'Days Until' },
  { key:'date',   label:'Date' },
]);

wireSection('seasonal', '#seasonalList', {
  name_asc:  (a,b) => ((a.dataset.name||'') > (b.dataset.name||'') ? 1 : -1),
  type_asc:  (a,b) => ((a.dataset.type||'') > (b.dataset.type||'') ? 1 : -1),
}, [
  { key:'name',   label:'Equipment', get:n => n.querySelector('h4')?.textContent?.trim() || '' },
  { key:'type',   label:'Service Type' },
]);

/* ============================================================================
   All Equipment grid ‚Äî search + sort
============================================================================ */
(function(){
  const grid = document.getElementById('equipGrid');
  if (!grid) return;
  const cards = Array.from(grid.children);
  const s = document.getElementById('equipSearch');
  const sort = document.getElementById('equipSort');

  function apply(){
    const q = (s?.value || '').trim().toLowerCase();
    cards.forEach(c => {
      const show = !q || (c.dataset.name||'').includes(q);
      c.style.display = show ? '' : 'none';
    });

    const key = sort?.value || 'updated_desc';
    const cmp = {
      updated_desc: (a,b) => (new Date(b.dataset.updated) - new Date(a.dataset.updated)),
      name_asc:     (a,b) => ((a.dataset.name||'') > (b.dataset.name||'') ? 1 : -1),
      status_asc:   (a,b) => ((a.dataset.status||'') > (b.dataset.status||'') ? 1 : -1),
      year_desc:    (a,b) => (parseInt(b.dataset.year||'0',10) - parseInt(a.dataset.year||'0',10)),
    }[key] || (()=>0);

    sortNodes(visible(cards), cmp).forEach(n => grid.appendChild(n));
  }

  s?.addEventListener('input', apply);
  sort?.addEventListener('change', apply);
  apply();
})();
</script>
{% endblock %}
