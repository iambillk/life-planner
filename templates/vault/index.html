{% extends "base.html" %}
{% block title %}Document Vault{% endblock %}
{% block header %}Document Vault{% endblock %}

{% block extra_css %}
<style>
  /* =============================================================================
     VAULT INDEX - Dark Theme Aligned with Project Design System
     VERSION: v2.0.0-fused
     UPDATED: 2025-01-27
     
     Layout from File B + real data wiring and behaviors from File A
  ============================================================================= */

  /* ===== Theme Variables (matching project standard) ===== */
  :root {
    --vault-bg: var(--bg, #0b0f1a);
    --vault-panel: var(--panel, #121a2a);
    --vault-card: var(--card, #0f1625);
    --vault-sub: #0c1322;
    --vault-line: var(--line, #1f2a3d);
    --vault-text: var(--text, #e6eaf2);
    --vault-muted: var(--text-muted, #9fb0c8);
    --vault-primary: var(--primary, #6ea8ff);
    --vault-primary-700: var(--primary-700, #3f7fe6);
    --vault-success: var(--success, #22c55e);
    --vault-warn: var(--warning, #f59e0b);
    --vault-danger: var(--danger, #ef4444);
    --vault-info: #38bdf8;
    
    --vault-radius: var(--radius, 14px);
    --vault-radius-sm: var(--radius-sm, 10px);
    --vault-shadow: 0 8px 24px rgba(0,0,0,.35);
    --vault-shadow-sm: 0 4px 16px rgba(0,0,0,.25);
  }

  /* ===== Main Container ===== */
  .vault-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
    display: grid;
    gap: 20px;
  }

  /* ===== Sticky Header with Actions ===== */
  .vault-header {
    position: sticky;
    top: 12px;
    z-index: 10;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius);
    padding: 16px;
    box-shadow: var(--vault-shadow);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
    flex-wrap: wrap;
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-title h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    letter-spacing: 0.2px;
    color: var(--vault-text);
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  /* ===== Buttons (matching project style) ===== */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 12px;
    border: 1px solid var(--vault-line);
    background: var(--vault-card);
    color: var(--vault-text);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn:hover {
    border-color: var(--vault-primary);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(110,168,255,0.2);
  }

  .btn-primary {
    background: rgba(110,168,255,.18);
    border-color: rgba(110,168,255,.45);
    color: var(--vault-primary);
  }

  .btn-primary:hover {
    background: rgba(110,168,255,.25);
    border-color: var(--vault-primary);
  }

  /* ===== Search Section ===== */
  .search-section {
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius);
    padding: 20px;
    box-shadow: var(--vault-shadow-sm);
  }

  .search-wrapper {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 14px 48px 14px 18px;
    background: var(--vault-sub);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius-sm);
    color: var(--vault-text);
    font-size: 15px;
    transition: all 0.2s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--vault-primary);
    box-shadow: 0 0 0 3px rgba(110,168,255,0.1);
    background: rgba(110,168,255,0.03);
  }

  .search-input::placeholder {
    color: var(--vault-muted);
  }

  .search-icon {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--vault-muted);
    pointer-events: none;
  }

  /* Live results dropdown (from File A) */
  .search-results-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius-sm);
    box-shadow: var(--vault-shadow);
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 100;
  }
  .search-results-dropdown.active { display:block; }
  .search-result-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; border-bottom: 1px solid var(--vault-line);
    text-decoration: none; color: var(--vault-text);
    transition: background .2s ease;
  }
  .search-result-item:hover { background: rgba(110,168,255,0.08); }
  .result-highlight { background: rgba(110,168,255,0.3); padding: 0 2px; border-radius: 2px; }

  /* ===== Quick Filters ===== */
  .quick-filters {
    display: flex;
    gap: 8px;
    margin-top: 14px;
    flex-wrap: wrap;
    align-items: center;
  }
  .filter-label { color: var(--vault-muted); font-size: 12px; font-weight: 600; text-transform: uppercase; }

  .filter-chip {
    padding: 8px 14px;
    background: var(--vault-sub);
    border: 1px solid var(--vault-line);
    border-radius: 20px;
    color: var(--vault-muted);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    display: inline-flex; align-items: center; gap: 6px;
    text-decoration: none;
  }
  .filter-chip:hover {
    background: rgba(110,168,255,0.1);
    border-color: rgba(110,168,255,0.3);
    color: var(--vault-primary);
    transform: translateY(-1px);
  }
  .filter-chip.active {
    background: rgba(110,168,255,0.15);
    border-color: var(--vault-primary);
    color: var(--vault-primary);
  }
  .filter-count { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: 600; }

  /* ===== Main Layout Grid ===== */
  .vault-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    align-items: start;
  }

  /* ===== Sidebar ===== */
  .vault-sidebar {
    position: sticky;
    top: 100px;
    display: grid;
    gap: 16px;
  }

  /* ===== Folders Section ===== */
  .folders-card {
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius);
    padding: 16px;
    box-shadow: var(--vault-shadow-sm);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--vault-line);
  }

  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--vault-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .folder-list { display: grid; gap: 4px; }

  .folder-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: var(--vault-radius-sm);
    cursor: pointer; transition: all 0.2s ease;
    text-decoration: none; color: var(--vault-text); font-size: 14px;
  }
  .folder-item:hover { background: rgba(110,168,255,0.08); transform: translateX(4px); }
  .folder-item.active { background: rgba(110,168,255,0.12); border-left: 3px solid var(--vault-primary); padding-left: 9px; }

  .folder-icon { font-size: 18px; width: 24px; text-align: center; }
  .folder-name { flex: 1; font-weight: 500; }
  .folder-count {
    background: var(--vault-sub);
    padding: 2px 8px; border-radius: 12px;
    font-size: 12px; color: var(--vault-muted); font-weight: 600;
  }

  /* ===== Tags Cloud ===== */
  .tags-card {
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius);
    padding: 16px;
    box-shadow: var(--vault-shadow-sm);
  }

  .tags-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
  .tag-pill {
    padding: 6px 12px;
    background: rgba(110,168,255,0.1);
    border: 1px solid rgba(110,168,255,0.3);
    border-radius: 16px;
    color: var(--vault-primary);
    font-size: 12px; text-decoration: none; transition: all 0.2s ease; font-weight: 500;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .tag-pill:hover { background: rgba(110,168,255,0.2); border-color: var(--vault-primary); transform: scale(1.05); }
  .tag-count { opacity:.75; font-size: 11px; }

  /* ===== Main Content Area ===== */
  .vault-main { display: grid; gap: 24px; }

  /* ===== Pinned Documents Section ===== */
  .pinned-section {
    background: linear-gradient(135deg, rgba(251,191,36,0.05), transparent);
    border: 1px solid rgba(251,191,36,0.2);
    border-radius: var(--vault-radius);
    padding: 20px;
  }

  .pinned-header { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
  .pinned-header .icon { color: #fbbf24; font-size: 20px; }
  .pinned-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--vault-text); }

  .pinned-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

  /* ===== Document Cards ===== */
  .doc-card {
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius-sm);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: block;
    position: relative;
    overflow: hidden;
  }
  .doc-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--vault-primary), rgba(110,168,255,0.3));
    opacity: 0; transition: opacity 0.3s ease;
  }
  .doc-card:hover { border-color: var(--vault-primary); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(110,168,255,0.15); }
  .doc-card:hover::before { opacity: 1; }
  .doc-card-header { display: flex; align-items: start; gap: 12px; margin-bottom: 10px; }
  .doc-icon { font-size: 24px; width: 32px; text-align: center; opacity: 0.8; }
  .doc-content { flex: 1; }
  .doc-title {
    font-size: 14px; font-weight: 600; color: var(--vault-text); margin-bottom: 4px;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .doc-preview {
    font-size: 12px; color: var(--vault-muted); line-height: 1.4;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    min-height: 32px;
  }
  .doc-meta {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--vault-line);
    font-size: 11px; color: var(--vault-muted);
  }
  .doc-date { display: flex; align-items: center; gap: 4px; }
  .doc-size { background: var(--vault-sub); padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .pin-indicator { position: absolute; top: 8px; right: 8px; color: #fbbf24; font-size: 14px; }

  /* ===== Recent Documents List ===== */
  .recent-section {
    background: var(--vault-card);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius);
    overflow: hidden;
    box-shadow: var(--vault-shadow-sm);
  }
  .recent-header { background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent); padding: 16px 20px; border-bottom: 1px solid var(--vault-line); display:flex; justify-content:space-between; align-items:center; }
  .recent-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--vault-text); }
  .view-all-link { color: var(--vault-primary); text-decoration: none; font-size: 13px; font-weight: 500; }
  .view-all-link:hover { text-decoration: underline; }

  .recent-list { max-height: 600px; overflow-y: auto; }
  .recent-item {
    display: grid; grid-template-columns: 36px 1fr auto 100px;
    align-items: center; gap: 12px; padding: 14px 20px;
    border-bottom: 1px solid var(--vault-line);
    text-decoration: none; color: inherit; transition: all 0.2s ease;
  }
  .recent-item:last-child { border-bottom: none; }
  .recent-item:hover { background: rgba(110,168,255,0.04); }
  .recent-item-icon { font-size: 20px; opacity: 0.7; }
  .recent-item-info { display: grid; gap: 4px; }
  .recent-item-title { font-size: 14px; font-weight: 500; color: var(--vault-text); }
  .recent-item-path { font-size: 12px; color: var(--vault-muted); }
  .recent-item-tags { display: flex; gap: 6px; }
  .mini-tag { padding: 2px 6px; background: rgba(110,168,255,0.1); border-radius: 4px; font-size: 11px; color: var(--vault-primary); }
  .recent-item-date { font-size: 12px; color: var(--vault-muted); text-align: right; }

  /* ===== Stats Bar ===== */
  .stats-bar {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border: 1px solid var(--vault-line);
    border-radius: var(--vault-radius-sm);
    padding: 12px 16px;
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
  }
  .stat-item { text-align: center; }
  .stat-value { font-size: 20px; font-weight: 600; color: var(--vault-primary); display: block; }
  .stat-label { font-size: 12px; color: var(--vault-muted); text-transform: uppercase; letter-spacing: 0.5px; }

  /* ===== Scrollbar Styling ===== */
  .recent-list::-webkit-scrollbar { width: 6px; }
  .recent-list::-webkit-scrollbar-track { background: var(--vault-sub); border-radius: 3px; }
  .recent-list::-webkit-scrollbar-thumb { background: var(--vault-primary); border-radius: 3px; opacity: 0.5; }
  .recent-list::-webkit-scrollbar-thumb:hover { opacity: 0.8; }

  /* ===== Responsive Design ===== */
  @media (max-width: 968px) {
    .vault-layout { grid-template-columns: 1fr; }
    .vault-sidebar { position: static; grid-row: 2; }
    .pinned-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
  }
  @media (max-width: 640px) {
    .vault-header { flex-direction: column; gap: 12px; align-items: stretch; }
    .header-actions { justify-content: center; }
    .recent-item { grid-template-columns: 32px 1fr; grid-template-rows: auto auto; }
    .recent-item-tags, .recent-item-date { grid-column: 2; }
  }
</style>
{% endblock %}

{% block content %}
<div class="vault-container">
  <!-- Sticky Header -->
  <div class="vault-header">
    <div class="header-title">
      <span style="font-size: 24px;">📁</span>
      <h2>Document Vault</h2>
    </div>
    <div class="header-actions">
      <!-- Hidden upload input wired to backend (File A behavior) -->
      <input type="file" id="upload-input" class="upload-input" accept=".txt,.md,.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.svg,.py,.js,.html,.css,.json,.yaml,.yml,.sh,.sql,.csv,.xml" style="display:none;">
      <button class="btn" onclick="document.getElementById('upload-input').click()">
        <span>📤</span><span>Upload</span>
      </button>
      <a href="{{ url_for('vault.create_document') }}" class="btn btn-primary">
        <span>➕</span><span>New Document</span>
      </a>
    </div>
  </div>

  <!-- Search Section (form + live results wired) -->
  <div class="search-section">
    <div class="search-wrapper">
      <form action="{{ url_for('vault.search') }}" method="get" style="margin:0;">
        <input type="text" 
               class="search-input" 
               placeholder="Search documents, folders, or tags..."
               name="q"
               id="vault-search"
               autocomplete="off">
        <span class="search-icon">🔍</span>
      </form>
      <div class="search-results-dropdown" id="search-results"></div>
    </div>
    
    <!-- Real quick filters (File A endpoints, File B styling) -->
    <div class="quick-filters">
      <span class="filter-label">Filter by type:</span>
      <a href="{{ url_for('vault.index') }}" class="filter-chip {% if not request.args.get('type') %}active{% endif %}">
        <span>📁</span><span>All Files</span>
        <span class="filter-count">{{ total_documents|default(0) }}</span>
      </a>
      {% if type_counts %}
        {% if type_counts.get('document', 0) > 0 %}
        <a href="{{ url_for('vault.search', type='document') }}" class="filter-chip {% if request.args.get('type')=='document' %}active{% endif %}">
          <span>📄</span><span>Documents</span><span class="filter-count">{{ type_counts.document }}</span>
        </a>
        {% endif %}
        {% if type_counts.get('image', 0) > 0 %}
        <a href="{{ url_for('vault.search', type='image') }}" class="filter-chip {% if request.args.get('type')=='image' %}active{% endif %}">
          <span>🖼️</span><span>Images</span><span class="filter-count">{{ type_counts.image }}</span>
        </a>
        {% endif %}
        {% if type_counts.get('data', 0) > 0 %}
        <a href="{{ url_for('vault.search', type='data') }}" class="filter-chip {% if request.args.get('type')=='data' %}active{% endif %}">
          <span>📊</span><span>Data Files</span><span class="filter-count">{{ type_counts.data }}</span>
        </a>
        {% endif %}
        {% if type_counts.get('config', 0) > 0 %}
        <a href="{{ url_for('vault.search', type='config') }}" class="filter-chip {% if request.args.get('type')=='config' %}active{% endif %}">
          <span>⚙️</span><span>Configs</span><span class="filter-count">{{ type_counts.config }}</span>
        </a>
        {% endif %}
        {% if type_counts.get('code', 0) > 0 %}
        <a href="{{ url_for('vault.search', type='code') }}" class="filter-chip {% if request.args.get('type')=='code' %}active{% endif %}">
          <span>💻</span><span>Code</span><span class="filter-count">{{ type_counts.code }}</span>
        </a>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- Main Layout Grid -->
  <div class="vault-layout">
    <!-- Sidebar -->
    <div class="vault-sidebar">
      <!-- Folders (real) -->
      <div class="folders-card">
        <div class="section-header">
          <span class="section-title">Folders</span>
          <a href="{{ url_for('vault.manage_folders') }}" title="Manage Folders" style="margin-left:auto; color: var(--vault-muted); text-decoration:none;">⚙️</a>
        </div>
        <div class="folder-list">
          <a href="{{ url_for('vault.index') }}" class="folder-item {% if not request.args.get('folder') %}active{% endif %}">
            <span class="folder-icon">📂</span>
            <span class="folder-name">All Documents</span>
            <span class="folder-count">{{ total_documents|default(0) }}</span>
          </a>
          {% for folder in folders %}
          <a href="{{ url_for('vault.search', folder=folder.id) }}" class="folder-item {% if request.args.get('folder', type=int) == folder.id %}active{% endif %}">
            <span class="folder-icon">{{ folder.icon }}</span>
            <span class="folder-name">{{ folder.name }}</span>
            <span class="folder-count">{{ folder.documents|length }}</span>
          </a>
          {% endfor %}
        </div>
      </div>

      <!-- Tags (real) -->
      {% if all_tags %}
      <div class="tags-card">
        <div class="section-header">
          <span class="section-title">Tags</span>
        </div>
        <div class="tags-cloud">
          {% for tag in all_tags %}
          <a href="{{ url_for('vault.search', tag=tag.name) }}" class="tag-pill" style="border-color: {{ tag.color|default('#6ea8ff') }}30; background: {{ tag.color|default('#6ea8ff') }}15;">
            <span>#{{ tag.name }}</span>
            <span class="tag-count">({{ tag.count }})</span>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Stats (real) -->
      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-value">{{ total_documents|default(0) }}</span>
          <span class="stat-label">Files</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ total_size_mb|default("0") }}MB</span>
          <span class="stat-label">Used</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ pinned_count|default(0) }}</span>
          <span class="stat-label">Pinned</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="vault-main">
      <!-- Pinned Documents (real) -->
      {% if pinned_docs %}
      <div class="pinned-section">
        <div class="pinned-header">
          <span class="icon">📌</span>
          <h3>Pinned Documents</h3>
        </div>
        <div class="pinned-grid">
          {% for doc in pinned_docs %}
          <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="doc-card">
            <span class="pin-indicator">📌</span>
            <div class="doc-card-header">
              <span class="doc-icon">
                {% if doc.doc_type == 'code' %}💻
                {% elif doc.doc_type == 'config' %}⚙️
                {% elif doc.doc_type == 'image' %}🖼️
                {% elif doc.doc_type == 'data' %}📊
                {% elif doc.doc_type == 'document' %}📄
                {% elif doc.doc_type == 'note' %}📝
                {% else %}📎{% endif %}
              </span>
              <div class="doc-content">
                <div class="doc-title">{{ doc.title }}</div>
                <div class="doc-preview">
                  {% if doc.content %}
                    {{ doc.content[:100] }}{% if doc.content|length > 100 %}...{% endif %}
                  {% elif doc.file_name %}
                    File: {{ doc.file_name }}
                  {% else %}
                    No preview available
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="doc-meta">
              <span class="doc-date">📅 {{ doc.updated_at.strftime('%b %d, %Y') if doc.updated_at else 'Unknown' }}</span>
              {% if doc.file_size %}
              <span class="doc-size">{{ (doc.file_size / 1024)|round(1) }} KB</span>
              {% endif %}
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Recent Documents (real) -->
      <div class="recent-section">
        <div class="recent-header">
          <h3>Recent Documents</h3>
          <a href="{{ url_for('vault.search') }}" class="view-all-link">View All →</a>
        </div>
        <div class="recent-list">
          {% if recent_docs %}
            {% for doc in recent_docs %}
            <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="recent-item">
              <span class="recent-item-icon">
                {% if doc.doc_type == 'code' %}💻
                {% elif doc.doc_type == 'config' %}⚙️
                {% elif doc.doc_type == 'image' %}🖼️
                {% elif doc.doc_type == 'data' %}📊
                {% elif doc.doc_type == 'document' %}📄
                {% elif doc.doc_type == 'note' %}📝
                {% else %}📎{% endif %}
              </span>
              <div class="recent-item-info">
                <span class="recent-item-title">
                  {{ doc.title }}
                  {% if doc.pinned %}<span style="color:#fbbf24; font-size:12px; margin-left:6px;">📌</span>{% endif %}
                </span>
                {% if doc.folder %}
                <span class="recent-item-path">{{ doc.folder.icon }} {{ doc.folder.name }}</span>
                {% endif %}
              </div>
              <div class="recent-item-tags">
                {% if doc.tags %}
                  {% for t in doc.tags[:3] %}
                    <span class="mini-tag">#{{ t.name }}</span>
                  {% endfor %}
                {% endif %}
              </div>
              <span class="recent-item-date">{{ doc.updated_at.strftime('%b %d') if doc.updated_at else 'Unknown' }}</span>
            </a>
            {% endfor %}
          {% else %}
            <div class="empty-state">
              <div class="empty-icon">📄</div>
              <div class="empty-title">No documents yet</div>
              <div class="empty-text">Upload or create your first document to get started</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== File upload (from File A)
  document.getElementById('upload-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    fetch('{{ url_for("vault.upload_file") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.url;
      } else {
        alert(data.error || 'Upload failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Upload failed');
    });
  });

  // ===== Live search with highlighting (from File A)
  let searchTimeout;
  const searchInput = document.getElementById('vault-search');
  const searchResults = document.getElementById('search-results');

  searchInput.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    if (query.length < 2) {
      searchResults.classList.remove('active');
      return;
    }
    searchTimeout = setTimeout(() => {
      fetch(`{{ url_for("vault.api_search") }}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            searchResults.innerHTML = data.map(doc => {
              const highlightedTitle = doc.title.replace(
                new RegExp(query, 'gi'),
                match => `<span class="result-highlight">${match}</span>`
              );
              return `
                <a href="${doc.url}" class="search-result-item">
                  <span style="font-size: 20px;">${doc.icon}</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 500;">${highlightedTitle}</div>
                    <div style="font-size: 12px; color: var(--vault-muted);">${doc.type}</div>
                  </div>
                </a>
              `;
            }).join('');
            searchResults.classList.add('active');
          } else {
            searchResults.innerHTML = `
              <div class="search-result-item" style="justify-content: center; color: var(--vault-muted);">
                No results found for "${query}"
              </div>
            `;
            searchResults.classList.add('active');
          }
        });
    }, 300);
  });

  // Hide search results when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-wrapper')) {
      searchResults.classList.remove('active');
    }
  });
</script>
{% endblock %}
