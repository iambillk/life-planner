{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% set active = 'home' %}
{% block header %}Home ‚Äî Beta{% endblock %}

{% block content %}
<!-- Local GridStack CSS (ship this alongside gridstack-all.js) -->
<link rel="stylesheet" href="/static/js/gridstack.min.css">

<style>
  :root{
    --gap: 8px;          /* grid gutter (set in JS, not CSS) */
    --cell: 78px;        /* row unit height */
    --radius: 12px;
    --ring: rgba(130,170,255,.45);
  }

  .topbar{display:flex;gap:8px;align-items:center;margin:6px 0 14px}
  .topbar h2{margin:0;font-weight:800}
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);
       border-radius:999px;padding:7px 12px;font-weight:700;cursor:pointer}
  .btn:hover{border-color:var(--ring)}
  .muted{color:var(--text-muted);font-size:.92rem}

  /* GridStack skin ‚Äî IMPORTANT: let GridStack own the gutter; no custom margins here */
  .grid-stack{ margin:0; }
  .grid-stack-item-content{
    background:rgba(18,22,28,.78);
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);
    box-shadow:0 2px 18px rgba(0,0,0,.24);
    padding:12px;
    overflow:hidden;
    height:100%; /* fill grid cell */
  }
  /* Avoid ‚Äúghost‚Äù overlays */
  .grid-stack .grid-stack-item{ z-index:auto; }
  .grid-stack .grid-stack-item.ui-draggable-dragging{ z-index:1000; }

  /* Edit affordances */
  .card-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .card-toolbar h3{margin:0;font-size:1rem;font-weight:800}
  .drag-handle{display:none}
  body.edit .drag-handle{display:inline-block;cursor:grab}
  .ui-resizable-handle{display:none}
  body.edit .ui-resizable-handle{display:block}

  /* Widget styles */
  #weather-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width: 900px){ #weather-grid{grid-template-columns:1fr} }
  .wx{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.035);border-radius:10px;padding:10px}
  .wx .row{display:flex;align-items:center}.wx .row .muted{margin-left:auto}

  .chips{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{font-size:.78rem;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.03);cursor:pointer}
  .chip.active{border-color:rgba(130,170,255,.6);background:rgba(130,170,255,.12)}
  .news-hero{border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;background:rgba(255,255,255,.03);
             display:grid;grid-template-columns:28px 1fr;gap:10px;align-items:start;margin-bottom:6px}
  .news-list .item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:10px}
  .news-list .item:hover{background:rgba(255,255,255,.03)}
  .fav{width:20px;height:20px;border-radius:6px;border:1px solid var(--line);background:rgba(255,255,255,.05)}
  .title a{color:var(--text);text-decoration:none}
  .title a:hover{text-decoration:underline}
  .meta{display:flex;gap:8px;align-items:center;color:var(--text-muted);font-size:.82rem}
  .fresh-dot{width:8px;height:8px;border-radius:999px}
  .fresh-1{background:#22c55e}.fresh-6{background:#f59e0b}.fresh-old{background:#475569}

  .links{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  @media (min-width: 980px){ .links{grid-template-columns:repeat(3,minmax(0,1fr));} }
  .link{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid rgba(255,255,255,.08);
        border-radius:10px;background:rgba(255,255,255,.03);text-decoration:none;color:var(--text);font-weight:600}
  .link:hover{border-color:rgba(130,170,255,.45)}

  .img-fit{width:100%;height:240px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.09)}
  .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.05),rgba(255,255,255,.10),rgba(255,255,255,.05));
            background-size:200% 100%;animation:sk 1.2s infinite;border-radius:12px}
  @keyframes sk{0%{background-position:0 0}100%{background-position:-200% 0}}
</style>

<div class="topbar">
  <h2 style="flex:1">Dashboard</h2>
  <button id="toggle-edit" class="btn">Customize</button>
  <button id="reset-layout" class="btn">Reset</button>
</div>

<!-- Sections that get mounted into GridStack items -->
<div id="cards-origin" style="display:none">
  <section id="card-potd">
    <div class="card-toolbar">
      <span class="drag-handle">‚†ø</span><h3>Photo of the Day</h3>
      <button class="btn" id="photo-refresh" style="margin-left:auto">Shuffle</button>
    </div>
    <img id="potd" class="img-fit skeleton" alt="Photo of the day"/>
    <div class="muted" id="photo-caption" style="margin-top:6px">Loading photo‚Ä¶</div>
  </section>

  <section id="card-links">
    <div class="card-toolbar">
      <span class="drag-handle">‚†ø</span><h3>Quick Links</h3>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="link-add">Add</button>
        <button class="btn" id="link-reset">Reset</button>
      </div>
    </div>
    <div id="links" class="links"></div>
  </section>

  <section id="card-news">
    <div class="card-toolbar">
      <span class="drag-handle">‚†ø</span><h3>News <span class="chip">live</span></h3>
      <div id="news-chips" class="chips" style="margin-left:8px"></div>
      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="news-prev">Prev</button>
        <button class="btn" id="news-next">Next</button>
        <button class="btn" id="news-density">Density</button>
        <button class="btn" id="news-count">Page Size</button>
        <button class="btn" id="news-sources">Sources</button>
        <button class="btn" id="news-refresh">Refresh</button>
      </div>
    </div>
    <div id="news-hero" class="news-hero" style="display:none"></div>
    <div id="news-list" class="news-list"></div>
    <div class="muted" id="news-page-ind" style="margin-top:6px"></div>
  </section>

  <section id="card-quote">
    <div class="card-toolbar">
      <span class="drag-handle">‚†ø</span><h3>Quote of the Day</h3>
      <button class="btn" id="quote-next" style="margin-left:auto">Next</button>
    </div>
    <div id="quote-body" class="muted">Fetching wisdom‚Ä¶</div>
  </section>

  <section id="card-weather">
    <div class="card-toolbar">
      <span class="drag-handle">‚†ø</span><h3>Weather <span class="chip">multi-city</span></h3>
      <button class="btn" id="weather-refresh" style="margin-left:auto">Refresh</button>
    </div>
    <div id="weather-grid"></div>
  </section>
</div>

<!-- GridStack mount -->
<div id="gs" class="grid-stack"></div>

<script>
/* ===== Storage & tiny utils ===== */
const LS={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const LAYOUT_KEY='home.gs.v3';            // bump to avoid stale layouts
const CELL_HEIGHT=78, GAP=8;
const $=(s,r=document)=>r.querySelector(s);

/* ===== Load local GridStack ===== */
async function loadGridStack(){
  if(window.GridStack) return;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='/static/js/gridstack-all.js';
    s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
}

/* ===== Self-healing Grid init ===== */
async function enableGrid(){
  const root = document.getElementById('gs');

  function mountInto(id){
    const item = root.querySelector(`.grid-stack-item[gs-id="${id}"] .grid-stack-item-content`);
    const section = document.getElementById(id);
    if(item && section){ item.appendChild(section); return true; }
    return false;
  }
  function contentMissing(){
    return Array.from(root.querySelectorAll('.grid-stack-item'))
      .some(it => !it.querySelector('.grid-stack-item-content > section'));
  }

  try{
    await loadGridStack();
    const grid = GridStack.init({
      column: 12,
      margin: GAP,                 // GridStack owns the gutter
      cellHeight: CELL_HEIGHT,
      float: true,
      handle: '.drag-handle',
      resizable: { handles: 'e, se, s' },
      draggable: { handle: '.drag-handle', scroll: true, appendTo: 'body' },
      disableOneColumnMode: false,
      oneColumnModeDomSort: true,
      animate: true
    }, root);

    const defaults = [
      {id:'card-potd',    x:0,  y:0, w:4, h:3},
      {id:'card-links',   x:4,  y:0, w:8, h:2},
      {id:'card-news',    x:0,  y:3, w:8, h:4},
      {id:'card-quote',   x:8,  y:3, w:4, h:2},
      {id:'card-weather', x:8,  y:5, w:4, h:3},
    ];

    const saved = LS.get(LAYOUT_KEY, null);

    if (Array.isArray(saved) && saved.length){
      grid.load(saved.map(n=>({id:n.id, x:n.x, y:n.y, w:n.w, h:n.h})));
      let ok = true;
      saved.forEach(n => { ok = mountInto(n.id) && ok; });
      if (!ok || contentMissing()){
        console.warn('Saved layout corrupt/empty ‚Äî rebuilding defaults');
        LS.set(LAYOUT_KEY, null);
        grid.removeAll();
        defaults.forEach(({id,x,y,w,h})=>{
          const node = grid.addWidget({x,y,w,h,id});
          node.el.querySelector('.grid-stack-item-content').appendChild(document.getElementById(id));
        });
        LS.set(LAYOUT_KEY, grid.save(true));
      }
    } else {
      defaults.forEach(({id,x,y,w,h})=>{
        const node = grid.addWidget({x,y,w,h,id});
        node.el.querySelector('.grid-stack-item-content').appendChild(document.getElementById(id));
      });
      LS.set(LAYOUT_KEY, grid.save(true));
    }

    // pack tightly once after load
    grid.compact();

    // Persist on change
    const save = ()=> LS.set(LAYOUT_KEY, grid.save(true));
    grid.on('change', save);
    grid.on('resizestop', ()=>{ save(); grid.compact(); });
    grid.on('dragstop',   ()=>{ save(); grid.compact(); });

    // Edit mode
    const toggleBtn = document.getElementById('toggle-edit');
    const setEdit = on => {
      document.body.classList.toggle('edit', !!on);
      grid.setStatic(!on);
      toggleBtn.textContent = on ? 'Lock Layout' : 'Customize';
    };
    toggleBtn.addEventListener('click', ()=> setEdit(!document.body.classList.contains('edit')));
    setEdit(false);

    // Double-click to auto-fit height to content
    root.addEventListener('dblclick', (e)=>{
      const item = e.target.closest('.grid-stack-item'); if(!item) return;
      const inner = item.querySelector('.grid-stack-item-content > section');
      const needed = Math.ceil((inner.scrollHeight + 24) / (CELL_HEIGHT + GAP));
      const node = grid.getNode(item);
      if(node) grid.update(item, {h: Math.max(1, needed)});
    });

    // Compact on resize / content changes
    const compact = () => grid.compact();
    window.addEventListener('resize', () => requestAnimationFrame(compact));
    window._grid = grid; // debug hook
  }catch(e){
    console.warn('GridStack failed, fallback static layout:', e);
    // Fallback: simple grid so content still shows
    root.style.display='grid';
    root.style.gridTemplateColumns='repeat(12,1fr)';
    root.style.gap=GAP+'px';
    ['card-potd','card-links','card-news','card-quote','card-weather'].forEach(id=>{
      const wrap=document.createElement('div');
      wrap.className='grid-stack-item-content';
      wrap.style.gridColumn='span 4';
      wrap.appendChild(document.getElementById(id));
      root.appendChild(wrap);
    });
  }
}

/* ===== Reset ===== */
document.getElementById('reset-layout').addEventListener('click', ()=>{
  if(confirm('Reset saved layout?')){
    localStorage.removeItem(LAYOUT_KEY);
    location.reload();
  }
});

/* ===== Widgets ===== */
const QUOTES=[
  "You have power over your mind ‚Äî not outside events. ~ Marcus Aurelius",
  "Waste no more time arguing what a good man should be. Be one. ~ Marcus Aurelius",
  "We suffer more often in imagination than in reality. ~ Seneca",
  "Courage is fear holding on a minute longer. ~ George S. Patton",
  "The impediment to action advances action. ~ Marcus Aurelius"
];
function renderQuote(){ document.getElementById('quote-body').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)]; }
document.getElementById('quote-next').addEventListener('click', renderQuote);

const DEF_LINKS=[
  {title:"TCH Portal", url:"https://www.totalchoicehosting.com/"},
  {title:"Observium", url:"https://netmon.tchmachines.com/"},
  {title:"GandZ", url:"https://gandz.us/"},
  {title:"Unraid", url:"http://192.168.1.150"}
];
function renderLinks(){
  const root=document.getElementById('links'); root.innerHTML='';
  const links=LS.get('home.links', DEF_LINKS);
  links.forEach((ln,i)=>{
    const a=document.createElement('a'); a.className='link'; a.href=ln.url; a.target='_blank'; a.rel='noopener';
    a.innerHTML=`<span>üîó</span><span>${ln.title}</span>`;
    a.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(confirm(`Remove '${ln.title}'?`)){ const upd=LS.get('home.links', DEF_LINKS).filter((_,idx)=>idx!==i); LS.set('home.links', upd); renderLinks(); }});
    root.appendChild(a);
  });
}
document.getElementById('link-add').addEventListener('click', ()=>{
  const t=prompt('Link title:'); if(!t) return;
  const u=prompt('URL (include http/https):'); if(!u) return;
  const ls=LS.get('home.links', DEF_LINKS); ls.push({title:t, url:u}); LS.set('home.links', ls); renderLinks();
});
document.getElementById('link-reset').addEventListener('click', ()=>{ if(confirm('Reset links to defaults?')){ LS.set('home.links', DEF_LINKS); renderLinks(); } });

const POTD_ITEMS = {{ (potd_items or [])|tojson|safe }};
const POTD_FALLBACK=[
  "https://picsum.photos/seed/ips/800/400",
  "https://picsum.photos/seed/detroit/800/400",
  "https://picsum.photos/seed/datacenter/800/400"
];
function prettyName(n){ if(!n) return ""; try{ return n.replace(/\.[^.]+$/,'').replace(/[_\-]+/g,' ').replace(/\s+/g,' ').trim(); }catch{return n;} }
function renderPhoto(){
  const img=document.getElementById('potd'); const cap=document.getElementById('photo-caption');
  const hasLocal=Array.isArray(POTD_ITEMS)&&POTD_ITEMS.length>0;
  const pick=()=> hasLocal ? POTD_ITEMS[Math.floor(Math.random()*POTD_ITEMS.length)] : {url:POTD_FALLBACK[Math.floor(Math.random()*POTD_FALLBACK.length)], name:"Demo image"};
  const c=pick(); img.classList.add('skeleton');
  img.onload=()=>{ img.classList.remove('skeleton'); window._grid?.compact(); };
  img.onerror=()=>{ img.classList.remove('skeleton'); cap.textContent='Image failed to load.'; window._grid?.compact(); };
  img.src=c.url; cap.textContent = hasLocal ? (prettyName(c.name)||c.name) : "Random demo image ‚Äî add files to /static/images/potd/";
}
document.getElementById('photo-refresh').addEventListener('click', ()=>{ renderPhoto(); setTimeout(()=>window._grid?.compact(), 150); });

/* ===== Weather ===== */
const WEATHER_API="{{ url_for('home.api_weather') }}";
const WEATHER_PRESETS_API="{{ url_for('home.api_weather_presets') }}";
function tfmt(ts){ try{ return new Date((ts||0)*1000).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});}catch{return''} }
function wxSkeleton(name){return `<div class="wx"><div class="row"><strong>${name}</strong><span class="muted">Loading‚Ä¶</span></div><div class="skeleton" style="height:52px;margin-top:8px;border-radius:8px"></div></div>`}
function renderWx(el,p,d){
  const t=d.now&&d.now.temp_f; const f=d.now&&d.now.feels_f; const pop=d.now&&d.now.pop;
  const hi=d.next12&&d.next12.hi_f; const lo=d.next12&&d.next12.lo_f;
  el.innerHTML = `<div class="wx">
    <div class="row"><strong>${d.location||p.name}</strong><span class="muted">Updated ${tfmt(d.updated_ts)}</span></div>
    <div style="margin-top:6px">üå§Ô∏è ${t??'‚Äì'}¬∞F ‚Ä¢ Feels ${f??'‚Äì'}¬∞ ‚Ä¢ ${pop??'‚Äì'}% rain</div>
    <div class="muted" style="margin-top:4px">Next 12h: ‚Üë${hi??'‚Äì'}¬∞ / ‚Üì${lo??'‚Äì'}¬∞</div>
  </div>`;
}
async function renderAllWeather(){
  const wrap=document.getElementById('weather-grid'); wrap.innerHTML='';
  let presets=[];
  try{ const r=await fetch(WEATHER_PRESETS_API,{cache:'no-store'}); presets=await r.json(); }
  catch{ wrap.innerHTML='<div class="muted">Weather unavailable.</div>'; return; }
  if(!Array.isArray(presets)||!presets.length){ wrap.innerHTML='<div class="muted">No locations configured.</div>'; return; }
  const mounts={}; presets.forEach(p=>{ const d=document.createElement('div'); d.innerHTML=wxSkeleton(p.name); wrap.appendChild(d); mounts[p.id]=d; });
  await Promise.allSettled(presets.map(async p=>{
    try{
      const u=new URL(WEATHER_API,location.origin);
      u.searchParams.set('lat', String(p.lat)); u.searchParams.set('lon', String(p.lon));
      u.searchParams.set('tz',  p.tz);          u.searchParams.set('label', p.name);
      const res=await fetch(u.toString(), {cache:'no-store'}); const data=await res.json();
      renderWx(mounts[p.id], p, data);
    }catch{
      mounts[p.id].innerHTML = `<div class="wx"><div class="row"><strong>${p.name}</strong><span class="muted">Error</span></div><div class="muted" style="margin-top:6px">Weather unavailable.</div></div>`;
    }
  }));
  window._grid?.compact();
}
document.getElementById('weather-refresh').addEventListener('click', ()=>{ renderAllWeather(); setTimeout(()=>window._grid?.compact(),150); });

/* ===== News ===== */
const NEWS_API="{{ url_for('home.api_news') }}";
const NEWS_SOURCES_API="{{ url_for('home.api_news_sources') }}";
const NS={itemsAll:[],itemsFiltered:[],page:0,pageSize:LS.get('home.news.page_size',7),perSource:LS.get('home.news.per_source',20),filter:LS.get('home.news.filter','All'),density:LS.get('home.news.density','cozy')};
function ago(p){ if(!p) return ''; const d=new Date(p); if(isNaN(d)) return ''; const s=(Date.now()-d)/1000; if(s<90) return 'just now'; const m=Math.floor(s/60); if(m<60) return `${m}m`; const h=Math.floor(m/60); if(h<24) return `${h}h`; return `${Math.floor(h/24)}d`; }
function fresh(p){ const d=new Date(p); if(isNaN(d)) return 'fresh-old'; const h=(Date.now()-d)/3600000; return h<1?'fresh-1':(h<6?'fresh-6':'fresh-old'); }
function fav(link){ try{return `https://www.google.com/s2/favicons?domain=${new URL(link).hostname}&sz=64`;}catch{return '';} }
async function getSelectedNewsSources(){
  const lsList = LS.get('home.news.sources', null);
  if (Array.isArray(lsList) && lsList.length) {
    try {
      const res = await fetch(NEWS_SOURCES_API, {cache:"no-store"});
      const all = await res.json();
      const nameToId = new Map(all.map(x => [x.name.toLowerCase(), x.id]));
      const mapped = lsList.map(n => nameToId.get(String(n).toLowerCase())).filter(Boolean);
      if (mapped.length) return mapped;
    } catch {}
  }
  return null;
}
function chips(items){
  const root=document.getElementById('news-chips'); root.innerHTML='';
  const labels=['All',...Array.from(new Set(items.map(i=>i.source))).sort()];
  labels.forEach(l=>{
    const b=document.createElement('button'); b.className='chip'+(NS.filter===l?' active':''); b.textContent=l;
    b.onclick=()=>{ NS.filter=l; LS.set('home.news.filter',l); applyFilter(); };
    root.appendChild(b);
  });
}
function applyFilter(){
  NS.itemsFiltered = NS.filter==='All' ? NS.itemsAll.slice() : NS.itemsAll.filter(i=>i.source===NS.filter);
  NS.page=0; renderNewsPage();
}
function renderNewsPage(){
  const list=document.getElementById('news-list'); const hero=document.getElementById('news-hero'); const ind=document.getElementById('news-page-ind');
  list.innerHTML=''; hero.style.display='none'; hero.innerHTML='';
  const items=NS.itemsFiltered; const start=NS.page*NS.pageSize; const slice=items.slice(start, start+NS.pageSize);
  if(!slice.length){ list.innerHTML='<div class="muted">No headlines.</div>'; }
  else{
    const h=slice[0]; hero.style.display='grid';
    hero.innerHTML = `<div><img class="fav" src="${fav(h.link)}" alt=""></div>
      <div><div class="title"><a href="${h.link}" target="_blank" rel="noopener">${h.title}</a></div>
      <div class="meta"><span class="chip">${h.source}</span><span class="fresh-dot ${fresh(h.published)}"></span><span>${ago(h.published)}</span></div></div>`;
    slice.slice(1).forEach(it=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `<img class="fav" src="${fav(it.link)}" alt="">
        <div class="title" style="flex:1">
          <a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
          <div class="meta" style="margin-top:2px"><span class="chip">${it.source}</span>
          <span class="fresh-dot ${fresh(it.published)}"></span><span>${ago(it.published)}</span></div>
        </div>`;
      list.appendChild(row);
    });
  }
  const total=Math.max(1, Math.ceil((NS.itemsFiltered.length||1)/NS.pageSize));
  ind.textContent = `Page ${Math.min(NS.page+1,total)} / ${total} (${NS.itemsFiltered.length} items)`;
  window._grid?.compact();
}
async function renderNews(){
  const list=document.getElementById('news-list'); list.innerHTML='<div class="muted">Loading‚Ä¶</div>';
  const ids=await getSelectedNewsSources(); const u=new URL(NEWS_API, location.origin);
  if(ids && ids.length) u.searchParams.set('sources', ids.join(','));
  u.searchParams.set('limit', String(NS.perSource));
  try{
    const res=await fetch(u.toString(), {cache:'no-store'}); const j=await res.json();
    NS.itemsAll=j.items||[];
    chips(NS.itemsAll); applyFilter();
  }catch(e){
    console.warn('News failed:', e);
    list.innerHTML='<div class="muted">News unavailable.</div>';
    NS.itemsAll=[]; chips([]); applyFilter();
  }
}
document.getElementById('news-prev').addEventListener('click', ()=>{ if(NS.page>0){NS.page--; renderNewsPage();} });
document.getElementById('news-next').addEventListener('click', ()=>{ const t=Math.max(1, Math.ceil(NS.itemsFiltered.length/NS.pageSize)); if(NS.page+1<t){ NS.page++; renderNewsPage(); } });
document.getElementById('news-count').addEventListener('click', ()=>{ const cur=NS.pageSize; const v=prompt('Items per page (1‚Äì20):', String(cur)); if(v!=null){ const n=Math.max(1,Math.min(20, parseInt(v,10)||cur)); NS.pageSize=n; LS.set('home.news.page_size',n); NS.page=0; renderNewsPage(); } });
document.getElementById('news-density').addEventListener('click', ()=>{ document.getElementById('news-list').classList.toggle('compact'); window._grid?.compact(); });
document.getElementById('news-sources').addEventListener('click', async ()=>{
  try{
   const res=await fetch(NEWS_SOURCES_API,{cache:'no-store'}); const all=await res.json();
   const cur=LS.get('home.news.sources',[]);
   const v=prompt("Choose sources (comma-separated).\nAvailable:\n"+all.map(x=>x.name).join(", ")+"\n\nCurrent: "+(cur.join(", ")||"Server default"), cur.join(", "));
   if(v!=null){ const names=v.split(',').map(s=>s.trim()).filter(Boolean); if(names.length){ LS.set('home.news.sources', names);} else { localStorage.removeItem('home.news.sources'); } renderNews(); }
  }catch{ alert('Could not load sources.'); }
});
document.getElementById('news-refresh').addEventListener('click', ()=>{ renderNews(); setTimeout(()=>window._grid?.compact(),150); });

/* ===== Init ===== */
(async function(){
  await enableGrid();
  renderQuote(); renderLinks(); renderPhoto();
  renderAllWeather(); renderNews();
})();
</script>
{% endblock %}
