<!-- templates/todo/view.html -->
{% extends "base.html" %}
{% block title %}{{ todo_list.title }}{% endblock %}
{% block header %}{{ todo_list.title }}{% endblock %}

{% block content %}
<div class="todo-view-container">
    <!-- Header with actions -->
    <div class="view-header">
        <div class="header-info">
            {% if parent_project %}
            <p class="parent-link">
                Attached to: <a href="{{ url_for('projects.tch_detail' if todo_list.module == 'tch_project' else 'projects.personal_detail', id=parent_project.id) }}">
                    {{ parent_project.name }}
                </a>
            </p>
            {% endif %}
            {% if todo_list.description %}
            <p class="list-description">{{ todo_list.description }}</p>
            {% endif %}
        </div>
        <div class="header-actions">
            <button onclick="togglePin({{ todo_list.id }})" class="btn btn-small">
                {% if todo_list.is_pinned %}ðŸ“Œ Unpin{% else %}ðŸ“Œ Pin{% endif %}
            </button>
            {% if todo_list.completion_percentage == 100 %}
            <form method="POST" action="{{ url_for('todo.archive', id=todo_list.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-small btn-success">âœ“ Archive</button>
            </form>
            {% endif %}
            <button onclick="confirmDelete()" class="btn btn-small btn-danger">Delete</button>
        </div>
    </div>
    
    <!-- Progress Overview -->
    <div class="progress-overview">
        <div class="progress-bar-large">
            <div class="progress-fill" style="width: {{ todo_list.completion_percentage }}%">
                <span class="progress-label">{{ todo_list.completion_percentage }}%</span>
            </div>
        </div>
        <div class="progress-stats">
            <span>âœ“ {{ todo_list.completed_count }} completed</span>
            <span>â—‹ {{ todo_list.total_count - todo_list.completed_count }} remaining</span>
            <span>Total: {{ todo_list.total_count }} items</span>
        </div>
    </div>
    
    <!-- Add Item Form -->
    <div class="add-item-section">
        <h3>Add New Item</h3>
        <form method="POST" action="{{ url_for('todo.add_item', id=todo_list.id) }}" class="add-item-form">
            <div class="form-row">
                <input type="text" name="content" placeholder="What needs to be done?" required>
                <label class="priority-check">
                    <input type="checkbox" name="priority">
                    High Priority
                </label>
                <input type="date" name="due_date">
                <button type="submit" class="btn btn-primary">Add Item</button>
            </div>
        </form>
    </div>
    
    <!-- Items List -->
    <div class="items-section">
        <h3>Items</h3>
        
        <!-- Active Items -->
        <div class="items-list">
            {% for item in todo_list.items if not item.completed %}
            <div class="todo-item {{ 'priority' if item.priority }}">
                <input type="checkbox" 
                       id="item-{{ item.id }}"
                       onchange="toggleItem({{ item.id }})">
                <label for="item-{{ item.id }}">
                    {{ item.content }}
                    {% if item.priority %}
                    <span class="priority-badge">!</span>
                    {% endif %}
                    {% if item.due_date %}
                    <span class="due-date">Due: {{ item.due_date.strftime('%b %d') }}</span>
                    {% endif %}
                </label>
                <button onclick="deleteItem({{ item.id }})" class="delete-btn">Ã—</button>
            </div>
            {% endfor %}
        </div>
        
        <!-- Completed Items -->
        {% set completed_items = todo_list.items|selectattr('completed')|list %}
        {% if completed_items %}
        <div class="completed-section">
            <h4>Completed ({{ completed_items|length }})</h4>
            <div class="items-list completed">
                {% for item in completed_items %}
                <div class="todo-item completed">
                    <input type="checkbox" 
                           id="item-{{ item.id }}"
                           checked
                           onchange="toggleItem({{ item.id }})">
                    <label for="item-{{ item.id }}">
                        {{ item.content }}
                        {% if item.completed_at %}
                        <span class="completed-date">{{ item.completed_at.strftime('%b %d, %I:%M %p') }}</span>
                        {% endif %}
                    </label>
                    <button onclick="deleteItem({{ item.id }})" class="delete-btn">Ã—</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Delete Form (hidden) -->
    <form id="delete-form" method="POST" action="{{ url_for('todo.delete', id=todo_list.id) }}" style="display: none;"></form>
</div>

<script>
function toggleItem(itemId) {
    fetch(`/todo/item/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        location.reload(); // Simple reload to update the view
    });
}

function deleteItem(itemId) {
    if (confirm('Delete this item?')) {
        fetch(`/todo/item/${itemId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            location.reload();
        });
    }
}

function togglePin(listId) {
    fetch(`/todo/${listId}/pin`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        location.reload();
    });
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this entire todo list? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}
</script>

<style>
.todo-view-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.view-header {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
}

.parent-link {
    color: #7f8c8d;
    font-size: 14px;
    margin-bottom: 5px;
}

.parent-link a {
    color: #3498db;
    text-decoration: none;
}

.list-description {
    color: #5d6d7e;
    margin-top: 10px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.progress-overview {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.progress-bar-large {
    height: 40px;
    background: #ecf0f1;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 15px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2980b9);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.5s;
}

.progress-label {
    color: white;
    font-weight: bold;
}

.progress-stats {
    display: flex;
    gap: 30px;
    font-size: 14px;
    color: #7f8c8d;
}

.add-item-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.add-item-form .form-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.add-item-form input[type="text"] {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.add-item-form input[type="date"] {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.priority-check {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

.items-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
}

.items-list {
    margin-top: 15px;
}

.todo-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
}

.todo-item.priority {
    background: #fff3cd;
    border-left: 3px solid #ffc107;
}

.todo-item.completed {
    opacity: 0.7;
    background: #e8f5e9;
}

.todo-item input[type="checkbox"] {
    margin-right: 12px;
}

.todo-item label {
    flex: 1;
    cursor: pointer;
}

.todo-item.completed label {
    text-decoration: line-through;
    color: #7f8c8d;
}

.priority-badge {
    background: #ffc107;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    margin-left: 10px;
}

.due-date {
    color: #e74c3c;
    font-size: 12px;
    margin-left: 10px;
}

.completed-date {
    color: #27ae60;
    font-size: 12px;
    margin-left: 10px;
}

.delete-btn {
    background: #e74c3c;
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
}

.completed-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

.completed-section h4 {
    color: #7f8c8d;
    margin-bottom: 15px;
}

.btn {
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-primary { background: #3498db; color: white; }
.btn-success { background: #27ae60; color: white; }
.btn-danger { background: #e74c3c; color: white; }
</style>
{% endblock %}