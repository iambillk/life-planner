<!-- templates/financial/settings.html -->
{% extends "base.html" %}
{% block title %}Settings - Financial{% endblock %}
{% block header %}Financial Settings{% endblock %}

{% block extra_css %}
<style>
    :root {
        --set-bg: var(--bg, #0b0f1a);
        --set-panel: var(--panel, #121a2a);
        --set-card: var(--card, #0f1625);
        --set-line: var(--line, #1f2a3d);
        --set-text: var(--text, #e6eaf2);
        --set-muted: var(--text-muted, #9fb0c8);
        --set-primary: var(--primary, #6ea8ff);
        --set-success: var(--success, #22c55e);
        --set-warning: var(--warning, #f59e0b);
        --set-danger: var(--danger, #ef4444);
        --set-radius: var(--radius, 14px);
    }

    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header with navigation */
    .settings-header {
        background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border: 1px solid var(--set-line);
        border-radius: var(--set-radius);
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .settings-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .settings-title h1 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--set-text);
    }

    .nav-buttons {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid var(--set-line);
        background: var(--set-card);
        color: var(--set-text);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    .btn:hover {
        border-color: var(--set-primary);
        transform: translateY(-1px);
    }

    .btn-primary {
        background: var(--set-primary);
        color: white;
        border-color: var(--set-primary);
    }

    .btn-danger {
        background: transparent;
        color: var(--set-danger);
        border-color: var(--set-danger);
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    /* Tabs */
    .settings-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 25px;
        background: var(--set-card);
        border: 1px solid var(--set-line);
        border-radius: var(--set-radius);
        padding: 5px;
    }

    .tab-btn {
        flex: 1;
        padding: 12px;
        background: transparent;
        border: none;
        color: var(--set-muted);
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .tab-btn:hover {
        background: var(--set-panel);
    }

    .tab-btn.active {
        background: var(--set-primary);
        color: white;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Add Category Section */
    .add-category-card {
        background: var(--set-card);
        border: 1px solid var(--set-line);
        border-radius: var(--set-radius);
        padding: 25px;
        margin-bottom: 25px;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--set-text);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 2fr 100px 100px auto;
        gap: 15px;
        align-items: end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: var(--set-muted);
        font-size: 0.85rem;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-input {
        background: var(--set-panel);
        border: 1px solid var(--set-line);
        color: var(--set-text);
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--set-primary);
        box-shadow: 0 0 0 2px rgba(110, 168, 255, 0.2);
    }

    /* Icon Picker */
    .icon-picker {
        background: var(--set-panel);
        border: 1px solid var(--set-line);
        padding: 8px;
        border-radius: 8px;
        font-size: 1.5rem;
        width: 60px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .icon-picker:hover {
        border-color: var(--set-primary);
    }

    /* Color Picker */
    .color-picker {
        width: 60px;
        height: 42px;
        border-radius: 8px;
        border: 1px solid var(--set-line);
        cursor: pointer;
        padding: 4px;
    }

    /* Categories Grid */
    .categories-grid {
        display: grid;
        gap: 20px;
    }

    .category-item {
        background: var(--set-card);
        border: 1px solid var(--set-line);
        border-radius: var(--set-radius);
        padding: 20px;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 20px;
        align-items: center;
        transition: all 0.2s ease;
    }

    .category-item:hover {
        border-color: var(--set-primary);
        transform: translateX(4px);
    }

    .category-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--set-panel);
        border-radius: 12px;
        font-size: 24px;
    }

    .category-info {
        flex: 1;
    }

    .category-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--set-text);
        margin-bottom: 5px;
    }

    .category-stats {
        display: flex;
        gap: 15px;
        font-size: 0.85rem;
        color: var(--set-muted);
    }

    .category-type {
        padding: 3px 8px;
        background: var(--set-panel);
        border: 1px solid var(--set-line);
        border-radius: 6px;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--set-muted);
    }

    .category-type.predefined {
        border-color: var(--set-primary);
        color: var(--set-primary);
    }

    .category-type.custom {
        border-color: var(--set-success);
        color: var(--set-success);
    }

    .category-actions {
        display: flex;
        gap: 8px;
    }

    /* Merchant Aliases Section */
    .aliases-grid {
        display: grid;
        gap: 12px;
    }

    .alias-item {
        background: var(--set-panel);
        border: 1px solid var(--set-line);
        border-radius: 10px;
        padding: 12px 16px;
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 15px;
        align-items: center;
    }

    .alias-merchant {
        font-weight: 500;
        color: var(--set-text);
    }

    .alias-arrow {
        color: var(--set-muted);
    }

    .alias-category {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--set-card);
        border: 1px solid var(--set-line);
        border-radius: 8px;
        font-size: 0.85rem;
    }

    /* Icon Suggestions */
    .icon-suggestions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .icon-option {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--set-panel);
        border: 1px solid var(--set-line);
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s ease;
    }

    .icon-option:hover {
        border-color: var(--set-primary);
        transform: scale(1.1);
    }

    /* Color Presets */
    .color-presets {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 2px solid var(--set-line);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .color-option:hover {
        border-color: var(--set-text);
        transform: scale(1.1);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--set-muted);
    }

    .empty-icon {
        font-size: 48px;
        opacity: 0.5;
        margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .category-item {
            grid-template-columns: auto 1fr;
        }

        .category-actions {
            grid-column: span 2;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header -->
    <div class="settings-header">
        <div class="settings-title">
            <span style="font-size: 32px;">‚öôÔ∏è</span>
            <h1>Financial Settings</h1>
        </div>
        <div class="nav-buttons">
            <a href="{{ url_for('financial.dashboard') }}" class="btn">
                <span>‚Üê</span> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <div class="settings-tabs">
        <button class="tab-btn active" onclick="showTab('categories')">
            <span>üìÇ</span> Categories
        </button>
        <button class="tab-btn" onclick="showTab('merchants')">
            <span>üè™</span> Merchant Rules
        </button>
    </div>

    <!-- Categories Tab -->
    <div id="categories-tab" class="tab-content active">
        <!-- Add New Category -->
        <div class="add-category-card">
            <h2 class="card-title">
                <span>‚ûï</span> Add New Category
            </h2>
            
            <form method="POST" action="{{ url_for('financial.settings') }}">
                <input type="hidden" name="action" value="add_category">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category Name</label>
                        <input type="text" name="name" class="form-input" 
                               placeholder="e.g., Coffee, Electronics, etc." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Icon</label>
                        <input type="text" name="icon" class="icon-picker" 
                               value="üí∞" maxlength="2" id="iconPicker">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <input type="color" name="color" class="color-picker" 
                               value="#6ea8ff" id="colorPicker">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        Add Category
                    </button>
                </div>
            </form>
            
            <!-- Icon Suggestions -->
            <div class="icon-suggestions">
                <div class="icon-option" onclick="setIcon('üí∞')">üí∞</div>
                <div class="icon-option" onclick="setIcon('üõí')">üõí</div>
                <div class="icon-option" onclick="setIcon('üçΩÔ∏è')">üçΩÔ∏è</div>
                <div class="icon-option" onclick="setIcon('‚òï')">‚òï</div>
                <div class="icon-option" onclick="setIcon('üçî')">üçî</div>
                <div class="icon-option" onclick="setIcon('‚õΩ')">‚õΩ</div>
                <div class="icon-option" onclick="setIcon('üöó')">üöó</div>
                <div class="icon-option" onclick="setIcon('üíä')">üíä</div>
                <div class="icon-option" onclick="setIcon('üè†')">üè†</div>
                <div class="icon-option" onclick="setIcon('üì±')">üì±</div>
                <div class="icon-option" onclick="setIcon('üíª')">üíª</div>
                <div class="icon-option" onclick="setIcon('üëï')">üëï</div>
                <div class="icon-option" onclick="setIcon('üéÆ')">üéÆ</div>
                <div class="icon-option" onclick="setIcon('üìö')">üìö</div>
                <div class="icon-option" onclick="setIcon('üêï')">üêï</div>
                <div class="icon-option" onclick="setIcon('üé¨')">üé¨</div>
                <div class="icon-option" onclick="setIcon('‚úàÔ∏è')">‚úàÔ∏è</div>
                <div class="icon-option" onclick="setIcon('üéÅ')">üéÅ</div>
                <div class="icon-option" onclick="setIcon('üí™')">üí™</div>
                <div class="icon-option" onclick="setIcon('üé®')">üé®</div>
            </div>
            
            <!-- Color Presets -->
            <div class="color-presets">
                <div class="color-option" style="background: #22c55e;" onclick="setColor('#22c55e')"></div>
                <div class="color-option" style="background: #f59e0b;" onclick="setColor('#f59e0b')"></div>
                <div class="color-option" style="background: #ef4444;" onclick="setColor('#ef4444')"></div>
                <div class="color-option" style="background: #8b5cf6;" onclick="setColor('#8b5cf6')"></div>
                <div class="color-option" style="background: #06b6d4;" onclick="setColor('#06b6d4')"></div>
                <div class="color-option" style="background: #ec4899;" onclick="setColor('#ec4899')"></div>
                <div class="color-option" style="background: #14b8a6;" onclick="setColor('#14b8a6')"></div>
                <div class="color-option" style="background: #6366f1;" onclick="setColor('#6366f1')"></div>
                <div class="color-option" style="background: #84cc16;" onclick="setColor('#84cc16')"></div>
                <div class="color-option" style="background: #a855f7;" onclick="setColor('#a855f7')"></div>
            </div>
        </div>

        <!-- Existing Categories -->
        <div class="add-category-card">
            <h2 class="card-title">
                <span>üìÇ</span> Existing Categories
            </h2>
            
            <div class="categories-grid">
                {% for category in categories %}
                <div class="category-item">
                    <div class="category-icon" style="background: {{ category.color }}20;">
                        {{ category.icon }}
                    </div>
                    
                    <div class="category-info">
                        <div class="category-name">{{ category.name }}</div>
                        <div class="category-stats">
                            <span>üìä {{ category_stats.get(category.id, {}).get('count', 0) }} transactions</span>
                            <span>üí∞ ${{ "%.2f"|format(category_stats.get(category.id, {}).get('total', 0)) }}</span>
                        </div>
                    </div>
                    
                    <div class="category-type {% if category.is_custom %}custom{% else %}predefined{% endif %}">
                        {% if category.is_custom %}Custom{% else %}System{% endif %}
                    </div>
                    
                    <div class="category-actions">
                        {% if category.is_custom and category_stats.get(category.id, {}).get('count', 0) == 0 %}
                        <form method="POST" action="{{ url_for('financial.settings') }}" 
                              style="display: inline;"
                              onsubmit="return confirm('Delete category {{ category.name }}?');">
                            <input type="hidden" name="action" value="delete_category">
                            <input type="hidden" name="category_id" value="{{ category.id }}">
                            <button type="submit" class="btn btn-danger" style="padding: 6px 10px;">
                                üóëÔ∏è
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Merchant Rules Tab -->
    <div id="merchants-tab" class="tab-content">
        <!-- Add Merchant Rule -->
        <div class="add-category-card">
            <h2 class="card-title">
                <span>‚ûï</span> Add Merchant Auto-Category Rule
            </h2>
            
            <form method="POST" action="{{ url_for('financial.settings') }}">
                <input type="hidden" name="action" value="add_merchant_alias">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Merchant Name (as appears on statement)</label>
                        <input type="text" name="merchant" class="form-input" 
                               placeholder="e.g., STARBUCKS #12345" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Display Name (optional)</label>
                        <input type="text" name="canonical" class="form-input" 
                               placeholder="e.g., Starbucks">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Auto-Category</label>
                        <select name="default_category" class="form-input" required>
                            <option value="">Select category...</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">
                                {{ category.icon }} {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        Add Rule
                    </button>
                </div>
            </form>
        </div>

        <!-- Existing Merchant Rules -->
        <div class="add-category-card">
            <h2 class="card-title">
                <span>üè™</span> Merchant Auto-Category Rules
            </h2>
            
            {% if aliases %}
            <div class="aliases-grid">
                {% for alias in aliases %}
                <div class="alias-item">
                    <div class="alias-merchant">
                        {{ alias.alias }}
                        {% if alias.canonical_name != alias.alias %}
                        <span style="color: var(--set-muted); font-size: 0.85rem;">
                            ‚Üí {{ alias.canonical_name }}
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if alias.default_category %}
                    <div class="alias-category">
                        <span>{{ alias.default_category.icon }}</span>
                        <span>{{ alias.default_category.name }}</span>
                    </div>
                    {% endif %}
                    
                    <form method="POST" action="{{ url_for('financial.settings') }}" 
                          style="display: inline;"
                          onsubmit="return confirm('Delete rule for {{ alias.alias }}?');">
                        <input type="hidden" name="action" value="delete_alias">
                        <input type="hidden" name="alias_id" value="{{ alias.id }}">
                        <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;">
                            ‚úï
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üè™</div>
                <h3>No merchant rules yet</h3>
                <p>Add rules to automatically categorize transactions from specific merchants</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Tab switching
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Mark button as active
    event.target.closest('.tab-btn').classList.add('active');
}

// Icon picker
function setIcon(icon) {
    document.getElementById('iconPicker').value = icon;
}

// Color picker
function setColor(color) {
    document.getElementById('colorPicker').value = color;
}

// Initialize with some emojis in the icon field
document.getElementById('iconPicker').addEventListener('click', function() {
    // You could open an emoji picker here
    this.select();
});
</script>
{% endblock %}