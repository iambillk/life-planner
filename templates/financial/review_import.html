<!-- templates/financial/review_import.html -->
{% extends "base.html" %}
{% block title %}Review Import - Financial{% endblock %}
{% block header %}Review Import{% endblock %}

{% block extra_css %}
<style>
    :root {
        --rev-bg: var(--bg, #0b0f1a);
        --rev-panel: var(--panel, #121a2a);
        --rev-card: var(--card, #0f1625);
        --rev-line: var(--line, #1f2a3d);
        --rev-text: var(--text, #e6eaf2);
        --rev-muted: var(--text-muted, #9fb0c8);
        --rev-primary: var(--primary, #6ea8ff);
        --rev-success: var(--success, #22c55e);
        --rev-warning: var(--warning, #f59e0b);
        --rev-danger: var(--danger, #ef4444);
        --rev-radius: var(--radius, 14px);
    }

    .review-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Summary Card */
    .summary-card {
        background: linear-gradient(135deg, var(--rev-card), var(--rev-panel));
        border: 1px solid var(--rev-line);
        border-radius: var(--rev-radius);
        padding: 25px;
        margin-bottom: 25px;
    }

    .summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .summary-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .summary-icon {
        font-size: 36px;
    }

    .summary-text h2 {
        margin: 0;
        color: var(--rev-text);
        font-size: 1.4rem;
    }

    .summary-subtitle {
        color: var(--rev-muted);
        margin-top: 5px;
        font-size: 0.9rem;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--rev-line);
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--rev-text);
    }

    .stat-label {
        color: var(--rev-muted);
        font-size: 0.85rem;
        margin-top: 5px;
    }

    /* Transactions Table */
    .transactions-card {
        background: var(--rev-card);
        border: 1px solid var(--rev-line);
        border-radius: var(--rev-radius);
        overflow: hidden;
        margin-bottom: 20px;
    }

    .card-header {
        background: var(--rev-panel);
        padding: 15px 20px;
        border-bottom: 1px solid var(--rev-line);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--rev-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .transactions-table {
        width: 100%;
        border-collapse: collapse;
    }

    .transactions-table th {
        background: var(--rev-panel);
        color: var(--rev-muted);
        font-weight: 600;
        text-align: left;
        padding: 12px 15px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--rev-line);
    }

    .transactions-table td {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(31, 42, 61, 0.5);
        color: var(--rev-text);
    }

    .transactions-table tbody tr:hover {
        background: rgba(110, 168, 255, 0.05);
    }

    .transaction-date {
        color: var(--rev-muted);
        font-size: 0.9rem;
    }

    .transaction-merchant {
        font-weight: 500;
        color: var(--rev-text);
    }

    .transaction-amount {
        font-weight: 600;
        color: var(--rev-text);
        text-align: right;
    }

    .category-select {
        background: var(--rev-panel);
        border: 1px solid var(--rev-line);
        color: var(--rev-text);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 150px;
    }

    .category-select:hover {
        border-color: var(--rev-primary);
    }

    .category-select:focus {
        outline: none;
        border-color: var(--rev-primary);
        box-shadow: 0 0 0 2px rgba(110, 168, 255, 0.2);
    }

    /* Skipped Transactions */
    .skipped-card {
        background: var(--rev-panel);
        border: 1px solid var(--rev-line);
        border-radius: var(--rev-radius);
        padding: 20px;
        margin-bottom: 20px;
    }

    .skipped-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: var(--rev-warning);
    }

    .skipped-list {
        display: grid;
        gap: 10px;
    }

    .skipped-item {
        display: grid;
        grid-template-columns: 100px 1fr auto 150px;
        gap: 15px;
        padding: 10px;
        background: var(--rev-card);
        border: 1px solid var(--rev-line);
        border-radius: 8px;
        align-items: center;
    }

    .skipped-date {
        color: var(--rev-muted);
        font-size: 0.85rem;
    }

    .skipped-merchant {
        color: var(--rev-text);
    }

    .skipped-amount {
        text-align: right;
        font-weight: 600;
        color: var(--rev-muted);
    }

    .skipped-reason {
        padding: 3px 8px;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--rev-warning);
        border-radius: 6px;
        font-size: 0.8rem;
        text-align: center;
    }

    /* Actions */
    .actions-bar {
        background: var(--rev-card);
        border: 1px solid var(--rev-line);
        border-radius: var(--rev-radius);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        bottom: 20px;
        margin-top: 20px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }

    .action-summary {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .action-stat {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--rev-muted);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: var(--rev-radius);
        border: 1px solid var(--rev-line);
        background: var(--rev-card);
        color: var(--rev-text);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    .btn-primary {
        background: var(--rev-success);
        color: white;
        border-color: var(--rev-success);
    }

    .btn-primary:hover {
        background: #1ea34b;
    }

    .btn-danger {
        background: transparent;
        color: var(--rev-danger);
        border-color: var(--rev-danger);
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--rev-muted);
    }

    .empty-icon {
        font-size: 48px;
        opacity: 0.5;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="review-container">
    <!-- Summary Card -->
    <div class="summary-card">
        <div class="summary-header">
            <div class="summary-title">
                <div class="summary-icon">📋</div>
                <div class="summary-text">
                    <h2>Review Import</h2>
                    <div class="summary-subtitle">Confirm categories before importing</div>
                </div>
            </div>
        </div>

        <div class="summary-stats">
            <div class="stat-item">
                <div class="stat-value">{{ import_data.total_count }}</div>
                <div class="stat-label">Transactions to Import</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${{ "%.2f"|format(import_data.total_amount) }}</div>
                <div class="stat-label">Total Amount</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ import_data.skipped_count }}</div>
                <div class="stat-label">Skipped (Payments/Duplicates)</div>
            </div>
        </div>
    </div>

    <!-- Transactions to Import -->
    {% if import_data.transactions %}
    <div class="transactions-card">
        <div class="card-header">
            <div class="card-title">
                <span>✅</span> Transactions to Import
            </div>
            <span style="color: var(--rev-muted); font-size: 0.9rem;">
                Review and adjust categories as needed
            </span>
        </div>
        
        <form method="POST" action="{{ url_for('financial.review_import') }}" id="importForm">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Merchant</th>
                        <th>Amount</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in import_data.transactions %}
                    <tr>
                        <td class="transaction-date">{{ trans.date_str }}</td>
                        <td class="transaction-merchant">
                            {{ trans.merchant[:50] }}{% if trans.merchant|length > 50 %}...{% endif %}
                        </td>
                        <td class="transaction-amount">${{ "%.2f"|format(trans.amount) }}</td>
                        <td>
                            <select name="category_{{ trans.reference }}" class="category-select">
                                <option value="">-- Uncategorized --</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {% if category.id == trans.suggested_category_id %}selected{% endif %}>
                                    {{ category.icon }} {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
    {% else %}
    <div class="transactions-card">
        <div class="empty-state">
            <div class="empty-icon">📭</div>
            <h3>No transactions to import</h3>
            <p>All transactions have already been imported or are payments/credits.</p>
        </div>
    </div>
    {% endif %}

    <!-- Skipped Transactions -->
    {% if import_data.skipped %}
    <div class="skipped-card">
        <div class="skipped-header">
            <span>⚠️</span>
            <strong>Skipped Transactions ({{ import_data.skipped_count }})</strong>
        </div>
        
        <div class="skipped-list">
            {% for skip in import_data.skipped[:10] %}
            <div class="skipped-item">
                <div class="skipped-date">{{ skip.date }}</div>
                <div class="skipped-merchant">{{ skip.description[:50] }}</div>
                <div class="skipped-amount">${{ "%.2f"|format(skip.amount|abs) }}</div>
                <div class="skipped-reason">{{ skip.reason }}</div>
            </div>
            {% endfor %}
            
            {% if import_data.skipped|length > 10 %}
            <div style="text-align: center; color: var(--rev-muted); padding: 10px;">
                ... and {{ import_data.skipped|length - 10 }} more
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Actions Bar -->
    <div class="actions-bar">
        <div class="action-summary">
            <div class="action-stat">
                <span>💳</span>
                <span>Ready to import <strong>{{ import_data.total_count }}</strong> transactions</span>
            </div>
            <div class="action-stat">
                <span>💰</span>
                <span>Total: <strong>${{ "%.2f"|format(import_data.total_amount) }}</strong></span>
            </div>
        </div>
        
        <div class="action-buttons">
            <a href="{{ url_for('financial.cancel_import') }}" class="btn btn-danger">
                <span>✕</span> Cancel
            </a>
            {% if import_data.transactions %}
            <button type="submit" form="importForm" class="btn btn-primary" 
                    onclick="return confirm('Import {{ import_data.total_count }} transactions?');">
                <span>✓</span> Confirm Import
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}