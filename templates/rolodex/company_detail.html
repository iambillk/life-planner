{% extends "base.html" %}
{% block title %}{{ company.name }} ¬∑ Rolodex{% endblock %}

{% block content %}
<style>
  /* Force small logo */
  .company-logo img {
    width: 80px !important;
    height: 80px !important;
    max-width: 80px !important;
    max-height: 80px !important;
    object-fit: contain !important;
    border-radius: 8px !important;
  }
  
  /* Force small contact avatars */
  .contact-avatar-small img {
    width: 35px !important;
    height: 35px !important;
    max-width: 35px !important;
    max-height: 35px !important;
    object-fit: cover !important;
    border-radius: 50% !important;
  }
</style>

<div style="padding: 20px; max-width: 1000px; margin: 0 auto;">
  <!-- Back link -->
  <div style="margin-bottom: 20px;">
    <a href="{{ url_for('rolodex.companies') }}" style="color: var(--text-muted); text-decoration: none;">
      ‚Üê Back to Companies
    </a>
  </div>

  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; gap: 20px;">
    <div style="display: flex; gap: 16px; align-items: center;">
      {% if company.logo %}
      <div class="company-logo">
        <img src="{{ url_for('static', filename='company_logos/' + company.logo) }}" alt="{{ company.name }}">
      </div>
      {% else %}
      <div style="width: 80px; height: 80px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px;">
        {{ company.name[0]|upper if company.name else '?' }}
      </div>
      {% endif %}
      
      <div>
        <h1 style="margin: 0; font-size: 28px; color: var(--text);">
          {{ company.name }}
        </h1>
        {% if company.industry or company.size %}
        <p style="margin: 4px 0; color: var(--text-muted); font-size: 14px;">
          {% if company.industry %}{{ company.industry|title }}{% endif %}
          {% if company.industry and company.size %} ‚Ä¢ {% endif %}
          {% if company.size %}{{ company.size }} employees{% endif %}
        </p>
        {% endif %}
        {% if company.tags %}
        <div style="margin-top: 8px;">
          {% for tag in company.tags.split(',') %}
          <span style="display: inline-block; padding: 2px 8px; background: rgba(139,92,246,0.2); color: #a78bfa; border-radius: 4px; font-size: 11px; margin-right: 4px;">
            {{ tag.strip() }}
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    
    <div style="display: flex; gap: 8px;">
      <a href="{{ url_for('rolodex.company_edit', id=company.id) }}" 
         style="padding: 8px 16px; background: var(--primary); color: white; text-decoration: none; border-radius: 6px;">
        Edit
      </a>
      <form method="POST" action="{{ url_for('rolodex.company_delete', id=company.id) }}" 
            style="display: inline;" 
            onsubmit="return confirm('Delete this company?');">
        <button type="submit" 
                style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">
          Delete
        </button>
      </form>
    </div>
  </div>

  <!-- Company Information -->
  <div style="background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text);">
      üè¢ Company Information
    </h3>
    
    <div style="display: grid; gap: 12px;">
      {% if company.website %}
      <div style="display: flex; gap: 12px;">
        <span style="color: var(--text-muted); width: 100px;">Website:</span>
        <a href="{{ company.website }}" target="_blank" style="color: var(--primary); text-decoration: none;">
          {{ company.website }}
        </a>
      </div>
      {% endif %}
      
      {% if company.phone %}
      <div style="display: flex; gap: 12px;">
        <span style="color: var(--text-muted); width: 100px;">Phone:</span>
        <a href="tel:{{ company.phone }}" style="color: var(--text); text-decoration: none;">
          {{ company.phone }}
        </a>
      </div>
      {% endif %}
      
      {% if company.address %}
      <div style="display: flex; gap: 12px;">
        <span style="color: var(--text-muted); width: 100px;">Address:</span>
        <span>{{ company.address }}</span>
      </div>
      {% endif %}
      
      {% if company.linkedin %}
      <div style="display: flex; gap: 12px;">
        <span style="color: var(--text-muted); width: 100px;">LinkedIn:</span>
        <a href="{{ company.linkedin }}" target="_blank" style="color: var(--primary); text-decoration: none;">
          View Profile
        </a>
      </div>
      {% endif %}
      
      {% if company.twitter %}
      <div style="display: flex; gap: 12px;">
        <span style="color: var(--text-muted); width: 100px;">Twitter/X:</span>
        <a href="https://twitter.com/{{ company.twitter.replace('@', '') }}" target="_blank" style="color: var(--primary); text-decoration: none;">
          {{ company.twitter }}
        </a>
      </div>
      {% endif %}
      
      {% if not company.website and not company.phone and not company.address %}
      <span style="color: var(--text-muted); font-style: italic;">No contact information provided</span>
      {% endif %}
    </div>
  </div>

  <!-- NEW: Linked Properties (as Vendor) -->
  <section class="kcard" id="linked-properties-company" style="margin-bottom:20px;">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;">
      <div class="kcard-title">üè† Linked Properties (as Vendor)</div>
      <a class="kbtn kbtn-primary" href="{{ url_for('rolodex.company_link_property', id=company.id) }}">‚ûï Link to Property</a>
    </div>

    {% if property_links %}
    <div class="kcard-body" style="display:grid;gap:10px;">
      {% for link in property_links %}
        {% set p = properties_by_id.get(link.target_id) %}
        <article class="kmini" style="border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
          <div style="min-width:0;">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <a class="kbtn" href="{{ url_for('realestate.property_detail', id=link.target_id) }}">{{ p.name if p else ('Property #' ~ link.target_id) }}</a>
              {% if link.role %}<span class="kchip">{{ link.role }}</span>{% endif %}
              {% if link.is_primary %}<span class="kchip" style="background:rgba(110,168,255,.18);border-color:rgba(110,168,255,.45);">Primary</span>{% endif %}
              {% if link.label %}<span class="kchip" title="{{ link.label }}">{{ link.label }}</span>{% endif %}
            </div>
            {% if link.notes %}<div class="khint" style="margin-top:4px;">{{ link.notes }}</div>{% endif %}
          </div>

          <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
            <form method="POST" action="{{ url_for('rolodex.company_make_primary', id=company.id, link_id=link.id) }}">
              <button class="kbtn" {% if link.is_primary %}disabled{% endif %}>Make Primary</button>
            </form>
            <form method="POST" action="{{ url_for('rolodex.company_unlink_property', id=company.id, link_id=link.id) }}">
              <button class="kbtn kbtn-danger" onclick="return confirm('Unlink this property?')">Remove</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="kempty">No properties linked yet.</div>
    {% endif %}
  </section>

  <!-- Associated Contacts -->
  <div style="background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="margin: 0; font-size: 16px; color: var(--text);">
        üë• Contacts ({{ company.contacts.count() }})
      </h3>
      <a href="{{ url_for('rolodex.contact_new') }}?company_id={{ company.id }}" 
         style="padding: 6px 12px; background: var(--primary); color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">
        + Add Contact
      </a>
    </div>
    
    {% if company.contacts.all() %}
    <div style="display: grid; gap: 10px;">
      {% for contact in company.contacts.all() %}
      <a href="{{ url_for('rolodex.contact_detail', id=contact.id) }}" 
         style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg); border: 1px solid var(--line); border-radius: 6px; text-decoration: none; transition: all 0.2s;">
        
        <div class="contact-avatar-small">
          {% if contact.profile_photo %}
            <img src="{{ url_for('static', filename='contact_photos/' + contact.profile_photo) }}" alt="{{ contact.display_name }}">
          {% else %}
            <div style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
              {{ contact.display_name[0]|upper if contact.display_name else '?' }}
            </div>
          {% endif %}
        </div>
        
        <div style="flex: 1;">
          <div style="color: var(--primary); font-weight: 500; font-size: 14px;">{{ contact.display_name }}</div>
          {% if contact.title %}
            <div style="color: var(--text-muted); font-size: 12px;">{{ contact.title }}</div>
          {% endif %}
        </div>
        
        <div style="text-align: right; font-size: 12px;">
          {% if contact.email %}
            <div style="color: var(--text-muted);">üìß {{ contact.email }}</div>
          {% endif %}
          {% if contact.phone %}
            <div style="color: var(--text-muted);">üì± {{ contact.phone }}</div>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
      <div style="font-size: 32px; margin-bottom: 8px;">üë•</div>
      <p>No contacts yet</p>
      <a href="{{ url_for('rolodex.contact_new') }}?company_id={{ company.id }}" 
         style="padding: 6px 12px; background: var(--primary); color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">
        Add First Contact
      </a>
    </div>
    {% endif %}
  </div>

  <!-- Notes -->
  {% if company.notes %}
  <div style="background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: var(--text);">
      üìù Notes
    </h3>
    <div style="white-space: pre-wrap; color: var(--text); line-height: 1.5;">{{ company.notes }}</div>
  </div>
  {% endif %}

  <!-- Metadata -->
  <div style="background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
    <h3 style="margin: 0 0 12px 0; font-size: 16px; color: var(--text);">
      ‚ÑπÔ∏è Record Information
    </h3>
    <div style="display: grid; gap: 8px; font-size: 13px;">
      <div>
        <span style="color: var(--text-muted);">Created:</span>
        <span style="margin-left: 8px;">{{ company.created_at.strftime('%B %d, %Y at %I:%M %p') if company.created_at else 'Unknown' }}</span>
      </div>
      <div>
        <span style="color: var(--text-muted);">Updated:</span>
        <span style="margin-left: 8px;">{{ company.updated_at.strftime('%B %d, %Y at %I:%M %p') if company.updated_at else 'Never' }}</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}
