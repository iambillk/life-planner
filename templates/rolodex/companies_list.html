{% extends "base.html" %}
{% block title %}Companies · Rolodex{% endblock %}

{% block content %}
<style>
  /* Force small logos */
  td img {
    width: 40px !important;
    height: 40px !important;
    max-width: 40px !important;
    max-height: 40px !important;
    object-fit: contain !important;
    border-radius: 4px !important;
  }
</style>

<div style="padding: 20px;">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <h1 style="margin: 0; font-size: 24px;">📋 Rolodex</h1>
      <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 14px;">Manage your business relationships</p>
    </div>
    <div>
      <a href="{{ url_for('rolodex.contact_new') }}" style="padding: 8px 16px; background: var(--primary); color: white; text-decoration: none; border-radius: 6px; margin-right: 8px;">+ New Contact</a>
      <a href="{{ url_for('rolodex.company_new') }}" style="padding: 8px 16px; background: var(--success); color: white; text-decoration: none; border-radius: 6px;">+ New Company</a>
    </div>
  </div>

  <!-- Tabs -->
  <div style="display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 4px;">
    <a href="{{ url_for('rolodex.contacts') }}" style="flex: 1; padding: 8px; text-align: center; color: var(--text); text-decoration: none;">👥 Contacts</a>
    <a href="{{ url_for('rolodex.companies') }}" style="flex: 1; padding: 8px; text-align: center; background: var(--primary); color: white; text-decoration: none; border-radius: 4px;">🏢 Companies</a>
  </div>

  <!-- Quick Stats -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
    <div style="background: var(--card); border: 1px solid var(--line); padding: 12px; border-radius: 6px; text-align: center;">
      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total Companies</div>
      <div style="font-size: 20px; font-weight: bold;">{{ companies.total }}</div>
    </div>
    <div style="background: var(--card); border: 1px solid var(--line); padding: 12px; border-radius: 6px; text-align: center;">
      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Active</div>
      <div style="font-size: 20px; font-weight: bold; color: var(--success);">{{ companies.total }}</div>
    </div>
    <div style="background: var(--card); border: 1px solid var(--line); padding: 12px; border-radius: 6px; text-align: center;">
      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Page</div>
      <div style="font-size: 20px; font-weight: bold;">{{ companies.page }}/{{ companies.pages or 1 }}</div>
    </div>
  </div>

  <!-- Search -->
  <form method="get" style="display: flex; gap: 10px; margin-bottom: 20px; background: var(--card); padding: 12px; border: 1px solid var(--line); border-radius: 8px;">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search companies..." style="flex: 1; padding: 6px 10px; background: var(--bg); border: 1px solid var(--line); border-radius: 4px; color: var(--text);">
    <select name="sort" style="padding: 6px 10px; background: var(--bg); border: 1px solid var(--line); border-radius: 4px; color: var(--text);">
      <option value="name_asc" {% if sort=='name_asc' %}selected{% endif %}>Name A→Z</option>
      <option value="name_desc" {% if sort=='name_desc' %}selected{% endif %}>Name Z→A</option>
      <option value="updated_desc" {% if sort=='updated_desc' %}selected{% endif %}>Recently Updated</option>
    </select>
    <label style="display: flex; align-items: center; gap: 4px;">
      <input type="checkbox" name="archived" value="1" {% if show_archived %}checked{% endif %}>
      <span>Show Archived</span>
    </label>
    <button type="submit" style="padding: 6px 14px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
  </form>

  <!-- Table -->
  {% if companies.items %}
  <div style="background: var(--card); border: 1px solid var(--line); border-radius: 8px; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--line);">
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase; width: 50px;"></th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Company</th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Contacts</th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Website</th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Phone</th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Tags</th>
          <th style="padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for co in companies.items %}
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.02);">
          <td style="padding: 8px 10px;">
            {% if co.logo %}
              <img src="{{ url_for('static', filename='company_logos/' + co.logo) }}" alt="{{ co.name }}">
            {% else %}
              <div style="width: 40px; height: 40px; border-radius: 4px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                {{ co.name[0]|upper if co.name else '?' }}
              </div>
            {% endif %}
          </td>
          
          <td style="padding: 8px 10px;">
            <a href="{{ url_for('rolodex.company_detail', id=co.id) }}" style="color: var(--primary); text-decoration: none; font-weight: 500;">
              {{ co.name }}
            </a>
            {% if co.archived %}
              <span style="display: inline-block; padding: 1px 4px; background: rgba(251,191,36,0.2); color: #fbbf24; border-radius: 4px; font-size: 9px; font-weight: 600; text-transform: uppercase; margin-left: 6px;">
                Archived
              </span>
            {% endif %}
            {% if co.city or co.state %}
              <div style="font-size: 12px; color: var(--text-muted);">
                📍 {{ co.city }}{% if co.city and co.state %}, {% endif %}{{ co.state }}
              </div>
            {% endif %}
          </td>

          <td style="padding: 8px 10px;">
            <span style="display: inline-block; padding: 2px 8px; background: var(--panel); border: 1px solid var(--line); border-radius: 12px; font-size: 12px;">
              👥 {{ co.contacts.count() }}
            </span>
          </td>
          
          <td style="padding: 8px 10px; font-size: 13px;">
            {% if co.website %}
              <a href="{{ co.website }}" target="_blank" style="color: var(--text-muted); text-decoration: none;">
                🔗 {{ co.website|replace('https://', '')|replace('http://', '')|truncate(25) }}
              </a>
            {% else %}
              —
            {% endif %}
          </td>
          
          <td style="padding: 8px 10px; font-size: 13px;">
            {% if co.phone %}
              <a href="tel:{{ co.phone }}" style="color: var(--text-muted); text-decoration: none;">
                📱 {{ co.phone }}
              </a>
            {% else %}
              —
            {% endif %}
          </td>
          
          <td style="padding: 8px 10px;">
            {% if co.tags %}
              {% for tag in co.tags.split(',')[:2] %}
                <span style="display: inline-block; padding: 2px 6px; background: rgba(139,92,246,0.2); color: #a78bfa; border-radius: 4px; font-size: 11px; margin-right: 2px;">
                  {{ tag.strip() }}
                </span>
              {% endfor %}
            {% else %}
              —
            {% endif %}
          </td>
          
          <td style="padding: 8px 10px;">
            <a href="{{ url_for('rolodex.company_detail', id=co.id) }}" style="padding: 4px 8px; background: var(--primary); color: white; text-decoration: none; border-radius: 4px; font-size: 12px; margin-right: 4px;">View</a>
            <a href="{{ url_for('rolodex.company_edit', id=co.id) }}" style="padding: 4px 8px; background: var(--panel); color: var(--text); text-decoration: none; border-radius: 4px; font-size: 12px;">Edit</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if companies.pages > 1 %}
  <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 20px;">
    {% if companies.has_prev %}
      <a href="{{ url_for('rolodex.companies', q=q, sort=sort, archived=1 if show_archived else None, page=companies.prev_num) }}" 
         style="padding: 6px 12px; background: var(--card); color: var(--text); text-decoration: none; border: 1px solid var(--line); border-radius: 4px;">
        ← Previous
      </a>
    {% endif %}
    
    <span>Page {{ companies.page }} of {{ companies.pages }}</span>
    
    {% if companies.has_next %}
      <a href="{{ url_for('rolodex.companies', q=q, sort=sort, archived=1 if show_archived else None, page=companies.next_num) }}"
         style="padding: 6px 12px; background: var(--card); color: var(--text); text-decoration: none; border: 1px solid var(--line); border-radius: 4px;">
        Next →
      </a>
    {% endif %}
  </div>
  {% endif %}

  {% else %}
  <!-- Empty State -->
  <div style="text-align: center; padding: 60px; background: var(--card); border: 1px solid var(--line); border-radius: 8px;">
    <div style="font-size: 48px;">🏢</div>
    <h2>No companies found</h2>
    <p style="color: var(--text-muted);">Start tracking your business relationships</p>
    <a href="{{ url_for('rolodex.company_new') }}" style="padding: 8px 16px; background: var(--primary); color: white; text-decoration: none; border-radius: 6px;">Add First Company</a>
  </div>
  {% endif %}
</div>
{% endblock %}