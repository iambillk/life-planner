{# =============================================================================
  FILE: projects_add_tch.html
  PURPOSE: Create New TCH Project
  TEMPLATE VERSION: v1.0.0
  LAST UPDATED: 2025-09-04

  CHANGELOG
  v1.0.0
  - NEW: Dark UI; compact grid; sticky action bar
  - NEW: Drag & drop file upload + live list + total size
  - NEW: Char counters for textareas
  - NEW: Client-side guards (date validation, single submit)
============================================================================= #}

{% extends "base.html" %}

{% block title %}Add TCH Project{% endblock %}
{% block header %}Create New TCH Project{% endblock %}

{% block extra_css %}
<style>
  /* ===========================
     Page-scoped variables (fallbacks to base)
  ============================ */
  :root{
    --ap-bg: var(--bg, #0b0f1a);
    --ap-card: var(--card, #0f1625);
    --ap-line: var(--line, #1f2a3d);
    --ap-text: var(--text, #e6eaf2);
    --ap-muted: var(--text-muted, #9fb0c8);
    --ap-primary: var(--primary, #6ea8ff);
    --ap-primary-700: var(--primary-700, #3f7fe6);
    --ap-danger: var(--danger, #ef4444);
    --ap-radius: var(--radius, 14px);
    --ap-radius-sm: var(--radius-sm, 10px);
    --ap-shadow: 0 6px 18px rgba(0,0,0,.35);
  }

  /* ===========================
     Container + sticky actions
  ============================ */
  .form-container{
    max-width: 980px;
    margin: 0 auto;
    display: grid;
    gap: 14px;
    padding: 14px;
  }

  .form-header{
    position: sticky; top: 12px; z-index: 5;
    display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--ap-line); border-radius: var(--ap-radius);
    padding: 10px 12px; box-shadow: var(--ap-shadow); backdrop-filter: blur(6px);
  }
  .form-header h1{ margin:0; font-size:1.15rem; }
  .header-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:12px; border:1px solid var(--ap-line);
    background: var(--ap-card); color: var(--ap-text); text-decoration:none;
    transition: transform .1s ease, border-color .2s ease, background .2s ease;
    font-size:.95rem;
  }
  .btn:hover{ border-color: var(--ap-primary); transform: translateY(-1px); }
  .btn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .btn-primary[disabled]{ opacity:.6; cursor:progress; }
  .btn-secondary{ background:#0c1322; }
  .btn-outline{ background:transparent; }

  /* ===========================
     Card section
  ============================ */
  .form-section{
    background: var(--ap-card);
    border:1px solid var(--ap-line);
    border-radius: var(--ap-radius);
    box-shadow: var(--ap-shadow);
    padding: 14px;
  }
  .form-section h2{
    margin: 0 0 10px 0; font-size:1.05rem; letter-spacing:.2px;
    padding-bottom:6px; border-bottom:1px dashed var(--ap-line);
    color: var(--ap-text);
  }

  /* ===========================
     Grid rows and groups
  ============================ */
  .project-form{ display:grid; gap:14px; }
  .form-row{
    display:grid; grid-template-columns: 1fr 1fr; gap:12px;
  }
  @media (max-width:820px){ .form-row{ grid-template-columns: 1fr; } }

  .form-group{ display:grid; gap:6px; }
  .form-group label{ color: var(--ap-muted); font-weight:600; }
  .hint{ color: var(--ap-muted); font-size:.85rem; }
  .required{ color: var(--ap-danger); }

  /* ===========================
     Inputs
  ============================ */
  .project-form input[type="text"],
  .project-form input[type="date"],
  .project-form select,
  .project-form textarea{
    width:100%;
    background:#0b1120;
    color: var(--ap-text);
    border:1px solid var(--ap-line);
    border-radius:10px;
    padding:10px 12px;
    font-size:.95rem;
  }
  .project-form textarea{ resize: vertical; min-height: 80px; }
  .counter{ color: var(--ap-muted); font-size:.8rem; text-align:right; }

  /* ===========================
     Attachments (drag & drop)
  ============================ */
  .drop{
    position:relative;
    border:2px dashed var(--ap-line);
    border-radius:12px;
    background:#0c1322;
    padding:12px;
    transition: border-color .2s ease, background .2s ease;
  }
  .drop.is-drag{ border-color: var(--ap-primary); background: rgba(110,168,255,.06); }
  .file-upload-input{ width:100%; }
  .file-upload-input::-webkit-file-upload-button{
    padding:8px 12px; border-radius:10px; border:none; cursor:pointer;
    color:#0a0f1a; background: var(--ap-primary);
    margin-right:10px;
  }
  .selected-files-list{ margin-top:10px; display:grid; gap:6px; }
  .file-pill{
    display:flex; align-items:center; gap:8px; padding:6px 10px;
    background:#0b1120; border:1px solid var(--ap-line); border-radius:999px;
    font-size:.9rem;
  }
  .file-pill .type{ font-weight:800; font-size:.75rem; color:#0a0f1a; padding:2px 8px; border-radius:999px; }
  .type.image{ background:#a78bfa; }  /* purple */
  .type.pdf{ background:#f87171; }    /* red */
  .type.word{ background:#60a5fa; }   /* blue */
  .type.excel{ background:#34d399; }  /* green */
  .type.archive{ background:#fbbf24; }/* amber */
  .type.other{ background:#94a3b8; }  /* slate */
  .pill-size{ margin-left:auto; color: var(--ap-muted); font-size:.8rem; }
  .totals{ margin-top:6px; padding-top:6px; border-top:1px dashed var(--ap-line); color: var(--ap-muted); font-size:.9rem; }

  /* ===========================
     Footer actions
  ============================ */
  .form-actions{ display:flex; gap:10px; justify-content:flex-end; }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <!-- Sticky header -->
  <div class="form-header">
    <h1>Create New TCH Project</h1>
    <div class="header-actions">
      <a href="{{ url_for('projects.tch_index') }}" class="btn btn-outline">‚Üê Back to Projects</a>
      <button form="createProjectForm" class="btn btn-primary" id="submitBtn">
        ‚ûï Create Project
      </button>
    </div>
  </div>

  <!-- Form -->
  <form id="createProjectForm" method="POST" class="project-form" enctype="multipart/form-data">
    <!-- ===== Basic Information ===== -->
    <div class="form-section">
      <h2>Basic Information</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="name">Project Name <span class="required">*</span></label>
          <input type="text" id="name" name="name" required placeholder="Enter project name" maxlength="120">
          <div class="hint counter" data-for="name"></div>
        </div>

        <div class="form-group">
          <label for="category">Category <span class="required">*</span></label>
          <select id="category" name="category" required>
            {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
          <div class="hint">Pick the closest fit ‚Äî you can change it later.</div>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" rows="3" placeholder="Brief description of the project" maxlength="1000"></textarea>
        <div class="counter" data-for="description"></div>
      </div>
    </div>

    <!-- ===== Project Details ===== -->
    <div class="form-section">
      <h2>Project Details</h2>

      <div class="form-group">
        <label for="goal">Goal/Objective</label>
        <textarea id="goal" name="goal" rows="2" placeholder="What do you want to achieve?" maxlength="500"></textarea>
        <div class="counter" data-for="goal"></div>
      </div>

      <div class="form-group">
        <label for="motivation">Motivation</label>
        <textarea id="motivation" name="motivation" rows="2" placeholder="Why is this project important?" maxlength="500"></textarea>
        <div class="counter" data-for="motivation"></div>
      </div>

      <div class="form-group">
        <label for="strategy">Strategy</label>
        <textarea id="strategy" name="strategy" rows="2" placeholder="How will you achieve the goal?" maxlength="500"></textarea>
        <div class="counter" data-for="strategy"></div>
      </div>
    </div>

    <!-- ===== Planning ===== -->
    <div class="form-section">
      <h2>Planning</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority" name="priority">
            {% for priority in priorities %}
              <option value="{{ priority }}" {% if priority == 'medium' %}selected{% endif %}>
                {{ priority|title }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="status">Initial Status</label>
          <select id="status" name="status">
            {% for status in statuses %}
              <option value="{{ status }}" {% if status == 'planning' %}selected{% endif %}>
                {{ status|replace('_', ' ')|title }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start_date">Start Date</label>
          <input type="date" id="start_date" name="start_date" value="{{ today }}">
        </div>

        <div class="form-group">
          <label for="deadline">Deadline (Optional)</label>
          <input type="date" id="deadline" name="deadline">
          <div class="hint" id="deadlineHint"></div>
        </div>
      </div>
    </div>

    <!-- ===== Attachments ===== -->
    <div class="form-section">
      <h2>üìé Attachments</h2>

      <div class="form-group">
        <label for="attachments">Upload Files (Optional)</label>

        <!-- Drag & drop zone wraps the input -->
        <div id="dropZone" class="drop">
          <input
            type="file"
            id="attachments"
            name="attachments"
            class="file-upload-input"
            multiple
            accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.zip,.rar,.7z">
          <div class="hint">Drag & drop files here, or click to select.</div>
        </div>

        <!-- Selected files -->
        <div id="selected-files" class="selected-files-list" aria-live="polite"></div>
        <div id="files-total" class="totals"></div>
      </div>
    </div>

    <!-- ===== Actions ===== -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary" id="submitBtnBottom">‚ûï Create Project</button>
      <a href="{{ url_for('projects.tch_index') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ============================================================================
   Add TCH Project ‚Äî client helpers
   - char counters for text/textarea
   - date validation (deadline ‚â• start)
   - drag & drop files + list + totals
   - single-submit guard with tiny "Saving‚Ä¶" state
============================================================================ */
(function(){
  // ---- Helpers --------------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ---- Character counters ---------------------------------------------------
  function wireCounter(id, max){
    const el = document.getElementById(id);
    if(!el) return;
    const counter = document.querySelector(`.counter[data-for="${id}"]`);
    const limit = parseInt(el.getAttribute('maxlength') || max || 1000, 10);
    const update = () => { if(counter) counter.textContent = `${el.value.length}/${limit}`; };
    el.addEventListener('input', update);
    update();
  }
  ['name','description','goal','motivation','strategy'].forEach(id => wireCounter(id));

  // ---- Date validation (deadline >= start) ---------------------------------
  const start = $('#start_date');
  const deadline = $('#deadline');
  const hint = $('#deadlineHint');
  function validateDates(){
    if(!start || !deadline) return true;
    if(!deadline.value){ hint.textContent = ''; return true; }
    const ok = new Date(deadline.value) >= new Date(start.value || deadline.value);
    hint.textContent = ok ? '' : '‚ö†Ô∏è Deadline must be on or after the start date.';
    hint.style.color = ok ? '' : 'var(--ap-danger)';
    return ok;
  }
  start?.addEventListener('change', validateDates);
  deadline?.addEventListener('change', validateDates);

  // ---- Drag & drop files ----------------------------------------------------
  const dz = $('#dropZone');
  const input = $('#attachments');
  const list = $('#selected-files');
  const totals = $('#files-total');

  function extType(name){
    const ext = (name.split('.').pop() || '').toLowerCase();
    if(['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)) return 'image';
    if(ext === 'pdf') return 'pdf';
    if(['doc','docx','rtf'].includes(ext)) return 'word';
    if(['xls','xlsx','csv'].includes(ext)) return 'excel';
    if(['zip','rar','7z','tar','gz'].includes(ext)) return 'archive';
    return 'other';
  }
  function fmtSize(bytes){
    if(bytes < 1024) return bytes + ' B';
    if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1024/1024).toFixed(1) + ' MB';
  }
  function renderFiles(files){
    if(!files || !files.length){ list.innerHTML=''; totals.textContent=''; return; }
    let total = 0;
    const rows = Array.from(files).map(f => {
      total += f.size;
      const t = extType(f.name);
      return `<div class="file-pill">
        <span class="type ${t}">${t}</span>
        <span class="name" title="${f.name}">${f.name}</span>
        <span class="pill-size">${fmtSize(f.size)}</span>
      </div>`;
    }).join('');
    list.innerHTML = rows;
    totals.textContent = `${files.length} file${files.length>1?'s':''} ‚Ä¢ ${fmtSize(total)}`;
  }

  input?.addEventListener('change', e => renderFiles(e.target.files));
  ['dragenter','dragover'].forEach(evt => dz?.addEventListener(evt, e => {
    e.preventDefault(); e.stopPropagation(); dz.classList.add('is-drag');
  }));
  ;['dragleave','drop'].forEach(evt => dz?.addEventListener(evt, e => {
    e.preventDefault(); e.stopPropagation(); dz.classList.remove('is-drag');
  }));
  dz?.addEventListener('drop', e => {
    if(!input) return;
    const dt = e.dataTransfer;
    if(dt?.files?.length){
      // Assign dropped files to the native input so the form submits them
      input.files = dt.files;
      renderFiles(dt.files);
    }
  });

  // ---- Single submit guard --------------------------------------------------
  const form = $('#createProjectForm');
  const topBtn = $('#submitBtn');
  const bottomBtn = $('#submitBtnBottom');
  function setSavingState(saving){
    [topBtn, bottomBtn].forEach(b=>{
      if(!b) return;
      b.disabled = !!saving;
      b.textContent = saving ? 'Saving‚Ä¶' : (b===topBtn ? '‚ûï Create Project' : '‚ûï Create Project');
    });
  }
  form?.addEventListener('submit', (e)=>{
    if(!validateDates()){ e.preventDefault(); return; }
    setSavingState(true);
  });

})();
</script>
{% endblock %}
