{# =============================================================================
FILE: templates/network/devices_list.html
TITLE: Home Network ‚Äî Devices
VERSION: v4.8.0
UPDATED: 2025-10-01

v4.8.0 (downloadable build)
- Rebuild Service Alerts hero:
  ‚Ä¢ Headline: "LibreNMS Failures"
  ‚Ä¢ Split severity panes (Critical / Warnings) with live counts
  ‚Ä¢ Robust counting from summary.by_severity or items[] fallback
  ‚Ä¢ Cache-busted fetch (& no-store) to avoid stale JSON
  ‚Ä¢ CTA aligned in a 2-col grid; split bar also opens modal
- Minor KPI sizing/tightening + "Last updated" timestamp
============================================================================ #}
{% extends "base.html" %}
{% block title %}üåê WTR Network Devices{% endblock %}
{% block header %}üåê WTR Network Command Center{% endblock %}

{% block extra_css %}
<style>
  :root {
    --nd-bg: var(--bg, #0b0f1a);
    --nd-panel: var(--panel, #121a2a);
    --nd-card: var(--card, #0f1625);
    --nd-line: var(--line, #1f2a3d);
    --nd-text: var(--text, #e6eaf2);
    --nd-muted: var(--text-muted, #9fb0c8);
    --nd-primary: var(--primary, #6ea8ff);
    --nd-primary-700: var(--primary-700, #3f7fe6);
    --nd-success: var(--success, #22c55e);
    --nd-warning: var(--warning, #f59e0b);
    --nd-danger: var(--danger, #ef4444);
    --nd-info: #38bdf8;
    --nd-radius: var(--radius, 14px);
    --nd-radius-sm: var(--radius-sm, 10px);
    --nd-shadow: 0 8px 24px rgba(0,0,0,.35);
    --nd-glow-green: 0 0 20px rgba(34,197,94,.6);
    --nd-glow-red: 0 0 20px rgba(239,68,68,.6);
    --nd-glow-blue: 0 0 20px rgba(110,168,255,.4);
  }

  .network-container { max-width: 1400px; margin: 0 auto; padding: 1rem; display: grid; gap: 1.5rem; }

  /* Force LibreNMS Failures card to neutral look */
  .alerts-card.alerts-ok,
  .alerts-card.alerts-warn,
  .alerts-card.alerts-crit {
  border-top: none !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03),
              0 10px 24px rgba(0,0,0,.28) !important;
}

  /* Hero */
  .hero-header { background: linear-gradient(135deg, var(--nd-card) 0%, rgba(110,168,255,.08) 100%); border: 1px solid var(--nd-line); border-radius: var(--nd-radius); padding: 1.25rem; box-shadow: var(--nd-shadow); position: relative; overflow: hidden; }
  .hero-header::before { content:""; position:absolute; top:-50%; right:-10%; width:300px; height:300px; background:radial-gradient(circle, var(--nd-primary) 0%, transparent 70%); opacity:.1; }
  .hero-content { position:relative; z-index:1; }
  .hero-top { display:flex; align-items:flex-end; justify-content:space-between; gap:1rem; margin-bottom:.75rem; }
  .hero-title { font-size:1.65rem; font-weight:800; background:linear-gradient(90deg, var(--nd-text), var(--nd-primary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; display:flex; align-items:center; gap:.75rem; }
  .hero-subtitle { color: var(--nd-muted); font-size:.9rem; }
  .hero-updated { color: var(--nd-muted); font-size:.8rem; opacity:.9; }

  /* KPIs */
  .kpi-dual { display:grid; grid-template-columns: repeat(2, minmax(200px,1fr)); gap:.6rem; margin-top:.5rem; }
  .kpi { position:relative; border-radius:var(--nd-radius-sm); padding:.7rem .9rem; overflow:hidden; color:#fff; box-shadow:var(--nd-shadow); border:1px solid var(--nd-line); display:flex; align-items:center; gap:.6rem; isolation:isolate; min-height:72px; }
  .kpi::after { content:""; position:absolute; inset:0; opacity:.12; background: radial-gradient(600px 200px at 80% -20%, #fff, transparent); z-index:0; }
  .kpi .kpi-icon{ font-size:1.4rem; z-index:1; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); }
  .kpi .kpi-body{ z-index:1; }
  .kpi .kpi-label{ text-transform:uppercase; letter-spacing:.05em; font-size:.68rem; opacity:.95; margin-bottom:.12rem; }
  .kpi .kpi-value{ font-size:1.35rem; font-weight:800; line-height:1; }
  .kpi .kpi-sub{ font-size:.72rem; opacity:.9; margin-top:.1rem; }
  .kpi.up{ background:linear-gradient(135deg, rgba(34,197,94,.95), #16a34a); box-shadow:var(--nd-glow-green);} 
  .kpi.down{ background:linear-gradient(135deg, rgba(239,68,68,.95), #dc2626); box-shadow:var(--nd-glow-red);} 

  /* Add spacing between hero KPIs and LibreNMS card */
  .alerts-card {
  margin-top: 1.00rem; /* adjust as needed */

}

  /* Service Alerts (full width) */
  .alerts-card{ background:linear-gradient(135deg, rgba(14,20,33,.95), rgba(18,26,42,.92)); border:1px solid var(--nd-line); grid-column: 1 / -1; display:grid; grid-template-columns: 1fr auto; align-items:center; gap:1rem; padding:1rem 1.25rem; border-radius:var(--nd-radius); box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 10px 24px rgba(0,0,0,.28); }
  .alerts-card.alerts-ok{border-top:3px solid rgba(34,197,94,.7);} 
  .alerts-card.alerts-warn{border-top:3px solid rgba(245,158,11,.7);} 
  .alerts-card.alerts-crit{border-top:3px solid rgba(239,68,68,.8); box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 12px 30px rgba(239,68,68,.12);} 
  .alerts-main{ display:flex; align-items:center; gap:1rem; flex:1; }
  .alerts-icon{ font-size:2.2rem; line-height:1; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); }
  .alerts-headline{ display:flex; align-items:baseline; gap:.5rem; flex-wrap:wrap; font-weight:900; letter-spacing:.01em; }
  .alerts-headline .dim{ color:var(--nd-muted); font-weight:700; font-size:1.1rem; }
  .alerts-badges{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem; }
  .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.28rem .55rem; border-radius:999px; font-size:.78rem; line-height:1; background:rgba(255,255,255,.03); border:1px solid rgba(159,176,200,.25); color:var(--nd-text); } 

  /* Split severity panes */
  .alerts-split{ display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-top:.7rem; }
  .alerts-pane{ position:relative; border-radius:12px; padding:.7rem .9rem; color:#fff; display:flex; align-items:center; gap:.7rem; box-shadow:0 6px 16px rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.06); }
  .alerts-pane .count{ font-size:1.1rem; font-weight:900; background:rgba(255,255,255,.12); border-radius:10px; padding:.2rem .5rem; }
  .alerts-pane .label{ font-size:.82rem; font-weight:800; text-transform:uppercase; letter-spacing:.04em; opacity:.95; }
  .alerts-pane.crit{ background:linear-gradient(135deg, rgba(239,68,68,.95), #dc2626); box-shadow:0 0 20px rgba(239,68,68,.25); }
  .alerts-pane.warn{ background:linear-gradient(135deg, rgba(245,158,11,.95), #d97706); box-shadow:0 0 20px rgba(245,158,11,.25); }

  .alerts-cta{ align-self:center; display:flex; align-items:center; justify-self:end; }

  /* Toolbar */
  .toolbar-container{ position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(11,15,26,.98), rgba(11,15,26,.9)); backdrop-filter: blur(10px); padding:1rem 0; margin:-1rem -1rem 1rem; padding-left:1rem; padding-right:1rem; }
  .toolbar{ display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap; background:var(--nd-card); padding:.75rem; border-radius:var(--nd-radius); border:1px solid var(--nd-line); box-shadow:0 4px 12px rgba(0,0,0,.2); }
  .filters{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; flex:1; }
  .search-input{ position:relative; flex:1; min-width:250px; }
  .search-input input{ width:100%; padding:.6rem 1rem .6rem 2.2rem; background:var(--nd-panel); color:var(--nd-text); border:1px solid var(--nd-line); border-radius:var(--nd-radius-sm); font-size:.875rem; }
  .search-input::before{ content:'üîç'; position:absolute; left:.6rem; top:50%; transform:translateY(-50%); opacity:.5; }
  select{ background:var(--nd-panel); color:var(--nd-text); border:1px solid var(--nd-line); border-radius:var(--nd-radius-sm); padding:.6rem 2rem .6rem 1rem; font-size:.875rem; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239fb0c8' d='M6 8L2 4h8z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right .5rem center; }
  input:focus, select:focus{ outline:none; border-color:var(--nd-primary); box-shadow:0 0 0 3px rgba(110,168,255,.15); }
  .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:var(--nd-radius-sm); font-size:.875rem; font-weight:600; border:none; cursor:pointer; }
  .btn-primary{ background:linear-gradient(135deg, var(--nd-primary), var(--nd-primary-700)); color:#fff; }
  .btn-secondary{ background:var(--nd-panel); color:var(--nd-text); border:1px solid var(--nd-line); }
  .view-toggle{ display:flex; background:var(--nd-panel); border-radius:var(--nd-radius-sm); padding:.25rem; gap:.25rem; }
  .view-btn{ padding:.5rem .875rem; background:transparent; color:var(--nd-muted); border-radius:var(--nd-radius-sm); border:none; cursor:pointer; font-size:.875rem; font-weight:500; }
  .view-btn.active{ background:var(--nd-primary); color:#fff; box-shadow:0 2px 8px rgba(110,168,255,.3); }

  /* Cards */
  .devices-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(380px,1fr)); gap:1.1rem; }
  .device-card{ background:var(--nd-card); border:1px solid var(--nd-line); border-radius:var(--nd-radius); padding:1.15rem; color:inherit; text-decoration:none; display:block; position:relative; transition:transform .2s ease; }
  .device-card:hover{ transform:translateY(-3px); border-color:var(--nd-primary); box-shadow:var(--nd-shadow), var(--nd-glow-blue); }

  /* Status ribbon */
  .status-ribbon{ position:absolute; top:-1px; right:1.15rem; padding:.45rem .9rem; border-radius:0 0 var(--nd-radius-sm) var(--nd-radius-sm); font-size:.7rem; font-weight:800; text-transform:uppercase; letter-spacing:.05em; z-index:2; display:flex; align-items:center; gap:.375rem; }
  .status-up{ background:linear-gradient(135deg, var(--nd-success), #16a34a); color:#fff; box-shadow:var(--nd-glow-green); }
  .status-down{ background:linear-gradient(135deg, var(--nd-danger), #dc2626); color:#fff; box-shadow:var(--nd-glow-red); animation: alertPulse 2s infinite; }
  .status-unknown{ background:var(--nd-panel); color:var(--nd-muted); border:1px solid var(--nd-line); }
  @keyframes alertPulse{0%,100%{opacity:1;}50%{opacity:.85;}}

  .device-header{ display:flex; align-items:flex-start; gap:1rem; margin-bottom:.9rem; }
  .device-icon{ font-size:2.35rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); }
  .device-name{ font-size:1.07rem; font-weight:700; color:var(--nd-text); margin-bottom:.18rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .role-badge{ display:inline-flex; align-items:center; gap:.25rem; padding:.22rem .55rem; background:var(--nd-panel); border:1px solid var(--nd-line); border-radius:.375rem; font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.025em; }
  .device-info{ display:grid; grid-template-columns: repeat(2,1fr); gap:.8rem; margin-bottom:.8rem; }
  .info-item{ display:flex; align-items:center; gap:.6rem; }
  .info-icon{ font-size:1.1rem; opacity:.8; }
  .info-label{ font-size:.68rem; color:var(--nd-muted); text-transform:uppercase; letter-spacing:.025em; margin-bottom:.1rem; }
  .info-value{ font-size:.9rem; color:var(--nd-text); font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .info-value.monospace{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }

  /* Live dots */
  .live-indicator{ display:inline-flex; align-items:center; gap:.35rem; }
  .live-dot{ width:.6rem; height:.6rem; border-radius:50%; background:var(--nd-muted); }
  .live-dot.up{ background:var(--nd-success); box-shadow:0 0 0 3px rgba(34,197,94,.2); animation: livePulse 2s infinite; }
  .live-dot.down{ background:var(--nd-danger); box-shadow:0 0 0 3px rgba(239,68,68,.2); animation: livePulse 1s infinite; }
  @keyframes livePulse{0%,100%{transform:scale(1);}50%{transform:scale(1.2);} }

  /* Monitoring pill */
  .mon-pill{ display:inline-flex; align-items:center; gap:.4rem; padding:.28rem .55rem; border-radius:999px; border:1px solid var(--nd-line); background:var(--nd-panel); font-size:.78rem; font-weight:600; }
  .mon-active{ color:var(--nd-success); border-color:rgba(34,197,94,.35); }
  .mon-disabled,.mon-inactive{ color:var(--nd-warning); border-color:rgba(245,158,11,.35); }
  .mon-missing{ color:var(--nd-danger); border-color:rgba(239,68,68,.35); }
  .mon-unknown,.mon-maintenance{ color:var(--nd-muted); }

  /* Table */
  .devices-table{ background:var(--nd-card); border:1px solid var(--nd-line); border-radius:var(--nd-radius); overflow:hidden; box-shadow:var(--nd-shadow); }
  .devices-table table{ width:100%; border-collapse:collapse; }
  .devices-table thead{ background:linear-gradient(180deg, var(--nd-panel), rgba(18,26,42,.8)); border-bottom:2px solid var(--nd-line); }
  .devices-table th{ padding:1rem; text-align:left; font-size:.75rem; font-weight:700; color:var(--nd-muted); text-transform:uppercase; letter-spacing:.075em; }
  .devices-table td{ padding:1rem; font-size:.9rem; color:var(--nd-text); }
  .table-device-name{ display:flex; align-items:center; gap:.625rem; }
  .table-device-icon{ font-size:1.5rem; opacity:.8; }

  .empty-state{ text-align:center; padding:4rem 2rem; background:var(--nd-card); border:2px dashed var(--nd-line); border-radius:var(--nd-radius); }
  .empty-icon{ font-size:4rem; margin-bottom:1rem; opacity:.3; }
  .empty-title{ font-size:1.25rem; font-weight:700; color:var(--nd-text); margin-bottom:.5rem; }
  .empty-message{ color:var(--nd-muted); margin-bottom:2rem; }

  /* ---------- Modal for Service Alerts ---------- */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal{ width:min(920px, 92vw); max-height:80vh; overflow:hidden; background:var(--nd-card); border:1px solid var(--nd-line); border-radius:var(--nd-radius); box-shadow:var(--nd-shadow); }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--nd-line); }
  .modal-title{ font-weight:800; font-size:1.1rem; }
  .modal-body{ padding:1rem 1.25rem; overflow:auto; max-height:calc(80vh - 120px); }
  .modal-actions{ display:flex; gap:.5rem; padding: .75rem 1.25rem; border-top:1px solid var(--nd-line); background:var(--nd-panel); }
  .table-compact{ width:100%; border-collapse:collapse; }
  .table-compact th, .table-compact td{ padding:.6rem .75rem; border-bottom:1px solid var(--nd-line); text-align:left; font-size:.9rem; }
  .pill-bad{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; border:1px solid rgba(239,68,68,.45); color:#fecaca; background:rgba(239,68,68,.08); font-size:.78rem; }
  .pill-warn{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; border:1px solid rgba(245,158,11,.45); color:#fde68a; background:rgba(245,158,11,.10); font-size:.78rem; }

  /* Service alert pills under status ribbon for per-card badges */
  .svc-badges { position: absolute; top: -1px; right: 1.15rem; display: flex; flex-direction: column; gap: 0.25rem; z-index: 1; margin-top: 2.7rem; }
  .svc-pill { padding: 0.42rem 0.8rem; border-radius: 0 0 var(--nd-radius-sm) var(--nd-radius-sm); font-size: 0.64rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.04em; display: inline-flex; align-items: center; gap: 0.3rem; white-space: nowrap; border: none; box-shadow: 0 4px 12px rgba(0,0,0,.3); }
  .svc-crit { background: linear-gradient(135deg, rgba(239,68,68,.95) 0%, #dc2626 100%); color: #fff; box-shadow: 0 0 15px rgba(239,68,68,.6); }
  .svc-warn { background: linear-gradient(135deg, rgba(245,158,11,.95) 0%, #d97706 100%); color: #fff; box-shadow: 0 0 15px rgba(245,158,11,.5); }

  @media (max-width:768px){ .modal{ width:95vw; } }
</style>
{% endblock %}

{% block content %}

{# ---------- Helpers ---------- #}
{% macro normalize_state(s) -%}
  {%- set v = (s|string)|lower -%}
  {%- if v in ['up','online','ok','true','1'] -%}up
  {%- elif v in ['down','offline','false','0','alert','critical'] -%}down
  {%- else -%}unknown
  {%- endif -%}
{%- endmacro %}

{% macro show_live_state(d, live_map) -%}
  {%- set L = (live_map[d.id] if live_map and d.id in live_map else None) -%}
  {%- if L -%}
    {%- if 'status' in L and (L['status']|lower in ['up','down','online','offline']) -%}
      {{ L['status'] }}
    {%- elif 'up' in L -%}
      {{ 'up' if L['up'] else 'down' }}
    {%- elif 'online' in L -%}
      {{ 'up' if L['online'] else 'down' }}
    {%- else -%}
      unknown
    {%- endif -%}
  {%- else -%}
    unknown
  {%- endif -%}
{%- endmacro %}

{% macro show_location(d) -%}
  {%- if d.location and d.location.name -%}{{ d.location.name }}
  {%- elif d.location_name -%}{{ d.location_name }}
  {%- elif d.location_str -%}{{ d.location_str }}
  {%- elif d.location -%}{{ d.location }}
  {%- else -%}Unknown
  {%- endif -%}
{%- endmacro %}

{% macro show_uptime_from_live(d, live_map) -%}
  {%- set L = (live_map[d.id] if live_map and d.id in live_map else None) -%}
  {%- if L and (L.uptime_seconds or L['uptime_seconds']) -%}
    {%- set secs = (L.uptime_seconds if L.uptime_seconds is defined else L['uptime_seconds'])|int -%}
    {%- set days = (secs // 86400) -%}
    {%- set hours = ((secs % 86400) // 3600) -%}
    {{ days }}d {{ hours }}h
  {%- elif L and (L.uptime_human or L['uptime_human']) -%}
    {{ L.uptime_human if L.uptime_human is defined else L['uptime_human'] }}
  {%- else -%}
    ‚Äî
  {%- endif -%}
{%- endmacro %}

{% macro get_device_icon(role) -%}
  {%- set r = (role|string)|lower -%}
  {%- if r == 'router' -%}üåê
  {%- elif r == 'switch' -%}üîÄ
  {%- elif r == 'firewall' -%}üõ°Ô∏è
  {%- elif r == 'server' -%}üñ•Ô∏è
  {%- elif r == 'storage' -%}üíæ
  {%- elif r in ['access_point','ap'] -%}üì°
  {%- elif r == 'printer' -%}üñ®Ô∏è
  {%- elif r == 'camera' -%}üìπ
  {%- elif r == 'iot' -%}üì±
  {%- elif r == 'workstation' -%}üíª
  {%- else -%}üìü
  {%- endif -%}
{%- endmacro %}

{# ---------- Server-side rough counts (JS will overwrite) ---------- #}
{% set total = devices|length %}
{% set by_status = {'up': 0, 'down': 0, 'unknown': 0} %}
{% for dd in devices %}
  {% set live_raw = show_live_state(dd, live_map) %}
  {% set norm = normalize_state(live_raw) %}
  {% set _ = by_status.update({norm: by_status.get(norm,0) + 1}) %}
{% endfor %}
{% set up_count = by_status.get('up', 0) %}
{% set down_count = by_status.get('down', 0) %}
{% set up_pct = (up_count * 100 / total) if total else 0 %}
{% set down_pct = (down_count * 100 / total) if total else 0 %}

<div class="network-container">
  <div class="hero-header">
    <div class="hero-content">
      <div class="hero-top">
        <div>
          <h1 class="hero-title"><span>üåê</span><span>WTR Network Command Center</span></h1>
          <p class="hero-subtitle">Monitor and manage the WTR Network!</p>
        </div>
        <div class="hero-updated" aria-live="polite">Last updated: <span id="last-updated">‚Äî</span></div>
      </div>

      <div class="kpi-dual">
        <div class="kpi up" role="status" aria-label="Devices Up">
          <div class="kpi-icon">‚úÖ</div>
          <div class="kpi-body">
            <div class="kpi-label">Devices Up</div>
            <div class="kpi-value" id="kpi-up-count">{{ up_count }}</div>
            <div class="kpi-sub"><span id="kpi-up-pct">{{ up_pct|round(1) }}</span>% of <span id="kpi-total">{{ total }}</span></div>
          </div>
        </div>
        <div class="kpi down" role="status" aria-label="Devices Down">
          <div class="kpi-icon">‚ùå</div>
          <div class="kpi-body">
            <div class="kpi-label">Devices Down</div>
            <div class="kpi-value" id="kpi-down-count">{{ down_count }}</div>
            <div class="kpi-sub"><span id="kpi-down-pct">{{ down_pct|round(1) }}</span>% of <span>{{ total }}</span></div>
          </div>
        </div>
      </div>

      {# ---------- Service Alerts Hero Card (full width) ---------- #}
      <div class="stat-card alerts-card alerts-ok" aria-live="polite">
        <div class="alerts-main">
          <div class="alerts-icon">üö®</div>
          <div class="stat-info">
            <div class="alerts-headline"><span class="dim">LibreNMS Failures</span></div>

            {# Type chips (server render if present) #}
            {% if svc_summary and svc_summary.by_type %}
            <div class="alerts-badges" id="svc-type-chips">
              {% for t, n in svc_summary.by_type.items() %}
              <span class="chip">{{ t }}: {{ n }}</span>
              {% endfor %}
            </div>
            {% else %}
            <div class="alerts-badges" id="svc-type-chips" style="display:none;"></div>
            {% endif %}

            {# Split severity #}
            <div class="alerts-split" role="group" aria-label="Severity breakdown" id="alerts-split">
              <div class="alerts-pane crit" title="Critical service checks">
                <div class="count" id="sev-crit">0</div>
                <div class="label">Critical</div>
              </div>
              <div class="alerts-pane warn" title="Warning service checks">
                <div class="count" id="sev-warn">0</div>
                <div class="label">Warnings</div>
              </div>
            </div>
          </div>
        </div>

        <div class="alerts-cta">
          <button class="btn btn-primary" id="btn-open-alerts" type="button" aria-haspopup="dialog" aria-controls="svc-modal-overlay" onclick="openSvcModal()">View LibreNMS Service Alerts</button>
        </div>
      </div>
      {# -------------------------------------------- #}
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar-container">
    <div class="toolbar" role="region" aria-label="Filters and controls">
      <form method="get" class="filters" role="search">
        <div class="search-input">
          <input type="text" name="q" value="{{ request.args.get('q','') }}" placeholder="Search devices..." aria-label="Search devices">
        </div>
        <select name="role" aria-label="Filter by type">
          <option value="">üè∑Ô∏è All Types</option>
          {% for r in role_choices %}
          <option value="{{ r }}" {% if request.args.get('role')==r %}selected{% endif %}>{{ get_device_icon(r) }} {{ r|replace('_',' ')|title }}</option>
          {% endfor %}
        </select>
        <select name="location_id" aria-label="Filter by location">
          <option value="">üìç All Locations</option>
          {% for loc in locations %}
          <option value="{{ loc.id }}" {% if request.args.get('location_id')|int == loc.id %}selected{% endif %}>üìç {{ loc.name }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-primary" type="submit"><span>üîç</span><span>Apply Filters</span></button>
        <a class="btn btn-secondary" href="{{ url_for('network.devices_list') }}"><span>‚Üª</span><span>Reset</span></a>
      </form>

      <div class="view-toggle" role="group" aria-label="View mode">
        <button class="view-btn active" id="btn-grid" onclick="setView('grid')" aria-pressed="true" type="button"><span>‚öè Grid</span></button>
        <button class="view-btn" id="btn-list" onclick="setView('list')" aria-pressed="false" type="button"><span>‚ò∞ List</span></button>
      </div>

      <a class="btn btn-primary" href="{{ url_for('network.device_new') }}"</span><span>Add Device</span></a>
    </div>
  </div>

  <!-- GRID VIEW -->
  <div id="grid-view" class="devices-grid" aria-label="Device cards">
    {% if devices %}
      {% for d in devices %}
      {% set live_state = normalize_state(show_live_state(d, live_map)) %}
      <a class="device-card" href="{{ url_for('network.device_detail', id=d.id) }}" data-device-id="{{ d.id }}" aria-label="{{ d.name }}">
        <div class="status-ribbon status-{{ live_state }}" data-live-status="{{ d.id }}">
          <span class="live-dot {{ live_state }}" data-live-dot="{{ d.id }}"></span>
          <span data-live-text="{{ d.id }}">{{ live_state|upper }}</span>
        </div>
        <div class="svc-badges" data-svc-badges="{{ d.librenms_device_id or '' }}"></div>
        <div class="device-header">
          <div class="device-icon">{{ get_device_icon(d.role) }}</div>
          <div class="device-main">
            <div class="device-name" title="{{ d.name }}">{{ d.name }}</div>
            <span class="role-badge">{{ get_device_icon(d.role) }} {{ d.role|default('device', true)|replace('_',' ')|title }}</span>
          </div>
        </div>

        <div class="device-info">
          <div class="info-item">
            <span class="info-icon">üåç</span>
            <div class="info-content">
              <div class="info-label">IP Address</div>
              <div class="info-value monospace">{{ d.mgmt_ip or 'Not Assigned' }}</div>
            </div>
          </div>

          <div class="info-item">
            <span class="info-icon">üìç</span>
            <div class="info-content">
              <div class="info-label">Location</div>
              <div class="info-value">{{ show_location(d) }}</div>
            </div>
          </div>

          <div class="info-item">
            <span class="info-icon">üíª</span>
            <div class="info-content">
              <div class="info-label">System</div>
              <div class="info-value">{{ d.os_name or 'Unknown' }}{% if d.os_version %} {{ d.os_version }}{% endif %}</div>
            </div>
          </div>

          <div class="info-item">
            <span class="info-icon">‚è±Ô∏è</span>
            <div class="info-content">
              <div class="info-label">Uptime</div>
              <div class="info-value" data-live-uptime="{{ d.id }}">{{ show_uptime_from_live(d, live_map) }}</div>
            </div>
          </div>

          {% if d.vendor or d.model %}
          <div class="info-item">
            <span class="info-icon">üè≠</span>
            <div class="info-content">
              <div class="info-label">Hardware</div>
              {% set vm = (d.vendor ~ ' ' ~ d.model)|trim %}
              <div class="info-value" title="{{ vm }}">{{ vm }}</div>
            </div>
          </div>
          {% endif %}

          <div class="info-item">
            <span class="info-icon">ü©∫</span>
            <div class="info-content">
              <div class="info-label">LibreNMS Status</div>
              {% set mon = (d.status or 'unknown')|lower %}
              <div class="info-value">
                <span class="mon-pill mon-{% if mon in ['active'] %}active{% elif mon in ['disabled','inactive'] %}disabled{% elif mon in ['missing'] %}missing{% elif mon in ['maintenance'] %}maintenance{% else %}unknown{% endif %}">
                  {% if mon == 'active' %}üü¢{% elif mon in ['disabled','inactive'] %}üü†{% elif mon == 'missing' %}üî¥{% elif mon == 'maintenance' %}üîµ{% else %}‚ö™{% endif %}
                  {{ mon|title }}
                </span>
              </div>
            </div>
          </div>
        </div>

        {% if d.tags %}
        <div class="device-tags">
          {% for t in d.tags.split(',') %}
          {% set tt = t.strip() %}
          {% if tt %}<span class="tag">üè∑Ô∏è {{ tt }}</span>{% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üåê</div>
        <h2 class="empty-title">No Devices Found</h2>
        <p class="empty-message">Start building your network by adding your first device.</p>
        <a class="btn btn-primary" href="{{ url_for('network.device_new') }}"><span>‚ûï</span><span>Add Your First Device</span></a>
      </div>
    {% endif %}
  </div>

  <!-- LIST VIEW -->
  <div id="list-view" class="devices-table" style="display:none" aria-label="Device table">
    <table>
      <thead>
        <tr>
          <th>Device</th>
          <th>Type</th>
          <th>Location</th>
          <th>IP Address</th>
          <th>System</th>
          <th>Hardware</th>
          <th>Live</th>
          <th>LibreNMS Status</th>
          <th>Uptime</th>
        </tr>
      </thead>
      <tbody>
        {% for d in devices %}
        {% set live_state = normalize_state(show_live_state(d, live_map)) %}
        {% set vm = (d.vendor ~ ' ' ~ d.model)|trim %}
        {% set mon = (d.status or 'unknown')|lower %}
        <tr data-device-id="{{ d.id }}">
          <td><a href="{{ url_for('network.device_detail', id=d.id) }}" class="table-device-name"><span class="table-device-icon">{{ get_device_icon(d.role) }}</span><span>{{ d.name }}</span></a></td>
          <td><span class="role-badge">{{ get_device_icon(d.role) }} {{ d.role|default('device', true)|replace('_',' ')|title }}</span></td>
          <td>üìç {{ show_location(d) }}</td>
          <td class="monospace">{{ d.mgmt_ip or '‚Äî' }}</td>
          <td>{{ d.os_name or '‚Äî' }}{% if d.os_version %} {{ d.os_version }}{% endif %}</td>
          <td title="{{ vm }}">{{ vm or '‚Äî' }}</td>
          <td>
            <span class="live-indicator">
              <span class="live-dot {{ live_state }}" data-live-dot="{{ d.id }}"></span>
              <span data-live-text="{{ d.id }}">{{ live_state|title }}</span>
            </span>
          </td>
          <td>
            <span class="mon-pill mon-{% if mon in ['active'] %}active{% elif mon in ['disabled','inactive'] %}disabled{% elif mon in ['missing'] %}missing{% elif mon in ['maintenance'] %}maintenance{% else %}unknown{% endif %}">
              {% if mon == 'active' %}üü¢{% elif mon in ['disabled','inactive'] %}üü†{% elif mon == 'missing' %}üî¥{% elif mon == 'maintenance' %}üîµ{% else %}‚ö™{% endif %}
              {{ mon|title }}
            </span>
          </td>
          <td data-live-uptime="{{ d.id }}">{{ show_uptime_from_live(d, live_map) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{# ---------- Modal Markup ---------- #}
<div class="modal-overlay" id="svc-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="svc-modal-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="svc-modal-title">üö® Service Alerts</div>
      <button class="btn btn-secondary" id="svc-btn-close" type="button" aria-label="Close">‚úñ</button>
    </div>
    <div class="modal-body">
      <div id="svc-empty" class="muted" style="display:none;">No current failing service checks.</div>
      <table class="table-compact" id="svc-table" aria-label="Current failing service checks">
        <thead>
          <tr>
            <th>Hostname</th>
            <th>Type</th>
            <th>Description</th>
            <th>Message</th>
            <th>Age</th>
          </tr>
        </thead>
        <tbody id="svc-tbody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="svc-btn-refresh" type="button">‚Üª Refresh</button>
      <button class="btn btn-danger" id="svc-btn-close2" type="button">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Initial server snapshot
  let SVC_SUMMARY = {{ (svc_summary or {'total_failed':0,'affected_devices':0,'by_type':{},'by_severity':{},'items':[]}) | tojson }};

  const modalOverlay = document.getElementById('svc-modal-overlay');
  const btnOpen   = document.getElementById('btn-open-alerts');
  const btnClose  = document.getElementById('svc-btn-close');
  const btnClose2 = document.getElementById('svc-btn-close2');
  const btnRefresh= document.getElementById('svc-btn-refresh');
  const tbody     = document.getElementById('svc-tbody');
  const emptyEl   = document.getElementById('svc-empty');

  const svcTotalsEl  = document.getElementById('svc-total');
  const svcDevicesEl = document.getElementById('svc-devices');
  const lastUpdatedEl= document.getElementById('last-updated');

  function setLastUpdated(ts){
    if(!lastUpdatedEl) return;
    const d = ts ? new Date(ts) : new Date();
    const t = d.toLocaleString(undefined, {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    lastUpdatedEl.textContent = t;
  }

  function humanAgeFromEpoch(epoch){
    if(!epoch || isNaN(Number(epoch))) return '‚Äî';
    const now = Math.floor(Date.now()/1000);
    let s = Math.max(0, now - Number(epoch));
    if(s < 60) return `${s}s`;
    const m = Math.floor(s/60); s = s%60;
    if(m < 60) return `${m}m ${s}s`;
    const h = Math.floor(m/60); const mm = m%60;
    if(h < 48) return `${h}h ${mm}m`;
    const d = Math.floor(h/24); const hh = h%24;
    return `${d}d ${hh}h`;
  }

  function renderSvcTable(summary){
    const items = (summary && summary.items) ? summary.items : [];
    tbody.innerHTML = '';
    if(!items.length){
      emptyEl.style.display = 'block';
      document.getElementById('svc-table').style.display = 'none';
      return;
    }
    emptyEl.style.display = 'none';
    document.getElementById('svc-table').style.display = 'table';
    for(const it of items){
      const tr = document.createElement('tr');
      const host = it.hostname || `#${it.device_id||'‚Äî'}`;
      const type = (it.type || 'unknown').toUpperCase();
      const desc = it.desc || '‚Äî';
      const msg  = it.message || '‚Äî';
      const age  = humanAgeFromEpoch(it.changed);
      const sev  = (it.sev || it.severity || ((it.state===2)?'critical':(it.state===1)?'warning':'unknown')).toString().toLowerCase();
      const sevPill = (sev.includes('warn') || Number(it.state)===1)
        ? `<span class="pill-warn">‚ö† ${type}</span>`
        : `<span class="pill-bad">‚õî ${type}</span>`;
      tr.innerHTML = `
        <td class="monospace">${host}</td>
        <td>${sevPill}</td>
        <td>${desc}</td>
        <td class="muted">${msg}</td>
        <td>${age}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Severity counting that tolerates many shapes
  function getSeverityCounts(summary){
    let warn = 0, crit = 0;
    if(summary){
      const sev = summary.by_severity || {};
      const lowerKeys = Object.keys(sev||{}).reduce((acc,k)=>{ acc[String(k).toLowerCase()] = sev[k]; return acc; }, {});
      const n = (v)=>Number(v||0) || 0;
      warn = n(lowerKeys.warning || lowerKeys.warnings || lowerKeys['1']);
      crit = n(lowerKeys.critical || lowerKeys.crit || lowerKeys['2']);
      if((!warn && !crit) && Array.isArray(summary.items)){
        summary.items.forEach(it=>{
          const s = String(it.sev || it.severity || it.status || '').toLowerCase();
          const stateNum = Number(it.state);
          const severityNum = Number(it.severity);
          if(s.includes('crit') || stateNum===2 || severityNum===2){ crit++; }
          else if(s.includes('warn') || stateNum===1 || severityNum===1){ warn++; }
        });
      }
    }
    return {warning: warn, critical: crit};
  }

  function updateHero(summary){
    // optional totals if you decide to re-show them somewhere
    if(svcTotalsEl)  svcTotalsEl.textContent  = summary.total_failed || 0;
    if(svcDevicesEl) svcDevicesEl.textContent = summary.affected_devices || 0;

    const {warning, critical} = getSeverityCounts(summary||{});
    const cEl = document.getElementById('sev-crit');
    const wEl = document.getElementById('sev-warn');
    if(cEl) cEl.textContent = Number(critical)||0;
    if(wEl) wEl.textContent = Number(warning)||0;

    const card = document.querySelector('.alerts-card');
    if(card){
      card.classList.remove('alerts-ok','alerts-warn','alerts-crit');
      const cls = critical>0 ? 'alerts-crit' : (warning>0 ? 'alerts-warn' : 'alerts-ok');
      card.classList.add(cls);
    }
  }

  function refreshSvcSummary(){
    const url = new URL('{{ url_for("network.api_services_failed") }}', window.location.origin);
    url.searchParams.set('_ts', Date.now());
    return fetch(url.toString(), {cache:'no-store'})
      .then(r => r.ok ? r.json() : SVC_SUMMARY)
      .then(summary => {
        if(!summary) return SVC_SUMMARY;
        SVC_SUMMARY = summary;
        updateHero(SVC_SUMMARY);
        if (modalOverlay && modalOverlay.style.display === 'flex'){
          renderSvcTable(SVC_SUMMARY);
        }
        setLastUpdated();
        return SVC_SUMMARY;
      })
      .catch(()=>SVC_SUMMARY);
  }

  function openSvcModal(){
    refreshSvcSummary().then(renderSvcTable);
    modalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeSvcModal(){
    modalOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  // Wire up modal
  if(btnOpen){ btnOpen.addEventListener('click', openSvcModal); }
  if(btnClose){ btnClose.addEventListener('click', closeSvcModal); }
  if(btnClose2){ btnClose2.addEventListener('click', closeSvcModal); }
  if(modalOverlay){
    modalOverlay.addEventListener('click', (e)=>{ if(e.target === modalOverlay) closeSvcModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modalOverlay.style.display==='flex') closeSvcModal(); });
  }
  // Make split panes clickable
  document.addEventListener('click', (e)=>{
    const pane = e.target.closest && e.target.closest('#alerts-split');
    if(pane){ openSvcModal(); }
  });

  // ------------------ View switching + live device status ------------------
  function setView(mode){
    const grid = document.getElementById('grid-view');
    const list = document.getElementById('list-view');
    const btnG = document.getElementById('btn-grid');
    const btnL = document.getElementById('btn-list');
    if(mode==='list'){
      grid.style.display='none'; list.style.display='block';
      btnG.classList.remove('active'); btnL.classList.add('active');
      btnG.setAttribute('aria-pressed','false'); btnL.setAttribute('aria-pressed','true');
      history.replaceState(null,'',updateQueryString('view','list'));
    }else{
      grid.style.display='grid'; list.style.display='none';
      btnG.classList.add('active'); btnL.classList.remove('active');
      btnG.setAttribute('aria-pressed','true'); btnL.setAttribute('aria-pressed','false');
      history.replaceState(null,'',updateQueryString('view',null));
    }
  }
  function updateQueryString(key,val){
    const url = new URL(window.location);
    if(val===null){ url.searchParams.delete(key); } else { url.searchParams.set(key,val); }
    return url.toString();
  }
  (function initViewFromQS(){ const v=new URLSearchParams(window.location.search).get('view'); if(v==='list') setView('list'); })();

  (function fetchLive(){
    const nodes = document.querySelectorAll('[data-device-id]');
    if(!nodes.length) return;
    const ids = [...new Set([...nodes].map(el => el.getAttribute('data-device-id')))];
    const url = new URL('{{ url_for("network.api_live_status") }}', window.location.origin);
    url.searchParams.set('ids', ids.join(','));
    url.searchParams.set('_ts', Date.now());
    fetch(url.toString(), {cache:'no-store'})
      .then(r => r.ok ? r.json() : {})
      .then(map => {
        let up=0, down=0, unknown=0;
        const total = ids.length;

        Object.entries(map || {}).forEach(([id, val]) => {
          const state = (typeof val === 'string' || typeof val === 'boolean' || typeof val === 'number') ? val : (val && val.status);
          const v = String(state).toLowerCase();
          const cls = (v === 'up' || v === 'online' || v === 'ok' || v === 'true' || v === '1') ? 'up'
                    : ((v === 'down' || v === 'offline' || v === 'false' || v === '0' || v === 'alert' || v === 'critical') ? 'down' : 'unknown');

          if(cls==='up') up++; else if(cls==='down') down++; else unknown++;

          document.querySelectorAll(`[data-live-dot="${id}"]`).forEach(dot=>{
            dot.classList.remove('up','down','unknown'); dot.classList.add(cls);
          });
          document.querySelectorAll(`[data-live-text="${id}"]`).forEach(txt=>{
            txt.textContent = cls.charAt(0).toUpperCase()+cls.slice(1);
          });
          document.querySelectorAll(`[data-live-status="${id}"]`).forEach(r=>{
            r.classList.remove('status-up','status-down','status-unknown'); r.classList.add(`status-${cls}`);
          });

          const upEl = document.querySelector(`[data-live-uptime="${id}"]`);
          const uptime_h = (val && val.uptime_human) || null;
          const uptime_s = (val && val.uptime_seconds);
          if(upEl){
            if(uptime_h){ upEl.textContent = uptime_h; }
            else if(typeof uptime_s === 'number'){
              const secs = Math.max(0, Math.floor(uptime_s)); const days = Math.floor(secs/86400); const hours = Math.floor((secs%86400)/3600);
              upEl.textContent = `${days}d ${hours}h`;
            }
          }
        });

        const totalEl = document.getElementById('kpi-total');
        if(totalEl) totalEl.textContent = total;
        const upEl = document.getElementById('kpi-up-count');
        const downEl = document.getElementById('kpi-down-count');
        const upPctEl = document.getElementById('kpi-up-pct');
        const downPctEl = document.getElementById('kpi-down-pct');
        if(upEl) upEl.textContent = up;
        if(downEl) downEl.textContent = down;
        if(upPctEl) upPctEl.textContent = total ? (up*100/total).toFixed(1) : '0.0';
        if(downPctEl) downPctEl.textContent = total ? (down*100/total).toFixed(1) : '0.0';
        setLastUpdated();
      })
      .catch(()=>{});
  })();

  // Initial render + periodic refresh
  document.addEventListener('DOMContentLoaded', function(){
    setLastUpdated();
    updateHero(SVC_SUMMARY||{});  // render snapshot immediately
    refreshSvcSummary();          // then fetch fresh
  });

  // Auto-refresh service summary + per-device badges every 30s
  function refreshSvcPerDevice(){
    const url = new URL('{{ url_for("network.api_services_failed_map") }}', window.location.origin);
    url.searchParams.set('_ts', Date.now());
    fetch(url.toString(), {cache:'no-store'})
      .then(r => r.ok ? r.json() : {})
      .then(map => {
        document.querySelectorAll('[data-svc-badges]').forEach(el => {
          const lnmsId = el.getAttribute('data-svc-badges');
          if (!lnmsId) { el.innerHTML = ''; return; }
          const stats = map[lnmsId] || map[Number(lnmsId)];
          if (!stats || !stats.total) { el.innerHTML = ''; return; }
          let html = '';
          if (stats.critical > 0) { html += `<span class="svc-pill svc-crit">‚õî ${stats.critical} critical</span>`; }
          if (stats.warning > 0) { html += `<span class="svc-pill svc-warn">‚ö† ${stats.warning} warning${stats.warning>1?'s':''}</span>`; }
          el.innerHTML = html;
        });
        setLastUpdated();
      })
      .catch(()=>{});
  }
  document.addEventListener('DOMContentLoaded', refreshSvcPerDevice);
  setInterval(()=>{ 
    if(modalOverlay && modalOverlay.style.display === 'flex') return;
    refreshSvcSummary();
    refreshSvcPerDevice();
  }, 30000);
</script>
{% endblock %}