{# =============================================================================
  FILE: templates/realestate/property_detail.html
  PURPOSE: Real Estate — Property Detail (summary, related entities, history)
  TEMPLATE VERSION: v1.3.1
  LAST UPDATED: 2025-09-05

  ── Changelog ──────────────────────────────────────────────────────────────────
  v1.3.1
  - Vendors list uses bullet-proof scroll container (.vendors-list) with visible,
    styled scrollbar and touch momentum scrolling.

  v1.3.0
  - Reordered sections: Maintenance above Vendors; Vendors scrollable.

  v1.2.0
  - Removed "Recent Photos" section; added captions for maintenance photos.

  v1.1.1
  - Fixed tall/odd-height action buttons across cards.
============================================================================= #}

{% extends "base.html" %}
{% block title %}{{ property.name }}{% endblock %}
{% set active = 'realestate' %}

{% block header %}{{ property.name }}{% endblock %}

{% block content %}
<div class="page-stack" style="display:flex;flex-direction:column;gap:14px;">

  {# ============================== SUMMARY CARD ============================ #}
  <section class="kcard" id="summary">
    <div class="kcard-head" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h2 class="kcard-title" style="margin:0;">{{ property.name }}</h2>
        {% if property.property_type %}
          <span class="kchip">Type: <strong>{{ property.property_type }}</strong></span>
        {% endif %}
        {% if property.city or property.state %}
          <span class="kchip">Location: <strong>{{ (property.city ~ ', ' if property.city) ~ (property.state or '') }}</strong></span>
        {% endif %}
        {% if property.status %}
          <span class="kstatus kstatus-{{ property.status|lower|replace(' ','-')|replace('/','-') }}"> {{ property.status|upper }} </span>
        {% endif %}
      </div>
      <div class="kcard-actions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a class="kbtn kbtn-ghost" href="{{ url_for('realestate.dashboard') }}">← Back</a>
        <a class="kbtn" href="{{ url_for('realestate.edit_property', id=property.id) }}">✏️ Edit</a>
        <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}">🛠️ Add Maintenance</a>
      </div>
    </div>

    <div class="kcard-body" style="display:grid;grid-template-columns:360px 1fr;gap:16px;">
      <div class="kpanel">
        <div style="border:1px solid var(--line);background:#0d1526;border-radius:14px;overflow:hidden;height:220px;display:flex;align-items:center;justify-content:center;">
          {% if property.profile_photo %}
            <img src="{{ url_for('static', filename='equipment_photos/property_profiles/' ~ property.profile_photo) }}"
                 alt="{{ property.name }}" style="width:100%;height:100%;object-fit:cover;">
          {% else %}
            <div style="font-size:56px;opacity:.6;">🏠</div>
          {% endif %}
        </div>
        {% if property.notes %}
          <div class="khint" style="margin-top:10px;"><strong>Notes:</strong> {{ property.notes }}</div>
        {% endif %}
      </div>

      <div class="kpanel">
        <div class="grid grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="kfield readonly"><label>Address</label><div class="kvalue">{{ property.address or '—' }}</div></div>
          <div class="kfield readonly"><label>City / State</label><div class="kvalue">{{ (property.city or '—') ~ ' / ' ~ (property.state or '—') }}</div></div>
          <div class="kfield readonly"><label>Zip</label><div class="kvalue">{{ property.zip_code or '—' }}</div></div>
          <div class="kfield readonly"><label>Country</label><div class="kvalue">{{ property.country or '—' }}</div></div>
          <div class="kfield readonly"><label>County</label><div class="kvalue">{{ property.county or '—' }}</div></div>
          <div class="kfield readonly"><label>Township</label><div class="kvalue">{{ property.township or '—' }}</div></div>
          <div class="kfield readonly"><label>Year Built</label><div class="kvalue">{{ property.year_built or '—' }}</div></div>
          <div class="kfield readonly"><label>Square Footage</label><div class="kvalue">{{ property.square_footage or '—' }}</div></div>
          <div class="kfield readonly"><label>Lot Size (acres)</label><div class="kvalue">{{ property.lot_size_acres or '—' }}</div></div>
          <div class="kfield readonly"><label>Purchase Date</label><div class="kvalue">{% if property.purchase_date %}{{ property.purchase_date.strftime('%B %d, %Y') }}{% else %}—{% endif %}</div></div>
          <div class="kfield readonly"><label>Purchase Price</label><div class="kvalue">{% if property.purchase_price %}${{ "%.2f"|format(property.purchase_price) }}{% else %}—{% endif %}</div></div>
          <div class="kfield readonly"><label>Serial / Parcel</label><div class="kvalue">{{ property.serial or property.parcel_id or '—' }}</div></div>
        </div>
      </div>
    </div>
  </section>

  {# ============================== MAINTENANCE COSTS ======================= #}
<section class="kcard" id="maintenance-costs">
  <div class="kcard-head">
    <div class="kcard-title">Maintenance Costs</div>
  </div>
  
  <div class="kcard-body" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
    <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
      <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">{{ current_year }} YTD</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--primary);">
        ${{ "{:,.0f}".format(property_ytd) }}
      </div>
      {% if property_last_year > 0 %}
        {% set change = ((property_ytd - property_last_year) / property_last_year * 100) %}
        <div style="margin-top:4px;font-size:.85rem;">
          <span style="color:{{ 'var(--danger)' if change > 0 else 'var(--success)' }};">
            {{ "↑" if change > 0 else "↓" }} {{ "{:.0f}".format(abs(change)) }}% vs last year
          </span>
        </div>
      {% endif %}
    </div>
    
    <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
      <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">{{ current_year - 1 }} Total</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--text);">
        ${{ "{:,.0f}".format(property_last_year) }}
      </div>
    </div>
    
    {% set total_all_time = maintenance|selectattr('cost')|sum(attribute='cost') %}
    <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
      <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">All-Time Total</div>
      <div style="font-size:1.8rem;font-weight:700;color:var(--text);">
        ${{ "{:,.0f}".format(total_all_time) }}
      </div>
      <div style="margin-top:4px;font-size:.85rem;color:var(--text-muted);">
        {{ maintenance|length }} records
      </div>
    </div>
  </div>
</section>

  {# ============================== OUTBUILDINGS ============================ #}
  <section class="kcard" id="outbuildings">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Outbuildings</div>
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_outbuilding', property_id=property.id) }}">➕ Add Outbuilding</a>
    </div>

    {% if outbuildings %}
      <div class="kcard-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">
        {% for ob in outbuildings %}
          <article class="kmini"
                   style="border:1px solid var(--line);border-radius:12px;padding:10px;
                          display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
            <div style="display:grid;grid-template-columns:92px 1fr;gap:10px;align-items:center;min-width:0;flex:1;">
              <div style="width:92px;height:92px;border-radius:10px;border:1px solid var(--line);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#0d1526;">
                {% if ob.profile_photo %}
                  <img src="{{ url_for('static', filename='equipment_photos/outbuilding_profiles/' ~ ob.profile_photo) }}"
                       alt="{{ ob.name }}" style="width:100%;height:100%;object-fit:cover;">
                {% else %}<span style="font-size:28px;opacity:.7;">🏚️</span>{% endif %}
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;min-width:0;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                  <strong>{{ ob.name }}</strong>
                  {% if ob.type %}<span class="kchip">{{ ob.type }}</span>{% endif %}
                </div>
                <div class="khint">
                  {% if ob.year_built %}Built {{ ob.year_built }}{% endif %}
                  {% if ob.square_footage %}{% if ob.year_built %} · {% endif %}{{ ob.square_footage }} sqft{% endif %}
                </div>
                {% if ob.notes %}<div class="khint">{{ ob.notes }}</div>{% endif %}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
              <a class="kbtn" href="{{ url_for('realestate.edit_outbuilding', property_id=property.id, ob_id=ob.id) }}">Edit</a>
              <form method="POST" action="{{ url_for('realestate.delete_outbuilding', property_id=property.id, ob_id=ob.id) }}">
                <button class="kbtn kbtn-danger" onclick="return confirm('Delete this outbuilding?')">Delete</button>
              </form>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="kempty">No outbuildings yet.</div>
    {% endif %}
  </section>

  {# ============================== MAINTENANCE HISTORY ===================== #}
  <section class="kcard" id="maintenance">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Maintenance History</div>
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}">➕ Add Maintenance Record</a>
    </div>

    {% if maintenance %}
      <div class="kcard-body" style="display:grid;gap:12px;max-height:520px;overflow:auto;">
        {% for m in maintenance %}
          <article class="kmini"
                   style="border:1px solid var(--line);border-radius:12px;padding:12px;
                          display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
              <div style="min-width:240px;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                  <strong>{{ m.task }}</strong>
                  {% if m.category %}<span class="kchip">{{ m.category }}</span>{% endif %}
                  {% if m.performed_by %}<span class="kchip">By {{ m.performed_by }}</span>{% endif %}
                </div>
                <div class="khint" style="margin-top:2px;">
                  {% if m.date_completed %}{{ m.date_completed.strftime('%B %d, %Y') }}{% endif %}
                  {% if m.cost %}{% if m.date_completed %} · {% endif %}${{ "%.2f"|format(m.cost) }}{% endif %}
                </div>
                {% if m.description %}
                  <div class="khint" style="margin-top:6px;">{{ m.description }}</div>
                {% endif %}
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
                <a class="kbtn" href="{{ url_for('realestate.edit_maintenance', property_id=property.id, maint_id=m.id) }}">Edit</a>
                <form method="POST" action="{{ url_for('realestate.delete_maintenance', property_id=property.id, maint_id=m.id) }}">
                  <button class="kbtn kbtn-danger" onclick="return confirm('Delete this maintenance item? This also removes its photos.')">Delete</button>
                </form>
              </div>
            </div>

            {% set photos = photos_by_maint.get(m.id, []) %}
            {% if photos %}
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;">
                {% for ph in photos %}
                  {% set is_pdf = ph.filename.lower().endswith('.pdf') %}
                  {% if ph.photo_type == 'receipt' %}
                    <div class="kthumb kthumb-receipt" style="border:1px dashed var(--line);border-radius:10px;padding:8px;background:rgba(255,255,255,0.02);">
                      <div style="font-weight:600;margin-bottom:4px;">Receipt</div>
                      {% if is_pdf %}
                        <a class="kbtn kbtn-ghost" href="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}" target="_blank">Open PDF</a>
                      {% else %}
                        <a href="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}" target="_blank">
                          <img src="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}"
                               alt="receipt" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
                        </a>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="kthumb" style="border:1px solid var(--line);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;">
                      <img src="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}"
                           alt="photo" style="width:100%;height:100%;object-fit:cover;">
                      {% if ph.caption %}
                        <div style="padding:4px 6px;font-size:.8rem;color:var(--text-muted);text-align:center;background:rgba(255,255,255,0.03);">
                          {{ ph.caption }}
                        </div>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="kempty"><div style="font-size:24px;margin-bottom:6px;">🧰</div>No maintenance records yet.</div>
    {% endif %}
  </section>

  {# ============================== VENDORS (SCROLLABLE) ==================== #}
  <section class="kcard" id="vendors">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Vendors & Neighbors</div>
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_vendor', property_id=property.id) }}">➕ Add Vendor / Neighbor</a>
    </div>

    {% if vendors %}
      <!-- Bullet-proof scroll container -->
      <div class="kcard-body vendors-list">
        {% for v in vendors %}
          <article class="kmini"
                   style="border:1px solid var(--line);border-radius:12px;padding:10px;
                          display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
            <div style="min-width:0;">
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                <strong>{{ v.company_name }}</strong>
                {% if v.service_type %}<span class="kchip">{{ v.service_type }}</span>{% endif %}
              </div>
              <div class="khint" style="margin-top:4px;">
                {% if v.phone %}📞 {{ v.phone }}{% endif %}
                {% if v.email %}{% if v.phone %} · {% endif %}✉️ {{ v.email }}{% endif %}
              </div>
              {% if v.notes %}<div class="khint" style="margin-top:4px;">{{ v.notes }}</div>{% endif %}
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
              <a class="kbtn" href="{{ url_for('realestate.edit_vendor', property_id=property.id, vendor_id=v.id) }}">Edit</a>
              <form method="POST" action="{{ url_for('realestate.delete_vendor', property_id=property.id, vendor_id=v.id) }}">
                <button class="kbtn kbtn-danger" onclick="return confirm('Delete this vendor?')">Delete</button>
              </form>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="kempty">No vendors yet.</div>
    {% endif %}
  </section>

  {# ============================== PAGE INFO =============================== #}
  <details class="kaccordion" id="meta">
    <summary>Page Info & Changelog</summary>
    <div class="kcard-body">
      <ul>
        <li><strong>Template:</strong> property_detail.html — v1.3.1</li>
        <li><strong>Last Updated:</strong> 2025-09-05</li>
        <li><strong>Notes:</strong> Vendors list has dedicated scroll area with visible scrollbar (tweak height via CSS var or class).</li>
      </ul>
    </div>
  </details>

</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Buttons */
  .kbtn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:10px; cursor:pointer;
    border:1px solid var(--line); background:rgba(255,255,255,.03);
    color:var(--text); text-decoration:none; line-height:1;
    transition:border-color .15s ease, background .15s ease, transform .06s ease;
  }
  .kbtn:hover{ border-color:var(--primary); transform:translateY(-1px); }
  .kbtn-ghost{ background:transparent; }
  .kbtn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .kbtn-danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.55); color:#fecaca; }
  .kbtn-danger:hover{ border-color:#ef4444; }

  /* Chips & fields */
  .kcard-head{padding-bottom:6px;border-bottom:1px solid var(--line);}
  .kcard-title{font-weight:700}
  .kchip{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 8px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,0.04);font-size:.9rem
  }
  .kstatus{padding:4px 10px;border-radius:999px;font-weight:700}
  .kstatus-active{background:#1d3b2b;border:1px solid #2a5a40;color:#bef3c7}
  .kpanel .kfield label{display:block;color:var(--text-muted);font-size:.85rem;margin-bottom:4px}
  .kvalue{padding:10px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,0.02)}

  /* Empty & changelog */
  .kempty{
    border:1px dashed var(--line);border-radius:12px;padding:32px;
    text-align:center;color:var(--text-muted);background:rgba(255,255,255,0.02)
  }
  details.kaccordion > summary{
    cursor:pointer;padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.03);
    border:1px solid var(--line);font-weight:700
  }
  details.kaccordion[open] > summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
  details.kaccordion .kcard-body{border:1px solid var(--line);border-top:0;border-radius:0 0 12px 12px;padding:12px 16px}

  /* ================= Scrollable Vendors List (bullet-proof) ================ */
  :root{ --vendors-max-h: 320px; }               /* ← adjust height here */
  .vendors-list{
    display:grid;
    gap:10px;
    max-height: var(--vendors-max-h);
    overflow-y: auto;                             /* vertical scroll when needed   */
    -webkit-overflow-scrolling: touch;            /* momentum on iOS               */
    overscroll-behavior: contain;                 /* prevent page from scrolling   */
  }
  /* Visible, styled scrollbar */
  .vendors-list::-webkit-scrollbar{ width:10px; }
  .vendors-list::-webkit-scrollbar-track{ background:#0b1120; border-radius:8px; }
  .vendors-list::-webkit-scrollbar-thumb{ background:#23324a; border-radius:8px; }
  .vendors-list:hover::-webkit-scrollbar-thumb{ background:#3b5aa1; }
  /* For Firefox */
  .vendors-list{ scrollbar-width: thin; scrollbar-color:#23324a #0b1120; }
</style>
{% endblock %}
