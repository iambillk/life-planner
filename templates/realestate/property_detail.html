{# ============================================================================= 
FILE: templates/realestate/property_detail.html 
PURPOSE: Real Estate ‚Äî Property Detail (summary, related entities, history)
TEMPLATE VERSION: v2.1.0 
LAST UPDATED: 2025-01-10 

‚îÄ‚îÄ Changelog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
v2.1.0 - Added individual photo deletion functionality for maintenance photos
v2.0.1 - Show captions under maintenance thumbnails (on page) and in modal.
v2.0.0 - Complete redesign of maintenance cards with date badges, smaller 
         clickable photos, improved visual hierarchy
v1.3.1 - Vendors list uses bullet-proof scroll container (.vendors-list) with 
         visible, styled scrollbar and touch momentum scrolling. 
v1.3.0 - Reordered sections: Maintenance above Vendors; Vendors scrollable. 
v1.2.0 - Removed "Recent Photos" section; added captions for maintenance photos. 
v1.1.1 - Fixed tall/odd-height action buttons across cards.
=============================================================================#} 
{% extends "base.html" %} 
{% block title %}{{ property.name }}{% endblock %} 
{% set active = 'realestate' %} 
{% block header %}{{ property.name }}{% endblock %} 

{% block content %} 
<div class="page-stack" style="display:flex;flex-direction:column;gap:14px;"> 
  {# ============================== SUMMARY CARD ============================ #} 
  <section class="kcard" id="summary">
    <div class="kcard-head" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h2 class="kcard-title" style="margin:0;">{{ property.name }}</h2> 
        {% if property.property_type %} 
        <span class="kchip">Type: <strong>{{ property.property_type }}</strong></span> 
        {% endif %} 
        {% if property.city or property.state %} 
        <span class="kchip">Location: <strong>{{ (property.city ~ ', ' if property.city) ~ (property.state or '') }}</strong></span> 
        {% endif %} 
        {% if property.status %} 
        <span class="kstatus kstatus-{{ property.status|lower|replace(' ','-')|replace('/','-') }}"> 
          {{ property.status|upper }} 
        </span> 
        {% endif %}
      </div>
      <div class="kcard-actions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a class="kbtn kbtn-ghost" href="{{ url_for('realestate.dashboard') }}">‚Üê Back</a>
        <a class="kbtn" href="{{ url_for('realestate.edit_property', id=property.id) }}">‚úèÔ∏è Edit</a>
        <a class="kbtn" href="{{ url_for('realestate.cost_analysis', property_id=property.id) }}">üìä Cost Analysis</a>
        <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}">üõ†Ô∏è Add Maintenance</a>
      </div>
    </div>
    <div class="kcard-body" style="display:grid;grid-template-columns:360px 1fr;gap:16px;">
      <div class="kpanel">
        <div style="border:1px solid var(--line);background:#0d1526;border-radius:14px;overflow:hidden;height:220px;display:flex;align-items:center;justify-content:center;">
          {% if property.profile_photo %} 
          <img src="{{ url_for('static', filename='equipment_photos/property_profiles/' ~ property.profile_photo) }}"
               alt="{{ property.name }}" style="width:100%;height:100%;object-fit:cover;"> 
          {% else %} 
          <div style="font-size:56px;opacity:.6;">üè†</div> 
          {% endif %} 
        </div> 
        {% if property.notes %} 
        <div class="khint" style="margin-top:10px;"><strong>Notes:</strong> {{ property.notes }}</div> 
        {% endif %}
      </div>
      <div class="kpanel">
        <div class="grid grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="kfield readonly">
            <label>Address</label>
            <div class="kvalue">{{ property.address or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>City / State</label>
            <div class="kvalue">{{ (property.city or '‚Äî') ~ ' / ' ~ (property.state or '‚Äî') }}</div>
          </div>
          <div class="kfield readonly">
            <label>Zip</label>
            <div class="kvalue">{{ property.zip_code or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Country</label>
            <div class="kvalue">{{ property.country or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>County</label>
            <div class="kvalue">{{ property.county or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Township</label>
            <div class="kvalue">{{ property.township or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Year Built</label>
            <div class="kvalue">{{ property.year_built or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Square Footage</label>
            <div class="kvalue">{{ property.square_footage or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Lot Size (acres)</label>
            <div class="kvalue">{{ property.lot_size_acres or '‚Äî' }}</div>
          </div>
          <div class="kfield readonly">
            <label>Purchase Date</label>
            <div class="kvalue">
              {% if property.purchase_date %}{{ property.purchase_date.strftime('%B %d, %Y') }}{% else %}‚Äî{% endif %}
            </div>
          </div>
          <div class="kfield readonly">
            <label>Purchase Price</label>
            <div class="kvalue">
              {% if property.purchase_price %}${{ "%.2f"|format(property.purchase_price) }}{% else %}‚Äî{% endif %}
            </div>
          </div>
          <div class="kfield readonly">
            <label>Serial / Parcel</label>
            <div class="kvalue">{{ property.serial or property.parcel_id or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>
  </section> 
  
  {# ============================== MAINTENANCE COSTS ======================= #} 
  <section class="kcard" id="maintenance-costs">
    <div class="kcard-head">
      <div class="kcard-title">Maintenance Costs</div>
    </div>
    <div class="kcard-body" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
        <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">{{ current_year }} YTD</div>
        <div style="font-size:1.8rem;font-weight:700;color:var(--primary);"> 
          ${{ "{:,.0f}".format(property_ytd) }}
        </div> 
        {% if property_last_year > 0 %} 
        {% set change = ((property_ytd - property_last_year) / property_last_year * 100) %} 
        <div style="margin-top:4px;font-size:.85rem;"> 
          <span style="color:{{ 'var(--danger)' if change > 0 else 'var(--success)' }};"> 
            {{ "‚Üë" if change > 0 else "‚Üì" }} {{ "{:.0f}".format(abs(change)) }}% vs last year 
          </span> 
        </div> 
        {% endif %}
      </div>
      <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
        <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">{{ current_year - 1 }} Total</div>
        <div style="font-size:1.8rem;font-weight:700;color:var(--text);"> 
          ${{ "{:,.0f}".format(property_last_year) }}
        </div>
      </div> 
      {% set total_all_time = maintenance|selectattr('cost')|sum(attribute='cost') %} 
      <div class="cost-card" style="border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,0.02);">
        <div style="color:var(--text-muted);font-size:.85rem;margin-bottom:4px;">All-Time Total</div>
        <div style="font-size:1.8rem;font-weight:700;color:var(--text);"> 
          ${{ "{:,.0f}".format(total_all_time) }} 
        </div>
        <div style="margin-top:4px;font-size:.85rem;color:var(--text-muted);"> 
          {{ maintenance|length }} records 
        </div>
      </div>
    </div>
  </section> 
  
  {# ============================== DOCUMENTS ============================== #}
  <section class="kcard" id="documents">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">üìÅ Documents</div>
      <button class="kbtn kbtn-primary" onclick="showUploadModal()">
        + Add Document
      </button>
    </div>
    
    {% if vault_documents %}
    <div class="kcard-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">
      {% for doc in vault_documents[:6] %}
      <article class="doc-card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,0.02);display:flex;gap:12px;align-items:center;">
        <div class="doc-icon" style="font-size:24px;">
          {{ 'üìÑ' if doc.doc_type == 'document' else 'üìë' if doc.doc_type == 'contract' else 'üßæ' if doc.doc_type == 'receipt' else 'üîê' if doc.doc_type == 'warranty' else 'üñºÔ∏è' if doc.doc_type == 'image' else 'üìé' }}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ doc.title }}</div>
          <div class="khint" style="font-size:.85rem;">
            {{ (doc.file_size // 1024) if doc.file_size else 0 }}KB ¬∑ {{ doc.created_at.strftime('%b %d, %Y') if doc.created_at else '' }}
          </div>
        </div>
        <div style="display:flex;gap:6px;">
          <a href="{{ url_for('vault.view_document', id=doc.id) }}" class="kbtn-icon" target="_blank" title="View">üëÅÔ∏è</a>
          <a href="{{ url_for('vault.download_file', id=doc.id) }}" class="kbtn-icon" title="Download">‚¨áÔ∏è</a>
        </div>
      </article>
      {% endfor %}
    </div>
    
    {% if vault_documents|length > 6 %}
    <div style="text-align:center;margin-top:12px;">
      <a href="{{ url_for('realestate.property_documents', id=property.id) }}" class="kbtn">
        View all {{ vault_documents|length }} documents ‚Üí
      </a>
    </div>
    {% endif %}
    
    {% else %}
    <div class="kempty">
      <div style="font-size:24px;margin-bottom:6px;">üìÇ</div>
      No documents uploaded yet.
    </div>
    {% endif %}
  </section>

  {# Upload Modal #}
  <div id="documentUploadModal" class="modal" style="display:none;" onclick="if(event.target===this)hideUploadModal()">
    <div class="modal-content" style="background:var(--card-bg,#0c1322);padding:24px;border-radius:12px;width:90%;max-width:500px;margin:100px auto;">
      <h3 style="margin-top:0;">Upload Document</h3>
      <form action="{{ url_for('realestate.upload_property_document', id=property.id) }}" 
            method="POST" enctype="multipart/form-data">
        
        <div class="kfield" style="margin-bottom:16px;">
          <label>Document Type</label>
          <select name="doc_type" class="form-control" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,0.02);">
            <option value="contract">Contract/Lease</option>
            <option value="warranty">Warranty</option>
            <option value="receipt">Receipt/Invoice</option>
            <option value="inspection">Inspection Report</option>
            <option value="insurance">Insurance</option>
            <option value="tax">Tax Document</option>
            <option value="permit">Permit</option>
            <option value="document">Other Document</option>
          </select>
        </div>
        
        <div class="kfield" style="margin-bottom:16px;">
          <label>Title (optional)</label>
          <input type="text" name="title" placeholder="e.g., 'HVAC Warranty 2024'" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,0.02);">
        </div>
        
        <div class="kfield" style="margin-bottom:16px;">
          <label>File</label>
          <input type="file" name="file" required 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,0.02);">
        </div>
        
        <div style="display:flex;gap:12px;justify-content:flex-end;">
          <button type="button" onclick="hideUploadModal()" class="kbtn">Cancel</button>
          <button type="submit" class="kbtn kbtn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
  
  {# ============================== OUTBUILDINGS ============================ #} 
  <section class="kcard" id="outbuildings">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Outbuildings</div> 
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_outbuilding', property_id=property.id) }}">‚ûï Add Outbuilding</a>
    </div> 
    {% if outbuildings %} 
    <div class="kcard-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;"> 
      {% for ob in outbuildings %} 
      <article class="kmini" style="border:1px solid var(--line);border-radius:12px;padding:10px; display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <div style="display:grid;grid-template-columns:92px 1fr;gap:10px;align-items:center;min-width:0;flex:1;">
          <div style="width:92px;height:92px;border-radius:10px;border:1px solid var(--line);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#0d1526;">
            {% if ob.profile_photo %} 
            <img src="{{ url_for('static', filename='equipment_photos/outbuilding_profiles/' ~ ob.profile_photo) }}"
                 alt="{{ ob.name }}" style="width:100%;height:100%;object-fit:cover;"> 
            {% else %}
            <span style="font-size:28px;opacity:.7;">üèöÔ∏è</span>
            {% endif %} 
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;min-width:0;">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"> 
              <strong>{{ ob.name }}</strong> 
              {% if ob.type %}<span class="kchip">{{ ob.type }}</span>{% endif %} 
            </div>
            <div class="khint"> 
              {% if ob.year_built %}Built {{ ob.year_built }}{% endif %} 
              {% if ob.square_footage %}{% if ob.year_built %} ¬∑ {% endif %}{{ ob.square_footage }} sqft{% endif %} 
            </div> 
            {% if ob.notes %}<div class="khint">{{ ob.notes }}</div>{% endif %}
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;"> 
          <a class="kbtn" href="{{ url_for('realestate.edit_outbuilding', property_id=property.id, ob_id=ob.id) }}">Edit</a>
          <form method="POST" action="{{ url_for('realestate.delete_outbuilding', property_id=property.id, ob_id=ob.id) }}"> 
            <button class="kbtn kbtn-danger" onclick="return confirm('Delete this outbuilding?')">Delete</button> 
          </form>
        </div>
      </article> 
      {% endfor %} 
    </div> 
    {% else %} 
    <div class="kempty">No outbuildings yet.</div> 
    {% endif %}
  </section> 
  
  {# ============================== IMPROVED MAINTENANCE HISTORY ===================== #} 
  <section class="kcard" id="maintenance">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Maintenance History</div> 
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}">‚ûï Add Maintenance Record</a>
    </div> 
    {% if maintenance %} 
    <div class="kcard-body maintenance-container">
      {% for m in maintenance %} 
      <article class="maintenance-card">
        <div class="date-badge">
          {% if m.date_completed %}
          <div class="month">{{ m.date_completed.strftime('%b') }}</div>
          <div class="day">{{ m.date_completed.strftime('%d') }}</div>
          <div class="year">{{ m.date_completed.strftime('%Y') }}</div>
          {% else %}
          <div class="month">‚Äî</div>
          <div class="day">‚Äî</div>
          <div class="year">‚Äî</div>
          {% endif %}
        </div>
        
        <div class="maint-content">
          <div class="maint-header">
            <h4 class="maint-title">
              {% if 'HVAC' in m.task or 'heating' in m.task|lower or 'cooling' in m.task|lower %}üîß
              {% elif 'plumb' in m.task|lower or 'sink' in m.task|lower or 'toilet' in m.task|lower %}üö∞
              {% elif 'paint' in m.task|lower %}üé®
              {% elif 'roof' in m.task|lower %}üè†
              {% elif 'electric' in m.task|lower %}‚ö°
              {% elif 'lawn' in m.task|lower or 'landscap' in m.task|lower %}üåø
              {% elif 'gutter' in m.task|lower %}üçÇ
              {% else %}üî®{% endif %}
              {{ m.task }}
            </h4>
            <div class="maint-actions">
              <a class="kbtn-icon" href="{{ url_for('realestate.edit_maintenance', property_id=property.id, maint_id=m.id) }}" title="Edit">‚úèÔ∏è</a>
              <form method="POST" action="{{ url_for('realestate.delete_maintenance', property_id=property.id, maint_id=m.id) }}" style="display:inline;"> 
                <button class="kbtn-icon kbtn-danger" onclick="return confirm('Delete this maintenance item? This also removes its photos.')" title="Delete">üóëÔ∏è</button>
              </form>
            </div>
          </div>
          
          <div class="maint-meta">
            {% if m.category %}<span class="kchip">{{ m.category }}</span>{% endif %} 
            {% if m.performed_by %}<span class="kchip">By: {{ m.performed_by }}</span>{% endif %}
            {% if m.cost %}<span class="maint-cost">${{ "%.2f"|format(m.cost) }}</span>{% endif %}
          </div>
          
          {% if m.description %} 
          <div class="maint-description">{{ m.description }}</div>
          {% endif %}
          
          {% set photos = photos_by_maint.get(m.id, []) %} 
          {% if photos %} 
          <div class="maint-photos">
            {% for ph in photos %} 
              {% set is_pdf = ph.filename.lower().endswith('.pdf') %}
              {% set caption_text = ph.caption or ph.photo_type or 'Photo' %}
              {% if is_pdf %}
                <figure class="photo-item photo-receipt">
                  <a class="photo-thumb"
                     href="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}"
                     target="_blank"
                     title="{{ caption_text }}">
                    <span style="font-size:24px;">üìÑ</span>
                    <span class="photo-type">PDF</span>
                  </a>
                  <figcaption class="photo-caption" title="{{ caption_text }}">{{ caption_text }}</figcaption>
                </figure>
              {% else %}
                <figure class="photo-item {% if ph.photo_type == 'receipt' %}photo-receipt{% endif %}">
                  <div class="photo-thumb-wrapper">
                    <div class="photo-thumb"
                         role="button"
                         tabindex="0"
                         data-src="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}"
                         data-caption="{{ caption_text }}"
                         title="{{ caption_text }}">
                      <img src="{{ url_for('static', filename='equipment_photos/maintenance_photos/' ~ ph.filename) }}" alt="{{ caption_text }}">
                      <span class="photo-type">{{ ph.photo_type|title if ph.photo_type else 'Photo' }}</span>
                    </div>
                    <!-- Delete button for photo -->
                    <button class="photo-delete-btn" 
                            onclick="deleteMaintenancePhoto({{ property.id }}, {{ m.id }}, {{ ph.id }})"
                            title="Delete this photo">
                      √ó
                    </button>
                  </div>
                  <figcaption class="photo-caption" title="{{ caption_text }}">{{ caption_text }}</figcaption>
                </figure>
              {% endif %}
            {% endfor %} 
          </div> 
          {% endif %}
        </div>
      </article> 
      {% endfor %} 
    </div> 
    {% else %} 
    <div class="kempty">
      <div style="font-size:24px;margin-bottom:6px;">üß∞</div>
      No maintenance records yet.
    </div> 
    {% endif %}
  </section> 
  
  {% include "realestate/_property_parties.html" %}

  {# ============================== VENDORS (SCROLLABLE) ==================== #} 
  <section class="kcard" id="vendors">
    <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div class="kcard-title">Vendors & Neighbors</div> 
      <a class="kbtn kbtn-primary" href="{{ url_for('realestate.add_vendor', property_id=property.id) }}">‚ûï Add Vendor / Neighbor</a>
    </div> 
    {% if vendors %} 
    <div class="kcard-body vendors-list"> 
      {% for v in vendors %} 
      <article class="kmini" style="border:1px solid var(--line);border-radius:12px;padding:10px; display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <div style="min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"> 
            <strong>{{ v.company_name }}</strong> 
            {% if v.service_type %}<span class="kchip">{{ v.service_type }}</span>{% endif %} 
          </div>
          <div class="khint" style="margin-top:4px;"> 
            {% if v.phone %}üìû {{ v.phone }}{% endif %} 
            {% if v.email %}{% if v.phone %} ¬∑ {% endif %}‚úâÔ∏è {{ v.email }}{% endif %} 
          </div> 
          {% if v.notes %}<div class="khint" style="margin-top:4px;">{{ v.notes }}</div>{% endif %}
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;"> 
          <a class="kbtn" href="{{ url_for('realestate.edit_vendor', property_id=property.id, vendor_id=v.id) }}">Edit</a>
          <form method="POST" action="{{ url_for('realestate.delete_vendor', property_id=property.id, vendor_id=v.id) }}"> 
            <button class="kbtn kbtn-danger" onclick="return confirm('Delete this vendor?')">Delete</button> 
          </form>
        </div>
      </article> 
      {% endfor %} 
    </div> 
    {% else %} 
    <div class="kempty">No vendors yet.</div> 
    {% endif %}
  </section> 
  
  {# ============================== PAGE INFO =============================== #} 
  <details class="kaccordion" id="meta">
    <summary>Page Info & Changelog</summary>
    <div class="kcard-body">
      <ul>
        <li><strong>Template:</strong> property_detail.html ‚Äî v2.1.0</li>
        <li><strong>Last Updated:</strong> 2025-01-10</li>
        <li><strong>Notes:</strong> Added individual photo deletion for maintenance photos</li>
      </ul>
    </div>
  </details>
</div> 

<!-- Photo Modal -->
<div id="photoModal" class="modal" onclick="closeModal()">
  <img class="modal-content" id="modalImg" alt="Enlarged photo">
  <div class="modal-caption" id="modalCaption"></div>
</div>

<!-- Hidden form for photo deletion -->
<form id="deletePhotoForm" method="POST" style="display: none;">
</form>

{% endblock %} 

{% block extra_css %} 
<style>
  /* Existing Buttons */
  .kbtn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, .03);
    color: var(--text);
    text-decoration: none;
    line-height: 1;
    transition: border-color .15s ease, background .15s ease, transform .06s ease;
  }

  .kbtn:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
  }

  .kbtn-ghost {
    background: transparent;
  }

  .kbtn-primary {
    background: rgba(110, 168, 255, .18);
    border-color: rgba(110, 168, 255, .45);
  }

  .kbtn-danger {
    background: rgba(239, 68, 68, .18);
    border-color: rgba(239, 68, 68, .55);
    color: #fecaca;
  }

  .kbtn-danger:hover {
    border-color: #ef4444;
  }
  
  /* Icon buttons for maintenance cards */
  .kbtn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, .03);
    text-decoration: none;
    transition: border-color .15s ease, transform .06s ease;
  }
  
  .kbtn-icon:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
  }
  
  .kbtn-icon.kbtn-danger {
    background: rgba(239, 68, 68, .18);
    border-color: rgba(239, 68, 68, .55);
  }

  /* Existing Chips & fields */
  .kcard-head {
    padding-bottom: 6px;
    border-bottom: 1px solid var(--line);
  }

  .kcard-title {
    font-weight: 700
  }

  .kchip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.04);
    font-size: .9rem
  }

  .kstatus {
    padding: 4px 10px;
    border-radius: 999px;
    font-weight: 700
  }

  .kstatus-active {
    background: #1d3b2b;
    border: 1px solid #2a5a40;
    color: #bef3c7
  }

  .kpanel .kfield label {
    display: block;
    color: var(--text-muted);
    font-size: .85rem;
    margin-bottom: 4px
  }

  .kvalue {
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.02)
  }

  /* Empty & changelog */
  .kempty {
    border: 1px dashed var(--line);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    color: var(--text-muted);
    background: rgba(255, 255, 255, 0.02)
  }

  details.kaccordion>summary {
    cursor: pointer;
    padding: 12px 16px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--line);
    font-weight: 700
  }

  details.kaccordion[open]>summary {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0
  }

  details.kaccordion .kcard-body {
    border: 1px solid var(--line);
    border-top: 0;
    border-radius: 0 0 12px 12px;
    padding: 12px 16px
  }

  /* ================= Scrollable Vendors List (bullet-proof) ================ */
  :root {
    --vendors-max-h: 320px;
  }

  .vendors-list {
    display: grid;
    gap: 10px;
    max-height: var(--vendors-max-h);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .vendors-list::-webkit-scrollbar {
    width: 10px;
  }

  .vendors-list::-webkit-scrollbar-track {
    background: #0b1120;
    border-radius: 8px;
  }

  .vendors-list::-webkit-scrollbar-thumb {
    background: #23324a;
    border-radius: 8px;
  }

  .vendors-list:hover::-webkit-scrollbar-thumb {
    background: #3b5aa1;
  }

  .vendors-list {
    scrollbar-width: thin;
    scrollbar-color: #23324a #0b1120;
  }
  
  /* ================= IMPROVED MAINTENANCE SECTION ================= */
  .maintenance-container {
    max-height: 580px;
    overflow-y: auto;
    padding-right: 4px;
  }
  
  /* Maintenance scrollbar */
  .maintenance-container::-webkit-scrollbar {
    width: 10px;
  }
  
  .maintenance-container::-webkit-scrollbar-track {
    background: #0b1120;
    border-radius: 8px;
  }
  
  .maintenance-container::-webkit-scrollbar-thumb {
    background: #23324a;
    border-radius: 8px;
  }
  
  .maintenance-container:hover::-webkit-scrollbar-thumb {
    background: #3b5aa1;
  }
  
  .maintenance-container {
    scrollbar-width: thin;
    scrollbar-color: #23324a #0b1120;
  }
  
  /* Maintenance Card */
  .maintenance-card {
    display: flex;
    background: #0c1322;
    border: 1px solid var(--line);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 12px;
    transition: transform .1s ease, border-color .2s ease;
  }
  
  .maintenance-card:hover {
    transform: translateY(-1px);
    border-color: var(--primary);
  }
  
  /* Date Badge */
  .date-badge {
    min-width: 92px;
    padding: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
    color: #fff;
  }
  
  .date-badge .month {
    font-size: .7rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    opacity: .9;
  }
  
  .date-badge .day {
    font-size: 1.6rem;
    line-height: 1;
    font-weight: 800;
    margin: 4px 0;
  }
  
  .date-badge .year {
    font-size: .8rem;
    opacity: .85;
  }
  
  /* Maintenance Content */
  .maint-content {
    flex: 1;
    padding: 14px;
  }
  
  .maint-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .maint-title {
    font-size: 1.05rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }
  
  .maint-actions {
    display: flex;
    gap: 6px;
  }
  
  .maint-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  
  .maint-cost {
    background: rgba(34, 197, 94, .15);
    border: 1px solid rgba(34, 197, 94, .3);
    color: #86efac;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: .85rem;
    font-weight: 700;
  }
  
  .maint-description {
    background: #0b1120;
    border: 1px dashed var(--line);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
    color: var(--text-muted);
    font-size: .9rem;
  }
  
  /* Photo Grid */
  .maint-photos {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  /* Photo wrapper for delete button */
  .photo-thumb-wrapper {
    position: relative;
    display: inline-block;
  }
  
  .photo-thumb {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--line);
    cursor: pointer;
    transition: transform .1s ease;
    background: #0b1120;
  }
  
  .photo-thumb:hover {
    transform: scale(1.05);
  }
  
  .photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  .photo-type {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    font-size: .65rem;
    padding: 2px 4px;
    background: rgba(0, 0, 0, .8);
    color: #fff;
  }
  
  .photo-receipt {
    border-style: dashed;
    background: rgba(255, 255, 255, 0.02);
  }

  /* Photo figure + caption */
  .photo-item{
    display:flex;
    flex-direction:column;
    gap:4px;
    width:80px;
  }

  .photo-caption{
    font-size:.72rem;
    line-height:1.1;
    color:var(--text-muted);
    max-width:100%;
    max-height:2.2em;
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    word-break: break-word;
  }
  
  /* Photo delete button */
  .photo-delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(239, 68, 68, .9);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: none;
    align-items: center;
    justify-content: center;
    transition: background .2s ease;
  }
  
  .photo-thumb-wrapper:hover .photo-delete-btn {
    display: flex;
  }
  
  .photo-delete-btn:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.1);
  }
  
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0, 0, 0, .9);
    cursor: pointer;
  }
  
  .modal-content {
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin: 60px auto 0;
    border-radius: 12px;
    border: 1px solid var(--line);
  }
  
  .modal-caption {
    text-align: center;
    color: var(--text);
    padding: 10px;
    background: rgba(0, 0, 0, .7);
    max-width: 90%;
    margin: 0 auto;
    border-radius: 0 0 12px 12px;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .kcard-body[style*="grid-template-columns:360px"] {
      grid-template-columns: 1fr !important;
    }
    
    .maintenance-card {
      flex-direction: column;
    }
    
    .date-badge {
      min-width: 100%;
      flex-direction: row;
      gap: 12px;
      padding: 10px;
    }
    
    .maint-header {
      flex-direction: column;
    }
  }
</style> 
{% endblock %}

{% block extra_js %}
<script>
function openModal(src, caption) {
  const modal = document.getElementById('photoModal');
  const img = document.getElementById('modalImg');
  const captionElement = document.getElementById('modalCaption');
  
  img.src = src;
  captionElement.textContent = caption || '';
  captionElement.style.display = caption ? 'block' : 'none';
  modal.style.display = 'block';
}

function closeModal() {
  document.getElementById('photoModal').style.display = 'none';
}

// Function to delete maintenance photo
function deleteMaintenancePhoto(propertyId, maintId, photoId) {
  if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
    return;
  }
  
  // Create and submit form
  const form = document.getElementById('deletePhotoForm');
  form.action = `/property/${propertyId}/maintenance/${maintId}/photo/${photoId}/delete`;
  form.submit();
}

// Delegated click for any .photo-thumb (ignore anchors used for PDFs)
document.addEventListener('click', function(e) {
  const thumb = e.target.closest('.photo-thumb');
  if (!thumb) return;
  // If it's an <a> (PDF), let the browser handle target=_blank
  if (thumb.tagName === 'A') return;
  const src = thumb.getAttribute('data-src');
  const caption = thumb.getAttribute('data-caption') || '';
  if (src) openModal(src, caption);
});

// Keyboard accessibility: Enter/Space on focused .photo-thumb (non-anchors)
document.addEventListener('keydown', function(e) {
  if ((e.key === 'Enter' || e.key === ' ') && document.activeElement.classList.contains('photo-thumb')) {
    // If focused element is an anchor, allow default behavior
    if (document.activeElement.tagName === 'A') return;
    e.preventDefault();
    const thumb = document.activeElement;
    const src = thumb.getAttribute('data-src');
    const caption = thumb.getAttribute('data-caption') || '';
    if (src) openModal(src, caption);
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
  }
});

// Prevent modal from closing when clicking on image or caption
document.getElementById('modalImg').addEventListener('click', function(e) {
  e.stopPropagation();
});

if (document.getElementById('modalCaption')) {
  document.getElementById('modalCaption').addEventListener('click', function(e) {
    e.stopPropagation();
  });
}
// Document upload modal functions
function showUploadModal() {
  document.getElementById('documentUploadModal').style.display = 'block';
}

function hideUploadModal() {
  document.getElementById('documentUploadModal').style.display = 'none';
}
</script>
{% endblock %}

