{# =============================================================================
  FILE: templates/realestate/cost_analysis.html
  PURPOSE: Individual Property Cost Analysis Dashboard
  TEMPLATE VERSION: v1.0.0
  LAST UPDATED: 2025-01-09
  
  Modeled after portfolio_costs.html but for single property analysis
============================================================================= #}

{% extends "base.html" %}
{% block title %}Cost Analysis - {{ property.name }}{% endblock %}
{% set active = 'realestate' %}
{% block header %}Cost Analysis - {{ property.name }}{% endblock %}

{% block extra_css %}
<style>
  /* Core variables matching real estate theme */
  :root {
    --re-bg: #0a0f1a;
    --re-card: #0f1625;
    --re-line: #1e2a3f;
    --re-text: #e6eaf2;
    --re-muted: #9fb0c8;
    --re-primary: #6ea8ff;
    --re-success: #22c55e;
    --re-danger: #ef4444;
    --re-warning: #f59e0b;
    --re-radius: 12px;
  }

  /* Dashboard container */
  .cost-dashboard {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header with property info */
  .dashboard-header {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .property-info h1 {
    margin: 0 0 8px 0;
    color: var(--re-text);
    font-size: 1.8rem;
  }

  .property-meta {
    display: flex;
    gap: 16px;
    color: var(--re-muted);
    font-size: 0.9rem;
  }

  .header-actions {
    display: flex;
    gap: 10px;
  }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
  }

  .stat-label {
    color: var(--re-muted);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .stat-value {
    color: var(--re-text);
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .stat-card.primary { border-left: 3px solid var(--re-primary); }
  .stat-card.success { border-left: 3px solid var(--re-success); }
  .stat-card.warning { border-left: 3px solid var(--re-warning); }
  .stat-card.danger { border-left: 3px solid var(--re-danger); }

  .stat-detail {
    color: var(--re-muted);
    font-size: 0.9rem;
  }

  .stat-change {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .stat-change.up {
    color: var(--re-danger);
    background: rgba(239, 68, 68, 0.1);
  }

  .stat-change.down {
    color: var(--re-success);
    background: rgba(34, 197, 94, 0.1);
  }

  /* Main content grid */
  .content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  @media (max-width: 968px) {
    .content-grid { grid-template-columns: 1fr; }
  }

  /* Category breakdown */
  .category-section {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
  }

  .section-title {
    color: var(--re-text);
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .category-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    transition: all 0.2s;
  }

  .category-item:hover {
    background: rgba(0, 0, 0, 0.3);
    transform: translateX(4px);
  }

  .category-name {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--re-text);
    font-weight: 500;
  }

  .category-icon {
    font-size: 1.2rem;
  }

  .category-amount {
    color: var(--re-primary);
    font-weight: 700;
    font-size: 1.1rem;
  }

  .category-bar {
    margin-top: 4px;
    height: 4px;
    background: var(--re-line);
    border-radius: 2px;
    overflow: hidden;
  }

  .category-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--re-primary), #4a90ff);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  /* Monthly chart */
  .chart-section {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
  }

  .chart-container {
    height: 300px;
    position: relative;
  }

  .chart-bars {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    height: 250px;
    padding: 0 10px;
  }

  .chart-bar {
    flex: 1;
    margin: 0 4px;
    background: linear-gradient(180deg, var(--re-primary), #3a7acc);
    border-radius: 4px 4px 0 0;
    position: relative;
    cursor: pointer;
    transition: opacity 0.2s;
    min-height: 2px;
  }

  .chart-bar:hover {
    opacity: 0.8;
  }

  .chart-bar-value {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--re-text);
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .chart-bar:hover .chart-bar-value {
    opacity: 1;
  }

  .chart-labels {
    display: flex;
    justify-content: space-between;
    padding: 10px 10px 0;
    border-top: 1px solid var(--re-line);
  }

  .chart-label {
    flex: 1;
    text-align: center;
    color: var(--re-muted);
    font-size: 0.8rem;
  }

  /* Insights panel */
  .insights-section {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
  }

  .insight-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .insight-icon {
    font-size: 1.5rem;
  }

  .insight-text {
    flex: 1;
    color: var(--re-text);
    line-height: 1.5;
  }

  /* Recent maintenance table */
  .maintenance-table {
    background: var(--re-card);
    border: 1px solid var(--re-line);
    border-radius: var(--re-radius);
    padding: 20px;
    margin-bottom: 24px;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    text-align: left;
    padding: 12px;
    color: var(--re-muted);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--re-line);
  }

  td {
    padding: 12px;
    color: var(--re-text);
    border-bottom: 1px solid rgba(30, 42, 63, 0.3);
  }

  tr:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  .task-cell {
    font-weight: 500;
  }

  .cost-cell {
    color: var(--re-primary);
    font-weight: 600;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--re-muted);
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Buttons */
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .btn-primary {
    background: var(--re-primary);
    color: white;
  }

  .btn-primary:hover {
    background: #5a94eb;
    transform: translateY(-1px);
  }

  .btn-ghost {
    background: transparent;
    color: var(--re-text);
    border: 1px solid var(--re-line);
  }

  .btn-ghost:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  /* Year filter pills */
  .year-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .year-pill {
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--re-muted);
    border: 1px solid var(--re-line);
    cursor: pointer;
    transition: all 0.2s;
  }

  .year-pill.active {
    background: var(--re-primary);
    color: white;
    border-color: var(--re-primary);
  }

  .year-pill:hover:not(.active) {
    background: rgba(255, 255, 255, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="cost-dashboard">
  
  <!-- Header with property info -->
  <div class="dashboard-header">
    <div class="property-info">
      <h1>{{ property.name }}</h1>
      <div class="property-meta">
        {% if property.address %}
          <span>üìç {{ property.address }}</span>
        {% endif %}
        {% if property.property_type %}
          <span>üè† {{ property.property_type }}</span>
        {% endif %}
        {% if property.square_footage %}
          <span>üìê {{ "{:,}".format(property.square_footage) }} sq ft</span>
        {% endif %}
      </div>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('realestate.property_detail', id=property.id) }}" class="btn btn-ghost">
        ‚Üê Back to Property
      </a>
      <a href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}" class="btn btn-primary">
        ‚ûï Add Maintenance
      </a>
    </div>
  </div>

  <!-- Key Stats -->
  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-label">Total Spent (All Time)</div>
      <div class="stat-value">${{ "{:,.0f}".format(total_all_time) }}</div>
      <div class="stat-detail">
        {% if maintenance_count > 0 %}
          Across {{ maintenance_count }} maintenance {{ "record" if maintenance_count == 1 else "records" }}
        {% else %}
          No maintenance records yet
        {% endif %}
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-label">This Year ({{ current_year }})</div>
      <div class="stat-value">${{ "{:,.0f}".format(yearly_total) }}</div>
      <div class="stat-detail">
        {% if last_year_total > 0 %}
          {% set change = ((yearly_total - last_year_total) / last_year_total * 100) %}
          <span class="stat-change {{ 'up' if change > 0 else 'down' }}">
            {{ "‚Üë" if change > 0 else "‚Üì" }} {{ "{:.0f}".format(change|abs) }}% vs last year
          </span>
        {% else %}
          {% if yearly_total > 0 %}First year with costs{% endif %}
        {% endif %}
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-label">Monthly Average</div>
      <div class="stat-value">${{ "{:,.0f}".format(monthly_avg) }}</div>
      <div class="stat-detail">
        YTD through {{ current_month_name }}
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Cost per Sq Ft</div>
      <div class="stat-value">${{ "{:.2f}".format(cost_per_sqft) }}</div>
      <div class="stat-detail">
        {{ current_year }} maintenance
      </div>
    </div>
  </div>

  <!-- Main content grid -->
  <div class="content-grid">
    
    <!-- Category Breakdown -->
    <div class="category-section">
      <h2 class="section-title">
        <span>Category Breakdown ({{ current_year }})</span>
        <span style="color: var(--re-muted); font-size: 0.9rem;">${{ "{:,.0f}".format(yearly_total) }}</span>
      </h2>
      
      {% if sorted_categories %}
        <div class="category-list">
          {% set max_cost = sorted_categories.values() | max %}
          {% for category, cost in sorted_categories.items() %}
            {% if cost > 0 %}
              <div class="category-item">
                <div class="category-name">
                  <span class="category-icon">
                    {% if category == 'HVAC' %}üå°Ô∏è
                    {% elif category == 'Plumbing' %}üöø
                    {% elif category == 'Electrical' %}‚ö°
                    {% elif category == 'Lawn & Yard' %}üå±
                    {% elif category == 'Roof & Gutters' %}üè†
                    {% elif category == 'Appliances' %}üîå
                    {% elif category == 'Interior' %}üé®
                    {% elif category == 'Exterior' %}üè°
                    {% elif category == 'Generator' %}‚öôÔ∏è
                    {% elif category == 'Pool' %}üèä
                    {% elif category == 'Septic' %}üöΩ
                    {% else %}üîß
                    {% endif %}
                  </span>
                  <span>{{ category }}</span>
                </div>
                <div class="category-amount">${{ "{:,.0f}".format(cost) }}</div>
              </div>
              <div class="category-bar">
                <div class="category-bar-fill" style="width: {{ (cost / max_cost * 100) }}%"></div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìä</div>
          <p>No maintenance costs this year</p>
        </div>
      {% endif %}
    </div>

    <!-- Insights Panel -->
    <div class="insights-section">
      <h2 class="section-title">Insights & Trends</h2>
      
      <div class="insight-item">
        <span class="insight-icon">üí∞</span>
        <div class="insight-text">
          {% if top_category %}
            <strong>{{ top_category }}</strong> is your highest expense at 
            <strong>${{ "{:,.0f}".format(top_category_amount) }}</strong>
            ({{ "{:.0f}".format(top_category_amount / yearly_total * 100) if yearly_total > 0 else 0 }}% of total)
          {% else %}
            Start logging maintenance to see spending patterns
          {% endif %}
        </div>
      </div>

      {% if monthly_avg > 0 %}
        <div class="insight-item">
          <span class="insight-icon">üìÖ</span>
          <div class="insight-text">
            Averaging <strong>${{ "{:,.0f}".format(monthly_avg) }}/month</strong> in maintenance costs
          </div>
        </div>
      {% endif %}

      {% if cost_per_sqft > 0 and property.square_footage %}
        <div class="insight-item">
          <span class="insight-icon">üìê</span>
          <div class="insight-text">
            <strong>${{ "{:.2f}".format(cost_per_sqft) }}</strong> per square foot this year
            {% if cost_per_sqft < 1 %}
              - Well below typical maintenance costs!
            {% elif cost_per_sqft > 3 %}
              - Higher than average, consider preventive maintenance
            {% else %}
              - Within normal range for property maintenance
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% if projected_annual and current_month >= 3 %}
        <div class="insight-item">
          <span class="insight-icon">üìà</span>
          <div class="insight-text">
            Projecting <strong>${{ "{:,.0f}".format(projected_annual) }}</strong> 
            for full year based on current spending
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Monthly Spending Chart -->
  <div class="chart-section">
    <h2 class="section-title">
      <span>Monthly Spending ({{ current_year }})</span>
      <span style="color: var(--re-muted); font-size: 0.9rem;">Total: ${{ "{:,.0f}".format(yearly_total) }}</span>
    </h2>
    
    <div class="chart-container">
      <div class="chart-bars">
        {% set max_monthly = monthly_costs | max if monthly_costs | max > 0 else 1 %}
        {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
        {% for cost in monthly_costs %}
          <div class="chart-bar" 
               style="height: {{ (cost / max_monthly * 100) if max_monthly > 0 else 0 }}%">
            <div class="chart-bar-value">${{ "{:,.0f}".format(cost) }}</div>
          </div>
        {% endfor %}
      </div>
      <div class="chart-labels">
        {% for month in months %}
          <div class="chart-label">{{ month }}</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Recent Maintenance Table -->
  <div class="maintenance-table">
    <h2 class="section-title">
      <span>Recent Maintenance</span>
      <a href="{{ url_for('realestate.property_detail', id=property.id) }}#maintenance" 
         style="font-size: 0.9rem; color: var(--re-primary);">View All ‚Üí</a>
    </h2>
    
    {% if recent_maintenance %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Task</th>
              <th>Performed By</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            {% for m in recent_maintenance[:10] %}
              <tr>
                <td>{{ m.date_completed.strftime('%b %d, %Y') if m.date_completed else 'N/A' }}</td>
                <td>{{ m.category or 'Other' }}</td>
                <td class="task-cell">{{ m.task }}</td>
                <td>{{ m.performed_by or '-' }}</td>
                <td class="cost-cell">${{ "{:,.2f}".format(m.cost) if m.cost else '0' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üîß</div>
        <p>No maintenance records yet</p>
        <a href="{{ url_for('realestate.add_maintenance', property_id=property.id) }}" class="btn btn-primary">
          Add First Record
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Historical comparison -->
  {% if yearly_totals %}
    <div class="category-section">
      <h2 class="section-title">Historical Spending</h2>
      
      <div class="category-list">
        {% for year, total in yearly_totals.items() | sort(reverse=true) %}
          <div class="category-item">
            <div class="category-name">
              <span class="category-icon">üìÖ</span>
              <span>{{ year }}</span>
            </div>
            <div class="category-amount">${{ "{:,.0f}".format(total) }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

</div>

<script>
// Add interactivity for charts and filters
document.addEventListener('DOMContentLoaded', function() {
  // Animate chart bars on load
  const bars = document.querySelectorAll('.chart-bar');
  bars.forEach((bar, index) => {
    setTimeout(() => {
      bar.style.opacity = '1';
    }, index * 50);
  });

  // Category bar animations
  const categoryBars = document.querySelectorAll('.category-bar-fill');
  categoryBars.forEach((bar, index) => {
    const width = bar.style.width;
    bar.style.width = '0';
    setTimeout(() => {
      bar.style.width = width;
    }, index * 100);
  });
});
</script>
{% endblock %}