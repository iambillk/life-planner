{# =============================================================================
  FILE: templates/realestate/property_form.html
  PURPOSE: Real Estate — Add/Edit Property
  TEMPLATE VERSION: v1.1.0
  LAST UPDATED: 2025-09-05

  ── Changelog ──────────────────────────────────────────────────────────────────
  v1.1.0
  - Added local .kbtn styles (primary/ghost/danger) for consistent rendering.
  - Converted/confirmed all action links are proper buttons.
  - Delete action styled as danger.

  v1.0.0
  - Dark, card-based layout; header chips; responsive grids; drag-drop preview;
    sticky action bar; Ctrl/Cmd+Enter submit. Backend-safe.
============================================================================= #}

{% extends "base.html" %}
{% block title %}{{ 'Edit' if property else 'Add' }} Property{% endblock %}
{% set active = 'realestate' %}
{% block header %}{{ 'Edit' if property else 'Add' }} Property{% endblock %}

{% block content %}
<form method="POST"
      enctype="multipart/form-data"
      class="kcard prop-form"
      style="display:grid;gap:14px;max-width:980px;">

  {# ============================== HEADER BAR ============================== #}
  <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <h2 class="kcard-title" style="margin:0;">{{ 'Edit Property' if property else 'Add Property' }}</h2>
      {% if property %}
        <span class="kchip">Property: <strong>{{ property.name }}</strong></span>
        {% if property.property_type %}
          <span class="kchip">Type: <strong>{{ property.property_type }}</strong></span>
        {% endif %}
        {% if property.city or property.state %}
          <span class="kchip">Location: <strong>{{ (property.city ~ ', ' if property.city) ~ (property.state or '') }}</strong></span>
        {% endif %}
      {% endif %}
    </div>
    <div class="kcard-actions" style="display:flex;gap:8px;">
      <a class="kbtn kbtn-ghost"
         href="{{ url_for('realestate.property_detail', id=property.id) if property else url_for('realestate.dashboard') }}">← Back</a>
    </div>
  </div>

  {# ============================== BASIC INFO ============================= #}
  <section class="ksection">
    <h3 class="ksection-title">Basic Info</h3>

    <div class="kfield">
      <label for="name">Name <span class="req">*</span></label>
      <input type="text" id="name" name="name" value="{{ property.name if property else '' }}" required
             placeholder="e.g., White Tail Ranch, Lake Cottage">
      <div class="khint">Display name used across the app.</div>
    </div>

    <div class="kfield">
      <label for="address">Address</label>
      <input type="text" id="address" name="address" value="{{ property.address if property else '' }}"
             placeholder="Street address">
    </div>

    <div class="grid-3">
      <div class="kfield">
        <label for="city">City</label>
        <input type="text" id="city" name="city" value="{{ property.city if property else '' }}">
      </div>
      <div class="kfield">
        <label for="state">State</label>
        <input type="text" id="state" name="state" value="{{ property.state if property else '' }}">
      </div>
      <div class="kfield">
        <label for="zip_code">ZIP</label>
        <input type="text" id="zip_code" name="zip_code" value="{{ property.zip_code if property else '' }}">
      </div>
    </div>

    <div class="grid-3">
      <div class="kfield">
        <label for="country">Country</label>
        <input type="text" id="country" name="country" value="{{ property.country if property else '' }}">
      </div>
      <div class="kfield">
        <label for="county">County</label>
        <input type="text" id="county" name="county" value="{{ property.county if property else '' }}">
      </div>
      <div class="kfield">
        <label for="township">Township</label>
        <input type="text" id="township" name="township" value="{{ property.township if property else '' }}">
      </div>
    </div>
  </section>

  {# ============================== TYPE & STATS =========================== #}
  <section class="ksection">
    <h3 class="ksection-title">Type & Stats</h3>

    <div class="kfield">
      <label for="property_type">Type <span class="req">*</span></label>
      <select id="property_type" name="property_type" required>
        <option value="">Select type…</option>
        {% set types = ['Home', 'Cottage', 'Rental', 'Estate', 'Out Building'] %}
        {% for t in types %}
          <option value="{{ t }}" {% if property and property.property_type == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
      <div class="khint">Used for grouping and filters.</div>
    </div>

    <div class="grid-3">
      <div class="kfield">
        <label for="year_built">Year Built</label>
        <input type="number" id="year_built" name="year_built"
               value="{{ property.year_built if property and property.year_built else '' }}"
               placeholder="YYYY" min="1800" max="2100" inputmode="numeric">
      </div>
      <div class="kfield">
        <label for="square_footage">Square Footage</label>
        <input type="number" id="square_footage" name="square_footage"
               value="{{ property.square_footage if property and property.square_footage else '' }}"
               placeholder="e.g., 2400" min="0" step="1">
      </div>
      <div class="kfield">
        <label for="lot_size_acres">Lot Size (acres)</label>
        <input type="number" step="0.01" id="lot_size_acres" name="lot_size_acres"
               value="{{ property.lot_size_acres if property and property.lot_size_acres else '' }}"
               placeholder="e.g., 2.50" min="0">
      </div>
    </div>
  </section>

  {# ============================== PURCHASE =============================== #}
  <section class="ksection">
    <h3 class="ksection-title">Purchase</h3>

    <div class="grid-2">
      <div class="kfield">
        <label for="purchase_date">Purchase Date</label>
        <input type="date" id="purchase_date" name="purchase_date"
               value="{{ property.purchase_date.strftime('%Y-%m-%d') if property and property.purchase_date else '' }}">
      </div>
      <div class="kfield">
        <label for="purchase_price">Purchase Price</label>
        <input type="number" step="0.01" id="purchase_price" name="purchase_price"
               value="{{ property.purchase_price if property and property.purchase_price else '' }}"
               inputmode="decimal" placeholder="0.00">
      </div>
    </div>
  </section>

  {# ============================== NOTES ================================== #}
  <section class="ksection">
    <h3 class="ksection-title">Notes</h3>
    <div class="kfield">
      <label for="notes">Notes</label>
      <textarea id="notes" name="notes" rows="4"
                placeholder="General information, utilities, contacts, zoning, reminders…">{{ property.notes if property else '' }}</textarea>
    </div>
  </section>

  {# ============================== PROFILE PHOTO ========================== #}
  <section class="ksection">
    <h3 class="ksection-title">Profile Photo {{ '(replace)' if property else '' }}</h3>

    <div id="dz-photo" class="dropzone" tabindex="0" aria-label="Upload a profile photo by clicking or dragging a file here">
      <div class="dz-inner">
        <div class="dz-icon">🖼️</div>
        <div class="dz-text">
          <strong>Choose or drag profile photo</strong>
          <span>JPG, PNG, HEIC</span>
        </div>
        <label class="kbtn" for="profile_photo">Choose File</label>
      </div>
      <!-- Native input preserved for backend -->
      <input type="file" id="profile_photo" name="profile_photo" accept="image/*" style="display:none;">
    </div>

    <!-- Live preview / current -->
    <div id="photo-preview" class="preview-grid one"
         {% if not (property and property.profile_photo) %}hidden{% endif %}>
      {% if property and property.profile_photo %}
        <div class="preview">
          <img src="{{ url_for('static', filename='equipment_photos/property_profiles/' ~ property.profile_photo) }}"
               alt="Current profile photo">
        </div>
      {% endif %}
    </div>
  </section>

  {# ============================== ACTION BAR ============================= #}
  <div class="actionbar">
    <div class="actionbar-inner">
      <div class="keys-hint">Press <kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>Enter</kbd> to Save</div>
      <div class="actions" style="gap:8px;display:flex;align-items:center;">
        <a href="{{ url_for('realestate.property_detail', id=property.id) if property else url_for('realestate.dashboard') }}"
           class="kbtn">Cancel</a>

        <button type="submit" class="kbtn kbtn-primary">
          {{ 'Save Changes' if property else 'Save' }}
        </button>

        {% if property %}
          <button type="submit"
                  class="kbtn kbtn-danger"
                  formmethod="post"
                  formaction="{{ url_for('realestate.delete_property', id=property.id) }}"
                  onclick="return confirm('Delete this property and all related maintenance, photos, and vendors? This cannot be undone.');"
                  style="margin-left:auto;">
            Delete Property
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  {# ============================== META / CHANGELOG ======================= #}
  <details class="kaccordion">
    <summary>Form Info & Changelog</summary>
    <div class="kcard-body">
      <ul>
        <li><strong>Template:</strong> property_form.html — v1.1.0</li>
        <li><strong>Last Updated:</strong> 2025-09-05</li>
        <li><strong>Behavior:</strong> Drag-drop & preview are cosmetic; backend receives the same <code>profile_photo</code> file.</li>
      </ul>
    </div>
  </details>
</form>
{% endblock %}

{% block extra_css %}
<style>
  /* ---------- Buttons (local styles so anchors always render as buttons) ---------- */
  .kbtn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:10px; cursor:pointer;
    border:1px solid var(--line); background:rgba(255,255,255,.03);
    color:var(--text); text-decoration:none; line-height:1;
    transition:border-color .15s ease, background .15s ease, transform .06s ease;
  }
  .kbtn:hover{ border-color:var(--primary); transform:translateY(-1px); }
  .kbtn-ghost{ background:transparent; }
  .kbtn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .kbtn-danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.55); color:#fecaca; }
  .kbtn-danger:hover{ border-color:#ef4444; }

  /* ---------- Card & form visuals ---------- */
  .kcard-head{padding-bottom:6px;border-bottom:1px solid var(--line);}
  .ksection{display:grid;gap:12px}
  .ksection-title{font-weight:700;margin:6px 0}
  .kchip{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 8px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,0.04);font-size:.9rem
  }
  .kfield label{display:block;margin-bottom:6px;color:var(--text-muted)}
  .kfield select,
  .kfield input[type="text"],
  .kfield input[type="date"],
  .kfield input[type="number"],
  .kfield textarea{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;
    background:rgba(255,255,255,0.02);color:var(--text)
  }
  .kfield textarea{resize:vertical;min-height:120px}

  .grid-2{display:grid;gap:12px;grid-template-columns:repeat(2, minmax(0,1fr));}
  .grid-3{display:grid;gap:12px;grid-template-columns:repeat(3, minmax(0,1fr));}
  @media (max-width: 960px){
    .grid-2{grid-template-columns:1fr;}
    .grid-3{grid-template-columns:1fr;}
  }

  .dropzone{
    border:1px dashed var(--line);border-radius:14px;background:rgba(255,255,255,0.02);
    padding:18px;outline:none
  }
  .dropzone:focus{box-shadow:0 0 0 2px rgba(255,255,255,0.06) inset}
  .dz-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .dz-icon{font-size:28px;opacity:.7}
  .dz-text{display:flex;flex-direction:column;gap:2px;color:var(--text-muted)}
  .dz-text strong{color:var(--text);font-weight:700}

  .preview-grid{
    margin-top:10px;
    display:grid;gap:10px;
    grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
  }
  .preview-grid.one{grid-template-columns:repeat(1, minmax(220px,1fr));}
  .preview{
    position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;
    background:rgba(255,255,255,0.02);
  }
  .preview img{display:block;width:100%;height:220px;object-fit:cover}

  .actionbar{position:sticky;bottom:0;z-index:5;margin-top:4px;}
  .actionbar-inner{
    border:1px solid var(--line);border-radius:12px;background:rgba(10,15,26,.75);
    backdrop-filter:blur(6px);padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:12px
  }
  .keys-hint{color:var(--text-muted);font-size:.9rem}
  kbd{border:1px solid var(--line);border-bottom-color:rgba(255,255,255,0.25);border-radius:6px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:rgba(255,255,255,0.06)}
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const form = document.querySelector('.prop-form');

    // Keyboard shortcut: Ctrl/Cmd + Enter submits
    form.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') form.requestSubmit();
    });

    // Drag & drop single-image preview for profile photo
    const input = document.getElementById('profile_photo');
    const dz = document.getElementById('dz-photo');
    const grid = document.getElementById('photo-preview');

    function prevent(e){ e.preventDefault(); e.stopPropagation(); }
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e)=>{ prevent(e); dz.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e)=>{ prevent(e); dz.classList.remove('is-drag'); }));

    dz.addEventListener('drop', (e)=>{
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith('image/'));
      if (!files.length) return;
      input.files = files.slice(0,1);
      renderPreview();
    });

    dz.addEventListener('click', (e)=>{ if (e.target.tagName !== 'LABEL') input.click(); });
    input.addEventListener('change', renderPreview);

    function renderPreview(){
      const file = (input.files || [])[0];
      grid.innerHTML = '';
      if (!file){ grid.hidden = true; return; }
      grid.hidden = false;

      const card = document.createElement('div');
      card.className = 'preview';

      const img = document.createElement('img'); img.alt = file.name;
      const reader = new FileReader(); reader.onload = e => img.src = e.target.result; reader.readAsDataURL(file);
      card.appendChild(img);

      grid.appendChild(card);
    }
  })();
</script>
{% endblock %}
