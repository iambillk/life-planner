{# =============================================================================
  FILE: templates/realestate/outbuilding_form.html
  PURPOSE: Real Estate — Add/Edit Outbuilding for a Property
  TEMPLATE VERSION: v1.1.0
  LAST UPDATED: 2025-09-05

  ── Changelog ──────────────────────────────────────────────────────────────────
  v1.1.0
  - Convert remaining text links to button-styled anchors.
  - Include local .kbtn styles to guarantee consistent rendering.
  - Show Delete button when editing (uses existing delete route).

  v1.0.0
  - Dark, card-based layout; drag+drop upload; sticky action bar; shortcuts.
============================================================================= #}

{% extends "base.html" %}
{% block title %}{{ 'Edit' if outbuilding else 'Add' }} Outbuilding — {{ property.name }}{% endblock %}
{% set active = 'realestate' %}
{% block header %}{{ 'Edit' if outbuilding else 'Add' }} Outbuilding — {{ property.name }}{% endblock %}

{% block content %}
<form method="POST"
      enctype="multipart/form-data"
      class="kcard ob-form"
      style="display:grid;gap:14px;max-width:820px;">

  {# ============================== HEADER BAR ============================== #}
  <div class="kcard-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <h2 class="kcard-title" style="margin:0;">{{ 'Edit Outbuilding' if outbuilding else 'Add Outbuilding' }}</h2>
      <span class="kchip">Property: <strong>{{ property.name }}</strong></span>
      {% if outbuilding and outbuilding.type %}
        <span class="kchip">{{ outbuilding.type }}</span>
      {% endif %}
    </div>

    <div class="kcard-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <a class="kbtn kbtn-ghost" href="{{ url_for('realestate.property_detail', id=property.id) }}">← Back</a>

      {% if outbuilding %}
        <form method="POST"
              action="{{ url_for('realestate.delete_outbuilding', property_id=property.id, ob_id=outbuilding.id) }}"
              onsubmit="return confirm('Delete this outbuilding? This cannot be undone.');"
              style="display:inline;">
          <button class="kbtn kbtn-danger" type="submit">Delete</button>
        </form>
      {% endif %}
    </div>
  </div>

  {# ============================== DETAILS ================================ #}
  <section class="ksection">
    <h3 class="ksection-title">Outbuilding Details</h3>

    <div class="kfield">
      <label for="name">Name <span class="req">*</span></label>
      <input type="text" id="name" name="name" value="{{ outbuilding.name if outbuilding else '' }}" required
             placeholder="e.g., Pole Barn, Guest House, Workshop">
      <div class="khint">Short, descriptive name used on cards and reports.</div>
    </div>

    <div class="kfield">
      <label for="type">Type</label>
      <select id="type" name="type">
        {% set types = ['Garage', 'MIL Suite', 'Pole Barn', 'Shed', 'Coop', 'Greenhouse', 'Other'] %}
        <option value="">Select type…</option>
        {% for t in types %}
          <option value="{{ t }}" {% if outbuilding and outbuilding.type == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="grid-2">
      <div class="kfield">
        <label for="year_built">Year Built</label>
        <input type="number" id="year_built" name="year_built"
               value="{{ outbuilding.year_built if outbuilding and outbuilding.year_built else '' }}"
               placeholder="YYYY" min="1800" max="2100" inputmode="numeric">
      </div>

      <div class="kfield">
        <label for="square_footage">Square Footage</label>
        <input type="number" id="square_footage" name="square_footage"
               value="{{ outbuilding.square_footage if outbuilding and outbuilding.square_footage else '' }}"
               placeholder="e.g., 1200" min="0" step="1">
      </div>
    </div>

    <div class="kfield">
      <label for="notes">Notes</label>
      <textarea id="notes" name="notes" rows="4" placeholder="Construction details, utilities, access, etc.">{{ outbuilding.notes if outbuilding else '' }}</textarea>
    </div>
  </section>

  {# ============================== PROFILE PHOTO ========================== #}
  <section class="ksection">
    <h3 class="ksection-title">Profile Photo {{ '(replace)' if outbuilding else '' }}</h3>

    <div id="dz-photo" class="dropzone" tabindex="0" aria-label="Upload a profile photo by clicking or dragging a file here">
      <div class="dz-inner">
        <div class="dz-icon">🖼️</div>
        <div class="dz-text">
          <strong>Choose or drag profile photo</strong>
          <span>JPG, PNG, HEIC</span>
        </div>
        <label class="kbtn" for="profile_photo">Choose File</label>
      </div>
      <!-- Keep native input for backend -->
      <input type="file" id="profile_photo" name="profile_photo" accept="image/*" style="display:none;">
    </div>

    <!-- Live preview area -->
    <div id="photo-preview" class="preview-grid one" {% if not (outbuilding and outbuilding.profile_photo) %}hidden{% endif %}>
      {% if outbuilding and outbuilding.profile_photo %}
        <div class="preview">
          <img src="{{ url_for('static', filename='equipment_photos/outbuilding_profiles/' ~ outbuilding.profile_photo) }}"
               alt="Current profile photo">
        </div>
      {% endif %}
    </div>
  </section>

  {# ============================== ACTION BAR ============================= #}
  <div class="actionbar">
    <div class="actionbar-inner">
      <div class="keys-hint">Press <kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>Enter</kbd> to Save</div>
      <div class="actions">
        <a href="{{ url_for('realestate.property_detail', id=property.id) }}" class="kbtn">Cancel</a>
        <button type="submit" class="kbtn kbtn-primary">{{ 'Save Changes' if outbuilding else 'Save Outbuilding' }}</button>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
  /* ---------- Buttons (local styles so anchors always render as buttons) ---------- */
  .kbtn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:10px; cursor:pointer;
    border:1px solid var(--line); background:rgba(255,255,255,.03);
    color:var(--text); text-decoration:none; line-height:1;
    transition:border-color .15s ease, background .15s ease, transform .06s ease;
  }
  .kbtn:hover{ border-color:var(--primary); transform:translateY(-1px); }
  .kbtn-ghost{ background:transparent; }
  .kbtn-primary{ background: rgba(110,168,255,.18); border-color: rgba(110,168,255,.45); }
  .kbtn-danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.55); color:#fecaca; }
  .kbtn-danger:hover{ border-color:#ef4444; }

  .kcard-head{padding-bottom:6px;border-bottom:1px solid var(--line);}
  .ksection{display:grid;gap:12px}
  .ksection-title{font-weight:700;margin:6px 0}
  .kchip{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 8px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,0.04);font-size:.9rem
  }
  .kfield label{display:block;margin-bottom:6px;color:var(--text-muted)}
  .kfield select,
  .kfield input[type="text"],
  .kfield input[type="number"],
  .kfield textarea{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;
    background:rgba(255,255,255,0.02);color:var(--text)
  }
  .kfield textarea{resize:vertical;min-height:120px}

  .grid-2{display:grid;gap:12px;grid-template-columns:repeat(2, minmax(0,1fr));}
  @media (max-width: 900px){ .grid-2{grid-template-columns:1fr;} }

  .dropzone{
    border:1px dashed var(--line);border-radius:14px;background:rgba(255,255,255,0.02);
    padding:18px;outline:none
  }
  .dropzone:focus{box-shadow:0 0 0 2px rgba(255,255,255,0.06) inset}
  .dz-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .dz-icon{font-size:28px;opacity:.7}
  .dz-text{display:flex;flex-direction:column;gap:2px;color:var(--text-muted)}
  .dz-text strong{color:var(--text);font-weight:700}

  .preview-grid{ margin-top:10px; display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); }
  .preview-grid.one{grid-template-columns:repeat(1, minmax(220px,1fr));}
  .preview{
    position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;
    background:rgba(255,255,255,0.02);
  }
  .preview img{display:block;width:100%;height:220px;object-fit:cover}

  .actionbar{position:sticky;bottom:0;z-index:5;margin-top:4px;}
  .actionbar-inner{
    border:1px solid var(--line);border-radius:12px;background:rgba(10,15,26,.75);
    backdrop-filter:blur(6px);padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:12px
  }
  .keys-hint{color:var(--text-muted);font-size:.9rem}
  kbd{border:1px solid var(--line);border-bottom-color:rgba(255,255,255,0.25);border-radius:6px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:rgba(255,255,255,0.06)}
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const form = document.querySelector('.ob-form');

    // Keyboard shortcut: Ctrl/Cmd + Enter submits
    form.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') form.requestSubmit();
    });

    // Drag & drop single-image preview
    const input = document.getElementById('profile_photo');
    const dz = document.getElementById('dz-photo');
    const grid = document.getElementById('photo-preview');

    function prevent(e){ e.preventDefault(); e.stopPropagation(); }
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e)=>{ prevent(e); dz.classList.add('is-drag'); }));
    ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e)=>{ prevent(e); dz.classList.remove('is-drag'); }));

    dz.addEventListener('drop', (e)=>{
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith('image/'));
      if (!files.length) return;
      input.files = files.slice(0,1);
      renderPreview();
    });

    dz.addEventListener('click', (e)=>{ if (e.target.tagName !== 'LABEL') input.click(); });
    input.addEventListener('change', renderPreview);

    function renderPreview(){
      const file = (input.files || [])[0];
      grid.innerHTML = '';
      if (!file){ grid.hidden = true; return; }
      grid.hidden = false;

      const card = document.createElement('div');
      card.className = 'preview';

      const img = document.createElement('img'); img.alt = file.name;
      const reader = new FileReader(); reader.onload = e => img.src = e.target.result; reader.readAsDataURL(file);
      card.appendChild(img);

      grid.appendChild(card);
    }
  })();
</script>
{% endblock %}
