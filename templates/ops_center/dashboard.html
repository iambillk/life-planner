<!--
Operations Command Center - Dashboard Template
Version: 1.4.0
Last Modified: 2025-01-XX
Author: Billas
Description: Main dashboard HTML template for Operations Command Center

File: /templates/ops_center/dashboard.html

CHANGELOG:
- 1.4.0 (2025-01-XX): Added Firewalla integration with real API data
                      Fixed missing closing body and html tags
                      Added Firewalla details modal
- 1.3.0 (2025-01-XX): Added real DLI PDU controls replacing mock data
- 1.2.0 (2024-01-XX): Added SFP/QSFP side panel for high-speed ports
- 1.1.0 (2024-01-XX): Added enhanced switch grid with proper state display and legend
- 1.0.0 (2024-01-XX): Initial implementation with mock display
-->

{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Enhanced styles with better UI/UX -->
<style>
  /* Import modern font */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
  
  /* Dashboard container */
  .ops-dash { 
    padding: 20px; 
    background: linear-gradient(135deg, #0a0f1a 0%, #0f1823 100%);
    min-height: 100vh;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  /* Header section - Enhanced */
  .ops-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 20px 25px; 
    background: linear-gradient(135deg, #1a2332 0%, #1e2837 100%);
    border: 1px solid rgba(110, 168, 255, 0.2);
    border-radius: 12px; 
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    position: relative;
    overflow: hidden;
  }
  
  .ops-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(110, 168, 255, 0.5), transparent);
    animation: shimmer 3s ease-in-out infinite;
  }
  
  @keyframes shimmer {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }
  
  .ops-title { 
    font-size: 28px; 
    font-weight: 800; 
    background: linear-gradient(135deg, #6ea8ff 0%, #92c3ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase; 
    letter-spacing: 1px;
    text-shadow: 0 0 30px rgba(110, 168, 255, 0.3);
  }
  
  .status { 
    color: #22c55e; 
    font-weight: 600;
    text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
  }
  
  /* Content sections - Enhanced */
  .section { 
    background: linear-gradient(135deg, #0f1823 0%, #131a25 100%);
    border: 1px solid rgba(42, 52, 65, 0.6);
    border-radius: 12px; 
    padding: 20px; 
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.02);
    position: relative;
  }
  
  .section::before {
    content: '';
    position: absolute;
    top: -1px;
    left: 20px;
    right: 20px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(110, 168, 255, 0.3), transparent);
  }
  
  .section h3 { 
    color: #6ea8ff; 
    margin-bottom: 20px; 
    font-size: 14px; 
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section h3::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, rgba(110, 168, 255, 0.3), transparent);
  }
  
  /* WAN display - Enhanced */
  .wan-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 20px; 
  }
  
  .wan-card { 
    background: linear-gradient(135deg, #0a0f1a 0%, #0d1219 100%);
    padding: 20px; 
    border-radius: 10px;
    border: 1px solid rgba(42, 52, 65, 0.4);
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .wan-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(110, 168, 255, 0.1);
    border-color: rgba(110, 168, 255, 0.3);
  }
  
  .wan-card strong {
    font-size: 14px;
    color: #92c3ff;
    display: block;
    margin-bottom: 15px;
  }
  
  /* Hero Stats Cards - DRAMATICALLY ENHANCED */
  .alerts-grid { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 20px; 
  }
  
  .alert-box { 
    background: linear-gradient(135deg, #0a0f1a 0%, #0d1219 100%);
    padding: 20px; 
    border-radius: 12px; 
    text-align: center;
    position: relative;
    overflow: hidden;
    border: 1px solid transparent;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  .alert-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, transparent, rgba(0,0,0,0.4));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .alert-box:hover::before {
    opacity: 1;
  }
  
  /* IPS Alert Box */
  .alert-box:nth-child(1) {
    background: linear-gradient(135deg, #1a0f0f 0%, #2a1515 100%);
    border: 1px solid rgba(239, 68, 68, 0.2);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.1), inset 0 1px 0 rgba(239, 68, 68, 0.1);
  }
  
  .alert-box:nth-child(1):hover {
    transform: translateY(-3px) scale(1.02);
    border-color: rgba(239, 68, 68, 0.5);
    box-shadow: 0 8px 30px rgba(239, 68, 68, 0.2), inset 0 1px 0 rgba(239, 68, 68, 0.2);
  }
  
  .alert-box:nth-child(1) .alert-count {
    color: #ef4444;
    text-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 40px rgba(239, 68, 68, 0.4);
    animation: pulse-red 2s ease-in-out infinite;
  }
  
  @keyframes pulse-red {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  /* Firewalla Alert Box */
  .alert-box:nth-child(2) {
    background: linear-gradient(135deg, #0f1a1a 0%, #152a2a 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.1), inset 0 1px 0 rgba(34, 197, 94, 0.1);
  }
  
  .alert-box:nth-child(2):hover {
    transform: translateY(-3px) scale(1.02);
    border-color: rgba(110, 168, 255, 0.5);
    box-shadow: 0 8px 30px rgba(110, 168, 255, 0.2), inset 0 1px 0 rgba(110, 168, 255, 0.2);
  }
  
  /* Sys Logs Alert Box */
  .alert-box:nth-child(3) {
    background: linear-gradient(135deg, #0f1a0f 0%, #152a15 100%);
    border: 1px solid rgba(34, 197, 94, 0.2);
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.1), inset 0 1px 0 rgba(34, 197, 94, 0.1);
  }
  
  .alert-box:nth-child(3):hover {
    transform: translateY(-3px) scale(1.02);
    border-color: rgba(34, 197, 94, 0.5);
    box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2), inset 0 1px 0 rgba(34, 197, 94, 0.2);
  }
  
  .alert-box:nth-child(3) .alert-count {
    color: #22c55e;
    text-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 40px rgba(34, 197, 94, 0.4);
  }
  
  /* HostMon Alert Box */
  .alert-box:nth-child(4) {
    background: linear-gradient(135deg, #1a1a0f 0%, #2a2a15 100%);
    border: 1px solid rgba(245, 158, 11, 0.2);
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.1), inset 0 1px 0 rgba(245, 158, 11, 0.1);
  }
  
  .alert-box:nth-child(4):hover {
    transform: translateY(-3px) scale(1.02);
    border-color: rgba(245, 158, 11, 0.5);
    box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2), inset 0 1px 0 rgba(245, 158, 11, 0.2);
  }
  
  .alert-count { 
    font-size: 36px; 
    font-weight: 700; 
    margin-bottom: 8px;
    display: block;
    line-height: 1;
    position: relative;
    z-index: 1;
  }
  
  .alert-box > div:not(.alert-count) {
    color: #9fb0c8;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 10px;
    position: relative;
    z-index: 1;
  }
  
  .alert-box small {
    display: block;
    margin-top: 8px;
    color: #7f8c8d;
    font-size: 11px;
    opacity: 0.8;
    position: relative;
    z-index: 1;
  }
  
  /* Icon decorations for alert boxes */
  .alert-box::after {
    font-size: 60px;
    opacity: 0.05;
    position: absolute;
    bottom: -10px;
    right: 10px;
    transform: rotate(-15deg);
    z-index: 0;
  }
  
  .alert-box:nth-child(1)::after {
    content: '‚ö†Ô∏è';
  }
  
  .alert-box:nth-child(2)::after {
    content: 'üõ°Ô∏è';
  }
  
  .alert-box:nth-child(3)::after {
    content: 'üìã';
  }
  
  .alert-box:nth-child(4)::after {
    content: 'üì°';
  }
  
  /* PDU outlets display - Enhanced */
  .outlets { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 12px; 
  }
  
  .outlet-control {
    position: relative;
    padding-top: 25px;
    margin-top: -25px;
  }
  
  .outlet-control:hover .outlet-actions {
    display: block !important;
  }
  
  .outlet { 
    background: linear-gradient(135deg, #0a0f1a 0%, #0d1219 100%);
    border: 2px solid #1a2332; 
    padding: 12px 8px; 
    text-align: center; 
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .outlet.on { 
    border-color: #22c55e; 
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.2) 100%);
    color: #22c55e;
    box-shadow: 0 2px 15px rgba(34, 197, 94, 0.2), inset 0 1px 0 rgba(34, 197, 94, 0.2);
  }
  
  .outlet.off {
    border-color: #7f8c8d;
    color: #7f8c8d;
    opacity: 0.7;
  }
  
  .outlet.locked {
    opacity: 0.5;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 5px,
      rgba(255,255,255,0.02) 5px,
      rgba(255,255,255,0.02) 10px
    );
  }
  
  .outlet:hover:not(.locked) {
    transform: scale(1.08) translateY(-2px);
    border-color: #6ea8ff !important;
    box-shadow: 0 4px 20px rgba(110, 168, 255, 0.3);
  }
  
  .outlet-actions {
    display: none;
    position: absolute;
    top: 0;
    right: 0;
    background: linear-gradient(135deg, #1a2332 0%, #1e2837 100%);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    z-index: 100;
    border: 1px solid rgba(110, 168, 255, 0.3);
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  .outlet-actions a {
    padding: 3px 6px;
    display: inline-block;
    transition: all 0.2s ease;
    border-radius: 4px;
  }
  
  .outlet-actions a:hover {
    background: rgba(110, 168, 255, 0.1);
  }
  
  /* Switch grid styles - Enhanced */
  .switch-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 8px;
    margin-top: 15px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
  }
  
  .switch-port {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #0a0f1a 0%, #0d1219 100%);
    border: 2px solid #1a2332;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    padding: 3px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .switch-port:hover {
    transform: scale(1.15) translateY(-3px);
    z-index: 10;
    border-color: #6ea8ff !important;
    box-shadow: 0 4px 15px rgba(110, 168, 255, 0.4);
  }
  
  .switch-port.disabled {
    background: linear-gradient(135deg, #0a0f1a 0%, #080b0f 100%);
    border-color: #2a3441;
    opacity: 0.3;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 3px,
      rgba(255,255,255,0.03) 3px,
      rgba(255,255,255,0.03) 6px
    );
  }
  
  .switch-port.no-link {
    background: linear-gradient(135deg, rgba(127, 140, 141, 0.05) 0%, rgba(127, 140, 141, 0.15) 100%);
    border-color: #7f8c8d;
  }
  
  .switch-port.active {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.25) 100%);
    border-color: #22c55e;
    box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3), inset 0 1px 0 rgba(34, 197, 94, 0.3);
  }
  
  .switch-port.error {
    animation: pulse-error 2s infinite;
    border-color: #ef4444 !important;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%) !important;
    box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
  }
  
  @keyframes pulse-error {
    0%, 100% { 
      opacity: 1; 
      box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
    }
    50% { 
      opacity: 0.7; 
      box-shadow: 0 2px 20px rgba(239, 68, 68, 0.6);
    }
  }
  
  .port-number {
    font-size: 11px;
    font-weight: 600;
    color: #e6eaf2;
    z-index: 1;
    position: relative;
    line-height: 1;
  }
  
  .port-name {
    font-size: 9px;
    font-weight: 500;
    color: #9fb0c8;
    z-index: 1;
    position: relative;
    line-height: 1;
    margin-top: 3px;
    text-align: center;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 0 2px;
  }
  
  /* Legend styles - Enhanced */
  .switch-legend {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(42, 52, 65, 0.3);
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 500;
  }
  
  .legend-box {
    width: 24px;
    height: 24px;
    border: 2px solid;
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .legend-box.disabled {
    background: linear-gradient(135deg, #0a0f1a 0%, #080b0f 100%);
    border-color: #2a3441;
    opacity: 0.3;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 2px,
      rgba(255,255,255,0.05) 2px,
      rgba(255,255,255,0.05) 4px
    );
  }
  
  .legend-box.no-link {
    background: linear-gradient(135deg, rgba(127, 140, 141, 0.05) 0%, rgba(127, 140, 141, 0.15) 100%);
    border-color: #7f8c8d;
  }
  
  .legend-box.active {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.25) 100%);
    border-color: #22c55e;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
  }
  
  .legend-box.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
    border-color: #ef4444;
    animation: pulse-error 2s infinite;
  }

  /* SFP Panel Styles - Enhanced */
  .sfp-panel {
    background: linear-gradient(135deg, #0a0f1a 0%, #0d1219 100%);
    border: 1px solid rgba(42, 52, 65, 0.4);
    border-radius: 10px;
    padding: 20px;
    min-width: 140px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  
  .sfp-section {
    margin-bottom: 20px;
  }
  
  .sfp-label {
    color: #6ea8ff;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .sfp-port, .qsfp-port {
    width: 100%;
    height: 45px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .qsfp-port {
    height: 55px;
    background-image: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.01) 10px,
      rgba(255,255,255,0.01) 20px
    );
  }
  
  .port-label {
    font-size: 12px;
    font-weight: 600;
    color: #e6eaf2;
  }
  
  .sfp-port-name {
    font-size: 10px;
    font-weight: 500;
    color: #9fb0c8;
    margin-top: 3px;
  }
  
  /* Enhanced buttons */
  button {
    transition: all 0.2s ease;
    font-weight: 500;
    letter-spacing: 0.5px;
  }
  
  button:hover {
    transform: translateY(-1px);
  }
  
  /* Modal enhancements */
  [id$="Modal"] {
    backdrop-filter: blur(5px);
  }
  
  [id$="Modal"] > div {
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: rgba(110, 168, 255, 0.3);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(110, 168, 255, 0.5);
  }

  .chip{
  background:#0a0f1a;
  border:1px solid #2a3441;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:#9fb0c8;
}

.ips-latest { margin-top: 5px; font-size: 1px; color: #6ea8ff; }
.ips-latest .ips-item {
  margin: 6px 0;            /* space between alerts */
  line-height: 1.3;
  text-align: center;
  word-break: break-word;   /* wrap long IOC lines cleanly */
}

.ips-latest { 
  margin-top: 5px; 
  font-size: 11px !important; 
  color: #6ea8ff; 
}

</style>

<div class="ops-dash">
  <!-- Header Bar with System Status -->
  <div class="ops-header">
    <div class="ops-title">üéØ WTR.NETWORK COMMAND CENTER</div>
    <div>LibreNMS Status: <span class="status">{{ system_status }}</span> | Last Refresh: <span id="last-refresh">{{ last_refresh }}</span></div>
  </div>

  <div class="section">
  <h3>üåê WAN Bandwidth</h3>
  <div class="wan-grid">
    <!-- WAN 1 -->
    <div class="wan-card">
      <strong>Spectrum WAN 1 - {{ wan1.port_name }}</strong>
      <div style="margin: 10px 0;">
        ‚Üì <span id="wan1-down" style="font-weight: 600;">{{ wan1.download_mbps }}</span> Mbps | 
        ‚Üë <span id="wan1-up" style="font-weight: 600;">{{ wan1.upload_mbps }}</span> Mbps<br>
        Status: <span style="color: {% if wan1.status == 'UP' %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 600;">{{ wan1.status }}</span>
      </div>
      <!-- LibreNMS Graph -->
      <img src="{{ wan1_graph_url }}" alt="WAN1 Bandwidth Graph" style="width: 100%; height: auto; border-radius: 6px; margin-top: 10px; background: #e8e8e8; padding: 4px;">
    </div>
    
    <!-- WAN 2 -->
    <div class="wan-card">
      <strong>Frontier WAN 2 - {{ wan2.port_name }}</strong>
      <div style="margin: 10px 0;">
        ‚Üì <span id="wan2-down" style="font-weight: 600;">{{ wan2.download_mbps }}</span> Mbps | 
        ‚Üë <span id="wan2-up" style="font-weight: 600;">{{ wan2.upload_mbps }}</span> Mbps<br>
        Status: <span style="color: {% if wan2.status == 'UP' %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 600;">{{ wan2.status }}</span>
      </div>
      <!-- LibreNMS Graph -->
      <img src="{{ wan2_graph_url }}" alt="WAN2 Bandwidth Graph" style="width: 100%; height: auto; border-radius: 6px; margin-top: 10px; background: #e8e8e8; padding: 4px;">
    </div>
  </div>
</div>

  <!-- Alerts Section - DRAMATICALLY ENHANCED HERO CARDS -->
  <div class="section">
    <h3>üö® Alerts & Status</h3>
    <div class="alerts-grid">

      <div class="alert-box">
        <div class="alert-count" id="ips-count">{{ alerts.ips_count }}</div>
        <div>IPS Alerts</div>
        <small>Last 24 hours</small>

        <!-- Multi-line, nicely spaced IPS alerts -->
        <div class="ips-latest">
          {% for line in (alerts.ips_latest or '').split('\n\n') %}
            <div class="ips-item">{{ line }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="alert-box" onclick="showFirewallaDetails()">
        <div class="alert-count" id="fw-count" style="color: {% if alerts.firewalla_count > 10 %}#ef4444{% elif alerts.firewalla_count > 5 %}#f59e0b{% else %}#22c55e{% endif %}">
          {{ alerts.firewalla_count }}
        </div>
        <div>Firewalla Security</div>
        <div id="fw-latest"
             style="font-size:11px; margin-top:5px; white-space:pre-line;">
          {{ alerts.firewalla_latest }}
        </div>
        {% if firewalla %}
        <div style="font-size:11px; color:#6ea8ff; margin-top:8px;">
          <span style="color: #22c55e;">‚óè</span> {{ firewalla.boxes_online }} Boxes | {{ firewalla.devices_online }}/{{ firewalla.devices_total }} Devices
        </div>
        {% endif %}
      </div>

      <div class="alert-box">
        <div class="alert-count" style="color:#22c55e;">{{ alerts.syslogs_count }}</div>
        <div>System Logs</div>
        <small>All Clear</small>
        <small style="margin-top: 5px; color: #22c55e;">‚óè No Issues</small>
      </div>

      <div class="alert-box" id="hostmon-box" onclick="openHostMonModal()" style="cursor:pointer;">
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span id="hostmon-dot" style="font-weight:bold; font-size:20px;">‚óè</span>
          <span style="font-weight:600; font-size:14px;">HostMon</span>
        </div>
        <div id="hostmon-line1" style="margin-top:10px; font-size:13px; color:#9fb0c8;">Loading‚Ä¶</div>
        <small id="hostmon-line2" style="font-size:11px; color:#7f8c8d; margin-top:5px;"></small>
        <div id="hostmon-stats" style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; justify-content:center;">
          <span class="chip" id="hm-rna">RNA ‚Äî ‚Ä¶</span>
          <span class="chip" id="hm-gw">GW ‚Äî ‚Ä¶</span>
          <span class="chip" id="hm-ext">EXT ‚Äî ‚Ä¶</span>
          <span class="chip" id="hm-extjitter">EXT JIT ‚Äî ‚Ä¶</span> <!-- NEW -->
        </div>
      </div>

    </div><!-- close .alerts-grid -->
  </div><!-- close Alerts .section -->

  
  <!-- Power & Control Section - UPDATED FOR DLI PDU -->
  <div class="section">
    <h3>‚ö° Power & Control</h3>
    
    <!-- PDU Header with Power Stats -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
      <div>
        <strong style="color: #92c3ff; font-size: 15px;">{{ pdu.name }}</strong> - 
        <span id="pdu-amps" style="font-size: 18px; font-weight: 600; color: {% if pdu.current_amps > 12 %}#ef4444{% elif pdu.current_amps > 10 %}#f59e0b{% else %}#22c55e{% endif %}">
          {{ pdu.current_amps|round(1) }}
        </span><span style="color: #7f8c8d;">A</span> / {{ pdu.max_amps }}A
        <span style="color: #7f8c8d; font-size: 13px; margin-left: 10px;">
          ({{ ((pdu.current_amps / pdu.max_amps * 100)|round(0))|int }}% load)
        </span>
      </div>
      <div style="font-size: 13px; color: #7f8c8d;">
        <span style="color: #6ea8ff;">{{ pdu.voltage }}V</span> | 
        <span style="color: #f59e0b;">{{ pdu.watts|round(0)|int }}W</span>
      </div>
    </div>
    
    <!-- Outlet Grid -->
    <div class="outlets">
      {% for outlet in pdu.outlets %}
      <div class="outlet-control" 
           data-outlet-id="{{ outlet.id }}"
           data-locked="{{ outlet.locked|lower }}">
        
        <!-- Outlet Box -->
        <div class="outlet {{ 'on' if outlet.on else 'off' }} {{ 'locked' if outlet.locked else '' }}"
             onclick="toggleOutlet({{ outlet.id }})"
             style="cursor: {{ 'not-allowed' if outlet.locked else 'pointer' }};">
          
          <!-- Outlet Number -->
          <div style="font-size: 18px; font-weight: 700;">{{ outlet.id }}</div>
          
          <!-- Outlet Name -->
          <div style="font-size: 11px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500;">
            {{ outlet.name|truncate(12, True, '') }}
          </div>
          
          <!-- Lock indicator -->
          {% if outlet.locked %}
          <div style="position: absolute; top: 4px; right: 4px; font-size: 12px;">üîí</div>
          {% endif %}
        </div>
        
        <!-- Quick Actions (shown on hover) -->
        {% if not outlet.locked %}
        <div class="outlet-actions">
          <a href="#" onclick="event.preventDefault(); cycleOutlet({{ outlet.id }})" style="color: #f59e0b; margin: 0 5px;" title="Cycle">‚ü≤</a>
          <a href="#" onclick="event.preventDefault(); renameOutlet({{ outlet.id }}, '{{ outlet.name }}')" style="color: #6ea8ff;" title="Rename">‚úè</a>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    
    <!-- Legend and Controls -->
    <div style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(42, 52, 65, 0.3);">
      <div style="display: flex; gap: 25px; font-size: 12px; color: #7f8c8d; font-weight: 500;">
        <span><span style="color: #22c55e; text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);">‚óè</span> On</span>
        <span><span style="color: #7f8c8d;">‚óè</span> Off</span>
        <span>üîí Locked</span>
      </div>
      <div>
        <button onclick="refreshPDU()" style="background: linear-gradient(135deg, #1a2332, #1e2837); border: 1px solid rgba(110, 168, 255, 0.3); color: #6ea8ff; padding: 6px 15px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500;">
          ‚Üª Refresh
        </button>
      </div>
    </div>
    
    <!-- Switch status display (keeping legacy display) -->
    <div style="margin-top:25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
      {% for switch in switches %}
      <div style="margin-bottom: 8px; color: #9fb0c8;">
        <span style="color: #6ea8ff; font-weight: 500;">{{ switch.name }}:</span> 
        <span style="color: #22c55e; font-weight: 600;">{{ switch.active }}</span>/{{ switch.ports }} ports active
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- MikroTik Switch Management Section -->
  <div class="section">
    <h3>üîå Switch Management - {{ mikrotik_switch.model }}</h3>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
      <div>
        <span style="color: #22c55e; font-weight: 600; font-size: 16px;">{{ mikrotik_switch.stats.ports_up }}/{{ mikrotik_switch.stats.total_ports }}</span> ports up
        {% if mikrotik_switch.stats.ports_errors > 0 %}
        | <span style="color: #ef4444; font-weight: 600;">{{ mikrotik_switch.stats.ports_errors }} errors</span>
        {% endif %}
      </div>
      <div style="font-size: 12px; color: #6ea8ff; font-weight: 500;">
        Click port for details
      </div>
    </div>
    
    <!-- Main Container with Grid and Side Panel -->
    <div style="display: flex; gap: 25px;">
      <!-- Main 48-Port Grid -->
      <div style="flex: 1;">
        <div id="switch-grid" class="switch-grid">
          {% for port in mikrotik_switch.ports %}
          {% if port.id <= 48 %}
          <div class="switch-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-number">{{ port.id }}</span>
            <span class="port-name">{{ port.name|truncate(10, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- SFP/QSFP Side Panel -->
      <div class="sfp-panel">
        <div class="sfp-section">
          <div class="sfp-label">SFP+ (10G)</div>
          {% for port in mikrotik_switch.ports %}
          {% if port.id >= 49 and port.id <= 52 %}
          <div class="switch-port sfp-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-label">SFP{{ port.id - 48 }}</span>
            <span class="sfp-port-name">{{ port.name|truncate(12, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        
        <div class="sfp-section" style="margin-top: 25px;">
          <div class="sfp-label">QSFP+ (40G)</div>
          {% for port in mikrotik_switch.ports %}
          {% if port.id >= 53 and port.id <= 54 %}
          <div class="switch-port qsfp-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-label">Q{{ port.id - 52 }}</span>
            <span class="sfp-port-name">{{ port.name|truncate(12, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Color Legend -->
    <div class="switch-legend">
      <div class="legend-item">
        <div class="legend-box disabled"></div>
        <span>Disabled</span>
      </div>
      <div class="legend-item">
        <div class="legend-box no-link"></div>
        <span>No Link</span>
      </div>
      <div class="legend-item">
        <div class="legend-box active"></div>
        <span>Active</span>
      </div>
      <div class="legend-item">
        <div class="legend-box error"></div>
        <span>Errors</span>
      </div>
    </div>
  </div>
</div>

<!-- ============== MODALS SECTION ============== -->

<!-- Port Detail Modal -->
<div id="portModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1002; align-items:center; justify-content:center;">
  <div style="background:linear-gradient(135deg, #1a2332 0%, #1e2837 100%); border:2px solid rgba(110, 168, 255, 0.3); border-radius:14px; width:600px; max-height:500px; padding:25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
      <h3 style="color:#6ea8ff; margin:0; font-weight: 600;">
        Port <span id="portNumber">--</span> Details
      </h3>
      <button onclick="closePortModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:24px; cursor:pointer; transition: transform 0.2s;">‚úñ</button>
    </div>
    
    <div id="portContent">
      <!-- Port Name -->
      <div style="margin-bottom:25px;">
        <label style="color:#7f8c8d; display:block; margin-bottom:8px; font-weight: 500;">Port Name:</label>
        <div style="display:flex; gap:12px;">
          <input id="portNameInput" type="text" style="flex:1; background:rgba(10, 15, 26, 0.8); border:1px solid rgba(42, 52, 65, 0.5); color:#e6eaf2; padding:10px; border-radius:6px; font-size: 14px;">
          <button onclick="updatePortName()" style="background:linear-gradient(135deg, #3498db, #2980b9); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight: 500;">Save</button>
        </div>
      </div>
      
      <!-- Port Status -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px; margin-bottom:25px;">
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
          <div style="color:#7f8c8d; margin-bottom:8px; font-weight: 500;">Status:</div>
          <div id="portStatus" style="font-size:20px; font-weight:bold;">--</div>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
          <div style="color:#7f8c8d; margin-bottom:8px; font-weight: 500;">Speed:</div>
          <div id="portSpeed" style="font-size:20px; color: #6ea8ff;">--</div>
        </div>
      </div>
      
      <!-- Bandwidth -->
      <div style="margin-bottom:25px;">
        <div style="color:#7f8c8d; margin-bottom:12px; font-weight: 500;">Current Bandwidth:</div>
        <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:8px;">
          <div style="margin-bottom: 10px;">‚Üì Download: <span id="portRxRate" style="color:#22c55e; font-weight:bold; font-size: 16px;">-- Mbps</span></div>
          <div>‚Üë Upload: <span id="portTxRate" style="color:#3498db; font-weight:bold; font-size: 16px;">-- Mbps</span></div>
        </div>
      </div>
      
      <!-- Errors -->
      <div id="portErrors" style="margin-bottom:25px; display:none;">
        <div style="color:#ef4444; margin-bottom:12px; font-weight: 500;">‚ö†Ô∏è Port Errors Detected:</div>
        <div style="background:rgba(239,68,68,0.1); padding:15px; border-radius:8px; border:1px solid rgba(239, 68, 68, 0.3);">
          RX Errors: <span id="portRxErrors" style="font-weight: 600;">0</span> | 
          TX Errors: <span id="portTxErrors" style="font-weight: 600;">0</span>
        </div>
      </div>
      
      <!-- Actions -->
      <div style="display:flex; gap:12px;">
        <button id="portToggleBtn" onclick="togglePort()" style="flex:1; padding:12px; border-radius:6px; cursor:pointer; font-weight:600;">
          Toggle Port
        </button>
        <button onclick="refreshPortDetails()" style="background:linear-gradient(135deg, #7f8c8d, #6c757d); color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight: 500;">
          Refresh
        </button>
      </div>
    </div>
  </div>
</div>

<!-- IPS Alerts Modal -->
<div id="ipsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:linear-gradient(135deg, #1a2332 0%, #1e2837 100%); border:2px solid rgba(239, 68, 68, 0.3); border-radius:14px; width:90%; max-width:800px; max-height:80vh; overflow:auto; padding:25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
      <h2 style="color:#ef4444; margin:0; font-weight: 600;">üö® IPS Alerts - Live Feed</h2>
      <button onclick="closeIpsModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:24px; cursor:pointer;">‚úñ</button>
    </div>
    <div id="ipsModalContent" style="font-family:'Courier New', monospace; font-size:13px; color:#9fb0c8;">
      Loading...
    </div>
  </div>
</div>

<!-- WHOIS Lookup Modal -->
<div id="whoisModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1001; align-items:center; justify-content:center;">
  <div style="background:linear-gradient(135deg, #1a2332 0%, #1e2837 100%); border:2px solid rgba(110, 168, 255, 0.3); border-radius:14px; width:500px; max-height:400px; overflow:auto; padding:25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
      <h3 style="color:#6ea8ff; margin:0; font-weight: 600;">üîç IP Intelligence</h3>
      <button onclick="closeWhoisModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:20px; cursor:pointer;">‚úñ</button>
    </div>
    <div id="whoisContent">Loading...</div>
  </div>
</div>

<!-- FIREWALLA DETAILS MODAL (ENHANCED) -->
<div id="firewallaModal" class="modal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center;">
  <div style="background:linear-gradient(135deg, #1a2332 0%, #1e2837 100%); border:2px solid rgba(110, 168, 255, 0.3); border-radius:14px; padding:30px; max-width:800px; max-height:80vh; overflow-y:auto; position:relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <span onclick="closeFirewallaModal()" style="position:absolute; right:20px; top:20px; font-size:28px; color:#6ea8ff; cursor:pointer; transition: transform 0.2s;">&times;</span>
    
    <h2 style="color:#6ea8ff; margin:0 0 25px 0; font-weight: 600;">üõ°Ô∏è Firewalla Security Status</h2>
    
    <div id="firewallaDetailsContent">
      <div style="text-align:center; color:#6ea8ff;">Loading...</div>
    </div>
  </div>
</div>

<!-- HOSTMON UPTIME MODAL -->
<div id="hostmonModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9);
            z-index:1002; justify-content:center; align-items:center;">
  <div style="background:linear-gradient(135deg,#0a0f1a,#0d1219); border:2px solid rgba(110,168,255,0.4);
              border-radius:14px; width:90%; max-width:1200px; height:85vh;
              box-shadow:0 0 30px rgba(0,0,0,0.6); overflow:hidden; display:flex; flex-direction:column;">
    <div style="display:flex; justify-content:space-between; align-items:center;
                padding:10px 18px; background:#1a2332; border-bottom:1px solid rgba(110,168,255,0.3);">
      <span style="color:#6ea8ff; font-weight:600;">üß≠ HostMon Uptime Report</span>
      <button onclick="closeHostMonModal()"
              style="background:none; border:none; color:#6ea8ff; font-size:22px; cursor:pointer;">‚úñ</button>
    </div>
    <iframe src="http://192.168.1.111:5000/static/hostmon/wtr_uptime.html"
            style="flex:1; width:100%; border:none; background:#000080;"></iframe>
  </div>
</div>


<!-- ============== JAVASCRIPT SECTION ============== -->
<script>

function openHostMonModal() {
  document.getElementById('hostmonModal').style.display = 'flex';
}
function closeHostMonModal() {
  document.getElementById('hostmonModal').style.display = 'none';
}

// ============== FIREWALLA FUNCTIONS ==============

function showFirewallaDetails() {
  document.getElementById('firewallaModal').style.display = 'flex';
  
  // Fetch detailed Firewalla data
  fetch('/ops/api/firewalla/details')
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        let content = '';
        
        // Summary cards
        content += `
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom:20px;">
          <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px; text-align:center;">
            <div style="font-size:32px; color:#6ea8ff; font-weight:bold;">${data.alarms.count}</div>
            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">24hr Alarms</div>
          </div>
          <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px; text-align:center;">
            <div style="font-size:32px; color:#22c55e; font-weight:bold;">${data.devices.online}</div>
            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">Devices Online</div>
          </div>
          <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px; text-align:center;">
            <div style="font-size:32px; color:#ef4444; font-weight:bold;">${data.flows.blocked}</div>
            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">Flows Blocked</div>
          </div>
          <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px; text-align:center;">
            <div style="font-size:32px; color:#f59e0b; font-weight:bold;">${data.rules.active}</div>
            <div style="color:#7f8c8d; font-size:12px; margin-top:5px;">Active Rules</div>
          </div>
        </div>`;
        
        // Firewalla Boxes Status
        if (data.boxes && data.boxes.length > 0) {
          content += '<h3 style="color:#6ea8ff; margin:20px 0 10px;">Firewalla Boxes</h3>';
          content += '<div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px;">';
          
          data.boxes.forEach(box => {
            const statusColor = box.online ? '#22c55e' : '#ef4444';
            const statusText = box.online ? 'ONLINE' : 'OFFLINE';
            content += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #2a3441;">
              <div>
                <strong style="color:#e6eaf2;">${box.name}</strong>
                <span style="color:#7f8c8d; margin-left:10px;">${box.model}</span>
              </div>
              <div style="display:flex; gap:20px; align-items:center;">
                <span style="color:#7f8c8d;">v${box.version}</span>
                <span style="color:#7f8c8d;">${box.public_ip}</span>
                <span style="color:#7f8c8d;">${box.device_count} devices</span>
                <span style="color:${statusColor}; font-weight:bold;">${statusText}</span>
              </div>
            </div>`;
          });
          
          content += '</div>';
        }
        
        // Recent Alarms
        if (data.alarms.recent && data.alarms.recent.length > 0) {
          content += '<h3 style="color:#6ea8ff; margin:20px 0 10px;">Recent Security Alarms</h3>';
          content += '<div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px; max-height:60vh; overflow-y:auto;">';
          
          data.alarms.recent.forEach(alarm => {
            const typeColor = alarm.severity === 'high' ? '#ef4444' : '#f59e0b';
            content += `
            <div style="padding:10px 0; border-bottom:1px solid #2a3441;">
              <span style="color:${typeColor}; font-weight:bold;">${alarm.type || 'Unknown'}</span>
              <span style="color:#7f8c8d; margin-left:15px;">${alarm.message || ''}</span>
            </div>`;
          });
          
          content += '</div>';
        }

        // --- Target List Controls ---
        content += `
          <h3 style="color:#6ea8ff; margin:20px 0 10px;">Target List</h3>
          <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:12px; margin-bottom:10px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="fw-target-input" placeholder="IP or domain to block" 
                     style="flex:1; background:#0a0f1a; border:1px solid #2a3441; color:#e6eaf2; padding:8px; border-radius:4px;">
              <button onclick="fwAddTarget()" 
                      style="background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">Block</button>
            </div>
          </div>
          <div id="fw-target-list" style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:12px; max-height:30vh; overflow-y:auto;">
            <div style="color:#6ea8ff;">Loading target list...</div>
          </div>
        `;

        // fetch & render target list
        fetch('/ops/api/firewalla/targets')
          .then(r => r.json())
          .then(tl => {
            const box = document.getElementById('fw-target-list');
            if (!tl.success) { box.innerHTML = '<div style="color:#ef4444;">Failed to load target list</div>'; return; }
            if (!tl.targets || tl.targets.length === 0) { box.innerHTML = '<div style="color:#7f8c8d;">No entries</div>'; return; }
            box.innerHTML = tl.targets.map(t => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #2a3441;">
                <span style="color:#e6eaf2; font-family:monospace;">${t}</span>
                <button onclick="fwRemoveTarget('${t.replace(/'/g, "\\'")}')" 
                        style="background:#1a2332; color:#f59e0b; border:1px solid #2a3441; padding:4px 8px; border-radius:4px; cursor:pointer;">Remove</button>
              </div>
            `).join('');
          });

        
        // Update time
        content += `<div style="text-align:right; margin-top:20px; color:#7f8c8d; font-size:12px;">Last Updated: ${data.timestamp}</div>`;
        
        document.getElementById('firewallaDetailsContent').innerHTML = content;
      }
    })
    .catch(err => {
      console.error('Failed to fetch Firewalla details:', err);
      document.getElementById('firewallaDetailsContent').innerHTML = 
        '<div style="color:#ef4444; text-align:center;">Failed to load Firewalla details</div>';
    });
}

function closeFirewallaModal() {
  document.getElementById('firewallaModal').style.display = 'none';
}

// ============== PDU Control Functions ==============

// Toggle outlet on/off
function toggleOutlet(outletId) {
  // Get outlet element
  const outletEl = document.querySelector(`[data-outlet-id="${outletId}"]`);
  if (outletEl.dataset.locked === 'true') {
    alert('This outlet is locked and cannot be changed.');
    return;
  }
  
  if (!confirm(`Toggle outlet ${outletId}?`)) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/toggle`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const outlet = outletEl.querySelector('.outlet');
      if (data.new_state === 'on') {
        outlet.classList.remove('off');
        outlet.classList.add('on');
      } else {
        outlet.classList.remove('on');
        outlet.classList.add('off');
      }
      console.log(`Outlet ${outletId} turned ${data.new_state}`);
    } else {
      alert(`Failed to toggle outlet: ${data.error || 'Unknown error'}`);
    }
  })
  .catch(err => {
    alert(`Error: ${err.message}`);
  });
}

// Cycle outlet (off, wait, on)
function cycleOutlet(outletId) {
  if (!confirm(`Cycle outlet ${outletId}? This will turn it OFF then back ON.`)) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/cycle`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert(`Outlet ${outletId} is cycling...`);
      // Refresh after a few seconds
      setTimeout(refreshPDU, 5000);
    } else {
      alert(`Failed to cycle outlet: ${data.error || 'Unknown error'}`);
    }
  });
}

// Rename outlet
function renameOutlet(outletId, currentName) {
  const newName = prompt(`Rename outlet ${outletId}:`, currentName);
  if (!newName || newName === currentName) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/name`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const outletEl = document.querySelector(`[data-outlet-id="${outletId}"] .outlet div:nth-child(2)`);
      if (outletEl) {
        outletEl.textContent = newName.substring(0, 12);
      }
      console.log(`Outlet ${outletId} renamed to "${newName}"`);
    } else {
      alert(`Failed to rename outlet: ${data.error || 'Unknown error'}`);
    }
  });
}

// Refresh PDU status
function refreshPDU() {
  fetch('/ops/api/pdu/outlets/all')
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Update outlet states
        data.outlets.forEach(outlet => {
          const outletEl = document.querySelector(`[data-outlet-id="${outlet.id}"] .outlet`);
          if (outletEl) {
            if (outlet.state) {
              outletEl.classList.remove('off');
              outletEl.classList.add('on');
            } else {
              outletEl.classList.remove('on');
              outletEl.classList.add('off');
            }
          }
        });
        
        // Update power stats
        if (data.power) {
          const ampsEl = document.getElementById('pdu-amps');
          if (ampsEl) {
            ampsEl.textContent = data.power.current_amps.toFixed(1);
            // Update color based on load
            if (data.power.current_amps > 12) {
              ampsEl.style.color = '#ef4444';
            } else if (data.power.current_amps > 10) {
              ampsEl.style.color = '#f59e0b';
            } else {
              ampsEl.style.color = '#22c55e';
            }
          }
        }
        
        console.log('PDU status refreshed');
      }
    })
    .catch(err => {
      console.error('Failed to refresh PDU:', err);
    });
}

// ============== IPS Alert Functions ==============

// Show IPS details with analytics
function showIpsDetails() {
  document.getElementById('ipsModal').style.display = 'flex';
  
  fetch('/ops/api/ips-details')
    .then(r => r.json())
    .then(data => {
      let content = '';
      
      if (data.analytics) {
        content += `
        <div style="background:#0f1823; border:2px solid #ef4444; border-radius:8px; padding:15px; margin-bottom:20px;">
          <h3 style="color:#ef4444; margin:0 0 15px 0;">üìä 24-Hour Threat Analytics</h3>
          
          <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-bottom:15px;">
            <div style="text-align:center;">
              <div style="font-size:28px; color:#ef4444; font-weight:bold;">${data.analytics['24hr_total']}</div>
              <div style="color:#6ea8ff; font-size:12px;">Total Blocks</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:28px; color:#f59e0b; font-weight:bold;">${data.analytics.hourly_rate}</div>
              <div style="color:#6ea8ff; font-size:12px;">Per Hour</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:28px; color:#22c55e; font-weight:bold;">${data.analytics.top_attackers ? data.analytics.top_attackers.length : 0}</div>
              <div style="color:#6ea8ff; font-size:12px;">Unique Attackers</div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <h4 style="color:#6ea8ff; margin:0 0 8px 0;">Top Attackers:</h4>
            ${data.analytics.top_attackers && data.analytics.top_attackers.length > 0 ? 
              data.analytics.top_attackers.map(([ip, count]) => 
                `<div style="display:flex; justify-content:space-between; padding:4px; background:#0a0f1a; margin:2px 0; border-radius:4px;">
                  <span style="color:#fff; font-family:monospace; cursor:pointer; text-decoration:underline;" onclick="lookupIP('${ip}')">${ip}</span>
                  <span style="color:#ef4444;">${count} attacks</span>
                </div>`
              ).join('') : '<div style="color:#9fb0c8;">No attackers detected</div>'}
          </div>
          
          <div>
            <h4 style="color:#6ea8ff; margin:0 0 8px 0;">Attack Types:</h4>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              ${data.analytics.attack_types ? Object.entries(data.analytics.attack_types).map(([type, count]) =>
                `<span style="background:#1a2332; padding:4px 8px; border-radius:4px; font-size:12px;">
                  ${type}: <span style="color:#f59e0b;">${count}</span>
                </span>`
              ).join('') : '<span style="color:#9fb0c8;">No attack types</span>'}
            </div>
          </div>
        </div>`;
      }
      
      content += '<h3 style="color:#6ea8ff; margin:20px 0 10px 0;">üîç Recent IPS Alerts</h3>';
      
      if (data.alerts && data.alerts.length > 0) {
        data.alerts.forEach(alert => {
          content += `<div style="background:#0a0f1a; padding:10px; margin-bottom:10px; border-left:3px solid #ef4444; border-radius:4px;">
            <div style="color:#6ea8ff; font-size:10px;">${alert.timestamp}</div>
            <div style="color:#fff; margin-top:5px; word-wrap:break-word; font-size:11px;">${alert.message}</div>
          </div>`;
        });
      } else {
        content = '<div style="color:#22c55e;">No IPS alerts in recent logs</div>';
      }
      
      document.getElementById('ipsModalContent').innerHTML = content;
    });
}

// IP WHOIS lookup using local whois.exe
function lookupIP(ip) {
  document.getElementById('whoisModal').style.display = 'flex';
  document.getElementById('whoisContent').innerHTML = 'Looking up ' + ip + '...';
  
  fetch('/ops/api/whois/' + ip)
    .then(r => r.json())
    .then(data => {
      let content = `
        <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px;">
          <div style="font-size:20px; color:#ef4444; font-family:monospace; margin-bottom:15px;">${data.ip}</div>
          <div style="display:grid; gap:8px; font-size:12px;">
            <div><span style="color:#6ea8ff;">Organization:</span> <span style="color:#fff;">${data.org || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">Country:</span> <span style="color:#fff;">${data.country || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">Network:</span> <span style="color:#fff;">${data.network || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">CIDR:</span> <span style="color:#fff; font-family:monospace;">${data.cidr || 'Unknown'}</span></div>
            ${data.contact && data.contact !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Contact:</span> <span style="color:#fff;">${data.contact}</span></div>` : ''}
            ${data.address && data.address !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Address:</span> <span style="color:#fff;">${data.address}</span></div>` : ''}
            ${data.abuse_email && data.abuse_email !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Abuse Email:</span> <span style="color:#ef4444;">${data.abuse_email}</span></div>` : ''}
            ${data.phone && data.phone !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Phone:</span> <span style="color:#fff;">${data.phone}</span></div>` : ''}
          </div>
        </div>
      `;
      document.getElementById('whoisContent').innerHTML = content;
    })
    .catch(err => {
      document.getElementById('whoisContent').innerHTML = '<div style="color:#ef4444;">Error performing lookup</div>';
    });
}

// Modal control functions
function closeIpsModal() {
  document.getElementById('ipsModal').style.display = 'none';
}

function closeWhoisModal() {
  document.getElementById('whoisModal').style.display = 'none';
}

// ============== Switch Port Functions ==============

let currentPortId = null;

// Show port details modal
function showPortDetails(portId) {
  currentPortId = portId;
  document.getElementById('portModal').style.display = 'flex';
  
  // Load port details
  fetch(`/ops/api/switch/port/${portId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById('portNumber').textContent = data.id;
      document.getElementById('portNameInput').value = data.name;
      
      // Show both admin and operational status
      let statusText = '';
      let statusColor = '';
      
      if (!data.enabled) {
        statusText = 'DISABLED';
        statusColor = '#7f8c8d';
      } else if (data.status === 'up') {
        statusText = 'UP';
        statusColor = '#22c55e';
      } else {
        statusText = 'NO LINK';
        statusColor = '#f59e0b';
      }
      
      document.getElementById('portStatus').textContent = statusText;
      document.getElementById('portStatus').style.color = statusColor;
      document.getElementById('portSpeed').textContent = data.speed;
      document.getElementById('portRxRate').textContent = data.rx_mbps + ' Mbps';
      document.getElementById('portTxRate').textContent = data.tx_mbps + ' Mbps';
      
      // Show errors if any
      if (data.rx_errors > 0 || data.tx_errors > 0) {
        document.getElementById('portErrors').style.display = 'block';
        document.getElementById('portRxErrors').textContent = data.rx_errors;
        document.getElementById('portTxErrors').textContent = data.tx_errors;
      } else {
        document.getElementById('portErrors').style.display = 'none';
      }
      
      // Update toggle button based on admin state
      const toggleBtn = document.getElementById('portToggleBtn');
      if (data.enabled) {
        toggleBtn.textContent = 'Disable Port';
        toggleBtn.style.background = '#ef4444';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
      } else {
        toggleBtn.textContent = 'Enable Port';
        toggleBtn.style.background = '#22c55e';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
      }
    });
}

// Close port modal
function closePortModal() {
  document.getElementById('portModal').style.display = 'none';
  currentPortId = null;
}

// Toggle port state
function togglePort() {
  if (!currentPortId) return;
  
  if (confirm('Are you sure you want to toggle this port ( ie; down port will up and vice versa?')) {
    fetch(`/ops/api/switch/port/${currentPortId}/toggle`, { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          refreshPortDetails();
          // Refresh the main grid too
          location.reload();
        }
      });
  }
}

// ============== Firewalla Functions ==============


// Update port name
function updatePortName() {
  if (!currentPortId) return;
  
  const newName = document.getElementById('portNameInput').value;
  
  fetch(`/ops/api/switch/port/${currentPortId}/name`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Port name updated');
        // Update the grid tooltip
        const portElement = document.querySelector(`[data-port-id="${currentPortId}"]`);
        if (portElement) {
          const status = portElement.dataset.enabled === 'false' ? 'DISABLED' :
                         portElement.dataset.status === 'up' ? 'ACTIVE' : 'NO LINK';
          portElement.title = `${newName} - ${status}`;
          // Also update the port name display
          const portNameElement = portElement.querySelector('.port-name') || portElement.querySelector('.sfp-port-name');
          if (portNameElement) {
            portNameElement.textContent = newName.substring(0, 10);
          }
        }
      }
    });
}

// Refresh port details
function refreshPortDetails() {
  if (currentPortId) {
    showPortDetails(currentPortId);
  }
}

function fwAddTarget() {
  const input = document.getElementById('fw-target-input');
  const target = (input.value || '').trim();
  if (!target) { alert('Enter an IP or domain'); return; }
  fetch('/ops/api/firewalla/targets', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({target})
  })
    .then(r => r.json())
    .then(res => {
      if (!res.success) { alert('Failed to add: ' + (res.error || '')); return; }
      // refresh list
      return fetch('/ops/api/firewalla/targets').then(r=>r.json()).then(tl=>{
        const box = document.getElementById('fw-target-list');
        if (!tl.success) { box.innerHTML = '<div style="color:#ef4444;">Failed to load target list</div>'; return; }
        box.innerHTML = (tl.targets||[]).map(t => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #2a3441;">
            <span style="color:#e6eaf2; font-family:monospace;">${t}</span>
            <button onclick="fwRemoveTarget('${t.replace(/'/g, "\\'")}')" 
                    style="background:#1a2332; color:#f59e0b; border:1px solid #2a3441; padding:4px 8px; border-radius:4px; cursor:pointer;">Remove</button>
          </div>
        `).join('') || '<div style="color:#7f8c8d;">No entries</div>';
        input.value = '';
      });
    });
}

function fwRemoveTarget(target) {
  if (!confirm('Remove ' + target + ' from block list?')) return;
  fetch('/ops/api/firewalla/targets/' + encodeURIComponent(target), { method: 'DELETE' })
    .then(r => r.json())
    .then(res => {
      if (!res.success) { alert('Failed to remove: ' + (res.error || '')); return; }
      // refresh list
      return fetch('/ops/api/firewalla/targets').then(r=>r.json()).then(tl=>{
        const box = document.getElementById('fw-target-list');
        if (!tl.success) { box.innerHTML = '<div style="color:#ef4444;">Failed to load target list</div>'; return; }
        box.innerHTML = (tl.targets||[]).map(t => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #2a3441;">
            <span style="color:#e6eaf2; font-family:monospace;">${t}</span>
            <button onclick="fwRemoveTarget('${t.replace(/'/g, "\\'")}')" 
                    style="background:#1a2332; color:#f59e0b; border:1px solid #2a3441; padding:4px 8px; border-radius:4px; cursor:pointer;">Remove</button>
          </div>
        `).join('') || '<div style="color:#7f8c8d;">No entries</div>';
      });
    });
}

// --- HostMon: tile + chips (HTML-report endpoints) ---
function hostmonColor(state){
  return state==='up' ? '#22c55e' : (state==='degraded' ? '#f59e0b' : '#ef4444');
}

// Tile (dot + lines) -> /ops/api/hostmon/status_simple
function refreshHostMonTile(){
  const dot = document.getElementById('hostmon-dot');
  const l1  = document.getElementById('hostmon-line1');
  const l2  = document.getElementById('hostmon-line2');
  if(!dot || !l1 || !l2) return;

  fetch('/ops/api/hostmon/status_simple',{cache:'no-store'})
    .then(r=>r.json())
    .then(d=>{
      if(!d || !d.ok){ dot.style.color='#f59e0b'; l1.textContent='Status unavailable'; l2.textContent=''; return; }
      dot.style.color = hostmonColor(d.state);
      const role = (d.wan.role || 'unknown').toUpperCase();
      const ip   = d.wan.ip || 'n/a';
      l1.textContent = `${role} WAN ${ip}`;
      l2.textContent = d.wan.since ? `Up since ${d.wan.since}` : `Updated ${d.updated}`;
    })
    .catch(()=>{ dot.style.color='#f59e0b'; l1.textContent='Status unavailable'; l2.textContent=''; });
}

// Chips (RNA / GW / EXT) -> /ops/api/hostmon/metrics_smart
function refreshHostMonChips(){
  const rna = document.getElementById('hm-rna');
  const gw  = document.getElementById('hm-gw');
  const ext = document.getElementById('hm-ext');
  const extjit = document.getElementById('hm-extjitter');
  if(!rna && !gw && !ext) return;

  fetch('/ops/api/hostmon/metrics_smart',{cache:'no-store'})
    .then(r=>r.json())
    .then(m=>{
      if(!m || !m.ok) return;
      if(rna) rna.textContent = `RNA ‚Äî ${m.rna_pct}% (24h)`;
      if(gw)  gw.textContent  = `GW ‚Äî ${m.perf.gw_ms!=null ? Math.round(m.perf.gw_ms) : '‚Äî'} ms`;
      if(ext) ext.textContent = `EXT ‚Äî ${m.perf.ext_ms!=null ? Math.round(m.perf.ext_ms) : '‚Äî'} ms`;
      if (extjit) extjit.textContent = `EXT JIT ‚Äî ${m.perf.ext_jitter_ms != null ? Math.round(m.perf.ext_jitter_ms) : '‚Äî'} ms`;
    })
    .catch(()=>{ /* silent */ });
}

// Kick off
document.addEventListener('DOMContentLoaded', ()=>{
  refreshHostMonTile();
  setInterval(refreshHostMonTile, 60000);      // every 60s
  refreshHostMonChips();
  setInterval(refreshHostMonChips, 300000);    // every 5 min
});


// ============== Global Event Handlers ==============

// Close modals when clicking outside
window.onclick = function(event) {
  // Check for Firewalla modal
  const fwModal = document.getElementById('firewallaModal');
  if (event.target === fwModal) {
    fwModal.style.display = 'none';
  }
  
  // Check for WHOIS modal
  const whoisModal = document.getElementById('whoisModal');
  if (event.target === whoisModal) {
    whoisModal.style.display = 'none';
  }
  
  // Check for IPS modal
  const ipsModal = document.getElementById('ipsModal');
  if (event.target === ipsModal) {
    ipsModal.style.display = 'none';
  }
  
  // Check for port modal
  const portModal = document.getElementById('portModal');
  if (event.target === portModal) {
    portModal.style.display = 'none';
  }
}

// Add click handlers to all elements on page load
document.addEventListener('DOMContentLoaded', function() {
  // IPS alert box clickable
  const alertBoxes = document.querySelectorAll('.alert-box');
  if (alertBoxes.length > 0) {
    const ipsBox = alertBoxes[0];
    ipsBox.style.cursor = 'pointer';
    ipsBox.onclick = showIpsDetails;
  }
  
  // Switch port click handlers
  document.querySelectorAll('.switch-port').forEach(port => {
    port.addEventListener('click', function() {
      const portId = parseInt(this.dataset.portId);
      showPortDetails(portId);
    });
  });
  
  // PDU outlet hover effects
  document.querySelectorAll('.outlet-control').forEach(el => {
    el.addEventListener('mouseenter', function() {
      if (this.dataset.locked !== 'true') {
        const actions = this.querySelector('.outlet-actions');
        if (actions) actions.style.display = 'block';
      }
    });
    el.addEventListener('mouseleave', function() {
      const actions = this.querySelector('.outlet-actions');
      if (actions) actions.style.display = 'none';
    });
  });
});
</script>
{% endblock %}