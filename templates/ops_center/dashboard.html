<!--
Operations Command Center - Dashboard Template
Version: 1.3.0
Last Modified: 2025-01-XX
Author: Billas
Description: Main dashboard HTML template for Operations Command Center

File: /templates/ops_center/dashboard.html

CHANGELOG:
- 1.3.0 (2025-01-XX): Added real DLI PDU controls replacing mock data
- 1.2.0 (2024-01-XX): Added SFP/QSFP side panel for high-speed ports
- 1.1.0 (2024-01-XX): Added enhanced switch grid with proper state display and legend
- 1.0.0 (2024-01-XX): Initial implementation with mock display
-->

{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Inline styles for Sprint 1 - will move to /static/ops_center/css/ later -->
<style>
  /* Dashboard container */
  .ops-dash { padding: 20px; background: #0a0f1a; min-height: 100vh; }
  
  /* Header section */
  .ops-header { display: flex; justify-content: space-between; padding: 15px; background: #1a2332; border: 1px solid #2a3441; border-radius: 8px; margin-bottom: 20px; }
  .ops-title { font-size: 24px; font-weight: 900; color: #6ea8ff; text-transform: uppercase; }
  .status { color: #22c55e; }
  
  /* Content sections */
  .section { background: #0f1823; border: 1px solid #2a3441; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
  .section h3 { color: #6ea8ff; margin-bottom: 15px; font-size: 14px; text-transform: uppercase; }
  
  /* WAN display */
  .wan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  .wan-card { background: #0a0f1a; padding: 10px; border-radius: 4px; }
  
  /* Alerts display */
  .alerts-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
  .alert-box { background: #0a0f1a; padding: 10px; border-radius: 4px; text-align: center; }
  .alert-count { font-size: 24px; font-weight: bold; color: #ef4444; }
  
  /* PDU outlets display - UPDATED FOR DLI */
   .outlets { 
     display: grid; 
     grid-template-columns: repeat(4, 1fr); 
     gap: 10px; 
   }
   
   .outlet-control {
     position: relative;
     /* Add padding top to create hover area above outlet */
     padding-top: 25px;
     margin-top: -25px;
   }
   
   /* Keep actions visible when hovering over the control area */
   .outlet-control:hover .outlet-actions {
     display: block !important;
   }
   
   .outlet { 
     background: #0a0f1a; 
     border: 2px solid #1a2332; 
     padding: 10px 5px; 
     text-align: center; 
     border-radius: 4px;
     transition: all 0.3s;
     min-height: 60px;
     display: flex;
     flex-direction: column;
     justify-content: center;
     align-items: center;
     position: relative;  /* Add this */
   }
   
   .outlet.on { 
     border-color: #22c55e; 
     background: rgba(34, 197, 94, 0.1);
     color: #22c55e; 
   }
   
   .outlet.off {
     border-color: #7f8c8d;
     color: #7f8c8d;
   }
   
   .outlet.locked {
     opacity: 0.6;
     background-image: repeating-linear-gradient(
       45deg,
       transparent,
       transparent 5px,
       rgba(255,255,255,0.03) 5px,
       rgba(255,255,255,0.03) 10px
     );
   }
   
   .outlet:hover:not(.locked) {
     transform: scale(1.05);
     border-color: #6ea8ff !important;
   }
   
   .outlet-actions {
     display: none;
     position: absolute;
     top: 0;  /* Changed from -25px to 0 */
     right: 0;
     background: #1a2332;
     padding: 4px 8px;  /* Increased padding */
     border-radius: 3px;
     font-size: 11px;
     z-index: 100;
     border: 1px solid #2a3441;  /* Add border for visibility */
     white-space: nowrap;  /* Prevent wrapping */
   }
   
   /* Make action links easier to click */
   .outlet-actions a {
     padding: 2px 5px;  /* Add padding to links */
     display: inline-block;  /* Make clickable area bigger */
   }
  
  /* Switch grid styles */
  .switch-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 6px;
    margin-top: 10px;
  }
  
  .switch-port {
    aspect-ratio: 1;
    background: #0a0f1a;
    border: 2px solid #1a2332;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    padding: 2px;
  }
  
  .switch-port:hover {
    transform: scale(1.1);
    z-index: 10;
    border-color: #6ea8ff !important;
  }
  
  /* Port state styles */
  .switch-port.disabled {
    background: #0a0f1a;
    border-color: #2a3441;
    opacity: 0.4;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 3px,
      rgba(255,255,255,0.05) 3px,
      rgba(255,255,255,0.05) 6px
    );
  }
  
  .switch-port.no-link {
    background: rgba(127, 140, 141, 0.1);
    border-color: #7f8c8d;
  }
  
  .switch-port.active {
    background: rgba(34, 197, 94, 0.15);
    border-color: #22c55e;
  }
  
  .switch-port.error {
    animation: pulse 2s infinite;
    border-color: #ef4444 !important;
    background: rgba(239, 68, 68, 0.1) !important;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  
  .port-number {
    font-size: 11px;
    font-weight: bold;
    color: #e6eaf2;
    z-index: 1;
    position: relative;
    line-height: 1;
  }
  
  .port-name {
    font-size: 10px;
    font-weight: bold; 
    color: #9fb0c8;
    z-index: 1;
    position: relative;
    line-height: 1;
    margin-top: 2px;
    text-align: center;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 0 1px;
  }
  
  /* Legend styles */
  .switch-legend {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #2a3441;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #7f8c8d;
  }
  
  .legend-box {
    width: 20px;
    height: 20px;
    border: 2px solid;
    border-radius: 3px;
    position: relative;
    overflow: hidden;
  }
  
  .legend-box.disabled {
    background: #0a0f1a;
    border-color: #2a3441;
    opacity: 0.4;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 2px,
      rgba(255,255,255,0.1) 2px,
      rgba(255,255,255,0.1) 4px
    );
  }
  
  .legend-box.no-link {
    background: rgba(127, 140, 141, 0.1);
    border-color: #7f8c8d;
  }
  
  .legend-box.active {
    background: rgba(34, 197, 94, 0.15);
    border-color: #22c55e;
  }
  
  .legend-box.error {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    animation: pulse 2s infinite;
  }

  /* SFP Panel Styles */
  .sfp-panel {
    background: #0a0f1a;
    border: 1px solid #2a3441;
    border-radius: 8px;
    padding: 15px;
    min-width: 120px;
  }
  
  .sfp-section {
    margin-bottom: 15px;
  }
  
  .sfp-label {
    color: #6ea8ff;
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 10px;
    text-transform: uppercase;
  }
  
  .sfp-port, .qsfp-port {
    width: 100%;
    height: 40px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }
  
  .qsfp-port {
    height: 50px;
    background-image: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.02) 10px,
      rgba(255,255,255,0.02) 20px
    );
  }
  
  .port-label {
    font-size: 12px;
    font-weight: bold;
    color: #e6eaf2;
  }
  
  .sfp-port-name {
    font-size: 10px;
    font-weight: bold; 
    color: #9fb0c8;
    margin-top: 2px;
  }
</style>

<div class="ops-dash">
  <!-- Header Bar with System Status -->
  <div class="ops-header">
    <div class="ops-title">üéØ OPERATIONS COMMAND CENTER</div>
    <div>Status: <span class="status">{{ system_status }}</span> | Last Refresh: <span id="last-refresh">{{ last_refresh }}</span></div>
  </div>

  <div class="section">
  <h3>üåê WAN Bandwidth</h3>
  <div class="wan-grid">
    <!-- WAN 1 -->
    <div class="wan-card">
      <strong>Spectrum WAN 1 - {{ wan1.port_name }}</strong><br>
      <div style="margin: 10px 0;">
        ‚Üì <span id="wan1-down">{{ wan1.download_mbps }}</span> Mbps | 
        ‚Üë <span id="wan1-up">{{ wan1.upload_mbps }}</span> Mbps<br>
        Status: <span style="color: {% if wan1.status == 'UP' %}#22c55e{% else %}#ef4444{% endif %}">{{ wan1.status }}</span>
      </div>
      <!-- LibreNMS Graph -->
      <img src="{{ wan1_graph_url }}" alt="WAN1 Bandwidth Graph" style="width: 100%; height: auto; border-radius: 4px; margin-top: 10px; background: #e8e8e8; padding: 4px;">
    </div>
    
    <!-- WAN 2 -->
    <div class="wan-card">
      <strong>Frontier WAN 2 - {{ wan2.port_name }}</strong><br>
      <div style="margin: 10px 0;">
        ‚Üì <span id="wan2-down">{{ wan2.download_mbps }}</span> Mbps | 
        ‚Üë <span id="wan2-up">{{ wan2.upload_mbps }}</span> Mbps<br>
        Status: <span style="color: {% if wan2.status == 'UP' %}#22c55e{% else %}#ef4444{% endif %}">{{ wan2.status }}</span>
      </div>
      <!-- LibreNMS Graph -->
      <img src="{{ wan2_graph_url }}" alt="WAN2 Bandwidth Graph" style="width: 100%; height: auto; border-radius: 4px; margin-top: 10px; background: #e8e8e8; padding: 4px;">
    </div>
  </div>
</div>

  <!-- Alerts Section -->
  <div class="section">
    <h3>üö® Alerts</h3>
    <div class="alerts-grid">
      <div class="alert-box">
        <div class="alert-count" id="ips-count">{{ alerts.ips_count }}</div>
        <div>IPS Alerts (Last 24h)</div>
        <small>{{ alerts.ips_latest }}</small>
      </div>
      <div class="alert-box">
        <div class="alert-count" style="color:#f59e0b;">{{ alerts.firewalla_count }}</div>
        <div>Firewalla</div>
        <small>{{ alerts.firewalla_latest }}</small>
      </div>
      <div class="alert-box">
        <div class="alert-count" style="color:#22c55e;">{{ alerts.syslogs_count }}</div>
        <div>Sys Logs</div>
        <small>All Clear</small>
      </div>
      <div class="alert-box">
        <div style="color:#6ea8ff;">WAN1</div>
        <div>Hostmon</div>
        <small>{{ alerts.hostmon_downtime }}</small>
      </div>
    </div>
  </div>

  <!-- Power & Control Section - UPDATED FOR DLI PDU -->
  <div class="section">
    <h3>‚ö° Power & Control</h3>
    
    <!-- PDU Header with Power Stats -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div>
        <strong>{{ pdu.name }}</strong> - 
        <span id="pdu-amps" style="color: {% if pdu.current_amps > 12 %}#ef4444{% elif pdu.current_amps > 10 %}#f59e0b{% else %}#22c55e{% endif %}">
          {{ pdu.current_amps|round(1) }}
        </span>A / {{ pdu.max_amps }}A
        <span style="color: #7f8c8d; font-size: 12px;">
          ({{ ((pdu.current_amps / pdu.max_amps * 100)|round(0))|int }}% load)
        </span>
      </div>
      <div style="font-size: 12px; color: #7f8c8d;">
        {{ pdu.voltage }}V | {{ pdu.watts|round(0)|int }}W
      </div>
    </div>
    
    <!-- Outlet Grid -->
    <div class="outlets" style="margin-top:10px;">
      {% for outlet in pdu.outlets %}
      <div class="outlet-control" 
           data-outlet-id="{{ outlet.id }}"
           data-locked="{{ outlet.locked|lower }}">
        
        <!-- Outlet Box -->
        <div class="outlet {{ 'on' if outlet.on else 'off' }} {{ 'locked' if outlet.locked else '' }}"
             onclick="toggleOutlet({{ outlet.id }})"
             style="cursor: {{ 'not-allowed' if outlet.locked else 'pointer' }};">
          
          <!-- Outlet Number -->
          <div style="font-size: 16px; font-weight: bold;">{{ outlet.id }}</div>
          
          <!-- Outlet Name -->
          <div style="font-size: 10px; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            {{ outlet.name|truncate(12, True, '') }}
          </div>
          
          <!-- Lock indicator -->
          {% if outlet.locked %}
          <div style="position: absolute; top: 2px; right: 2px; font-size: 10px;">üîí</div>
          {% endif %}
        </div>
        
        <!-- Quick Actions (shown on hover) -->
        {% if not outlet.locked %}
        <div class="outlet-actions">
          <a href="#" onclick="event.preventDefault(); cycleOutlet({{ outlet.id }})" style="color: #f59e0b; margin: 0 5px;" title="Cycle">‚ü≤</a>
          <a href="#" onclick="event.preventDefault(); renameOutlet({{ outlet.id }}, '{{ outlet.name }}')" style="color: #6ea8ff;" title="Rename">‚úè</a>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    
    <!-- Legend and Controls -->
    <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #2a3441;">
      <div style="display: flex; gap: 20px; font-size: 12px; color: #7f8c8d;">
        <span><span style="color: #22c55e;">‚óè</span> On</span>
        <span><span style="color: #7f8c8d;">‚óè</span> Off</span>
        <span>üîí Locked</span>
      </div>
      <div>
        <button onclick="refreshPDU()" style="background: #1a2332; border: 1px solid #2a3441; color: #6ea8ff; padding: 3px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">
          Refresh
        </button>
      </div>
    </div>
    
    <!-- Switch status display (keeping legacy display) -->
    <div style="margin-top:20px;">
      {% for switch in switches %}
      <div>{{ switch.name }}: {{ switch.active }}/{{ switch.ports }} ports</div>
      {% endfor %}
    </div>
  </div>

  <!-- MikroTik Switch Management Section -->
  <div class="section">
    <h3>üîå Switch Management - {{ mikrotik_switch.model }}</h3>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div>
        <span style="color: #22c55e;">{{ mikrotik_switch.stats.ports_up }}/{{ mikrotik_switch.stats.total_ports }}</span> ports up
        {% if mikrotik_switch.stats.ports_errors > 0 %}
        | <span style="color: #ef4444;">{{ mikrotik_switch.stats.ports_errors }} errors</span>
        {% endif %}
      </div>
      <div style="font-size: 12px; color: #7f8c8d;">
        Click port for details
      </div>
    </div>
    
    <!-- Main Container with Grid and Side Panel -->
    <div style="display: flex; gap: 20px;">
      <!-- Main 48-Port Grid -->
      <div style="flex: 1;">
        <div id="switch-grid" class="switch-grid">
          {% for port in mikrotik_switch.ports %}
          {% if port.id <= 48 %}
          <div class="switch-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-number">{{ port.id }}</span>
            <span class="port-name">{{ port.name|truncate(10, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- SFP/QSFP Side Panel -->
      <div class="sfp-panel">
        <div class="sfp-section">
          <div class="sfp-label">SFP+ (10G)</div>
          {% for port in mikrotik_switch.ports %}
          {% if port.id >= 49 and port.id <= 52 %}
          <div class="switch-port sfp-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-label">SFP{{ port.id - 48 }}</span>
            <span class="sfp-port-name">{{ port.name|truncate(12, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        
        <div class="sfp-section" style="margin-top: 20px;">
          <div class="sfp-label">QSFP+ (40G)</div>
          {% for port in mikrotik_switch.ports %}
          {% if port.id >= 53 and port.id <= 54 %}
          <div class="switch-port qsfp-port {% if not port.enabled %}disabled{% elif port.status == 'up' %}active{% else %}no-link{% endif %} {% if port.has_errors %}error{% endif %}" 
               data-port-id="{{ port.id }}" 
               data-port-name="{{ port.name }}"
               data-enabled="{{ port.enabled|lower }}"
               data-status="{{ port.status }}"
               title="{{ port.name }} - {% if not port.enabled %}DISABLED{% elif port.status == 'up' %}ACTIVE{% else %}NO LINK{% endif %}">
            <span class="port-label">Q{{ port.id - 52 }}</span>
            <span class="sfp-port-name">{{ port.name|truncate(12, True, '') }}</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Color Legend -->
    <div class="switch-legend">
      <div class="legend-item">
        <div class="legend-box disabled"></div>
        <span>Disabled</span>
      </div>
      <div class="legend-item">
        <div class="legend-box no-link"></div>
        <span>No Link</span>
      </div>
      <div class="legend-item">
        <div class="legend-box active"></div>
        <span>Active</span>
      </div>
      <div class="legend-item">
        <div class="legend-box error"></div>
        <span>Errors</span>
      </div>
    </div>
  </div>
</div>

<!-- Port Detail Modal -->
<div id="portModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1002; align-items:center; justify-content:center;">
  <div style="background:#1a2332; border:2px solid #6ea8ff; border-radius:12px; width:600px; max-height:500px; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="color:#6ea8ff; margin:0;">
        Port <span id="portNumber">--</span> Details
      </h3>
      <button onclick="closePortModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:24px; cursor:pointer;">‚úñ</button>
    </div>
    
    <div id="portContent">
      <!-- Port Name -->
      <div style="margin-bottom:20px;">
        <label style="color:#7f8c8d; display:block; margin-bottom:5px;">Port Name:</label>
        <div style="display:flex; gap:10px;">
          <input id="portNameInput" type="text" style="flex:1; background:#0a0f1a; border:1px solid #2a3441; color:#e6eaf2; padding:8px; border-radius:4px;">
          <button onclick="updatePortName()" style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Save</button>
        </div>
      </div>
      
      <!-- Port Status -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
        <div>
          <div style="color:#7f8c8d; margin-bottom:5px;">Status:</div>
          <div id="portStatus" style="font-size:18px; font-weight:bold;">--</div>
        </div>
        <div>
          <div style="color:#7f8c8d; margin-bottom:5px;">Speed:</div>
          <div id="portSpeed" style="font-size:18px;">--</div>
        </div>
      </div>
      
      <!-- Bandwidth -->
      <div style="margin-bottom:20px;">
        <div style="color:#7f8c8d; margin-bottom:10px;">Current Bandwidth:</div>
        <div style="background:#0a0f1a; padding:15px; border-radius:4px;">
          <div>‚Üì Download: <span id="portRxRate" style="color:#22c55e; font-weight:bold;">-- Mbps</span></div>
          <div>‚Üë Upload: <span id="portTxRate" style="color:#3498db; font-weight:bold;">-- Mbps</span></div>
        </div>
      </div>
      
      <!-- Errors -->
      <div id="portErrors" style="margin-bottom:20px; display:none;">
        <div style="color:#ef4444; margin-bottom:10px;">‚ö†Ô∏è Port Errors Detected:</div>
        <div style="background:rgba(239,68,68,0.1); padding:10px; border-radius:4px; border:1px solid #ef4444;">
          RX Errors: <span id="portRxErrors">0</span> | 
          TX Errors: <span id="portTxErrors">0</span>
        </div>
      </div>
      
      <!-- Actions -->
      <div style="display:flex; gap:10px;">
        <button id="portToggleBtn" onclick="togglePort()" style="flex:1; padding:10px; border-radius:4px; cursor:pointer; font-weight:bold;">
          Toggle Port
        </button>
        <button onclick="refreshPortDetails()" style="background:#7f8c8d; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">
          Refresh
        </button>
      </div>
    </div>
  </div>
</div>

<!-- IPS Alerts Modal -->
<div id="ipsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#1a2332; border:2px solid #2a3441; border-radius:12px; width:90%; max-width:800px; max-height:80vh; overflow:auto; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="color:#ef4444; margin:0;">üö® IPS Alerts - Live Feed</h2>
      <button onclick="closeIpsModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:24px; cursor:pointer;">‚úñ</button>
    </div>
    <div id="ipsModalContent" style="font-family:monospace; font-size:12px; color:#9fb0c8;">
      Loading...
    </div>
  </div>
</div>

<!-- WHOIS Lookup Modal -->
<div id="whoisModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1001; align-items:center; justify-content:center;">
  <div style="background:#1a2332; border:2px solid #6ea8ff; border-radius:12px; width:500px; max-height:400px; overflow:auto; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="color:#6ea8ff; margin:0;">üîç IP Intelligence</h3>
      <button onclick="closeWhoisModal()" style="background:transparent; border:none; color:#6ea8ff; font-size:20px; cursor:pointer;">‚úñ</button>
    </div>
    <div id="whoisContent">Loading...</div>
  </div>
</div>

<!-- JavaScript for all functionality -->
<script>
// Auto-refresh every 30 seconds
setInterval(function() {
  fetch('/ops/api/refresh')
    .then(r => r.json())
    .then(data => {
      document.getElementById('last-refresh').textContent = data.timestamp;
      document.getElementById('wan1-down').textContent = data.wan1_down;
      document.getElementById('wan1-up').textContent = data.wan1_up;
      document.getElementById('wan2-down').textContent = data.wan2_down;
      document.getElementById('wan2-up').textContent = data.wan2_up;
      document.getElementById('ips-count').textContent = data.ips_count;
      document.getElementById('pdu-amps').textContent = data.pdu_amps;
    });
}, 30000);

// ============== PDU Control Functions ==============

// Toggle outlet on/off
function toggleOutlet(outletId) {
  // Get outlet element
  const outletEl = document.querySelector(`[data-outlet-id="${outletId}"]`);
  if (outletEl.dataset.locked === 'true') {
    alert('This outlet is locked and cannot be changed.');
    return;
  }
  
  if (!confirm(`Toggle outlet ${outletId}?`)) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/toggle`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const outlet = outletEl.querySelector('.outlet');
      if (data.new_state === 'on') {
        outlet.classList.remove('off');
        outlet.classList.add('on');
      } else {
        outlet.classList.remove('on');
        outlet.classList.add('off');
      }
      console.log(`Outlet ${outletId} turned ${data.new_state}`);
    } else {
      alert(`Failed to toggle outlet: ${data.error || 'Unknown error'}`);
    }
  })
  .catch(err => {
    alert(`Error: ${err.message}`);
  });
}

// Cycle outlet (off, wait, on)
function cycleOutlet(outletId) {
  if (!confirm(`Cycle outlet ${outletId}? This will turn it OFF then back ON.`)) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/cycle`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert(`Outlet ${outletId} is cycling...`);
      // Refresh after a few seconds
      setTimeout(refreshPDU, 5000);
    } else {
      alert(`Failed to cycle outlet: ${data.error || 'Unknown error'}`);
    }
  });
}

// Rename outlet
function renameOutlet(outletId, currentName) {
  const newName = prompt(`Rename outlet ${outletId}:`, currentName);
  if (!newName || newName === currentName) {
    return;
  }
  
  fetch(`/ops/api/pdu/outlet/${outletId}/name`, { 
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const outletEl = document.querySelector(`[data-outlet-id="${outletId}"] .outlet div:nth-child(2)`);
      if (outletEl) {
        outletEl.textContent = newName.substring(0, 12);
      }
      console.log(`Outlet ${outletId} renamed to "${newName}"`);
    } else {
      alert(`Failed to rename outlet: ${data.error || 'Unknown error'}`);
    }
  });
}

// Refresh PDU status
function refreshPDU() {
  fetch('/ops/api/pdu/outlets/all')
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Update outlet states
        data.outlets.forEach(outlet => {
          const outletEl = document.querySelector(`[data-outlet-id="${outlet.id}"] .outlet`);
          if (outletEl) {
            if (outlet.state) {
              outletEl.classList.remove('off');
              outletEl.classList.add('on');
            } else {
              outletEl.classList.remove('on');
              outletEl.classList.add('off');
            }
          }
        });
        
        // Update power stats
        if (data.power) {
          const ampsEl = document.getElementById('pdu-amps');
          if (ampsEl) {
            ampsEl.textContent = data.power.current_amps.toFixed(1);
            // Update color based on load
            if (data.power.current_amps > 12) {
              ampsEl.style.color = '#ef4444';
            } else if (data.power.current_amps > 10) {
              ampsEl.style.color = '#f59e0b';
            } else {
              ampsEl.style.color = '#22c55e';
            }
          }
        }
        
        console.log('PDU status refreshed');
      }
    })
    .catch(err => {
      console.error('Failed to refresh PDU:', err);
    });
}

// ============== IPS Alert Functions ==============

// Show IPS details with analytics
function showIpsDetails() {
  document.getElementById('ipsModal').style.display = 'flex';
  
  fetch('/ops/api/ips-details')
    .then(r => r.json())
    .then(data => {
      let content = '';
      
      if (data.analytics) {
        content += `
        <div style="background:#0f1823; border:2px solid #ef4444; border-radius:8px; padding:15px; margin-bottom:20px;">
          <h3 style="color:#ef4444; margin:0 0 15px 0;">üìä 24-Hour Threat Analytics</h3>
          
          <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-bottom:15px;">
            <div style="text-align:center;">
              <div style="font-size:28px; color:#ef4444; font-weight:bold;">${data.analytics['24hr_total']}</div>
              <div style="color:#6ea8ff; font-size:12px;">Total Blocks</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:28px; color:#f59e0b; font-weight:bold;">${data.analytics.hourly_rate}</div>
              <div style="color:#6ea8ff; font-size:12px;">Per Hour</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:28px; color:#22c55e; font-weight:bold;">${data.analytics.top_attackers ? data.analytics.top_attackers.length : 0}</div>
              <div style="color:#6ea8ff; font-size:12px;">Unique Attackers</div>
            </div>
          </div>
          
          <div style="margin-bottom:15px;">
            <h4 style="color:#6ea8ff; margin:0 0 8px 0;">Top Attackers:</h4>
            ${data.analytics.top_attackers && data.analytics.top_attackers.length > 0 ? 
              data.analytics.top_attackers.map(([ip, count]) => 
                `<div style="display:flex; justify-content:space-between; padding:4px; background:#0a0f1a; margin:2px 0; border-radius:4px;">
                  <span style="color:#fff; font-family:monospace; cursor:pointer; text-decoration:underline;" onclick="lookupIP('${ip}')">${ip}</span>
                  <span style="color:#ef4444;">${count} attacks</span>
                </div>`
              ).join('') : '<div style="color:#9fb0c8;">No attackers detected</div>'}
          </div>
          
          <div>
            <h4 style="color:#6ea8ff; margin:0 0 8px 0;">Attack Types:</h4>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              ${data.analytics.attack_types ? Object.entries(data.analytics.attack_types).map(([type, count]) =>
                `<span style="background:#1a2332; padding:4px 8px; border-radius:4px; font-size:12px;">
                  ${type}: <span style="color:#f59e0b;">${count}</span>
                </span>`
              ).join('') : '<span style="color:#9fb0c8;">No attack types</span>'}
            </div>
          </div>
        </div>`;
      }
      
      content += '<h3 style="color:#6ea8ff; margin:20px 0 10px 0;">üîç Recent IPS Alerts</h3>';
      
      if (data.alerts && data.alerts.length > 0) {
        data.alerts.forEach(alert => {
          content += `<div style="background:#0a0f1a; padding:10px; margin-bottom:10px; border-left:3px solid #ef4444; border-radius:4px;">
            <div style="color:#6ea8ff; font-size:10px;">${alert.timestamp}</div>
            <div style="color:#fff; margin-top:5px; word-wrap:break-word; font-size:11px;">${alert.message}</div>
          </div>`;
        });
      } else {
        content = '<div style="color:#22c55e;">No IPS alerts in recent logs</div>';
      }
      
      document.getElementById('ipsModalContent').innerHTML = content;
    });
}

// IP WHOIS lookup using local whois.exe
function lookupIP(ip) {
  document.getElementById('whoisModal').style.display = 'flex';
  document.getElementById('whoisContent').innerHTML = 'Looking up ' + ip + '...';
  
  fetch('/ops/api/whois/' + ip)
    .then(r => r.json())
    .then(data => {
      let content = `
        <div style="background:#0a0f1a; border:1px solid #2a3441; border-radius:8px; padding:15px;">
          <div style="font-size:20px; color:#ef4444; font-family:monospace; margin-bottom:15px;">${data.ip}</div>
          <div style="display:grid; gap:8px; font-size:12px;">
            <div><span style="color:#6ea8ff;">Organization:</span> <span style="color:#fff;">${data.org || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">Country:</span> <span style="color:#fff;">${data.country || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">Network:</span> <span style="color:#fff;">${data.network || 'Unknown'}</span></div>
            <div><span style="color:#6ea8ff;">CIDR:</span> <span style="color:#fff; font-family:monospace;">${data.cidr || 'Unknown'}</span></div>
            ${data.contact && data.contact !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Contact:</span> <span style="color:#fff;">${data.contact}</span></div>` : ''}
            ${data.address && data.address !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Address:</span> <span style="color:#fff;">${data.address}</span></div>` : ''}
            ${data.abuse_email && data.abuse_email !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Abuse Email:</span> <span style="color:#ef4444;">${data.abuse_email}</span></div>` : ''}
            ${data.phone && data.phone !== 'Unknown' ? `<div><span style="color:#6ea8ff;">Phone:</span> <span style="color:#fff;">${data.phone}</span></div>` : ''}
          </div>
        </div>
      `;
      document.getElementById('whoisContent').innerHTML = content;
    })
    .catch(err => {
      document.getElementById('whoisContent').innerHTML = '<div style="color:#ef4444;">Error performing lookup</div>';
    });
}

// Modal control functions
function closeIpsModal() {
  document.getElementById('ipsModal').style.display = 'none';
}

function closeWhoisModal() {
  document.getElementById('whoisModal').style.display = 'none';
}

// ============== Switch Port Functions ==============

let currentPortId = null;

// Show port details modal
function showPortDetails(portId) {
  currentPortId = portId;
  document.getElementById('portModal').style.display = 'flex';
  
  // Load port details
  fetch(`/ops/api/switch/port/${portId}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById('portNumber').textContent = data.id;
      document.getElementById('portNameInput').value = data.name;
      
      // Show both admin and operational status
      let statusText = '';
      let statusColor = '';
      
      if (!data.enabled) {
        statusText = 'DISABLED';
        statusColor = '#7f8c8d';
      } else if (data.status === 'up') {
        statusText = 'UP';
        statusColor = '#22c55e';
      } else {
        statusText = 'NO LINK';
        statusColor = '#f59e0b';
      }
      
      document.getElementById('portStatus').textContent = statusText;
      document.getElementById('portStatus').style.color = statusColor;
      document.getElementById('portSpeed').textContent = data.speed;
      document.getElementById('portRxRate').textContent = data.rx_mbps + ' Mbps';
      document.getElementById('portTxRate').textContent = data.tx_mbps + ' Mbps';
      
      // Show errors if any
      if (data.rx_errors > 0 || data.tx_errors > 0) {
        document.getElementById('portErrors').style.display = 'block';
        document.getElementById('portRxErrors').textContent = data.rx_errors;
        document.getElementById('portTxErrors').textContent = data.tx_errors;
      } else {
        document.getElementById('portErrors').style.display = 'none';
      }
      
      // Update toggle button based on admin state
      const toggleBtn = document.getElementById('portToggleBtn');
      if (data.enabled) {
        toggleBtn.textContent = 'Disable Port';
        toggleBtn.style.background = '#ef4444';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
      } else {
        toggleBtn.textContent = 'Enable Port';
        toggleBtn.style.background = '#22c55e';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
      }
    });
}

// Close port modal
function closePortModal() {
  document.getElementById('portModal').style.display = 'none';
  currentPortId = null;
}

// Toggle port state
function togglePort() {
  if (!currentPortId) return;
  
  if (confirm('Are you sure you want to toggle this port?')) {
    fetch(`/ops/api/switch/port/${currentPortId}/toggle`, { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          refreshPortDetails();
          // Refresh the main grid too
          location.reload();
        }
      });
  }
}

// Update port name
function updatePortName() {
  if (!currentPortId) return;
  
  const newName = document.getElementById('portNameInput').value;
  
  fetch(`/ops/api/switch/port/${currentPortId}/name`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Port name updated');
        // Update the grid tooltip
        const portElement = document.querySelector(`[data-port-id="${currentPortId}"]`);
        if (portElement) {
          const status = portElement.dataset.enabled === 'false' ? 'DISABLED' :
                         portElement.dataset.status === 'up' ? 'ACTIVE' : 'NO LINK';
          portElement.title = `${newName} - ${status}`;
          // Also update the port name display
          const portNameElement = portElement.querySelector('.port-name') || portElement.querySelector('.sfp-port-name');
          if (portNameElement) {
            portNameElement.textContent = newName.substring(0, 10);
          }
        }
      }
    });
}

// Refresh port details
function refreshPortDetails() {
  if (currentPortId) {
    showPortDetails(currentPortId);
  }
}

// Add click handlers to all elements on page load
document.addEventListener('DOMContentLoaded', function() {
  // IPS alert box clickable
  const alertBoxes = document.querySelectorAll('.alert-box');
  if (alertBoxes.length > 0) {
    const ipsBox = alertBoxes[0];
    ipsBox.style.cursor = 'pointer';
    ipsBox.onclick = showIpsDetails;
  }
  
  // Switch port click handlers
  document.querySelectorAll('.switch-port').forEach(port => {
    port.addEventListener('click', function() {
      const portId = parseInt(this.dataset.portId);
      showPortDetails(portId);
    });
  });
  
  // PDU outlet hover effects
  document.querySelectorAll('.outlet-control').forEach(el => {
    el.addEventListener('mouseenter', function() {
      if (this.dataset.locked !== 'true') {
        const actions = this.querySelector('.outlet-actions');
        if (actions) actions.style.display = 'block';
      }
    });
    el.addEventListener('mouseleave', function() {
      const actions = this.querySelector('.outlet-actions');
      if (actions) actions.style.display = 'none';
    });
  });
});
</script>

{% endblock %}