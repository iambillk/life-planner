{% extends "base.html" %}
{% block title %}Calendar Analytics{% endblock %}
{% block header %}Calendar Analytics{% endblock %}

{% block extra_css %}
<style>
  :root{
    --glow: 0 10px 30px rgba(0,0,0,.25);
    --glow-strong: 0 18px 50px rgba(0,0,0,.35);
    --grad-1: linear-gradient(135deg, #0ea5e9 0%, #6366f1 50%, #22d3ee 100%);
    --grad-2: linear-gradient(135deg, #f43f5e 0%, #f59e0b 50%, #84cc16 100%);
    --chip-bg: color-mix(in oklab, var(--panel) 88%, transparent);
  }

  .analytics-wrap{
    max-width:1400px;margin:0 auto;padding:20px 20px 64px;
  }

  /* HERO / HEADER STRIP */
  .hero{
    position:relative;overflow:hidden;border-radius:18px;margin-bottom:18px;
    background: radial-gradient(1200px 300px at 10% -20%, rgba(99,102,241,.25), transparent),
                radial-gradient(900px 260px at 90% -30%, rgba(14,165,233,.22), transparent),
                var(--panel);
    border:1px solid var(--line);
    box-shadow: var(--glow);
  }
  .hero-inner{
    display:flex;gap:16px;align-items:center;flex-wrap:wrap;
    padding:14px 16px;backdrop-filter: blur(6px);
  }
  .hero .btn{margin-left:auto}

  /* CONTROLS (sticky) */
  .controls{
    position:sticky;top:0;z-index:6;margin-bottom:16px;
    border:1px solid var(--line);border-radius:14px;
    background: color-mix(in oklab, var(--panel) 92%, transparent);
    padding:10px 12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    box-shadow: var(--glow);
  }
  .controls select{
    background:var(--card);border:1px solid var(--line);color:var(--text);
    padding:8px 10px;border-radius:10px;outline:none
  }
  .controls .daterange{color:var(--text-muted)}

  /* KPI GRID */
  .kpi-grid{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:14px;margin:12px 0 22px;
  }
  .kpi{
    position:relative;border-radius:16px;padding:18px;border:1px solid var(--line);
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--card) 96%, transparent), var(--card));
    box-shadow: var(--glow);transform: translateZ(0);
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    overflow:hidden;
  }
  .kpi::before{
    content:"";position:absolute;inset:-1px;border-radius:16px;
    background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    pointer-events:none;
  }
  .kpi:hover{transform: translateY(-3px);box-shadow: var(--glow-strong);filter: saturate(1.02)}
  .kpi .label{color:var(--text-muted);font-size:.8rem;letter-spacing:.4px;text-transform:uppercase}
  .kpi .num{font-size:2.4rem;font-weight:800;margin-top:6px}
  .kpi .num.success{color:var(--success)}
  .kpi .num.danger{color:var(--danger)}

  /* SMALL ‚ÄúWHO‚Äù GRID INSIDE KPI */
  .mini-who{
    display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
  }
  .mini-chip{
    flex:0 1 auto;min-width:84px;text-align:center;border-radius:12px;padding:8px 10px;
    background:var(--chip-bg);border:1px solid var(--line)
  }
  .mini-chip .n{font-size:1.3rem;font-weight:800}
  .mini-chip .t{font-size:.78rem;color:var(--text-muted)}

  /* INSIGHTS CALLOUT */
  .insights{
    border-radius:16px;border:1px solid color-mix(in oklab, var(--danger) 38%, var(--line));
    background: color-mix(in oklab, var(--danger) 16%, transparent);
    padding:16px 18px;margin:14px 0 18px;box-shadow: var(--glow);
  }
  .insights h3{margin:0 0 6px}
  .ins{padding:8px 0;font-size:1.03rem}

  /* LEGEND */
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:2px 0 10px}
  .chip{
    display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;
    background:var(--chip-bg);border:1px solid var(--line);font-size:.85rem;color:var(--text-muted)
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.primary{background:var(--primary)}
  .dot.danger{background:var(--danger)}
  .dot.wife{background:#ec4899}
  .dot.kids{background:#10b981}
  .dot.family{background:#f59e0b}

  /* CHART CARDS */
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  .charts-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  @media (max-width:980px){.charts,.charts-2{grid-template-columns:1fr}}

  .card{
    border-radius:16px;border:1px solid var(--line);padding:18px;background:var(--card);
    box-shadow: var(--glow);
  }
  .title{
    display:flex;align-items:center;gap:10px;margin:0 0 10px;
    font-size:1.08rem;font-weight:800;color:var(--primary)
  }

  /* BARS (animated) */
  .bar{
    --h:44px;position:relative;display:flex;justify-content:space-between;align-items:center;
    border-radius:12px;padding:8px 12px;margin:10px 0;color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.18);height:var(--h);min-width:120px;max-width:100%;
    transform: translateZ(0);overflow:hidden;
  }
  .bar .fill{
    position:absolute;left:0;top:0;bottom:0;border-radius:12px;z-index:0;
    background:var(--grad-1);width:0%;
    transition: width .9s cubic-bezier(.2,.8,.2,1);
  }
  .bar.emergency .fill{background:var(--grad-2)}
  .bar.wife .fill{background:#ec4899}
  .bar.kids .fill{background:#10b981}
  .bar.family .fill{background:#f59e0b}
  .bar .l,.bar .r{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar .r{font-variant-numeric:tabular-nums;opacity:.95}

  /* EMPTY STATE */
  .empty{
    text-align:center;border:1px dashed var(--line);border-radius:12px;padding:14px;color:var(--text-muted);
    background: color-mix(in oklab, var(--panel) 92%, transparent);
  }

  /* FLOATER ACTIONS */
  .float-actions{
    position:fixed;right:18px;bottom:18px;display:flex;gap:10px;z-index:10;
  }
  .fab{
    border-radius:14px;padding:10px 14px;border:1px solid var(--line);
    background: var(--panel);box-shadow: var(--glow);cursor:pointer;
    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .fab:hover{transform: translateY(-2px);box-shadow: var(--glow-strong);filter: brightness(1.05)}
</style>
{% endblock %}

{% block content %}
<div class="analytics-wrap">

  <!-- Sticky Controls -->
  <div class="controls">
    <span>Showing last</span>
    <select onchange="window.location.href='?days=' + this.value" class="form-input" style="width:auto;">
      <option value="7"  {% if days_back == 7 %}selected{% endif %}>7 days</option>
      <option value="30" {% if days_back == 30 %}selected{% endif %}>30 days</option>
      <option value="60" {% if days_back == 60 %}selected{% endif %}>60 days</option>
      <option value="90" {% if days_back == 90 %}selected{% endif %}>90 days</option>
    </select>
    <span class="daterange">({{ start_date.strftime('%b %d') }} ‚Äì {{ end_date.strftime('%b %d, %Y') }})</span>
    <a href="{{ url_for('daily.calendar_view') }}" class="btn">‚Üê Back to Calendar</a>
  </div>

  <!-- Hero Strip (light spice without new routes) -->
  <div class="hero">
    <div class="hero-inner">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 24px var(--primary)"></div>
        <strong>Calendar Pulse</strong>
        <span style="color:var(--text-muted)">Quick health check of your last {{ days_back }} days</span>
      </div>
      <div class="legend" style="margin-left:auto">
        <span class="chip"><span class="dot primary"></span>Primary</span>
        <span class="chip"><span class="dot danger"></span>Emergency</span>
        <span class="chip"><span class="dot wife"></span>Wife</span>
        <span class="chip"><span class="dot kids"></span>Kids</span>
        <span class="chip"><span class="dot family"></span>Family</span>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi" aria-label="Total events">
      <div class="label">Total Events</div>
      <div class="num js-count" data-count="{{ total_events }}">{{ total_events }}</div>
    </div>

    <div class="kpi" aria-label="Planned events">
      <div class="label">Planned</div>
      <div class="num success js-count" data-count="{{ planned_events }}">{{ planned_events }}</div>
    </div>

    <div class="kpi" aria-label="Emergency events">
      <div class="label">Emergencies</div>
      <div class="num danger js-count" data-count="{{ emergency_events }}">{{ emergency_events }}</div>
    </div>

    <div class="kpi" aria-label="Emergency rate">
      <div class="label">Emergency Rate</div>
      <div class="num danger js-count" data-count="{{ '%.0f'|format(emergency_rate) }}">0</div>
      <div style="color:var(--text-muted);font-size:.85rem;margin-top:6px">percent</div>
    </div>

    <div class="kpi" aria-label="Events by person">
      <div class="label">Events by Person</div>
      <div class="mini-who">
        {% for who, count in who_counts.items()|sort(attribute=1, reverse=true) %}
        <div class="mini-chip" title="{{ who }}: {{ count }}">
          <div class="n" style="color:
            {% if who == 'Me' %}var(--primary)
            {% elif who == 'Wife' %}#ec4899
            {% elif who in ['Kids','Ziggy','Gus'] %}#10b981
            {% elif who == 'Family' %}#f59e0b
            {% else %}#8b95a1{% endif %};">{{ count }}</div>
          <div class="t">{{ who }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% if insights %}
  <div class="insights">
    <h3>üìä Key Insights</h3>
    {% for insight in insights %}
      <div class="ins">‚Ä¢ {{ insight }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- CHART ROW 1 -->
  <div class="charts">
    <!-- Categories -->
    <div class="card">
      <div class="title">üìÇ Events by Category</div>
      {% set has_cat = (total_events > 0 and category_counts|length > 0) %}
      {% for cat, count in category_counts.items()|sort(attribute=1, reverse=true) %}
        {% if total_events > 0 %}
        {% set pct = (count / total_events * 95) %}
        <div class="bar" data-width="{{ '%.3f'|format(pct) }}">
          <div class="fill"></div>
          <span class="l">{{ cat }}</span>
          <span class="r">{{ count }} ({{ '%.0f'|format(count / total_events * 100) }}%)</span>
        </div>
        {% endif %}
      {% endfor %}
      {% if not has_cat %}
        <div class="empty">No category data yet</div>
      {% endif %}
    </div>

    <!-- Who -->
    <div class="card">
      <div class="title">üë• Events by Person</div>
      {% set has_who = (total_events > 0 and who_counts|length > 0) %}
      {% for who, count in who_counts.items()|sort(attribute=1, reverse=true) %}
        {% if total_events > 0 %}
        {% set pct = (count / total_events * 95) %}
        <div class="bar {% if who == 'Wife' %}emergency wife{% elif who in ['Kids','Ziggy','Gus'] %}kids{% elif who == 'Family' %}family{% endif %}"
             data-width="{{ '%.3f'|format(pct) }}">
          <div class="fill"></div>
          <span class="l">{{ who }}</span>
          <span class="r">{{ count }} ({{ '%.0f'|format(count / total_events * 100) }}%)</span>
        </div>
        {% endif %}
      {% endfor %}
      {% if not has_who %}
        <div class="empty">No person breakdown yet</div>
      {% endif %}
    </div>
  </div>

  <!-- CHART ROW 2 -->
  <div class="charts-2">
    <!-- Locations -->
    <div class="card">
      <div class="title">üìç Top Locations</div>
      {% if top_locations %}
        {% for location, count in top_locations %}
          {% if total_events > 0 %}
          {% set pct = (count / total_events * 95) %}
          <div class="bar" data-width="{{ '%.3f'|format(pct) }}">
            <div class="fill"></div>
            <span class="l">{{ location }}</span>
            <span class="r">{{ count }}</span>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="empty">No location data yet</div>
      {% endif %}
    </div>

    <!-- Emergencies by Person -->
    <div class="card">
      <div class="title">üö® Emergencies by Person</div>
      {% if who_emergencies %}
        {% for who, count in who_emergencies.items()|sort(attribute=1, reverse=true) %}
        <div class="bar emergency" data-width="95">
          <div class="fill"></div>
          <span class="l">{{ who }}</span>
          <span class="r">{{ count }} emergencies</span>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty">No emergencies recorded</div>
      {% endif %}
    </div>
  </div>

  <!-- Emergencies by Category -->
  <div class="card" style="margin-bottom:16px">
    <div class="title">üö® Emergencies by Category</div>
    {% if emergency_by_category %}
      {% for cat, count in emergency_by_category.items()|sort(attribute=1, reverse=true) %}
      <div class="bar emergency" data-width="{{ '%.3f'|format(count / (emergency_events or 1) * 95) }}">
        <div class="fill"></div>
        <span class="l">{{ cat }}</span>
        <span class="r">{{ count }} emergencies</span>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty">No emergencies by category</div>
    {% endif %}
  </div>

  <!-- Activities -->
  <div class="card" style="margin-bottom:16px">
    <div class="title">üéØ Most Frequent Activities</div>
    {% set has_act = (total_events > 0 and top_activities|length > 0) %}
    {% for activity, count in top_activities[:10] %}
      {% if total_events > 0 %}
      <div class="bar" data-width="{{ '%.3f'|format(count / total_events * 95) }}">
        <div class="fill"></div>
        <span class="l">{{ activity }}</span>
        <span class="r">{{ count }}</span>
      </div>
      {% endif %}
    {% endfor %}
    {% if not has_act %}
      <div class="empty">No activity data yet</div>
    {% endif %}
  </div>

  <!-- Weekday -->
  <div class="card">
    <div class="title">üìÖ Events by Day of Week</div>
    {% set day_names = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
    {% set any_day = false %}
    {% for day_num in range(7) %}
      {% if weekday_counts[day_num] > 0 %}
      {% set any_day = true %}
      <div class="bar" data-width="{{ '%.3f'|format(weekday_counts[day_num] / total_events * 95) }}">
        <div class="fill"></div>
        <span class="l">{{ day_names[day_num] }}</span>
        <span class="r">
          {{ weekday_counts[day_num] }} events
          {% if weekday_emergency[day_num] > 0 %}
            ({{ weekday_emergency[day_num] }} emergencies)
          {% endif %}
        </span>
      </div>
      {% endif %}
    {% endfor %}
    {% if not any_day %}
      <div class="empty">No events in this window</div>
    {% endif %}
  </div>

  <!-- Floating actions (no new routes; purely cosmetic helpers) -->
  <div class="float-actions">
    <button class="fab" onclick="window.print()" title="Print">
      üñ®Ô∏è Print
    </button>
    <button class="fab" onclick="scrollTo(0,0)" title="Top">
      ‚¨ÜÔ∏è Top
    </button>
  </div>

</div>

<!-- Minimal spice JS: count-up + animated bar fill (keeps routes/data intact) -->
<script>
  (function(){
    // Count-up KPIs
    document.querySelectorAll('.js-count').forEach(el=>{
      const target = parseFloat(el.getAttribute('data-count') || '0');
      const isPercent = el.textContent.trim().endsWith('%') || el.nextElementSibling?.textContent?.toLowerCase()?.includes('percent');
      let start = 0, startTs = null, dur = 900;
      function step(ts){
        if(!startTs) startTs = ts;
        const p = Math.min(1, (ts - startTs)/dur);
        const val = Math.floor(target * p);
        el.textContent = isPercent ? val : val.toLocaleString();
        if(p < 1) requestAnimationFrame(step);
        else { el.textContent = isPercent ? Math.round(target) : target.toLocaleString(); }
      }
      requestAnimationFrame(step);
    });

    // Animate bar widths
    const bars = document.querySelectorAll('.bar');
    const io = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting){
          const w = e.target.getAttribute('data-width');
          const fill = e.target.querySelector('.fill');
          if(fill && w) fill.style.width = (parseFloat(w)||0) + '%';
          io.unobserve(e.target);
        }
      }
    }, {threshold:.2});
    bars.forEach(b=>io.observe(b));
  })();
</script>
{% endblock %}
