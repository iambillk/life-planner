<!-- templates/daily/add_event.html -->
{% extends "base.html" %}
{% block title %}Add Event{% endblock %}
{% block header %}ADD CALENDAR EVENT{% endblock %}

{% block extra_css %}
<style>
    /* ==================== FORM CONTAINER ==================== */
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-card {
        background: var(--card);
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .form-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--line);
    }
    
    .form-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 10px;
    }
    
    .form-subtitle {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    /* ==================== FORM GROUPS ==================== */
    .form-content {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--text);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .form-input {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 12px 15px;
        color: var(--text);
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.1);
    }
    
    .form-hint {
        font-size: 12px;
        color: var(--text-muted);
        font-style: italic;
    }
    
    textarea.form-input {
        min-height: 100px;
        resize: vertical;
    }
    
    /* ==================== EVENT TYPE CHIPS ==================== */
    .event-type-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .event-type-chip {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 20px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    
    .event-type-chip:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .event-type-chip.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* ==================== WHO SELECTOR ==================== */
    .who-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }
    
    .who-option {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .who-option:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .who-option.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .who-emoji {
        font-size: 24px;
        margin-bottom: 5px;
    }
    
    .who-name {
        font-weight: 600;
        font-size: 14px;
    }
    
    /* ==================== TIME SHORTCUTS ==================== */
    .time-shortcuts {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .time-shortcut {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .time-shortcut:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* ==================== RECURRING OPTIONS ==================== */
    .recurring-toggle {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
    }
    
    .recurring-toggle:hover {
        border-color: var(--primary);
    }
    
    .toggle-checkbox {
        width: 24px;
        height: 24px;
        border: 2px solid var(--line);
        border-radius: 6px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .toggle-checkbox.checked {
        background: var(--primary);
        border-color: var(--primary);
    }
    
    .toggle-checkbox.checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
    }
    
    .recurring-options {
        display: none;
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 20px;
        margin-top: 15px;
    }
    
    .recurring-options.active {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Recurrence Type Selector */
    .recurrence-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .recurrence-type-btn {
        background: var(--card);
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 600;
    }
    
    .recurrence-type-btn:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .recurrence-type-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* Pattern Options */
    .pattern-options {
        margin-top: 20px;
        padding: 15px;
        background: var(--card);
        border-radius: 8px;
    }
    
    .pattern-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .pattern-row label {
        min-width: 80px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .pattern-row input[type="number"] {
        width: 80px;
    }
    
    .pattern-row select {
        background: var(--panel);
        border: 2px solid var(--line);
        border-radius: 6px;
        padding: 8px;
        color: var(--text);
    }
    
    /* Day Selector */
    .day-selector {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .day-option {
        background: var(--card);
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        font-size: 14px;
    }
    
    .day-option:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .day-option.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* ==================== WARNING CARD ==================== */
    .warning-card {
        background: rgba(245, 158, 11, 0.1);
        border: 2px solid var(--warning);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .warning-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 16px;
        color: var(--warning);
        margin-bottom: 10px;
    }
    
    .warning-text {
        color: var(--text);
        font-size: 14px;
        line-height: 1.6;
    }
    
    /* ==================== FORM ACTIONS ==================== */
    .form-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid var(--line);
    }
    
    .btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
    }
    
    .btn-secondary {
        background: var(--panel);
        color: var(--text);
        border: 2px solid var(--line);
    }
    
    .btn-secondary:hover {
        background: var(--card);
        border-color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h1 class="form-title">Add New Event</h1>
            <p class="form-subtitle">Schedule something for your calendar</p>
        </div>
        
        <form method="POST" action="{{ url_for('daily.add_event') }}">
            
            <div class="form-content">
                
                <!-- EVENT TYPE -->
                <div class="form-group">
                    <label class="form-label">Event Type</label>
                    <input type="text" name="event_type" id="event_type" class="form-input" 
                           placeholder="e.g., Doctor Appointment, Meeting, Birthday" required>
                    <div class="event-type-chips">
                        {% for type in event_types[:8] %}
                        <div class="event-type-chip" onclick="setEventType('{{ type.type_name }}')">
                            {{ type.type_name }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- CATEGORY & LOCATION -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category (optional)</label>
                        <select name="category" class="form-input">
                            <option value="">-- Select Category --</option>
                            <option value="Work">💼 Work</option>
                            <option value="Errands">🚗 Errands</option>
                            <option value="Health">🏥 Health</option>
                            <option value="Social">👥 Social</option>
                            <option value="Family">👨‍👩‍👧‍👦 Family</option>
                            <option value="Personal">🧘 Personal</option>
                        </select>
                    </div>
                
                    <div class="form-group">
                        <label class="form-label">Location (optional)</label>
                        <input type="text" name="location" class="form-input" placeholder="e.g., Office, Home, DC, Kroger..."
                            list="location-list">
                        <datalist id="location-list">
                            <option value="Home">
                            <option value="Office">
                            <option value="DC">
                            <option value="Kroger">
                            <option value="School">
                        </datalist>
                    </div>
                </div>
                
                <!-- PLANNED STATUS -->
                <div class="form-group">
                    <label class="form-label">Was this planned?</label>
                    <select name="was_planned" class="form-input">
                        <option value="planned">✅ Planned - On my schedule</option>
                        <option value="emergency">🚨 Emergency - Unexpected/Urgent</option>
                    </select>
                </div>
                
                <!-- DATE AND TIME -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" name="event_date" class="form-input" 
                               value="{{ default_date }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Time (Optional)</label>
                        <input type="text" name="event_time" id="event_time" class="form-input" 
                               placeholder="e.g., 2:00 PM or Morning">
                        <div class="time-shortcuts">
                            <button type="button" class="time-shortcut" onclick="setTime('Morning')">Morning</button>
                            <button type="button" class="time-shortcut" onclick="setTime('Afternoon')">Afternoon</button>
                            <button type="button" class="time-shortcut" onclick="setTime('Evening')">Evening</button>
                            <button type="button" class="time-shortcut" onclick="setTime('All Day')">All Day</button>
                        </div>
                    </div>
                </div>
                
                <!-- WHO -->
                <div class="form-group">
                    <label class="form-label">Who is this for?</label>
                    <input type="hidden" name="who" id="who" required>
                    <div class="who-selector">
                        <div class="who-option" onclick="setWho('Me')">
                            <div class="who-emoji">👤</div>
                            <div class="who-name">Me</div>
                        </div>
                        <div class="who-option" onclick="setWho('Wife')">
                            <div class="who-emoji">👩</div>
                            <div class="who-name">Wife</div>
                        </div>
                        <div class="who-option" onclick="setWho('Family')">
                            <div class="who-emoji">👨‍👩‍👦‍👦</div>
                            <div class="who-name">Family</div>
                        </div>
                        <div class="who-option" onclick="setWho('Ziggy')">
                            <div class="who-emoji">👦</div>
                            <div class="who-name">Ziggy</div>
                        </div>
                        <div class="who-option" onclick="setWho('Gus')">
                            <div class="who-emoji">👶</div>
                            <div class="who-name">Gus</div>
                        </div>
                    </div>
                </div>
                
                <!-- DESCRIPTION -->
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea name="description" class="form-input" 
                              placeholder="Add any additional details..."></textarea>
                </div>
                
                <!-- RECURRING OPTIONS -->
                <div class="form-group">
                    <div class="recurring-toggle" onclick="toggleRecurring()">
                        <div class="toggle-checkbox" id="recurring_checkbox"></div>
                        <div>
                            <div style="font-weight: 600;">Make this a recurring event</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Set up a repeating schedule</div>
                        </div>
                    </div>
                    
                    <div class="recurring-options" id="recurring_options">
                        <!-- Recurrence Type Selector -->
                        <label class="form-label">Recurrence Pattern</label>
                        <div class="recurrence-type-selector">
                            <div class="recurrence-type-btn active" onclick="setRecurrenceType('daily')" data-type="daily">
                                Daily
                            </div>
                            <div class="recurrence-type-btn" onclick="setRecurrenceType('weekly')" data-type="weekly">
                                Weekly
                            </div>
                            <div class="recurrence-type-btn" onclick="setRecurrenceType('monthly_date')" data-type="monthly_date">
                                Monthly
                            </div>
                            <div class="recurrence-type-btn" onclick="setRecurrenceType('monthly_day')" data-type="monthly_day">
                                Monthly (Day)
                            </div>
                            <div class="recurrence-type-btn" onclick="setRecurrenceType('yearly')" data-type="yearly">
                                Yearly
                            </div>
                        </div>
                        
                        <!-- FIXED: Changed from value="daily" to value="" -->
                        <input type="hidden" name="recurrence_type" id="recurrence_type" value="">
                        
                        <!-- Pattern Options Container -->
                        <div class="pattern-options">
                            <!-- Daily Pattern -->
                            <div id="daily_pattern" class="pattern-section">
                                <div class="pattern-row">
                                    <label>Every</label>
                                    <input type="number" name="daily_interval" value="1" min="1" max="365" class="form-input">
                                    <span>day(s)</span>
                                </div>
                            </div>
                            
                            <!-- Weekly Pattern -->
                            <div id="weekly_pattern" class="pattern-section" style="display: none;">
                                <div class="pattern-row">
                                    <label>Every</label>
                                    <input type="number" name="weekly_interval" value="1" min="1" max="52" class="form-input">
                                    <span>week(s) on:</span>
                                </div>
                                <div class="day-selector">
                                    <div class="day-option" data-day="Mon">MON</div>
                                    <div class="day-option" data-day="Tue">TUE</div>
                                    <div class="day-option" data-day="Wed">WED</div>
                                    <div class="day-option" data-day="Thu">THU</div>
                                    <div class="day-option" data-day="Fri">FRI</div>
                                    <div class="day-option" data-day="Sat">SAT</div>
                                    <div class="day-option" data-day="Sun">SUN</div>
                                </div>
                                <input type="hidden" name="recurring_days" id="recurring_days">
                            </div>
                            
                            <!-- Monthly by Date Pattern -->
                            <div id="monthly_date_pattern" class="pattern-section" style="display: none;">
                                <div class="pattern-row">
                                    <label>Day</label>
                                    <input type="number" name="monthly_date" value="1" min="1" max="31" class="form-input">
                                    <label style="margin-left: 20px;">Every</label>
                                    <input type="number" name="monthly_interval" value="1" min="1" max="12" class="form-input">
                                    <span>month(s)</span>
                                </div>
                                <div class="form-hint">e.g., "15th of every month" or "1st of every 3 months"</div>
                            </div>
                            
                            <!-- Monthly by Day Pattern -->
                            <div id="monthly_day_pattern" class="pattern-section" style="display: none;">
                                <div class="pattern-row">
                                    <label>The</label>
                                    <select name="monthly_week" class="form-input">
                                        <option value="1">First</option>
                                        <option value="2">Second</option>
                                        <option value="3">Third</option>
                                        <option value="4">Fourth</option>
                                        <option value="-1">Last</option>
                                    </select>
                                    <select name="monthly_weekday" class="form-input">
                                        <option value="0">Monday</option>
                                        <option value="1">Tuesday</option>
                                        <option value="2">Wednesday</option>
                                        <option value="3">Thursday</option>
                                        <option value="4">Friday</option>
                                        <option value="5">Saturday</option>
                                        <option value="6">Sunday</option>
                                    </select>
                                </div>
                                <div class="form-hint">e.g., "Second Tuesday of every month"</div>
                            </div>
                            
                            <!-- Yearly Pattern -->
                            <div id="yearly_pattern" class="pattern-section" style="display: none;">
                                <div class="pattern-row">
                                    <label>Every year on</label>
                                    <select name="yearly_month" class="form-input">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                    <input type="number" name="yearly_day" value="1" min="1" max="31" class="form-input" style="width: 80px;">
                                </div>
                                <div class="form-hint">e.g., "July 4th every year"</div>
                            </div>
                        </div>
                        
                        <!-- End Date -->
                        <div style="margin-top: 20px;">
                            <label class="form-label">Repeat Until</label>
                            <input type="date" name="until_date" class="form-input">
                            <div class="form-hint">Leave empty to continue indefinitely</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TIMETREE WARNING -->
            <div class="warning-card">
                <div class="warning-title">
                    <span>📱</span>
                    <span>Don't Forget TimeTree!</span>
                </div>
                <div class="warning-text">
                    If this event involves your wife or family, make sure to add it to TimeTree as well. 
                    This calendar is just for YOUR personal tracking. Your wife won't see these events unless 
                    you also add them to the shared TimeTree calendar!
                </div>
            </div>
            
            <!-- FORM ACTIONS -->
            <div class="form-actions">
                <a href="{{ url_for('daily.calendar_view') }}" class="btn btn-secondary">
                    <span>←</span>
                    <span>Cancel</span>
                </a>
                <button type="submit" class="btn btn-primary">
                    <span>✓</span>
                    <span>Add Event</span>
                </button>
            </div>
            
        </form>
    </div>
</div>

<script>
    // Set event type from chip
    function setEventType(type) {
        document.getElementById('event_type').value = type;
        
        // Update visual state
        document.querySelectorAll('.event-type-chip').forEach(chip => {
            chip.classList.remove('selected');
        });
        event.target.classList.add('selected');
    }
    
    // Set who
    function setWho(who) {
        document.getElementById('who').value = who;
        
        // Update visual state
        document.querySelectorAll('.who-option').forEach(option => {
            option.classList.remove('selected');
            if (option.querySelector('.who-name').textContent === who) {
                option.classList.add('selected');
            }
        });
    }
    
    // Set time shortcut
    function setTime(time) {
        document.getElementById('event_time').value = time;
    }
    
    // FIXED: Toggle recurring options - now properly clears/sets recurrence_type
    function toggleRecurring() {
        const checkbox = document.getElementById('recurring_checkbox');
        const options = document.getElementById('recurring_options');
        const recurrenceTypeInput = document.getElementById('recurrence_type');
        
        checkbox.classList.toggle('checked');
        
        if (checkbox.classList.contains('checked')) {
            options.classList.add('active');
            // Set default recurrence type when enabling
            recurrenceTypeInput.value = 'daily';
        } else {
            options.classList.remove('active');
            // IMPORTANT: Clear the recurrence type when disabling
            recurrenceTypeInput.value = '';
        }
    }
    
    // FIXED: Set recurrence type - only works when recurring is enabled
    function setRecurrenceType(type) {
        const checkbox = document.getElementById('recurring_checkbox');
        
        // Only set if recurring is actually enabled
        if (!checkbox.classList.contains('checked')) {
            return;
        }
        
        // Update hidden input
        document.getElementById('recurrence_type').value = type;
        
        // Update button states
        document.querySelectorAll('.recurrence-type-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.type === type) {
                btn.classList.add('active');
            }
        });
        
        // Hide all pattern sections
        document.querySelectorAll('.pattern-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show relevant pattern section
        document.getElementById(type + '_pattern').style.display = 'block';
    }
    
    // Day selector for weekly recurring
    document.querySelectorAll('.day-option').forEach(day => {
        day.addEventListener('click', function() {
            this.classList.toggle('selected');
            updateRecurringDays();
        });
    });
    
    function updateRecurringDays() {
        const selected = [];
        document.querySelectorAll('.day-option.selected').forEach(day => {
            selected.push(day.dataset.day);
        });
        document.getElementById('recurring_days').value = selected.join(',');
    }
    
    // Set today's date as default if not provided
    window.onload = function() {
        const dateInput = document.querySelector('input[name="event_date"]');
        if (!dateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
    }
</script>
{% endblock %}