{% extends "base.html" %}
{% block title %}Weight Accountability System{% endblock %}
{% block header %}Weight Loss - No Excuses{% endblock %}

{% block extra_css %}
<style>
    /* Dark theme for accountability system */
    .weight-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Navigation Tabs */
    .health-nav {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        background: var(--panel);
        padding: 10px;
        border-radius: 12px;
    }
    
    .health-nav-item {
        flex: 1;
        text-align: center;
        padding: 12px 20px;
        background: var(--card);
        border: 2px solid var(--line);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text);
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .health-nav-item:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }
    
    .health-nav-item.active {
        background: linear-gradient(135deg, #6ea8ff, #3f7fe6);
        color: white;
        border-color: #3f7fe6;
    }
    
    /* Quick Weight Entry Box */
    .quick-weight-entry {
        background: linear-gradient(135deg, #1e40af, #3730a3);
        border: 2px solid #6366f1;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .quick-weight-form {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .quick-weight-input {
        width: 150px;
        font-size: 32px;
        font-weight: 700;
        background: rgba(255,255,255,0.1);
        border: 2px solid #6366f1;
        border-radius: 8px;
        padding: 10px;
        color: white;
        text-align: center;
    }
    
    .quick-habits {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .quick-habit-check {
        display: flex;
        align-items: center;
        gap: 5px;
        color: white;
        cursor: pointer;
    }
    
    .quick-habit-check input {
        width: 20px;
        height: 20px;
    }
    
    .quick-submit-btn {
        background: #22c55e;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        transition: all 0.3s;
    }
    
    .quick-submit-btn:hover {
        background: #16a34a;
        transform: translateY(-2px);
    }
    
    .weight-logged-box {
        background: rgba(34, 197, 94, 0.1);
        border: 2px solid #22c55e;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    /* Harassment Banner */
    .harassment-banner {
        background: linear-gradient(135deg, #dc2626, #991b1b);
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.9; }
    }
    
    .harassment-text {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* Quick Failure Buttons */
    .failure-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .failure-btn {
        background: #1f2937;
        border: 2px solid #374151;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .failure-btn:hover {
        background: #dc2626;
        border-color: #ef4444;
        transform: translateY(-2px);
    }
    
    .failure-btn .icon {
        font-size: 32px;
        margin-bottom: 8px;
    }
    
    .failure-btn .label {
        font-size: 14px;
        font-weight: 600;
        color: #e5e7eb;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 20px;
    }
    
    .stat-card.danger {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .stat-card.success {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }
    
    .stat-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text);
    }
    
    .stat-change {
        font-size: 14px;
        margin-top: 5px;
    }
    
    .stat-change.up {
        color: #ef4444;
    }
    
    .stat-change.down {
        color: #22c55e;
    }
    
    /* Today's Report Card */
    .report-card {
        background: var(--panel);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
    }
    
    .report-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .habit-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
    }
    
    .habit-item {
        background: var(--card);
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: all 0.3s;
    }
    
    .habit-item.good {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }
    
    .habit-item.bad {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        animation: shake 0.5s;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .habit-icon {
        font-size: 24px;
        margin-bottom: 5px;
    }
    
    .habit-label {
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .habit-status {
        font-size: 11px;
        margin-top: 3px;
        font-weight: 600;
    }
    
    /* Streaks Section */
    .streaks-container {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .streak-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .streak-item {
        text-align: center;
        padding: 15px;
        background: var(--card);
        border-radius: 8px;
        border: 2px solid var(--line);
    }
    
    .streak-item.active {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }
    
    .streak-number {
        font-size: 36px;
        font-weight: 700;
        color: #f59e0b;
    }
    
    .streak-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
    }
    
    /* Weight Chart */
    .chart-container {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        height: 400px;
    }
    
    /* Log Weight Button */
    .log-weight-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #6ea8ff, #3f7fe6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        font-size: 32px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(110, 168, 255, 0.4);
        transition: all 0.3s;
        z-index: 1000;
    }
    
    .log-weight-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(110, 168, 255, 0.6);
    }
    
    /* Failure Patterns */
    .patterns-section {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .pattern-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--card);
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .pattern-label {
        font-weight: 600;
    }
    
    .pattern-value {
        color: #ef4444;
        font-weight: 700;
    }
    
    /* Progress Bar */
    .progress-container {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .progress-bar-wrapper {
        background: var(--card);
        border-radius: 8px;
        height: 40px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
    }
    
    .progress-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="weight-container">
    
    <!-- Navigation Tabs -->
    <div class="health-nav">
        <a href="{{ url_for('health.weight_index') }}" class="health-nav-item active">
            <span>📊 Dashboard</span>
        </a>
        <a href="{{ url_for('health.weight_analytics') }}" class="health-nav-item">
            <span>📈 Analytics</span>
        </a>
        <a href="{{ url_for('health.manage_goals') }}" class="health-nav-item">
            <span>🎯 Goals</span>
        </a>
        <a href="{{ url_for('health.health_settings') }}" class="health-nav-item">
            <span>⚙️ Settings</span>
        </a>
    </div>
    
    {% if harassment %}
    <div class="harassment-banner">
        <div class="harassment-text">{{ harassment }}</div>
    </div>
    {% endif %}
    
    <!-- Quick Weight Entry (only show if not logged today) -->
    {% if not today_entry.time_logged %}
    <div class="quick-weight-entry">
        <form method="POST" action="{{ url_for('health.log_weight') }}" class="quick-weight-form">
            <div style="flex: 1;">
                <label style="display: block; font-size: 14px; color: #e0e7ff; margin-bottom: 5px;">
                    Step on the scale NOW!
                </label>
                <input type="number" 
                       name="weight" 
                       step="0.1" 
                       placeholder="000.0" 
                       required
                       class="quick-weight-input">
            </div>
            
            <input type="hidden" name="date" value="{{ datetime.now().strftime('%Y-%m-%d') }}">
            
            <!-- Quick bad habit checkboxes -->
            <div class="quick-habits">
                <label class="quick-habit-check">
                    <input type="checkbox" name="had_soda" value="yes">
                    <span>🥤 Soda</span>
                </label>
                <label class="quick-habit-check">
                    <input type="checkbox" name="had_candy" value="yes">
                    <span>🍬 Candy</span>
                </label>
                <label class="quick-habit-check">
                    <input type="checkbox" name="had_junk" value="yes">
                    <span>🍕 Junk</span>
                </label>
            </div>
            
            <button type="submit" class="quick-submit-btn">
                Log It
            </button>
        </form>
        
        <div style="margin-top: 10px; text-align: center;">
            <a href="{{ url_for('health.log_weight') }}" style="color: #e0e7ff; text-decoration: underline; font-size: 14px;">
                Or click here for full accountability check-in →
            </a>
        </div>
    </div>
    {% else %}
    <div class="weight-logged-box">
        <div style="font-size: 18px; font-weight: 600; color: #22c55e;">
            ✓ Today's weight logged: {{ "%.1f"|format(today_entry.weight) }} lbs
        </div>
        <a href="{{ url_for('health.log_weight') }}" style="color: var(--text-muted); text-decoration: underline; font-size: 14px;">
            Update today's entry →
        </a>
    </div>
    {% endif %}
    
    <!-- Quick Failure Logging -->
    <div class="failure-grid">
        <form method="POST" action="{{ url_for('health.log_failure') }}" style="display: contents;">
            <input type="hidden" name="type" value="soda">
            <button type="submit" class="failure-btn">
                <div class="icon">🥤</div>
                <div class="label">Had Soda</div>
            </button>
        </form>
        
        <form method="POST" action="{{ url_for('health.log_failure') }}" style="display: contents;">
            <input type="hidden" name="type" value="candy">
            <button type="submit" class="failure-btn">
                <div class="icon">🍬</div>
                <div class="label">Ate Candy</div>
            </button>
        </form>
        
        <form method="POST" action="{{ url_for('health.log_failure') }}" style="display: contents;">
            <input type="hidden" name="type" value="junk">
            <button type="submit" class="failure-btn">
                <div class="icon">🍕</div>
                <div class="label">Junk Food</div>
            </button>
        </form>
        
        <form method="POST" action="{{ url_for('health.log_failure') }}" style="display: contents;">
            <input type="hidden" name="type" value="fast_food">
            <button type="submit" class="failure-btn">
                <div class="icon">🍔</div>
                <div class="label">Fast Food</div>
            </button>
        </form>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        {% if stats %}
        <div class="stat-card {% if stats.change_day is defined %}{{ 'danger' if stats.change_day > 0 else 'success' if stats.change_day < 0 else '' }}{% endif %}">
            <div class="stat-label">Current Weight</div>
            <div class="stat-value">{{ "%.1f"|format(stats.current) }} lbs</div>
            {% if stats.change_day is defined %}
            <div class="stat-change {{ 'up' if stats.change_day > 0 else 'down' }}">
                {{ "%+.1f"|format(stats.change_day) }} today
            </div>
            {% endif %}
        </div>
        
        {% if stats.change_week is defined %}
        <div class="stat-card">
            <div class="stat-label">Week Change</div>
            <div class="stat-value {{ 'up' if stats.change_week > 0 else 'down' }}">
                {{ "%+.1f"|format(stats.change_week) }}
            </div>
            <div class="stat-change">lbs this week</div>
        </div>
        {% endif %}
        {% endif %}
        
        {% if goal %}
        <div class="stat-card">
            <div class="stat-label">Goal Weight</div>
            <div class="stat-value">{{ "%.0f"|format(goal.goal_weight) }}</div>
            <div class="stat-change">{{ "%.1f"|format(goal.current_weight - goal.goal_weight) }} to go</div>
        </div>
        {% endif %}
        
        {% if stats %}
        <div class="stat-card {{ 'danger' if stats.failure_rate > 30 else '' }}">
            <div class="stat-label">Failure Rate</div>
            <div class="stat-value">{{ "%.0f"|format(stats.failure_rate) }}%</div>
            <div class="stat-change">{{ today_entry.failure_count }} today</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Today's Report Card -->
    <div class="report-card">
        <div class="report-title">
            <span>📋</span>
            <span>Today's Report Card - {{ today_entry.date.strftime('%B %d') }}</span>
        </div>
        
        <div class="habit-grid">
            <div class="habit-item {{ 'good' if today_entry.time_logged else 'bad' }}">
                <div class="habit-icon">⚖️</div>
                <div class="habit-label">Weight</div>
                <div class="habit-status">
                    {% if today_entry.time_logged %}
                        ✓ {{ "%.1f"|format(today_entry.weight) }}
                    {% else %}
                        ✗ Not logged
                    {% endif %}
                </div>
            </div>
            
            <div class="habit-item {{ 'bad' if today_entry.had_soda else 'good' }}">
                <div class="habit-icon">🥤</div>
                <div class="habit-label">Soda</div>
                <div class="habit-status">
                    {% if today_entry.had_soda %}
                        ✗ {{ today_entry.soda_count }}
                    {% else %}
                        ✓ None
                    {% endif %}
                </div>
            </div>
            
            <div class="habit-item {{ 'bad' if today_entry.had_candy else 'good' }}">
                <div class="habit-icon">🍬</div>
                <div class="habit-label">Candy</div>
                <div class="habit-status">
                    {{ '✗ Failed' if today_entry.had_candy else '✓ Clean' }}
                </div>
            </div>
            
            <div class="habit-item {{ 'bad' if today_entry.had_junk_food else 'good' }}">
                <div class="habit-icon">🍕</div>
                <div class="habit-label">Junk Food</div>
                <div class="habit-status">
                    {{ '✗ Failed' if today_entry.had_junk_food else '✓ Clean' }}
                </div>
            </div>
            
            <div class="habit-item {{ 'good' if today_entry.exercised else 'bad' }}">
                <div class="habit-icon">🏃</div>
                <div class="habit-label">Exercise</div>
                <div class="habit-status">
                    {% if today_entry.exercised %}
                        ✓ {{ today_entry.exercise_minutes }} min
                    {% else %}
                        ✗ None
                    {% endif %}
                </div>
            </div>
            
            <div class="habit-item {{ 'good' if today_entry.water_intake >= 8 else 'bad' }}">
                <div class="habit-icon">💧</div>
                <div class="habit-label">Water</div>
                <div class="habit-status">
                    {{ today_entry.water_intake }}/8 glasses
                </div>
            </div>
        </div>
    </div>
    
    <!-- Streaks -->
    {% if streaks %}
    <div class="streaks-container">
        <div class="report-title">
            <span>🔥</span>
            <span>Streaks</span>
        </div>
        
        <div class="streak-grid">
            <div class="streak-item {{ 'active' if streaks.logged > 0 else '' }}">
                <div class="streak-number">{{ streaks.logged }}</div>
                <div class="streak-label">Days Logged</div>
            </div>
            
            <div class="streak-item {{ 'active' if streaks.no_soda > 0 else '' }}">
                <div class="streak-number">{{ streaks.no_soda }}</div>
                <div class="streak-label">No Soda</div>
            </div>
            
            <div class="streak-item {{ 'active' if streaks.no_junk > 0 else '' }}">
                <div class="streak-number">{{ streaks.no_junk }}</div>
                <div class="streak-label">No Junk</div>
            </div>
            
            <div class="streak-item {{ 'active' if streaks.exercise > 0 else '' }}">
                <div class="streak-number">{{ streaks.exercise }}</div>
                <div class="streak-label">Exercise</div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Failure Patterns -->
    {% if patterns and patterns.total > 0 %}
    <div class="patterns-section">
        <div class="report-title">
            <span>📊</span>
            <span>Your Failure Patterns (Last 7 Days)</span>
        </div>
        
        <div class="pattern-item">
            <span class="pattern-label">Total Failures</span>
            <span class="pattern-value">{{ patterns.total }}</span>
        </div>
        
        {% if patterns.worst_habit %}
        <div class="pattern-item">
            <span class="pattern-label">Worst Habit</span>
            <span class="pattern-value">{{ patterns.worst_habit|title }}</span>
        </div>
        {% endif %}
        
        {% if patterns.worst_time %}
        <div class="pattern-item">
            <span class="pattern-label">Danger Time</span>
            <span class="pattern-value">{{ patterns.worst_time|title }}</span>
        </div>
        {% endif %}
        
        {% if patterns.worst_trigger %}
        <div class="pattern-item">
            <span class="pattern-label">Main Trigger</span>
            <span class="pattern-value">{{ patterns.worst_trigger|title }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Progress to Goal -->
    {% if goal %}
    <div class="progress-container">
        <div class="report-title">
            <span>🎯</span>
            <span>Progress to Goal</span>
        </div>
        
        <div class="progress-bar-wrapper">
            <div class="progress-bar" style="width: {{ [goal.progress_percentage, 100]|min }}%">
                {{ "%.1f"|format(goal.progress_percentage) }}%
            </div>
        </div>
        
        <div class="progress-labels">
            <span>Start: {{ "%.1f"|format(goal.start_weight) }} lbs</span>
            <span>Current: {{ "%.1f"|format(goal.current_weight) }} lbs</span>
            <span>Goal: {{ "%.1f"|format(goal.goal_weight) }} lbs</span>
        </div>
        
        {% if goal.days_remaining %}
        <div style="text-align: center; margin-top: 15px; color: var(--text-muted);">
            {{ goal.days_remaining }} days remaining • 
            Need to lose {{ "%.2f"|format(goal.required_daily_loss) }} lbs/day
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Weight Chart -->
    <div class="chart-container">
        <div class="report-title">
            <span>📈</span>
            <span>30-Day Trend</span>
        </div>
        <canvas id="weightChart"></canvas>
    </div>
    
    <!-- Recent Entries Table -->
    {% if entries %}
    <div class="report-card">
        <div class="report-title">
            <span>📋</span>
            <span>Recent History</span>
        </div>
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--line);">
                    <th style="padding: 10px; text-align: left;">Date</th>
                    <th style="padding: 10px; text-align: right;">Weight</th>
                    <th style="padding: 10px; text-align: right;">Change</th>
                    <th style="padding: 10px; text-align: center;">Failures</th>
                    <th style="padding: 10px; text-align: left;">Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries[:10] %}
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 10px;">{{ entry.date.strftime('%m/%d') }}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600;">
                        {{ "%.1f"|format(entry.weight) }}
                    </td>
                    <td style="padding: 10px; text-align: right;">
                        <span style="color: {{ '#ef4444' if entry.weight_change > 0 else '#22c55e' }};">
                            {{ "%+.1f"|format(entry.weight_change) }}
                        </span>
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        {% if entry.failure_count > 0 %}
                            <span style="color: #ef4444; font-weight: 700;">{{ entry.failure_count }}</span>
                        {% else %}
                            <span style="color: #22c55e;">✓</span>
                        {% endif %}
                    </td>
                    <td style="padding: 10px; font-size: 12px; color: var(--text-muted);">
                        {% if entry.had_soda %}🥤{% endif %}
                        {% if entry.had_candy %}🍬{% endif %}
                        {% if entry.had_junk_food %}🍕{% endif %}
                        {% if entry.exercised %}🏃{% endif %}
                        {{ entry.notes[:30] if entry.notes else '' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Log Weight Floating Button -->
    <a href="{{ url_for('health.log_weight') }}" class="log-weight-btn">
        ⚖️
    </a>
    
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Fetch and display weight chart
fetch('{{ url_for("health.weight_chart_data", days=30) }}')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('weightChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Weight',
                    data: data.weights,
                    borderColor: '#6ea8ff',
                    backgroundColor: 'rgba(110, 168, 255, 0.1)',
                    tension: 0.1,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}